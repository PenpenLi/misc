SelfFieldsHdr=Class.extern(function(){var a=null,b=null;this.init=function(d){a=d,b=this,c()};var c=function(){a.regEvent(EVT.LOGIN_OK,0,b,d),a.regEvent(EVT.NET,NETCMD.SELFFIELD,b,e)},d=function(){SelfFieldSender.sendGetAllSelfFields(a)},e=function(b){var c=b.data;c.selffields&&(TQ.dictCopy(a.getImgr().getSelfFields().list,c.selffields),a.sendEvent({eid:EVT.SELFFIELD_UPDATE,sid:0}))}}),SelfFieldDlg=Class.extern(function(){var a=null,b=null,c=null,d=null,e={};this.init=function(c){a=c,b=this,f()},this.openDlg=function(a){UIM.closeAllFieldDlg(),g(a),h(),j(),k()},this.closeDlg=function(){if(!d)return;d.hide()};var f=function(){a.regEvent(EVT.SELFFIELD_UPDATE,0,b,u),a.regEvent(EVT.PERSONAL_ARMY_UPDATE,0,b,u)},g=function(a){c=a},h=function(){if(d)return;d=Dialog.snew(a,{modal:!1,title:rstr.field.selffielddlg.title,pos:{x:"center",y:50}}),a.getGUI().initDlg(d,uicfg.field.selffielddlg,e),i()},i=function(){d.setCaller({self:b,caller:t}),e.callbackBtn.setCaller({self:b,caller:x}),e.dispatchBtn.setCaller({self:b,caller:y}),e.startOrStopBtn.setCaller({self:b,caller:z}),e.giveUpBtn.setCaller({self:b,caller:C})},j=function(){d.show()},k=function(){l(),m(),n(),o(),p(),q(),r(),s()},l=function(){SelfFieldSender.sendGetCanGetRes(a,c.gridId)},m=function(){a.regUpdater(b,v,1e3),a.regUpdater(b,w,3e4)},n=function(){var a=FieldUtil.getPosByGridId(c.gridId),b=FieldUtil.getFieldName(c),d=" ("+a.x+", "+a.y+")";TQ.setTextEx(e.fieldName,b+d)},o=function(){var a=SelfFieldUtil.getCurDispatchHero(c);if(!a){TQ.setTextEx(e.armyInfo,"");return}var b=TQ.format(rstr.field.selffielddlg.lbl.armyInfo,a.name,a.level,RStrUtil.getSoldierNameByResId(a.soldier.resid),a.soldier.number);TQ.setTextEx(e.armyInfo,b)},p=function(){var b=a.getImgr().getSelfFieldByGridId(c.gridId);if(!b||!b.startTime){TQ.setTextEx(e.collectedTime,"");return}var d=a.getSvrTimeS()-b.startTime;d=Math.clamp(d,0,res_max_collect_time),TQ.setTextEx(e.collectedTime,TQ.formatTime(0,d))},q=function(){var b=a.getImgr().getSelfFieldByGridId(c.gridId);if(!b||!b.canGetRes){TQ.setTextEx(e.canGetRes,"0");return}var d="",f=["food","wood","stone","iron"];for(var g=0;g<f.length;++g){var h=f[g];if(!b.canGetRes[h])continue;d!=""&&(d+=" "),d+=rstr.comm[h],d+=b.canGetRes[h]}TQ.setTextEx(e.canGetRes,d)},r=function(){var b="",d=a.getImgr().getSelfFieldByGridId(c.gridId);!d||!d.startTime?b=rstr.field.selffielddlg.btn.start:b=rstr.field.selffielddlg.btn.stop,e.startOrStopBtn.setText(b)},s=function(){e.callbackBtn.enable(SelfFieldUtil.hasArmyDispatched(c)?!0:!1)},t=function(c){c==C_SYS_DLG_HIDE&&(a.unregUpdater(b,v),a.unregUpdater(b,w))},u=function(){if(!D())return;o(),p(),q(),r(),s()},v=function(){p()},w=function(){SelfFieldSender.sendGetCanGetRes(a,c.gridId)},x=function(){var d=function(b){b==MB_IDYES&&SelfFieldSender.sendRecallArmy(a,c.gridId)};a.getGUI().msgBox(rstr.comm.msgts,rstr.military.opdlg.lbl.confirmCallBack,MB_F_YESNO,{self:b,caller:d})},y=function(){if(SelfFieldUtil.hasArmyDispatched(c)){a.getGUI().sysMsgTips(SMT_WARNING,rstr.ids[100057].msg);return}ExpedUtil.expedTo(c)},z=function(){var b=a.getImgr().getSelfFieldByGridId(c.gridId);!b||!b.startTime?A():B()},A=function(){if(!SelfFieldUtil.hasArmyDispatched(c)){a.getGUI().sysMsgTips(SMT_WARNING,rstr.ids[100058].msg);return}if(!SelfFieldUtil.hasSoldiersDispatched(c)){a.getGUI().sysMsgTips(SMT_WARNING,rstr.ids[100056].msg);return}SelfFieldSender.sendStartCollect(a,c.gridId)},B=function(){SelfFieldSender.sendStopCollect(a,c.gridId)},C=function(){var d=function(b){b==MB_IDYES&&SelfFieldSender.sendGiveUpField(a,c.gridId)};a.getGUI().msgBox(rstr.comm.msgts,rstr.field.selffielddlg.lbl.confirmGiveup,MB_F_YESNO,{self:b,caller:d})},D=function(){return d?d.isShow():!1}})