SelfRoleCityOpHdr=BaseFieldOpHdr.extern(function(){this.initBtnsText=function(){this.btnTexts=rstr.field.rolecitydlg.btn.selfCityBtns},this.initBtnsCaller=function(){this.callers=[null,null,null,null,this.onEnterCity,this.onEnterFarm]},this.setSomeBtnsHidden=function(){this.items.opbtn1.hidden(),this.items.opbtn2.hidden(),this.items.opbtn3.hidden(),this.items.opbtn4.hidden()},this.onEnterCity=function(){UIM.closeMapPanels(),UIM.getPanel("inbuild").open(),this.dlg.closeDlg()}}),SameAlliRoleCityOpHdr=BaseFieldOpHdr.extern(function(){this.initBtnsText=function(){this.btnTexts=rstr.field.rolecitydlg.btn.sameAlliCityBtns},this.initBtnsCaller=function(){this.callers=[this.onSendMail,this.onTalkTo,this.onDispatchArmy,this.onAddFavorite,this.onAddFriend,this.onEnterFarm]},this.onDispatchArmy=function(){ExpedUtil.expedTo(this.field),this.dlg.closeDlg()}}),OtherAlliRoleCityOpHdr=BaseFieldOpHdr.extern(function(){this.initBtnsText=function(){this.btnTexts=rstr.field.rolecitydlg.btn.otherAlliCityBtns},this.initBtnsCaller=function(){this.callers=[this.onSendMail,this.onTalkTo,this.onDeclareOrAttack,this.onAddFavorite,this.onAddFriend,this.onEnterFarm]},this.setSomeBtnsHidden=function(){this.g.getImgr().getFightRefState(this.field.roleId)==REF_ROLESTATE.DECLARING_FIGHT&&this.items.opbtn3.hidden()},this.update=function(){var a=rstr.field.rolecitydlg.btn.declareFight;this.g.getImgr().getFightRefState(this.field.roleId)==REF_ROLESTATE.FIGHTING&&(a=rstr.field.rolecitydlg.btn.fightTo),this.items.opbtn3.setText(a)},this.onDeclareOrAttack=function(){var a=this.g.getImgr().getFightRefState(this.field.roleId);a==REF_ROLESTATE.NORMAL?(MilitarySender.sendDeclareFight(this.g,this.field.roleId),OutFieldSender.sendRefreshFieldsByLastViewPos(this.g)):a==REF_ROLESTATE.FIGHTING&&(ExpedUtil.expedTo(this.field),this.dlg.closeDlg())}}),RoleCityDlg=Class.extern(function(){var a=6,b=null,c=null,d=null,e=null,f={},g=null,h=!1,i=null;this.init=function(a,d){b=a,c=this,h=d?!0:!1,j()},this.openDlg=function(a){d=a,h||UIM.closeAllFieldDlg(),k(),l(),m()},this.closeDlg=function(){if(!e)return;e.hide()};var j=function(){b.regEvent(EVT.LOGIN_OK,0,c,z),b.regEvent(EVT.NET,NETCMD.FIGHTREFSTATE,c,A),b.regEvent(EVT.OUTFIELD_DETAIL,0,c,q)},k=function(){if(e)return;e=Dialog.snew(b,{modal:h,title:"...",pos:{x:"center",y:50}}),b.getGUI().initDlg(e,uicfg.field.rolecitydlg,f),e.setCaller({self:c,caller:x}),i=RoleAchievement.snew(b,f.achievement)},l=function(){e.show()},m=function(){n(),p(),o(),q(),r(),s()},n=function(){b.regUpdater(c,y,1e3)},o=function(){var a=TQ.format(rstr.field.rolecitydlg.title,d.roleName);e.setTitle(a)},p=function(){b.getImgr().isSameRole(d.roleName)?g=SelfRoleCityOpHdr.snew(b,c,a,f,d):b.getImgr().isSameAlliance(d.alliance.uid)?g=SameAlliRoleCityOpHdr.snew(b,c,a,f,d):g=OtherAlliRoleCityOpHdr.snew(b,c,a,f,d)},q=function(){if(!t())return;g.update(),u(),v(),w(),s()},r=function(){if(d.isDetail)return;OutFieldSender.sendGetFieldDetail(b,d.gridId)},s=function(){if(!d.isDetail)return;i.setRole({cityMaxLevel:d.cityMaxLevel,actTower:d.actTower,actTerrace:d.actTerrace,vip:d.vip})},t=function(){return e?e.isShow():!1},u=function(){if(!d.isDetail){C();return}IMG.setBKImage(f.icon,IMG.makeBigImg(d.icon));var a=RStrUtil.makeXDiamondRoleName(d.roleName,d);TQ.setRichText(f.name,a);var b=ItemResUtil.findItemres(FieldUtil.getCityResIdByGridId(d.gridId));IMG.setBKImage(f.stateCityFlag,IMG.makeStateCityFlag(b.flagimg)),TQ.setTextEx(f.roleLevel,d.level);var c=FieldUtil.getPosByGridId(d.gridId),e="#[m:"+c.x+":"+c.y+"]";TQ.setTextEx(f.cood,HyperLinkMgr.formatLink(e))},v=function(){if(!d.isDetail){D();return}var a=b.getImgr().getFightRefState(d.roleId),c=rstr.field.rolecitydlg.lbl.refstate[a];if(a!=REF_ROLESTATE.NORMAL){var e=b.getImgr().getFightRefStateStopTime(d.roleId),g=Math.max(0,e-b.getSvrTimeS());c+=TQ.formatTime(0,g)}TQ.setTextEx(f.fightState,TQ.formatColorStr(c,B(a)))},w=function(){if(!d.isDetail){E();return}TQ.setTextEx(f.alliance,d.alliance.name),TQ.setTextEx(f.cityLevel,RStrUtil.getCityNameByLevel(d.buildval.level)),TQ.setTextEx(f.buildVal,d.buildval.cur),TQ.setTextEx(f.sort,d.rank),TQ.setRichText(f.introduction,TQ.decodeMessage(d.introduction))},x=function(a){a==C_SYS_DLG_HIDE&&b.unregUpdater(c,y)},y=function(){v()},z=function(){FightResStateSender.sendGetRefStates(b)},A=function(a){a.data.states&&TQ.dictCopy(b.getImgr().getFightRefStates(),a.data.states)},B=function(a){var b={};return b[REF_ROLESTATE.NORMAL]=COLORS.ROLESTATE_NORMAL,b[REF_ROLESTATE.DECLARING_FIGHT]=COLORS.ROLESTATE_DECLARING_FIGHT,b[REF_ROLESTATE.FIGHTING]=COLORS.ROLESTATE_FIGHTING,b[a]},C=function(){IMG.setBKImage(f.icon,""),TQ.setTextEx(f.name,""),IMG.setBKImage(f.stateCityFlag,""),TQ.setTextEx(f.roleLevel,""),TQ.setTextEx(f.cood,"")},D=function(){TQ.setTextEx(f.fightState,"")},E=function(){TQ.setTextEx(f.alliance,""),TQ.setTextEx(f.cityLevel,""),TQ.setTextEx(f.buildVal,""),TQ.setTextEx(f.sort,""),TQ.setTextEx(f.introduction,"")}})