WS=function(){var a=null,b=null,c=null,d=null,e=null,f="0",g=null,h=new XXTea,i=4,j={pos:0,pkgLen:0,buf:new ArrayBuffer(65536),binary:!1,gzip:!1,encrypt:!1};this.init=function(e,f,g){a=this,b=e,c=f,d=g},this.setGameObj=function(a){e=a},this.connect=function(){g=new WebSocket("ws://"+b+":"+c),g.onopen=function(b){a._onOpen(b)},g.onclose=function(b){a._onClose(b)},g.onmessage=function(b){a._onMessage(b.data)},g.onerror=function(b){a._onError(b)}},this.send=function(a){try{g.send(a),log(">>[c->s]"+a)}catch(b){}},this.close=function(){g.close()},this._onOpen=function(a){if(e==null)return;g.binaryType="arraybuffer",log("websocket opened!")},this._onMessage=function(a){if(e==null)return;if(a==null)return;if(f=="0"){if(typeof a!="string"||a!="1"&&a!="2"){e.onClose();return}f=a,e.onConnect(!0);return}f=="1"?this._onDataVer1(a):f=="2"&&this._onDataVer2(a)},this._onDataVer1=function(a){if(typeof a!="string")return;var b=a,c=a.length;this._onCommData(b,c,function(a,b){return a.charCodeAt(b)})},this._onDataVer2=function(a){if(!(a instanceof ArrayBuffer))return;var b=new Uint8Array(a),c=b.byteLength;this._onCommData(b,c,function(a,b){return a[b]})},this._onCommData=function(b,c,d){var e=0;while(e<c)if(j.pkgLen==0){var f=Math.min(i-j.pos,c-e),g=j.pos+f,k=new DataView(j.buf,j.pos,f);for(;j.pos<g;++j.pos)k.setUint8(j.pos,d(b,e++));if(j.pos==i){var l=ntohl(k.getUint32(0,!0));j.gzip=(l&134217728)!=0,j.binary=(l&67108864)!=0,j.encrypt=(l&33554432)!=0,j.pkgLen=l&16777215,j.pos=0}}else if(j.pos<j.pkgLen){var f=Math.min(j.pkgLen-j.pos,c-e),g=j.pos+f,m=new Uint8Array(j.buf,j.pos,f);for(;j.pos<g;++j.pos)m[j.pos]=d(b,e++);var n=Math.floor((g+3)/4)*4,m=new Uint8Array(j.buf,0,n);for(var o=g;o<n;++o)m[o]=0;if(j.pos==j.pkgLen){var p="",q=[],m=new Uint32Array(j.buf,0,Math.floor((j.pkgLen+3)/4));for(var o=0;o<m.length;++o)q.push(m[o]);try{j.encrypt?p=h.decrypt_ex(q):p=h.long2str(q)}catch(r){}j.pos=0,j.pkgLen=0,a._onData(p)}}},this._onData=function(a){e!=null&&e.onData(a)},this._onClose=function(a){log("websocket close !"),e!=null&&e.onClose()},this._onError=function(a){log("websocket error !"),e!=null&&e.onClose()},this.send=function(a){try{var b=h.encrypt(a);if(f=="1"){var c=h.long2str([htonl(b.length)]);g.send(":"+c+b)}else if(f=="2"){var d=new ArrayBuffer(b.length),e=new Uint8Array(d);for(var i=0;i<b.length;++i)e[i]=b.charCodeAt(i);var c=new Uint8Array(htonl_array(b.length));g.send(c),g.send(e)}log(">>[c->s]"+a)}catch(j){alert(j.description)}},this.close=function(){g.close()},this.setKey=function(a){h.setKey(a)},this.setMaxPackLen=function(a){log("set max len : "+a)},this.init.apply(this,arguments)}