SelectExpedTargetDlg=Class.extern(function(){var a=0,b=1,c=0,d=1,e=null,f=null,g=null,h={},i=null,j=null,k=null,l=null,m=[];this.init=function(a){e=a,f=this,$(),e.regEvent(EVT.FAVORITE_UPDATE,0,f,T),e.regEvent(EVT.ENEMY_UPDATE,0,f,U),e.regEvent(EVT.NET,NETCMD.MILITARY,f,S)},this.openDlg=function(a,b){n(a,b),o(),p(),z(),A(),HelpGuider.getNewcomerSpirit().onDlgOpen("selectexpedtarget",{parent:g.getParent(),items:h})},this.hideDlg=function(){g&&g.hide()},this.getCtrl=function(a){return h[a]},this.isShow=function(){return g?g.isShow():!1},this.click=function(){H()},this.setCaller=function(a){i=a};var n=function(a,b){k=a,l=b},o=function(){if(g)return;g=Dialog.snew(e,{modal:!0,title:rstr.selectexpedtarget.title,pos:{x:"center",y:30}}),e.getGUI().initDlg(g,uicfg.expedition.selecttarget,h),q(),r(),s(),t()},p=function(){g.show()},q=function(){for(var a=0;a<rstr.selectexpedtarget.tabs.length;++a)h.tablist.setTabText(a,rstr.selectexpedtarget.tabs[a])},r=function(){var b=h.tablist.getTabItems(a);b.typelist.setItemCount(j.length);for(var c=0,d=b.typelist.getCount();c<d;++c){var e=j[c],f=b.typelist.getItem(c);TQ.setText(f.exsubs.name,e.typename)}},s=function(){var a=h.tablist.getTabItems(b);a.typelist.setItemCount(rstr.selectexpedtarget.lbl.emenytypes.length);for(var c=0,d=a.typelist.getCount();c<d;++c){var e=rstr.selectexpedtarget.lbl.emenytypes[c],f=a.typelist.getItem(c);TQ.setText(f.exsubs.name,e)}},t=function(){g.setCaller({self:f,caller:B}),u(),v(),w(),x(),y()},u=function(){h.tablist.setCaller({self:f,caller:C})},v=function(){var b=h.tablist.getTabItems(a);b.typelist.setCaller({self:f,caller:D})},w=function(){var a=h.tablist.getTabItems(b);a.typelist.setCaller({self:f,caller:E})},x=function(){var c=h.tablist.getTabItems(a);c.targetlist.setCaller({self:f,caller:F}),c=h.tablist.getTabItems(b),c.targetlist.setCaller({self:f,caller:F})},y=function(){h.deleteBtn.setCaller({self:f,caller:G}),h.confirmBtn.setCaller({self:f,caller:H}),h.cancelBtn.setCaller({self:f,caller:I})},z=function(){MilitarySender.sendGetFavorites(e)},A=function(){h.tablist.activeTab(l.tabIdx),h.tablist.getTabItems(l.tabIdx).typelist.setCurSel(l.typeListIdx)},B=function(a){a==C_SYS_DLG_HIDE&&(e.unregUpdater(f,_onUpdate),HelpGuider.getNewcomerSpirit().onDlgClose("selectexpedtarget"))},C=function(a){var b=h.tablist.getTabItems(a),c=b.typelist.getCurSel();b.typelist.setCurSel(c>=0?c:0),_()},D=function(b,c){var d=h.tablist.getTabItems(a),e=j[c].targetlist;d.targetlist.setItemCount(e.length);for(var f=0;f<e.length;++f){var i=e[f],k=d.targetlist.getItem(f);TQ.setText(k.exsubs.name,i.name),TQ.setText(k.exsubs.level,i.level),TQ.setText(k.exsubs.taofa,Z("taofa",i.id)?rstr.selectexpedtarget.lbl.fightsucc:rstr.selectexpedtarget.lbl.fightnosucc),TQ.setText(k.exsubs.needtime,TQ.formatTime(0,i.needtime))}d.targetlist.setCurSel(-1),HelpGuider.getNewcomerSpirit().onDlgOpen("selectexpedtarget",{parent:g.getParent(),items:h})},E=function(a,e){e==c?R():e==d?V():alert("error: 398e84");var f=h.tablist.getTabItems(b);f.targetlist.setCurSel(-1),_()},F=function(a,b){_(),HelpGuider.getNewcomerSpirit().onDlgOpen("selectexpedtarget",{parent:g.getParent(),items:h})},G=function(a){var b=K();if(!b)return;MilitarySender.sendDelFavoriteTarget(e,b.gridId)},H=function(){if(!k.isSatisfiedBy(K())){e.getGUI().sysMsgTips(SMT_WARNING,k.getInvalidTip());return}i&&i.caller.call(i.self,K()),g.hide()},I=function(){g.hide()},J=function(){return ExpedUtil.makeExpedTarget(K())},K=function(){var e=L(),f=M(),g=N();return e==a?O(f,g):e==b&&f==c?P(g):e==b&&f==d?Q(g):null},L=function(){return h.tablist.getActiveTab()},M=function(){var a=h.tablist.getTabItems(L());return a.typelist.getCurSel()},N=function(){var a=h.tablist.getTabItems(L());return a.targetlist.getCurSel()},O=function(a,b){if(!j[a])return null;var c=j[a].targetlist[b];return c?(c.objType=OBJ_TYPE.COPYFIELD,c):null},P=function(a){var b=e.getImgr().getTargetsFavorite();return b[a]},Q=function(a){var b=m[a];return!b||b.objType!=OBJ_TYPE.ROLE?null:b},R=function(){var a=e.getImgr().getTargetsFavorite(),c=h.tablist.getTabItems(b);c.targetlist.setItemCount(a.length);for(var d=0,f=c.targetlist.getCount();d<f;++d){var g=a[d],i=c.targetlist.getItem(d);X(i,g)}},S=function(a){a.data.succcopyfields&&TQ.dictCopy(e.getImgr().getSuccCopyFields(),a.data.succcopyfields)},T=function(){if(!f.isShow())return;R();var a=h.tablist.getTabItems(b);a.targetlist.setCurSel(-1)},U=function(){if(!f.isShow())return;V();var a=h.tablist.getTabItems(b);a.targetlist.setCurSel(-1)},V=function(){m=W(e.getImgr().getEnemys(),10);var a=h.tablist.getTabItems(b);a.targetlist.setItemCount(m.length);for(var c=0,d=a.targetlist.getCount();c<d;++c){var f=m[c],g=a.targetlist.getItem(c);X(g,f)}},W=function(a,b){var c=[];if(a.length<b)return a;var d=a.length-b;for(var e=d;e<d+b;++e)c.push(a[e]);return c},X=function(a,b){var c=b.roleName!=""?b.roleName:"--",d=FieldUtil.getPosByGridId(b.gridId);TQ.setText(a.exsubs.name,c),TQ.setText(a.exsubs.fieldType,FieldUtil.getFieldName(b));var f="#[m:"+d.x+":"+d.y+"]";TQ.setRichText(a.exsubs.cood,HyperLinkMgr.formatLink(f));var g=rstr.selectexpedtarget.lbl.refstate[e.getImgr().getFightRefState(b.roleId)],h=ExpedTargetUtil.getMoveNeedTime(e,d,res_army_movespeed,0);Y(d)||(h=res_countryfight_needtime,g+=rstr.selectexpedtarget.lbl.countryFight),TQ.setText(a.exsubs.refstate,g),TQ.setText(a.exsubs.needtime,TQ.formatTime(0,h))},Y=function(a){var b=e.getImgr().getRoleRes().pos;return FieldUtil.getCityResIdByPos(a)==FieldUtil.getCityResIdByPos(b)},Z=function(a,b){var c=e.getImgr().getSuccCopyFields();return TQ.find(c[a],null,b)!=null},$=function(){j=[];for(var a=0;a<res_copyfields.length;++a){var b=res_copyfields[a];if(b.id>=FIXID.ACT_TOWER_STARTID)break;var c=TQ.find(j,"typename",b.typename);c||(j.push({typename:b.typename,targetlist:[]}),c=j[j.length-1]),c.targetlist.push(b)}},_=function(){if(L()!=b){h.deleteBtn.enable(!1);return}if(M()!=c){h.deleteBtn.enable(!1);return}if(N()<0){h.deleteBtn.enable(!1);return}h.deleteBtn.enable(!0)}})