DragMapChecker=Class.extern(function(){var a=!1;this.isDragging=function(){return a},this.startDrag=function(){a=!0},this.endDrag=function(){a=!1}}).snew(),GameMap=Class.extern(function(){var a=null,b=null,c=null,d=0,e={id:0,name:"no",desc:"no",mapsize:{cx:2048,cy:1536},img:"000001.jpg",buildtips:[]},f={cx:32,cy:32},g={cx:30*f.cx,cy:30*f.cy},h={x1:0,y1:0,x2:1,y2:1},i={x:0,y:0,w:2048,h:1536},j={x:0,y:0},k={x:0,y:0,w:0,h:0},l=null,m=[],n=[],o=null;this.init=function(d,e){a=this,b=d,c=e,o=MapObjsContainer.snew(b,c),p()},this.getMapId=function(){return d},this.loadMap=function(a){A(a)},this.setMapPixelRect=function(a,b,c,d){h.x1=a,h.y1=b,h.x2=c,h.y2=d},this.getMapPixelRect=function(){return{x:h.x1,y:h.y1,w:h.x2-h.x1,h:h.y2-h.y1}},this.setCaller=function(a){l=a},this.getBlocksize=function(){return f},this.getMapPixelSize=function(){return g},this.getViewport=function(){return i},this.setViewportPos=function(b){B(b),l&&l.caller.call(l.self,a.getViewport())},this.setViewportSize=function(a){i.w=a.cx,i.h=a.cy},this.getMapRes=function(){return e},this.isRoutePassed=function(a,b,c,d){return _isRoutePassed(a,b,c,d)},this.getMouseDownPos=function(){return j};var p=function(){q()},q=function(){TQ.addEvent(c,"dragstart",function(a){return!1}),TQ.addEvent(c,"selectstart",function(a){return!1}),TQ.captureMouseEvent(c,{self:a,mouseDown:u,mouseMove:v,mouseUp:w}),TQ.captureTouchEvent(c,{self:a,touchStart:r,touchMove:s,touchEnd:t,touchCancel:t})},r=function(a,b){x({x:b.pageX,y:b.pageY})},s=function(a,b){y({x:b.pageX,y:b.pageY})},t=function(a,b){z({x:b.pageX,y:b.pageY})},u=function(a){x(TQ.mouseCoords(a))},v=function(a){y(TQ.mouseCoords(a))},w=function(a){z(TQ.mouseCoords(a))},x=function(b){j=b;var c=a.getViewport();k.x=c.x,k.y=c.y,DragMapChecker.startDrag()},y=function(b){var c=b.x-j.x,d=b.y-j.y;if(Math.abs(c)>2||Math.abs(d)>2){var e=k.x-c,f=k.y-d;B({x:e,y:f}),l&&l.caller.call(l.self,a.getViewport())}},z=function(a){DragMapChecker.endDrag()},A=function(a){if(a==d)return;d=a,e=ItemResUtil.findItemres(d),IMG.setBKImage(c,IMG.makeImg("map/"+e.img)),TQ.setDomSize(c,e.mapsize.cx,e.mapsize.cy),c.style.backgroundPosition="0px 0px",g.cx=e.mapsize.cx,g.cy=e.mapsize.cy,h.x1=0,h.y1=0,h.x2=e.mapsize.cx,h.y2=e.mapsize.cy,o.load(d)},B=function(a){i.x=Math.floor(a.x),i.y=Math.floor(a.y),i.x<h.x1?i.x=h.x1:i.x+i.w>h.x2&&(i.x=h.x2-i.w),i.y<h.y1?i.y=h.y1:i.y+i.h>h.y2&&(i.y=h.y2-i.h),TQ.setDomPos(c,-i.x,-i.y)}}),MapObjsContainer=Class.extern(function(){var a=null,b=null,c=0,d=[],e=[],f=[];this.init=function(c,d){a=c,b=d},this.load=function(a){g(a),h(),k()};var g=function(a){c=a},h=function(){i(),j()},i=function(){for(var a=0;a<d.length;++a){var b=d[a];TQ.setCSS(b,"display","none"),e.push(b)}d=[]},j=function(){for(var a=0;a<f.length;++a)f[a].stop();f=[]},k=function(){var a=TQ.find(res_mapobjs,"id",c);if(!a)return;for(var b=0;b<a.objs.length;++b){var d=a.objs[b];d.type=="gif"?l(d):d.type=="anim"&&m(d)}},l=function(a){var b=n();IMG.setBKImage(b,IMG.makeImg(a.path)),TQ.setDomRect(b,a.pos.x,a.pos.y,a.size.cx,a.size.cy)},m=function(b){var c=a.getAnimMgr().alloc(b.animId);c.setPosition(b.pos),c.play(),f.push(c)},n=function(){if(e.length==0){var a=TQ.createDom("div");TQ.setClass(a,"map_fixobject"),TQ.append(b,a),e.push(a)}var a=e[e.length-1];return e.length-=1,TQ.setCSS(a,"display","block"),d.push(a),a}})