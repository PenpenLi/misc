ActTowerForceTabHdr=ExpedForceTabHdr.extern(function(){this.isNeedSingleHero=function(){return!1}}),HerosUtil=JClass.ex({getHerosFightCap:function(a,b){var c=0;for(var d=0;d<b.length;++d){var e=b[d],f=a.getImgr().getHero(e);if(!f)continue;c+=a.getImgr().getHeroAttrVal(f,ATTR.FC)}return c}}).snew(),ExpedHerosChecker=Class.extern(function(){var a=null;this.g_=null,this.isValid=function(f,h,i){a=this,this.g_=f;if(e(h))return this.g_.getGUI().sysMsgTips(SMT_WARNING,rstr.expeddlg.err.noAssignHeros),!1;if(b(h))return this.g_.getGUI().sysMsgTips(SMT_WARNING,rstr.expeddlg.err.noHealth),!1;if(!g(i)&&c(h))return this.g_.getGUI().sysMsgTips(SMT_WARNING,rstr.expeddlg.err.noCarrySoldiers),!1;var j=d(i,h);return j!=""?(this.g_.getGUI().sysMsgTips(SMT_WARNING,TQ.format(rstr.expeddlg.err.hasBusyHero,j)),!1):!0};var b=function(b){var c=a.g_.getImgr();for(var d=0;d<b.length;++d){var e=b[d],f=c.getHero(e);if(!f)continue;var g=c.getHeroAttrVal(f,ATTR.HEALTH);if(res_gethealthtype(g)==HEALTH_TYPE.DEEP_WOUND)return!0}return!1},c=function(b){for(var c=0;c<b.length;++c){var d=b[c],e=a.g_.getImgr().getHero(d);if(!e)continue;if(!e.soldier)return!0;if(e.soldier.number==0)return!0}return!1},d=function(b,c){var d="";for(var e=0;e<c.length;++e){var g=c[e],h=a.g_.getImgr().getHero(g);if(!h)continue;if(f(h,b))continue;d+=" "+h.name}return d!=""&&(d+=" "),d},e=function(b){var c=0;for(var d=0;d<b.length;++d){var e=b[d],f=a.g_.getImgr().getHero(e);if(!f)continue;c++}return c==0},f=function(a,b){return a.state==HERO_STATE.FREE?!0:a.state==HERO_STATE.ACT_TERRACE&&b==EXPED_TYPE.ACT_TERRACE?!0:a.state==HERO_STATE.ACT_TOWER&&b==EXPED_TYPE.ACT_TOWER?!0:a.state==HERO_STATE.ACT_TOWER&&b==EXPED_TYPE.ACT_TOWER?!0:a.state==HERO_STATE.ACT_WORLDBOSS&&b==EXPED_TYPE.ACT_WORLDBOSS?!0:!1},g=function(a){return a==EXPED_TYPE.DANTIAO||a==EXPED_TYPE.TIAOXIN||a==EXPED_TYPE.ACT_TERRACE}}).snew(),ActTowerExpedDlg=BaseDlg.extern(function(){var a=30,b=10,c=100,d=null,e=[];this.enterTower_={stopTime:0},this.forceTabHdr_=null,this.isAutoFight_=!1,this.autoToLayer_=0,this.running_=!1,this.lastLifes_=0,this.checkAutoFightTimes_=0,this.reset=function(){e=[],this.running_=!1,this._stopAutoFight()},this.isRunning=function(){return this.running_},this.forceShow=function(){this.dlg_&&(this.dlg_.show(),this._initUpdate())},this._init=function(){d=this,this.g_.regEvent(EVT.LOGIN_OK,0,this,this._onLoginOk),this.g_.regEvent(EVT.NET,NETCMD.ACT_TOWER,this,this._onSvrPkg),this.g_.regEvent(EVT.ROLESPECSTATE_CHANGE,0,this,A),this.g_.regEvent(EVT.HERO_UPDATE,0,this,this._onHeroUpdate),this.g_.regEvent(EVT.SAVE_FORCES,0,this,this._onCheckAutoFight)},this._getDlgCfg=function(){return{modal:!1,title:rstr.activity.tower.expeddlg.title,pos:{x:"center",y:40},uicfg:uicfg.activity.tower.expeddlg}},this._setCallers=function(){this.dlg_.setCaller({self:this,caller:this._onDlgEvent}),this.items_.showGetGiftsBtn.setCaller({self:this,caller:this._onClickShowGetGiftsBtn}),this.items_.addRecoveryRateBtn.setCaller({self:this,caller:this._onClickAddRecoveryRateBtn}),this.items_.vsBtn.setCaller({self:this,caller:this._onClickVSBtn}),this.items_.autoFightBtn.setCaller({self:this,caller:this._onClickAutoFightBtn}),this.items_.changeForceBtn.setCaller({self:this,caller:this._onClickChangeForceBtn}),this.items_.assignSoldierBtn.setCaller({self:this,caller:this._onClickAssignSoldierBtn}),this.items_.treatmentBtn.setCaller({self:this,caller:this._onClickTreatmentBtn}),this.items_.exitBtn.setCaller({self:this,caller:this._onClickExitBtn}),TTIP.setCallerData(this.items_.tooltips.$autoFight,{self:this,caller:this._onGetAutoFightBtnTip},{})},this._afterCreate=function(){f(),this.forceTabHdr_=ActTowerForceTabHdr.snew(this.g_,this.items_)};var f=function(){var a=d.items_.layerGiftsList;a.setItemCount(10);for(var b=0;b<a.getCount();++b){var c=a.getItem(b),e=(b+1)*10-1,f=FIXID.ACT_TOWER_STARTID+e,g=ItemResUtil.findItemres(f);IMG.setBKImage(c.exsubs.icon,g.itemicon?IMG.makeBigImg(g.itemicon):""),TTIP.setCallerData(c.exsubs.tooltips.$item,{self:d,caller:d._onGettLayerGiftTip},{idx:b})}};this._showDlg=function(){this.isAutoFight_||this.dlg_.show()},this._initInfo=function(){this.enterTower_=this.params_,this._initUpdate(),this.lastLifes_=this.enterTower_.leftLifes},this._initUpdate=function(){g(),h(),i(),j(),k(),m(),n(),r(),s(),t(),u(),this.g_.regUpdater(this,this._onUpdate,1e3);var a=this.g_.getImgr().getSaveForceByType(FORCELINE_TYPE.ACTTOWER);this._updateForceTab(a.lineup,a.heros)};var g=function(){d.dlg_.setTitle(TQ.format(rstr.activity.tower.maindlg.dtitle,z()))},h=function(){if(!d.isAutoFight_)return;d.enterTower_.curLayer>d.autoToLayer_&&d._stopAutoFight()},i=function(){if(!d.isAutoFight_)return;d.enterTower_.leftLifes<d.lastLifes_&&d._stopAutoFight()},j=function(){var a=23,b=62,c=18,e=Math.floor(d.enterTower_.curLayer/10);e=Math.min(e,9);var f=a+e*b+(b-c)/2;TQ.setCSS(d.items_.curLayerArrow,"left",f+"px")},k=function(){if(!d.enterTower_.lastLayerInfo){TQ.setCSS(d.items_.lastLayerInfo,"display","none");return}TQ.setCSS(d.items_.lastLayerInfo,"display","block");var a=d.enterTower_.lastLayerInfo,b=rstr.activity.tower.expeddlg.fightResults[a.fightResult],c=l(a.gift.items),e=TQ.format(rstr.activity.tower.expeddlg.tip.lastLayerInfo,a.layer,b,a.gift.heroExp,c);TQ.setTextEx(d.items_.lastLayerInfo,e)},l=function(a){if(!a.length)return rstr.activity.tower.expeddlg.noItem;var b="";for(var c=0;c<a.length;++c){var d=a[c];b+=RStrUtil.getItemColorNameByResId(d.id)+rstr.comm.numPrefix+d.number}return b},m=function(){if(q()==0){TQ.setTextEx(d.items_.leftTime,"");return}var a=TQ.formatTime(0,q());TQ.setTextEx(d.items_.leftTime,TQ.format(rstr.activity.tower.expeddlg.leftTime,a))},n=function(){d.items_.vsBtn.enable(q()==0&&!d.isAutoFight_),d.isAutoFight_?d.items_.autoFightBtn.enable(!0):d.items_.autoFightBtn.enable(q()==0&&o())},o=function(){var a=d.g_.getImgr().getActTower().baseInfo.maxLayer;return d.enterTower_.curLayer>b||a>=b},p=function(a){a.stopTime&&d.g_.getSvrTimeS()>=a.stopTime&&(a.stopTime=d.g_.getSvrTimeS()+1)},q=function(){var a=d.enterTower_.stopTime?d.enterTower_.stopTime:0,b=a-d.g_.getSvrTimeS();return b<0&&(b=0),b},r=function(){d.items_.autoFightBtn.setText(d.isAutoFight_?rstr.activity.tower.expeddlg.btn.cancelAutoFight:rstr.activity.tower.expeddlg.btn.autoFight)},s=function(){TQ.setDomWidth(d.items_.leftLifes,d.enterTower_.leftLifes*a)},t=function(){if(!d.isShow())return;var a=rstr.activity.tower.maindlg.lbl.noUseRecoverItem;d.g_.getImgr().hasRoleState(RES_EFF.TOWER_RECOVER_SOLDIER)&&(a=rstr.activity.tower.maindlg.lbl.useRecoverItem),TQ.setTextEx(d.items_.usedItemTip,a)},u=function(){v(),w(),x()},v=function(){var a=y();TQ.setTextEx(d.items_.enemyLineupName,a.lineupRes.name)},w=function(){var a=y(),b=0;for(var c=0;c<a.copyField.heros.length;++c){var e=ItemResUtil.findItemres(a.copyField.heros[c]);b+=e.fightcap}TQ.setTextEx(d.items_.enemyFightCap,b)},x=function(){var a=y();for(var b=0,c=0;b<d.items_.enemyForceTabList.getCount();++b){var e=d.items_.enemyForceTabList.getItem(b);if(b!=a.lineupRes.grids[c]){TQ.setTextEx(e.exsubs.name,"");continue}var f=ItemResUtil.findItemres(a.copyField.heros[c++]);TQ.setTextEx(e.exsubs.name,rstr.comm.heroprofs[f.prof])}},y=function(){var a=z(),b=FIXID.ACT_TOWER_STARTID+a-1,c=ItemResUtil.findItemres(b),d=ItemResUtil.findItemres(c.lineup);return{copyField:c,lineupRes:d}},z=function(){return Math.min(d.enterTower_.curLayer,c)},A=function(){t()};this._onLoginOk=function(){ActTowerSender.sendCheckAutoFight(this.g_)},this._onSvrPkg=function(a){if(a.data.autoFight){this.autoToLayer_=a.data.autoToLayer,this._onCheckAutoFight();return}this._isNeedShowFightDemo(a.data.enterTower)?this._showFightDemo(a.data.enterTower):B(a.data.enterTower)},this._onCheckAutoFight=function(){this.checkAutoFightTimes_++;if(this.checkAutoFightTimes_<2)return;this.isAutoFight_=!0,ActTowerSender.sendGetBaseInfo(this.g_)},this._isNeedShowFightDemo=function(a){return!this.isAutoFight_&&a&&a.fightDemo},this._showFightDemo=function(a){this.hideDlg();var b=UIM.getDlg("fightmap");b.setHideCaller({self:this,caller:function(){B(a),b.setHideCaller(null)}}),b.openDlg(a.fightDemo.armyId,a.fightDemo.fightId)};var B=function(a){if(!a)return;p(a),a.isExit?d.running_=!1:d.running_=!0,d.enterTower_=a;if(a.leftLifes==0){UIM.getPanel("sysmsg").append(CHAT_TAG.SYS,rstr.activity.tower.expeddlg.tip.noLifeSysTip),d._stopAutoFight();return}if(d._isPassLayer(a.curLayer)){UIM.getPanel("sysmsg").append(CHAT_TAG.SYS,rstr.activity.tower.expeddlg.tip.passLayerSysTip),d._stopAutoFight();return}C(a.lastLayerInfo),d.openDlg(a)};this._isPassLayer=function(a){return a>c};var C=function(a){if(!a)return;for(var b=0;b<a.gift.items.length;++b)e.push(a.gift.items[b])};this._onUpdate=function(){m(),n(),this._checkStopFight(),this._onAutoFight()},this._checkStopFight=function(){this.isShow()&&!this._hasLeftLifes()&&this._isArriveStopTime()?this._popCloseMsgBox(rstr.activity.tower.expeddlg.tip.noLifeMsgTip):this.isShow()&&this._isPassLayer(this.enterTower_.curLayer)&&this._isArriveStopTime()&&this._popCloseMsgBox(rstr.activity.tower.expeddlg.tip.passLayerMsgTip)},this._popCloseMsgBox=function(a){this.g_.getGUI().msgBox(rstr.comm.msgts,a,MB_F_CLOSE,{self:this,caller:function(){d._stopAutoFight(),d.running_=!1,d.hideDlg()}})},this._onAutoFight=function(){if(!d.isAutoFight_)return;if(d.enterTower_.leftLifes==0)return;if(q()>0)return;var a=FillSoldiersHdr.snew(this.g_,null,SoldierSender);a.setHeros(this.forceTabHdr_.getFreeHeros()),a.fillAll(),this._onClickTreatmentBtn(),this._onClickVSBtn()||this._stopAutoFight()},this._hasLeftLifes=function(){return this.enterTower_.leftLifes>0},this._isArriveStopTime=function(){return this.g_.getSvrTimeS()>=this.enterTower_.stopTime},this._onGetAutoFightBtnTip=function(){return o()?"":rstr.activity.tower.expeddlg.tip.autoFightBtnTip},this._onGettLayerGiftTip=function(a){var b=(a.idx+1)*10,c=FIXID.ACT_TOWER_STARTID+b-1,d=ItemResUtil.findItemres(c);return!d.itemicontip||d.itemicontip==""?"":TQ.format(rstr.activity.tower.expeddlg.tip.layerDropTip,b)+d.itemicontip},this._onDlgEvent=function(a){a==C_SYS_DLG_HIDE&&!this.running_&&this.g_.unregUpdater(this,this._onUpdate)},this._onClickShowGetGiftsBtn=function(){UIM.getDlg("acttowerlastgetgifts").openDlg(e)},this._onClickAddRecoveryRateBtn=function(){if(d.g_.getImgr().hasRoleState(RES_EFF.TOWER_RECOVER_SOLDIER)){this.g_.getGUI().sysMsgTips(SMT_WARNING,rstr.activity.tower.maindlg.tip.itemused);return}UIM.openDlg("uselistitem",[RES_EFF.TOWER_RECOVER_SOLDIER],{id:0,name:"",type:RES_TRG.SELF_ROLE})},this._onClickChangeForceBtn=function(){var a=UIM.getDlg("assignheros");a.setCaller({self:this,caller:this._updateForceTabAndSendSave}),a.openDlg()},this._updateForceTabAndSendSave=function(a,b){this._updateForceTab(a,b),MilitarySender.sendSaveForceLineUp(this.g_,FORCELINE_TYPE.ACTTOWER,a,b),TQ.dictCopy(this.g_.getImgr().getSaveForces(),[{_k:"type"},{type:FORCELINE_TYPE.ACTTOWER,lineup:a,heros:b}])},this._updateForceTab=function(a,b){this.forceTabHdr_.setLineup(a,b),this.forceTabHdr_.refresh(),TQ.setTextEx(this.items_.myFightCap,D(b))},this._onClickAssignSoldierBtn=function(){UIM.openDlg("assignsoldiers")},this._onClickTreatmentBtn=function(){TreatmentHeroHdr.treatmentHeros(this.g_,this.forceTabHdr_.getHeroIds())},this._onClickExitBtn=function(){this.g_.getGUI().msgBox(rstr.comm.msgts,rstr.activity.tower.expeddlg.tip.confirmExit,MB_F_YESNO,{self:this,caller:function(a){a==MB_IDYES&&(ActTowerSender.sendLeaveTower(d.g_),d.dlg_.hide())}})},this._onClickVSBtn=function(){var a=this.forceTabHdr_.getCanExpedHeros();return ExpedHerosChecker.isValid(this.g_,a,EXPED_TYPE.ACT_TOWER)?(E(),!0):!1},this._onClickAutoFightBtn=function(){if(!this.isAutoFight_){var a=UIM.getDlg("inputnum");a.openDlg(rstr.activity.tower.expeddlg.tip.inputAutoFightMaxLayer,c),a.setCaller({self:this,caller:this._onSetAutoFightMaxLayer})}else this._stopAutoFight()},this._onSetAutoFightMaxLayer=function(a){if(a<this.enterTower_.curLayer){this.g_.getGUI().sysMsgTips(SMT_WARNING,rstr.activity.tower.expeddlg.tip.autoFightLessLayer);return}this.autoToLayer_=a,this._startAutoFight()},this._onHeroUpdate=function(){if(!this.isShow())return;this.forceTabHdr_.refresh();var a=this.forceTabHdr_.getHeroIds();TQ.setTextEx(this.items_.myFightCap,D(a))};var D=function(a){var b=0;for(var c=0;c<a.length;++c){var e=a[c],f=d.g_.getImgr().getHero(e);if(!f)continue;b+=d.g_.getImgr().getHeroAttrVal(f,ATTR.FC)}return b},E=function(){var a=y().copyField;a.objType=OBJ_TYPE.COPYFIELD,a.type=OBJ_TYPE.COPYFIELD;var b=EXPED_TYPE.ACT_TOWER,c=d.forceTabHdr_.getExpedHerosInLineup(),e=d.forceTabHdr_.getLineup();ActTowerSender.sendExped(d.g_,a,b,e,c),d.isAutoFight_||d.dlg_.hide()};this._startAutoFight=function(){this.isAutoFight_=!0,n(),r(),ActTowerSender.sendStartAutoFight(this.g_,this.forceTabHdr_.getExpedHerosInLineup(),this.autoToLayer_)},this._stopAutoFight=function(){d.isAutoFight_=!1,this.isShow()&&(n(),r()),ActTowerSender.sendStopAutoFight(this.g_)}}),ActTowerLastGetGiftsDlg=BaseDlg.extern(function(){this._getDlgCfg=function(){return{modal:!0,title:rstr.activity.tower.lastGetGiftsDlg.title,pos:{x:"center",y:40},uicfg:uicfg.activity.tower.lastGetGiftsDlg}},this._initInfo=function(){var a=this.params_;this.items_.list.setItemCount(a.length);for(var b=0;b<a.length;++b){var c=this.items_.list.getItem(b),d=RStrUtil.getItemColorNameByResId(a[b].id);TQ.setRichText(c.exsubs.nameAndNumber,d+rstr.comm.numPrefix+a[b].number)}}})