LetterNetCmdHdr=Class.extern(function(){var a=null,b=null;this.init=function(d){a=d,b=this,a.regEvent(EVT.NET,NETCMD.MAIL,b,c)};var c=function(b){var c=b.data;if(c.mails){d(c.mails);var h=a.getImgr().getLetterRes(),i=f(c.mails);TQ.dictCopy(h.all,i),g(),e(h.all),a.sendEvent({eid:EVT.LETTERUPDATE,sid:0})}},d=function(b){var c=!1;for(var d=0;d<b.length;++d)if(b[d].read==0){c=!0;break}c&&a.sendEvent({eid:EVT.NEW_MAIL,sid:0,start:!0})},e=function(b){var c=!1;for(var d=0;d<b.length;++d)if(b[d].read==0){c=!0;break}c||a.sendEvent({eid:EVT.NEW_MAIL,sid:0,stop:!0})},f=function(a){var b=a;for(var c=0;c<b.length;++c){var d=b[c];d.title&&(d.title=TQ.decodeMessage(d.title)),d.detail&&d.detail.msg&&(d.detail.msg=TQ.decodeMessage(d.detail.msg))}return b},g=function(){var b=a.getImgr().getLetterRes();b.un=[],b.sys=[],b.com=[];for(var c=0,d=b.all.length;c<d;++c){var e=b.all[c];e.read==0&&b.un.push(e),e.sys==1?(e.from=rstr.letter.letterdlg.sysFrom,b.sys.push(e)):b.com.push(e)}var f=function(a,b){return b.time-a.time};b.un.sort(f),b.sys.sort(f),b.com.sort(f)}}),LetterDlg=BaseDlg.extern(function(){this._init=function(){this.PAGE_ITEM_CNT=11,this.g_.regEvent(EVT.LOGIN_OK,0,this,this._onLoginOk),this.g_.regEvent(EVT.LETTERUPDATE,0,this,this._onLetterUpdate)},this._getDlgCfg=function(){return{modal:!1,title:rstr.letter.letterdlg.title,pos:{x:"center",y:30},uicfg:uicfg.letter.letterdlg,btns:[{btn:{id:0,text:rstr.letter.letterdlg.btns.write},caller:{self:this,caller:this._onClickWriteBtn}},{btn:{id:C_SYS_DLG_SEPARATOR},caller:null},{btn:{id:0,text:rstr.letter.letterdlg.btns.selall},caller:{self:this,caller:this._onClickSelectAllBtn}},{btn:{id:0,text:rstr.letter.letterdlg.btns.unselall},caller:{self:this,caller:this._onClickUnSelectAllBtn}},{btn:{id:0,text:rstr.letter.letterdlg.btns.deleteall},caller:{self:this,caller:this._onClickDeleteSelectedLettersBtn}},{btn:{id:C_SYS_DLG_SEPARATOR},caller:null},{btn:{id:0,text:rstr.comm.close},caller:{self:this,caller:this._onClickCloseDlgBtn}}]}},this._afterCreate=function(){this._setTabsText(),this._showSelAllBtn()},this._setTabsText=function(){var a=rstr.letter.letterdlg.tabs;this.items_.lettertabs.setTabCount(a.length);for(var b=0;b<this.items_.lettertabs.getTabCount();++b)this.items_.lettertabs.setTabText(b,a[b])},this._setCallers=function(){this._setLetterListsCaller(),this._setPageBarsCaller()},this._setLetterListsCaller=function(){for(var a=0;a<this.items_.lettertabs.getTabCount();++a){var b=this.items_.lettertabs.getTabItems(a),c=b.letterlist;c.setCaller(null,null,null,{self:this,caller:this._onDbClickList})}},this._setPageBarsCaller=function(){for(var a=0,b=this.items_.lettertabs.getTabCount();a<b;++a){var c=this.items_.lettertabs.getTabItems(a);c.pagebar.setCaller({self:this,caller:this._onPageNavigate})}},this._initInfo=function(){this._initLetterLists(),this.items_.lettertabs.activeTab(0)},this._initLetterLists=function(){if(!this.isShow())return;for(var a=0;a<this.items_.lettertabs.getTabCount();++a){var b=this.items_.lettertabs.getTabItems(a),c=this._getLetterResList(a);this._initPageBarsCount(b.pagebar,c),this._initLetterList(b.letterlist,c,b.pagebar.getCurPage())}},this._getLetterResList=function(a){var b=this.g_.getImgr().getLetterRes(),c=["un","sys","com"];return b[c[a]]},this._initPageBarsCount=function(a,b){var c=Math.ceil(b.length/this.PAGE_ITEM_CNT);a.setPageCnt(c>0?c:1)},this._initLetterList=function(a,b,c){this._setLetterListCount(a,b,c),this._initLetterListContent(a,b,c),this._initLetterListBtnCaller(a,b,c)},this._setLetterListCount=function(a,b,c){var d=this._getLettersRangeByPageIdx(b,c);a.setItemCount(d.count)},this._initLetterListContent=function(a,b,c){var d=function(a,b,c){TQ.setTextEx(c.exsubs.flag,rstr.letter.letterdlg.status[b.read]),TQ.setTextEx(c.exsubs.from,b.from);var d="";b.hasgoods&&(d='<img src="'+IMG.makeImg("item/small/1_1.gif")+'"/>'),TQ.setHtml(c.exsubs.title,b.title+d),TQ.setTextEx(c.exsubs.time,TQ.formatDateTime(b.time))};this._traveLetterList(a,b,c,d)},this._initLetterListBtnCaller=function(a,b,c){var d=this,e=function(a,b,c){c.exsubs.delbtn.setId(a),c.exsubs.delbtn.setCaller({self:d,caller:d._onDelLetter}),c.exsubs.readbtn.setId(a),c.exsubs.readbtn.setCaller({self:d,caller:d._onReadLetter})};this._traveLetterList(a,b,c,e)},this._traveLetterList=function(a,b,c,d){var e=this._getLettersRangeByPageIdx(b,c);for(var f=e.start;f<e.start+e.count;++f){var g=b[f],h=a.getItem(f-e.start);d(f,g,h)}},this._getLettersRangeByPageIdx=function(a,b){var c=b-1,d=c*this.PAGE_ITEM_CNT,e=Math.min(this.PAGE_ITEM_CNT,a.length-d);return{count:e,start:d}},this._onLoginOk=function(){MailSender.sendGetMails(this.g_)},this._onLetterUpdate=function(){this._initLetterLists()},this._onPageNavigate=function(a){var b=this.items_.lettertabs.getActiveTab(),c=this._getLetterResList(b),d=this.items_.lettertabs.getTabItems(b).letterlist;this._initLetterList(d,c,a)},this._onDelLetter=function(a){var b=this._getLetterResList(this.items_.lettertabs.getActiveTab()),c=b[a];c&&this._confirmSendDelCmd([c.id])},this._onReadLetter=function(a){this._readLetter(a)},this._onDbClickList=function(a,b){var c=this.items_.lettertabs.getActiveTab(),d=this.items_.lettertabs.getTabItems(c),e=d.letterlist.getItem(b),f=e.exsubs.readbtn.getId();this._readLetter(f)},this._readLetter=function(a){var b=this._getLetterResList(this.items_.lettertabs.getActiveTab());UIM.openDlg("readletter",b,a)},this._onClickWriteBtn=function(){var a=UIM.getDlg("writeletter");a.openDlg(),a.clear()},this._onClickSelectAllBtn=function(){this._selectCurListAllItem(),this._showUnSelAllBtn()},this._onClickUnSelectAllBtn=function(){this._unselectCurListAllItem(),this._showSelAllBtn()},this._onClickDeleteSelectedLettersBtn=function(){this._delSelLetters()},this._onClickCloseDlgBtn=function(){this.hideDlg()},this._selectCurListAllItem=function(){this._setCurListAllItemCheckState(1)},this._unselectCurListAllItem=function(){this._setCurListAllItemCheckState(0)},this._setCurListAllItemCheckState=function(a){var b=this.items_.lettertabs.getTabItems(this.items_.lettertabs.getActiveTab()),c=b.letterlist;for(var d=0;d<c.getCount();++d){var e=c.getItem(d);e.exsubs.sel.setCheck(a)}},this._showSelAllBtn=function(){this._toggleSelAllAndUnSelAllBtn(1,2)},this._showUnSelAllBtn=function(){this._toggleSelAllAndUnSelAllBtn(2,1)},this._toggleSelAllAndUnSelAllBtn=function(a,b){var c=this.dlg_.getBtns();c[a].show(),c[b].hide(),this.dlg_.refreshBtn()},this._delSelLetters=function(){var a=this._collectSelectedIds();a.length>0&&this._confirmSendDelCmd(a)},this._collectSelectedIds=function(){var a=this.items_.lettertabs.getActiveTab(),b=this._getLetterResList(a),c=this.items_.lettertabs.getTabItems(a).letterlist,d=[];for(var e=0;e<c.getCount();++e){var f=c.getItem(e);if(f.exsubs.sel.getCheck()!=1)continue;var g=f.exsubs.readbtn.getId(),h=b[g];d.push(h.id)}return d},this._confirmSendDelCmd=function(a){var b=this.g_,c=function(c){c==MB_IDYES&&MailSender.sendDelMails(b,a)};this.g_.getGUI().msgBox(rstr.comm.msgts,rstr.letter.letterdlg.confirmdel,MB_F_YESNO,{self:this,caller:c})}}),ReadLetterDlg=Class.extern(function(){var a=null,b=null,c=null,d={},e=[],f=0,g=null;this.init=function(c){a=c,b=this,g=TempLetterMakerMgr.snew(a),a.regEvent(EVT.LETTERUPDATE,0,b,k)},this.openDlg=function(a,b){h(a,b),i(),r()};var h=function(a,b){e=a,f=b},i=function(){c||(c=Dialog.snew(a,{modal:!1,title:rstr.letter.readdlg.title,pos:{x:"center",y:38},btns:[{btn:{id:0,text:rstr.letter.readdlg.btns.prev},caller:{self:b,caller:l}},{btn:{id:0,text:rstr.letter.readdlg.btns.next},caller:{self:b,caller:m}},{btn:{id:0,text:rstr.letter.readdlg.btns.reply},caller:{self:b,caller:n}},{btn:{id:C_SYS_DLG_SEPARATOR}},{btn:{id:0,text:rstr.comm.close},caller:{self:b,caller:o}}]}),a.getGUI().initDlg(c,uicfg.letter.readdlg,d),j()),c.show()},j=function(){d.getbtn.setCaller({self:b,caller:C})},k=function(){r()},l=function(){p(),r()},m=function(){q(),r()},n=function(){var a=t();if(!a)return;var b=UIM.getDlg("writeletter");b.openDlg(),b.setRecv(a.from),b.setTitle(rstr.letter.readdlg.reply+TQ.decodeMessageForText(a.title)),b.setContent("")},o=function(){c.hide()},p=function(){f--,f<0&&(f=0)},q=function(){f++,f>=e.length&&(f=e.length-1)},r=function(){if(!s())return;var b=t();if(!b)return;if(!b.detail){MailSender.sendGetDetailMail(a,b.id);return}u(b),w(b),x(b)},s=function(){return!c||!c.isShow()?!1:!0},t=function(){return e[f]},u=function(a){TQ.setTextEx(d.from,a.from),TQ.setHtml(d.title,a.title),TQ.setTextEx(d.time,TQ.formatDateTime(a.time));var b=v(a.detail);a.sys==0&&(b+=rstr.letter.readdlg.lbl.nosystag),TQ.setHtml(d.content.getContainerObj(),b),d.content.refresh()},v=function(a){return a.msg?HyperLinkMgr.formatLink(a.msg):a.tmsg?g.make(a.tempId,a.tmsg):""},w=function(a){var c=a.items&&a.items.length>0;if(!c){TQ.setCSS(d.itemsPanel,"display","none");return}TQ.setCSS(d.itemsPanel,"display","block"),d.itemsList.setItemCount(a.items.length);for(var e=0,f=a.items.length;e<f;++e){var g=a.items[e],h=d.itemsList.getItem(e);g.itemres=ItemResUtil.findItemres(g.resid),CommDrawItem.drawIconAndNumber(h,g,!0),TTIP.setCallerData(h.exsubs.tooltips.$item,{self:b,caller:B},{idx:e})}},x=function(a){y(),z(),A(a)},y=function(){var a=c.getBtns(),b=a[0];b.enable(f>0)},z=function(){var a=c.getBtns(),b=a[1];b.enable(f<e.length-1)},A=function(a){var b=c.getBtns(),d=b[2];d.enable(a.sys==0)},B=function(a){var b=t();if(!b)return"";if(!b.items)return"";var c=b.items[a.idx];return c?TIPM.getItemDesc(c):""},C=function(){var b=t();if(!b)return;MailSender.sendGetItems(a,b.id)}}),WriteLetterDlg=Class.extern(function(){var a=1,b=2,c=500,d,e,f,g={};this.init=function(a){d=a,e=this},this.writeLetterTo=function(a){this.openDlg(),this.clear(),this.setRecv(a),this.setFocus("title")},this.setRecv=function(a){h(),j(a)},this.setTitle=function(a){h(),k(a)},this.setContent=function(a){h(),l(a)},this.openDlg=function(){h(),f.show(),g.content.refresh()},this.clear=function(){e.setRecv(""),e.setTitle(""),e.setContent("")},this.setFocus=function(a){h(),m(a)};var h=function(){f||(f=Dialog.snew(d,{modal:!1,title:rstr.letter.writedlg.title,pos:{x:"center",y:30},btns:[{btn:{id:0,text:rstr.letter.writedlg.sendbtn},caller:{self:e,caller:n}},{btn:{id:0,text:rstr.letter.writedlg.cancelbtn},caller:{self:e,caller:o}}]}),d.getGUI().initDlg(f,uicfg.letter.writedlg,g),i())},i=function(){InputLimit.maxGBKBytes(g.recv,JVALID.getMaxUserLen()),InputLimit.maxGBKBytes(g.title,JVALID.getMaxMailTitleLen()),InputLimit.maxGBKBytes(g.content.getContainerObj(),JVALID.getMaxMailContentLen())},j=function(a){g.recv.value=a},k=function(a){g.title.value=a},l=function(a){g.content.getContainerObj().value=a},m=function(a){a=="recv"?g.recv.focus():a=="title"?g.title.focus():a=="content"&&g.content.getContainerObj().focus()},n=function(){p(),f.hide()},o=function(){f.hide()},p=function(){if(!q())return;if(!r())return;if(!s())return;MailSender.sendMail(d,g.recv.value,g.title.value,g.content.getContainerObj().value),d.getGUI().sysMsgTips(SMT_NORMAL,rstr.letter.writedlg.tip.sendOk)},q=function(){return t(JVALID.checkUsername,g.recv.value,"recv",rstr.letter.writedlg.errname)},r=function(){return t(JVALID.checkEmailTitle,g.title.value,"title",rstr.letter.writedlg.errtitle)},s=function(){return t(JVALID.checkEmailContent,g.content.getContainerObj().value,"content",rstr.letter.writedlg.errcontent)},t=function(a,b,c,g){if(!a(b)){var h=function(){f.show(),e.setFocus(c)};return d.getGUI().msgBox(rstr.letter.writedlg.errmsgtitle,g,MB_F_CLOSE,{self:e,caller:h}),!1}return!0}}),LetterHandlerEx=function(){var a,b;this.init=function(c){a=c,b=this},this.writeLetter=function(a){c(a)};var c=function(a){var b=UIM.getDlg("writeletter");b.setValue("recv",a.name),b.setValue("title",""),b.setValue("content",""),b.openDlg(),b.setFocus("title")};this.init.apply(this,arguments)},FightResultTempLetterMaker=Class.extern(function(){var a=null,b=null;this.init=function(c){a=c,b=FightResultMaker.snew(a)},this.make=function(a,d){return a=a.replace("#result#",b.getResultTitle(d)),a=a.replace("#lines#",c(d)),a=a.replace("#res#",f(d)),a};var c=function(a){var b="";for(var c=0;c<5;++c){var f=a.attacker.heros[c],g=a.defender.heros[c];b+="<tr height=25 class=line>",f?b+=d(!0,f,"attackline"):b+=e(7,"attackline"),g?b+=d(!1,g,"defline"):b+=e(6,"defline"),b+="</tr>"}return b},d=function(a,b,c){var d="";return d+="<td class="+c+">"+b.name+"</td>",d+="<td class="+c+">"+b.level+"</td>",d+="<td class="+c+">"+RStrUtil.getSoldierNameByResId(b.soldier.resid)+"</td>",d+="<td class="+c+">"+b.soldier.number+"</td>",d+="<td class="+c+">"+b.soldier.loss+"</td>",d+="<td class="+c+">"+b.soldier.revive+"</td>",a&&(d+="<td class="+c+">"+b.addExp+"</td>"),d},e=function(a,b){var c="";for(var d=0;d<a;++d)c+="<td class="+b+"></td>";return c},f=function(a){var c="";b.hasDefExpend(a.defender.defexpend)&&(c+=b.getDefExpend(a.defender.defexpend)+"<br/>");var d=b.getGetOrLostResTitle(a);return c+=g(d.attack,a.attacker),c+=g(d.target,a.defender),c},g=function(a,c){var d=a+"：",e=b.getGetOrLostResString(c)+b.getDropItemsString(c);return e==""&&(e=rstr.military.fightresult.lbl.no),d+=e+"<br/>",d}}),CommSysTempLetterMaker=Class.extern(function(){var a=null;this.init=function(b){a=b},this.make=function(a,b){return a=a.replace("#con#",HyperLinkMgr.formatLink(b.con)),a}}),TempLetterMakerMgr=Class.extern(function(){this.init=function(a){this.makers={},this.makers[FIXID.FDEMO_MAILTEMP]=FightResultTempLetterMaker.snew(a),this.makers[FIXID.COMM_SYS_MAILTEMP]=CommSysTempLetterMaker.snew(a)},this.make=function(a,b){var c=this.makers[a];if(!c)return"";var d=res_mailtemps_fact[a];return d?c.make(d,b):""}})