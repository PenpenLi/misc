RoleDlg=ListenerBaseDlg.extern(function(){var a=0,b,c,d,e={},f=null,g=null,h=null,i=null;this._init=function(){b=this.g_,c=this,f=PPointAssign.snew(b)},this.openDlg=function(){j(),d.show(),k(),this._notifyOpenDlg()},this.closeDlg=function(){this.hideDlg()},this.hideDlg=function(){d&&d.hide()},this.isShow=function(){return d?d.isShow():!1};var j=function(){d||(d=Dialog.snew(b,{modal:!1,title:rstr.roledlg.title,pos:{x:"center",y:35}}),b.getGUI().initDlg(d,uicfg.roledlg,e),h=RoleDlgInfoPanel.snew(b,e),y(),e.confirmpp.setCaller({self:c,caller:u}),e.clearpp.setCaller({self:c,caller:v}),e.assignexp.setCaller({self:c,caller:w}),TQ.addEvent(e.cityflag,"click",p),s("addpp",q),s("subpp",r),f.setLeftPPDom(e.rolepp),f.setAttrCaller(t),f.setBtnStateCaller(x),f.append({drtpp:res_role_pp_drts[0],attr_b:ATTR.FOR_B,attr_a:ATTR.FOR_A,dom:e.forceattr}),f.append({drtpp:res_role_pp_drts[1],attr_b:ATTR.IN_B,attr_a:ATTR.IN_A,dom:e.polityattr}),b.regEvent(EVT.ROLEBASE,0,c,o),d.setCaller({self:c,caller:n}),i=RoleAchievement.snew(b,e.achievement),d.hide())},k=function(){l(),m()},l=function(){var a=b.getImgr().getRoleRes();i.setRole({cityMaxLevel:a.cityMaxLevel,actTower:a.actTower,actTerrace:a.actTerrace,vip:b.getImgr().getVipLevel()})},m=function(){var a=b.getImgr(),c=a.getRoleRes(),d=a.getRoleAttrVal(ATTR.PP);f.isChanged(d)&&f.setLeftPP(d),IMG.setBKImage(e.roleicon,IMG.makeBigImg(c.itemres.bigpic)),TQ.setTextEx(e.roleName,c.name),TQ.setTextEx(e.level,c.level),TQ.setTextEx(e.rsort,c.ranking),e.phybar.setRange(a.getRoleAttrVal(ATTR.MPS)),e.phybar.setValue(0,a.getRoleAttrVal(ATTR.PS)),e.healthbar.setRange(a.getRoleAttrVal(ATTR.MHEALTH)),e.healthbar.setValue(0,a.getRoleAttrVal(ATTR.HEALTH)),e.expbar.setRange(a.getRoleAttrVal(ATTR.NXP)),e.expbar.setValue(0,a.getRoleAttrVal(ATTR.XP)),e.armforcesbar.setRange(a.getRoleAttrVal(ATTR.MAF)),e.armforcesbar.setValue(0,a.getRoleAttrVal(ATTR.AF)),TQ.setTextEx(e.alli,c.alliance.name),TQ.setTextEx(e.prestige,c.prestige),TQ.setTextEx(e.cityhonor,c.cityhonor);var g=ItemResUtil.findItemres(c.cityid);IMG.setBKImage(e.cityflag,IMG.makeStateCityFlag(g.flagimg)),e.herosexpbar.setRange(a.getRoleAttrVal(ATTR.MXPS)),e.herosexpbar.setValue(0,a.getRoleAttrVal(ATTR.XPS)),HelpGuider.firstAssignRolePP(e.addpp0.getDom(),a.getRoleAttrVal(ATTR.PP)),HelpGuider.firstChangeCountry(e.cityflag)},n=function(a){a==C_SYS_DLG_HIDE&&(HelpGuider.hideTipDlgById(HelpGuider.HELP_TIP.CHANGE_CITY),HelpGuider.hideTipDlgById(HelpGuider.HELP_TIP.ASSIGN_ROLEPP))},o=function(){m()},p=function(){UIM.openDlg("changecity"),HelpGuider.sendHelpTip(b,HelpGuider.HELP_TIP.CHANGE_CITY)},q=function(a){f.add(a)},r=function(a){f.sub(a)},s=function(a,b){for(var d=0;d<2;++d)e[a+d].setId(d),e[a+d].setType(BTN_TYPE.TIMER),e[a+d].setCaller({self:c,caller:b})},t=function(a){return b.getImgr().getRoleAttrVal(a)},u=function(a){RoleSender.sendSavePP(b,f.getAssignStr()),HelpGuider.sendHelpTip(b,HelpGuider.HELP_TIP.ASSIGN_ROLEPP)},v=function(a){UIM.openDlg("clearrolepp")},w=function(a){UIM.openDlg("roleassignexp")},x=function(a,b,c){a=="confirm"?(e.confirmpp.enable(c),c?g.start(-1):g.stop()):a=="add"?e["addpp"+b].enable(c):a=="sub"&&e["subpp"+b].enable(c)},y=function(){var a=e.confirmpp.getDom();g=BlinkingPanel.snew(b,{borderw:2}),g.bind(a,a,BLINKING_TYPE.INSERT,-1,-1,TQ.getDomWidth(a)+2,TQ.getDomHeight(a)+2)}}),RoleStateHdr=Class.extern(function(){this.g_=null,this.init=function(a){this.g_=a},this.getRoleStateText=function(){return this._getSubHdr().getRoleStateText()},this.getOpBtnTextAndEnable=function(){return this._getSubHdr().getOpBtnTextAndEnable()},this.getToolTip=function(){return this._getSubHdr().getToolTip()},this._getSubHdr=function(){return this._createSubHdrs(),this.g_.getImgr().hasRoleState(RES_EFF.AVOIDFIGHTCD)?this.avoidFightCDState_:this.g_.getImgr().hasRoleState(RES_EFF.AVOIDFIGHT)?this.avoidFightState_:this.g_.getImgr().hasRoleState(RES_EFF.YOUNG_STATE)?this.youngState_:this.freeState_},this._createSubHdrs=function(){this.freeState_=this.freeState_?this.freeState_:RoleFreeStateHdr.snew(this.g_),this.avoidFightState_=this.avoidFightState_?this.avoidFightState_:RoleAvoidFightStateHdr.snew(this.g_),this.avoidFightCDState_=this.avoidFightCDState_?this.avoidFightCDState_:RoleAvoidFightCDStateHdr.snew(this.g_),this.youngState_=this.youngState_?this.youngState_:RoleYoungStateHdr.snew(this.g_)},this._getRoleEffectState=function(a,b){var c=this.g_.getImgr().getRoleState(a),d=Math.max(0,c.stoptime-this.g_.getSvrTimeS());return TQ.format(b,TQ.formatTime(0,d))}}),RoleFreeStateHdr=RoleStateHdr.extern(function(){this.getRoleStateText=function(){var a=this.g_.getImgr().getRoleRes();return rstr.comm.rolestate[a.state]},this.getOpBtnTextAndEnable=function(){return{enable:!0,text:rstr.roledlg.btns.avoidfight}},this.getToolTip=function(){return rstr.roledlg.tips.roleFreeState}}),RoleAvoidFightStateHdr=RoleStateHdr.extern(function(){this.getRoleStateText=function(){return this._getRoleEffectState(RES_EFF.AVOIDFIGHT,rstr.roledlg.lbl.avoidfight)},this.getOpBtnTextAndEnable=function(){return{enable:!0,text:rstr.roledlg.btns.stopavoidfight}},this.getToolTip=function(){return rstr.roledlg.tips.roleAvoidFightState}}),RoleAvoidFightCDStateHdr=RoleStateHdr.extern(function(){this.getRoleStateText=function(){return this._getRoleEffectState(RES_EFF.AVOIDFIGHTCD,rstr.comm.cooldown)},this.getOpBtnTextAndEnable=function(){return{enable:!1,text:rstr.roledlg.btns.avoidfight}},this.getToolTip=function(){return rstr.roledlg.tips.roleAvoidFightCDState}}),RoleYoungStateHdr=RoleStateHdr.extern(function(){this.getRoleStateText=function(){return this._getRoleEffectState(RES_EFF.YOUNG_STATE,rstr.roledlg.lbl.youngstate)},this.getOpBtnTextAndEnable=function(){return{enable:!1,text:rstr.roledlg.btns.avoidfight}},this.getToolTip=function(){return rstr.roledlg.tips.roleYoungState}}),RoleDlgInfoPanel=Class.extern(function(){var a=null,b=null,c=null,d=!1,e=null;this.init=function(b,c){f(this,b,c),e=RoleStateHdr.snew(a),g(),h(),i(),j()},this.show=function(){d=!0,a.regUpdater(b,p,1e3),j()},this.hide=function(){d=!1,a.unregUpdater(b,p)};var f=function(d,e,f){a=e,b=d,c=f},g=function(){TTIP.setCallerData(c.tooltips[TIP_PREFIX+"rolestate"],{self:b,caller:o},{})},h=function(){c.movepopu.setCaller({self:b,caller:q}),c.changestate.setCaller({self:b,caller:r}),c.avoidfight.setCaller({self:b,caller:s}),c.savemodify.setCaller({self:b,caller:w}),c.cancelsave.setCaller({self:b,caller:x}),TQ.addEvent(c.iselfsign.getContainerObj(),"keyup",y),a.regEvent(EVT.ROLEBASE,0,b,z),a.regEvent(EVT.ROLEBASE,1,b,A),a.regEvent(EVT.ROLESPECSTATE_CHANGE,0,b,B)},i=function(){InputLimit.maxGBKBytes(c.iselfsign.getContainerObj(),JVALID.getSelfSignMaxLen())},j=function(){k(),l(),m(),n()},k=function(){var b=a.getImgr().getRoleRes(),d=ItemResUtil.findItemres(b.cityid);TQ.setTextEx(c.statecity,d.name),TQ.setTextEx(c.position,b.pos.x+","+b.pos.y)},l=function(){c.iselfsign.getContainerObj().value=TQ.decodeMessageForText(a.getImgr().getRoleRes().introduction),D()},m=function(){TQ.setTextEx(c.rolestate,e.getRoleStateText())},n=function(){var a=e.getOpBtnTextAndEnable();c.avoidfight.enable(a.enable),c.avoidfight.setText(a.text)},o=function(){return e.getToolTip()},p=function(){m()},q=function(){UIM.openDlg("changecity")},r=function(){var b=a.getImgr().getRoleRes(),c=UIM.getDlg("uselistitem");c.openDlg([RES_EFF.RAND_MOVECITY,RES_EFF.SETPOS_MOVECITY],{id:b.id,name:b.name,type:RES_TRG.SELF_ROLE})},s=function(){t()?u():v()},t=function(){var b=a.getImgr().getRoleRes();return b.state==ROLE_STATE.REST},u=function(){var c=function(b){b==MB_IDYES&&RoleStateSender.cancelState(a,RES_EFF.AVOIDFIGHT)};a.getGUI().msgBox(rstr.comm.msgts,rstr.roledlg.tips.cancelReset,MB_F_YESNO,{self:b,caller:c})},v=function(){var b=a.getImgr().getRoleRes(),c=UIM.getDlg("uselistitem");c.openDlg([RES_EFF.AVOIDFIGHT],{id:b.id,name:b.name,type:RES_TRG.SELF_ROLE})},w=function(){RoleSender.sendSelfSign(a,E(c.iselfsign.getContainerObj().value))},x=function(){l()},y=function(){var b=E()!=a.getImgr().getRoleRes().introduction;b?C():D()},z=function(){k(),m(),n()},A=function(){l()},B=function(){if(!d)return;m(),n()},C=function(){c.savemodify.show(),c.cancelsave.show()},D=function(){c.savemodify.hide(),c.cancelsave.hide()},E=function(){return TQ.encodeMsgByBytesLimit(c.iselfsign.getContainerObj().value,JVALID.getSelfSignMaxBytes())}}),PPointAssign=Class.extern(function(){this.init=function(a){this.g=a,this.list=[],this.leftpps=0,this.originalLeftPPS=0,this.leftppdom=null,this.getAttrCaller=null,this.btnStateCaller=null},this.setAttrCaller=function(a){this.getAttrCaller=a},this.setBtnStateCaller=function(a){this.btnStateCaller=a},this.setLeftPPDom=function(a){this.leftppdom=a},this.append=function(a){a.pps=0,this.list.push(a)},this.isChanged=function(a){if(a!=this.originalLeftPPS||a==0)return!0;for(var b=0;b<this.list.length;++b){var c=this.list[b],d=this.getAttrCaller(c.attr_b)+this.getAttrCaller(c.attr_a);if(d!=c.originalAttr)return!0}return!1},this.clear=function(){this.leftpps=0,this._clearOriginalAttrs(),this._clearCurPPS(),this._refresh()},this.setLeftPP=function(a){this.leftpps=a,this._saveOriginalAttrs(),this._clearCurPPS(),this._refresh()},this.getLeftPP=function(){return this.leftpps},this.add=function(a){var b=this.list[a];this.leftpps>=b.drtpp&&(b.pps+=b.drtpp,this.leftpps-=b.drtpp,this._refresh())},this.sub=function(a){var b=this.list[a];b.pps>=b.drtpp&&(b.pps-=b.drtpp,this.leftpps+=b.drtpp,this._refresh())},this.getAssignStr=function(){var a="";for(var b=0;b<this.list.length;++b){var c=this.list[b];a=a+",p"+b+"="+c.pps}return a},this._saveOriginalAttrs=function(){this.originalLeftPPS=this.leftpps;for(var a=0;a<this.list.length;++a){var b=this.list[a];b.originalAttr=this.getAttrCaller(b.attr_b)+this.getAttrCaller(b.attr_a)}},this._clearOriginalAttrs=function(){this.originalLeftPPS=0;for(var a=0;a<this.list.length;++a){var b=this.list[a];b.originalAttr=0}},this._clearCurPPS=function(){for(var a=0;a<this.list.length;++a)this.list[a].pps=0},this._refresh=function(){this._setVal(),this._checkButtons()},this._setVal=function(){TQ.setTextEx(this.leftppdom,this.leftpps);for(var a=0;a<this.list.length;++a){var b=this.list[a],c=this.getAttrCaller(b.attr_b)+parseInt(b.pps/b.drtpp,10),d=this.getAttrCaller(b.attr_a);d>0&&(d="("+TQ.formatColorStr("+"+d,COLORS.APPEND_ATTR)+")"),TQ.setTextEx(b.dom,c+d)}},this._checkButtons=function(){var a=0;for(var b=0;b<this.list.length;++b){var c=this.list[b];a+=c.pps,this.btnStateCaller("add",b,this.leftpps>=c.drtpp),this.btnStateCaller("sub",b,c.pps>=c.drtpp)}this.btnStateCaller("confirm",0,a>0)}}),ChangeCityDlg=Class.extern(function(){var a=null,b=null,c=null,d={};this.init=function(c){a=c,b=this},this.openDlg=function(){e(),f(),c.show(),a.regUpdater(b,_onUpdate,1e3)},this.closeDlg=function(){c&&c.hide()},this.getItems=function(){return d};var e=function(){c||(c=Dialog.snew(a,{modal:!1,title:rstr.changecitydlg.title,pos:{x:"center",y:35}}),a.getGUI().initDlg(c,uicfg.changecitydlg,d),c.setCaller({self:b,caller:_onDlgEvent}),d.confirmbtn.setCaller({self:b,caller:j}),c.hide())},f=function(){g()},g=function(){var b=a.getImgr(),c=b.getRoleRes(),e=ItemResUtil.findItemres(c.cityid);IMG.setBKImage(d.curcity,IMG.makeStateCityFlag(e.flagimg));var f=[9900001,9900002,9900003];for(var g=listidx=0;g<f.length;++g){var j=f[g];if(j!=c.cityid){var k=d.list.getItem(listidx++),e=ItemResUtil.findItemres(j);IMG.setBKImage(k.exsubs.icon,IMG.makeStateCityFlag(e.flagimg)),k.cityid=j}}var l=h();TQ.setHtml(d.needgold,i(l))},h=function(){return a.getImgr().isNewPlayer()?0:100},i=function(b){return b==0?TQ.formatColorStr(rstr.changecitydlg.lbl.newplayer,COLORS.ENOUGH_GOLD):b<=a.getImgr().getGold()?TQ.formatColorStr(b,COLORS.ENOUGH_GOLD):TQ.formatColorStr(b,COLORS.NOTENOUGH_GOLD)},j=function(b){if(!k())return;var e=d.list.getItem(d.list.getCurSel()).cityid;RoleSender.sendChangeCity(a,e),c.hide()},k=function(){if(d.list.getCurSel()<0)return a.getGUI().sysMsgTips(SMT_ERROR,rstr.changecitydlg.msg.err_nosel),!1;var b=[{attr:ATTR.GIFTGOLD,type:EXPEND_TYPE.GIFTGOLD,val:h()}],c=ExpendUtil.createExpendObjs(a,0,b);if(!ExpendUtil.isEnough(c))return!1;var e=a.getImgr().getRoleRes(),f=parseInt(a.getSvrTimeMs()/1e3,10);if(f<e.citycd)return a.getGUI().sysMsgTips(SMT_ERROR,rstr.changecitydlg.msg.err_colddown),!1;if(e.alliance.uid!=0)return a.getGUI().sysMsgTips(SMT_ERROR,rstr.changecitydlg.msg.err_hasalli),!1;var g=a.getImgr().getHeros().list;for(var i=0;i<g.length;++i){var j=g[i];if(j.state==HERO_STATE.EXPED)return a.getGUI().sysMsgTips(SMT_ERROR,rstr.changecitydlg.msg.err_heronofree),!1}return!0};_onUpdate=function(b){var c=a.getImgr().getRoleRes(),e=parseInt(a.getSvrTimeMs()/1e3,10),f=c.citycd-e;f<0&&(f=0),TQ.setTextEx(d.colddown,TQ.formatTime(0,f))},_onDlgEvent=function(c){c==C_SYS_DLG_HIDE&&a.unregUpdater(b,_onUpdate)}}),ClearRolePPDlg=function(){var a=null,b=null,c=null,d={};this.init=function(c){a=c,b=this},this.openDlg=function(){e(),f(),c.show()},this.closeDlg=function(){c.hide()};var e=function(){c||(c=Dialog.snew(a,{modal:!0,title:rstr.clearroleppdlg.title,pos:{x:"center",y:35},btns:[{btn:{id:0,text:rstr.comm.confirm},caller:{self:b,caller:i}},{btn:{id:0,text:rstr.comm.cancel},caller:{self:b,caller:j}}]}),a.getGUI().initDlg(c,uicfg.clearroleppdlg,d),d.buyitembtn.setCaller({self:b,caller:h}),d.iforce.setLimit(k),d.ipolity.setLimit(l),d.iforce.setCaller({self:b,caller:n}),d.ipolity.setCaller({self:b,caller:o}),c.hide(),a.regEvent(EVT.PKG_CHANGE,0,b,p))},f=function(){d.iforce.setVal(0),d.ipolity.setVal(0),g()},g=function(){TQ.setTextEx(d.lblclearforce,TQ.format(rstr.clearroleppdlg.lbl.clearforce,r(ATTR.FOR_B))),TQ.setTextEx(d.lblclearpolity,TQ.format(rstr.clearroleppdlg.lbl.clearpolity,r(ATTR.IN_B)))},h=function(){UIM.getDlg("buyitemlist").openDlg([FIXID.CLEARFORCARD,FIXID.CLEARINCARD])},i=function(){var b=d.iforce.getVal(),e=d.ipolity.getVal();b<=0&&e<=0?a.getGUI().sysMsgTips(SMT_WARNING,rstr.clearroleppdlg.msg.noneedclear):RoleSender.sendClearPP(a,b,e),c.hide()},j=function(){c.hide()},k=function(){return m(ATTR.FOR_B,FIXID.CLEARFORCARD)},l=function(){return m(ATTR.IN_B,FIXID.CLEARINCARD)},m=function(b,c){var d=r(b),e=a.getImgr().getItemNumByResId(c);return{min:0,max:Math.min(d,e)}},n=function(a){q(a,FIXID.CLEARFORCARD,rstr.clearroleppdlg.lbl.needforceitem,"needforceitem")},o=function(a){q(a,FIXID.CLEARINCARD,rstr.clearroleppdlg.lbl.needpolityitem,"needpolityitem")},p=function(){if(!c.isShow())return;q(d.iforce.getVal(),FIXID.CLEARFORCARD,rstr.clearroleppdlg.lbl.needforceitem,"needforceitem"),q(d.ipolity.getVal(),FIXID.CLEARINCARD,rstr.clearroleppdlg.lbl.needpolityitem,"needpolityitem")},q=function(b,c,e,f){var g=a.getImgr().getItemNumByResId(c);g=TQ.formatColorStr(g,g==0?COLORS.NO_ENOUGH_ITEM:COLORS.ENOUGH_ITEM),TQ.setTextEx(d[f],TQ.format(e,b,g))},r=function(b){var c=a.getImgr();return c.getRoleAttrVal(b)-c.getRoleInitAttrVal(b)};this.init.apply(this,arguments)},RoleAssignExpDlg=Class.extern(function(){var a=null,b=null,c=null,d={},e=0,f=null;this.init=function(c){a=c,b=this},this.openDlg=function(a){g(),h(a)},this.closeDlg=function(){c.hide()},this.isShow=function(){return c&&c.isShow()};var g=function(){c||(c=Dialog.snew(a,{modal:!0,title:rstr.roleassignexpdlg.title,pos:{x:"center",y:45},btns:[{btn:{id:0,text:rstr.comm.confirm},caller:{self:b,caller:k}},{btn:{id:0,text:rstr.comm.cancel},caller:{self:b,caller:l}}]}),a.getGUI().initDlg(c,uicfg.roleassignexpdlg,d),d.herolist.setCaller({self:b,caller:j}),a.regEvent(EVT.HERO_UPDATE,0,b,m),a.regEvent(EVT.ROLEBASE,0,b,n),d.iassignexp.setLimit(p),d.upgradeneed.setCaller({self:b,caller:o})),c.show()},h=function(b){b==undefined?e=0:e=a.getImgr().getHeroIdxFromId(b),i()},i=function(){if(!b.isShow())return;q(),s()},j=function(b,c){e=c,f=a.getImgr().getHeroByIdx(c),r()},k=function(){var b=d.iassignexp.getVal();d.iassignexp.setVal(0);if(b<=0||!f){a.getGUI().sysMsgTips(SMT_WARNING,rstr.roleassignexpdlg.msg.noexp);return}RoleSender.sendAssignExp(a,f.id,b)},l=function(){c.hide()},m=function(){q(),r()},n=function(){s()},o=function(){var b=a.getImgr(),c=b.getRoleAttrVal(ATTR.XPS),e=b.getHeroAttrVal(f,ATTR.NXP)-b.getHeroAttrVal(f,ATTR.XP);e=e>0?e:0,b.isMaxHeroLevel(f)&&(e=0),b.isMaxHeroLevel(f)&&!b.isMaxMaxHeroLevel(f)&&a.getGUI().sysMsgTips(SMT_WARNING,rstr.roleassignexpdlg.msg.maxlevel),d.iassignexp.setVal(Math.min(e,c))},p=function(){var b=a.getImgr().getRoleAttrVal(ATTR.XPS);return{min:0,max:b}},q=function(){d.herolist.deleteAllItem(),d.herolist.setTitle(rstr.roleassignexpdlg.lbl.nohero);var b=a.getImgr(),c=b.getHeros().list;for(var f=0,g=c.length;f<g;++f){var h=c[f];h.attrs||HeroSender.sendGetDetail(a,h.id);var i=b.getHeroAttrVal(h,ATTR.NXP),j=b.getHeroAttrVal(h,ATTR.XP),k=100;i>0&&(k=Math.min(parseInt(j*100/i,10),100)),b.isMaxHeroLevel(h)&&(k=100);var l=TQ.format(rstr.roleassignexpdlg.msg.selname,h.name,h.level,k);d.herolist.addItem({text:l})}d.herolist.setCurSel(e)},r=function(){var b=a.getImgr();d.heroexpbar.setRange(b.getHeroAttrVal(f,ATTR.NXP)),d.heroexpbar.setValue(0,b.getHeroAttrVal(f,ATTR.XP))},s=function(){var b=a.getImgr();d.expsbar.setRange(b.getRoleAttrVal(ATTR.MXPS)),d.expsbar.setValue(0,b.getRoleAttrVal(ATTR.XPS))}})