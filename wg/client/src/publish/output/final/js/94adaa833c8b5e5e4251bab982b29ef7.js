ARM_EFF_MAP_ATTR={},ARM_EFF_MAP_ATTR[RES_EFF.H_ADD_STR]=ATTR.ST_B,ARM_EFF_MAP_ATTR[RES_EFF.H_ADD_PHY]=ATTR.PH_B,ARM_EFF_MAP_ATTR[RES_EFF.H_ADD_AGILE]=ATTR.AG_B,ARM_EFF_MAP_ATTR[RES_EFF.H_ADD_CO]=ATTR.CO,ARM_EFF_MAP_ATTR[RES_EFF.H_ADD_JIN_SKILL_LEVEL]=ATTR.JIN_SKILL_LEVEL,ARM_EFF_MAP_ATTR[RES_EFF.H_ADD_MU_SKILL_LEVEL]=ATTR.MU_SKILL_LEVEL,ARM_EFF_MAP_ATTR[RES_EFF.H_ADD_SHUI_SKILL_LEVEL]=ATTR.SHUI_SKILL_LEVEL,ARM_EFF_MAP_ATTR[RES_EFF.H_ADD_HUO_SKILL_LEVEL]=ATTR.HUO_SKILL_LEVEL,ARM_EFF_MAP_ATTR[RES_EFF.H_ADD_TU_SKILL_LEVEL]=ATTR.TU_SKILL_LEVEL,ARM_EFF_MAP_ATTR[RES_EFF.H_ADD_SP]=ATTR.SP,ARM_EFF_MAP_ATTR[RES_EFF.H_ADD_ATT]=ATTR.HU,ARM_EFF_MAP_ATTR[RES_EFF.H_ADD_DEF]=ATTR.DE,ARM_EFF_MAP_ATTR[RES_EFF.H_ADD_HIT]=ATTR.HI,ARM_EFF_MAP_ATTR[RES_EFF.H_ADD_ES]=ATTR.ES,ARM_EFF_MAP_ATTR[RES_EFF.H_ADD_MPS]=ATTR.MPS,MAX_GEMS_POS_COUNT=3,GemUtil=Class.extern(function(){this.isMaxGemLevel=function(a){var b=ItemResUtil.findItemres(a);return b.gemLevel>=res_max_gem_level},this.getCombineNeedNumber=function(a){return res_gem_combinelevels[a-1].needNumber},this.hasSameTypeGems=function(a,b){for(var c=0;c<a.gems.length;++c){var d=a.gems[c];if(this._getGemEffectId(d)==this._getGemEffectId(b))return!0}return!1},this._getGemEffectId=function(a){var b=ItemResUtil.findItemres(a);return b.effects[0].id}}).snew(),SysItemMaker=Class.extern(function(){this.make=function(a,b,c){return{id:a,itemres:b,appendDesc:this._makeProAttrsDesc(b),resid:b.id,attrs:this._makeAttrs(b),buylimit:c}},this._makeAttrs=function(a){if(!a.effects)return{};var b={};for(var c=0;c<a.effects.length;++c){var d=a.effects[c];if(d.id&&d.pro&&d.pro==100&&d.min>0){var e=d.min,f=d.unit?d.unit:0;b[ARM_EFF_MAP_ATTR[d.id]]={val:d.min,u:f}}}return b},this._makeProAttrsDesc=function(a){if(!a.effects)return"";var b="";for(var c=0;c<a.effects.length;++c){var d=a.effects[c];if(d.id&&d.pro&&d.pro<100){var e=TQ.qfind(res_attrs,"id",d.id);if(!e)continue;b+=e.name,b+=" "}}return b==""?b:rstr.comm.proget+b}}).snew(),ArmOpDlg=Class.extern(function(){var a=null,b=null,c=null,d={},e=[];this.init=function(c){a=c,b=this},this.openDlg=function(a){f(),g(),h(a)},this.isShow=function(){return c?c.isShow():!1};var f=function(){if(c)return;c=Dialog.snew(a,{modal:!1,title:rstr.armopdlg.title,pos:{x:"center",y:30}}),a.getGUI().initDlg(c,uicfg.armopdlg,d),j(),k()},g=function(){c.show()},h=function(a){d.tabList.activeTab(a),i()},i=function(){for(var a=0;a<e.length;++a)e[a].update()},j=function(){for(var a=0,b=d.tabList.getTabCount();a<b;++a)d.tabList.setTabText(a,rstr.armopdlg.tabs[a])},k=function(){e=[],e.push(BuyArmOpPanel.snew(a,b,d.tabList.getTabItems(0))),e.push(SplitArmOpPanel.snew(a,b,d.tabList.getTabItems(1))),e.push(IntensifyArmOpPanel.snew(a,b,d.tabList.getTabItems(2))),e.push(CombineGemOpPanel.snew(a,b,d.tabList.getTabItems(3))),e.push(BesetGemOpPanel.snew(a,b,d.tabList.getTabItems(4)))}}),ArmListWithHerosAndArmPos=Class.extern(function(){var a=null;this.g=null,this.panel=null,this.items=null,this.myArms=[],this.init=function(b,f,g){a=this,this.g=b,this.panel=f,this.items=g,c(),d(),e()},this.updateArmList=function(){var a=this._getLastSelItemId();this.myArms=f(),this.panel.sortArms(this.myArms),this.panel.setMyArmListItems(this.items.armList,this.myArms),b(a),this.panel.setListTipCaller(this.items.armList,g)},this.updateHeroList=function(){this.items.heroDropList.deleteAllItem();var a=this.g.getImgr().getHeros().list;this.items.heroDropList.addItem({text:rstr.comm.pkg});for(var b=0;b<a.length;++b)this.items.heroDropList.addItem({text:a[b].name});this.items.heroDropList.getCurSel()<0?this.items.heroDropList.setCurSel(1):this.items.heroDropList.setCurSel(this.items.heroDropList.getCurSel())},this.getCurSelArm=function(){var a=this.myArms[this.items.armList.getCurSel()];return a&&!a.gems&&(a.gems=[]),a},this.getCurHeroId=function(){var a=this.g.getImgr().getHeroByIdx(o());return a?a.id:0},this._getLastSelItemId=function(){var a=this.items.armList.getCurSel();return a>=0&&a<this.myArms.length?this.myArms[a].id:0};var b=function(b){TQ.find(a.myArms,"id",b)?a.items.armList.setCurSel(TQ.getLastFindIdx()):a.items.armList.setCurSel(0)},c=function(){a.g.regEvent(EVT.HERO_UPDATE,0,a,j)},d=function(){a.items.armPosDropList.setCaller({self:a,caller:h}),a.items.heroDropList.setCaller({self:a,caller:i})},e=function(){var b=rstr.armopdlg.intensifyarms.armPosName;for(var c in b)a.items.armPosDropList.addItem({text:b[c]});a.items.armPosDropList.setCurSel(0)},f=function(){var b=CanIntensifyArmPosFilter.snew(a.g);return b.filter({armPos:l(),items:m()})},g=function(b){return TIPM.getItemDesc(a.myArms[b.idx])},h=function(b,c){a.updateArmList(),k()},i=function(b,c){a.updateArmList(),k()},j=function(){if(!a.panel.dlg.isShow())return;a.updateArmList()},k=function(){a.items.armList.setCurSel(0)},l=function(){return a.items.armPosDropList.getCurSel()},m=function(){var b=a.g.getImgr();if(n())return b.getPkgs().items;var c=b.getHeroByIdx(o());if(!c)return[];if(!b.isDetailHero(c))return HeroSender.sendGetDetail(a.g,c.id),[];var d=[];for(var e in c.wears){var f=c.wears[e];if(!f)continue;d.push(f)}return d},n=function(){return a.items.heroDropList.getCurSel()<=0},o=function(){return a.items.heroDropList.getCurSel()-1}}),BaseArmOpPanel=Class.extern(function(){this.g=null,this.dlg=null,this.items=null,this.init=function(a,b,c){this.g=a,this.dlg=b,this.items=c,this.initPanel()},this.initPanel=function(){},this.update=function(){},this.sortArms=function(a){var b=function(a,b){return a.flevel||(a.flevel=0),b.flevel||(b.flevel=0),a.flevel!=b.flevel?b.flevel-a.flevel:a.itemres.level!=b.itemres.level?b.itemres.level-a.itemres.level:a.itemres.apos-b.itemres.apos};a.sort(b)},this.setMyArmListItems=function(a,b){a.setItemCount(b.length);for(var c=0,d=a.getCount();c<d;++c){var e=a.getItem(c),f=b[c];CommDrawItem.drawItemName(e.exsubs.name,f.itemres),this.setListItemSecField(e,f)}},this.setListTipCaller=function(a,b){for(var c=0,d=a.getCount();c<d;++c){var e=a.getItem(c);TTIP.setCallerData(e.exsubs.tooltips[TIP_PREFIX+"item"],{self:this,caller:b},{idx:c})}},this.setListItemSecField=function(a,b){TQ.setTextEx(a.exsubs.levelOrNumber,b.flevel?TQ.format(rstr.armopdlg.flevel,b.flevel):"")},this.resetListCurSel=function(a){var b=a.getCurSel()<0;b?a.setCurSel(0):a.setCurSel(a.getCurSel())}}),BuyArmOpPanel=BaseArmOpPanel.extern(function(){var a=null,b=[],c=[];this.initPanel=function(){a=this,d(),e()},this.update=function(){f(),g()};var d=function(){a.g.regEvent(EVT.PKG_CHANGE,0,a,n)},e=function(){a.items.saleList.setCaller({self:a,caller:o}),a.items.myItemList.setCaller({self:a,caller:p})},f=function(){h(),j()},g=function(){i(),k()},h=function(){var c=res_smithy_salelist[a.g.getImgr().getBuildLevelByResId(BUILDCITY_ID.ALL,FIXID.SMITHY)-1];if(!c){a.items.saleList.setItemCount(0);return}q(c),r(c.items),a.items.saleList.setItemCount(b.length);for(var d=0,e=a.items.saleList.getCount();d<e;++d){var f=a.items.saleList.getItem(d);CommDrawItem.drawItemIcon(f.exsubs.icon,b[d].itemres)}},i=function(){var b=CanSaleFilterEx.snew(a.g);c=b.filter(),a.items.myItemList.setItemCount(c.length);for(var d=0,e=a.items.myItemList.getCount();d<e;++d){var f=a.items.myItemList.getItem(d);CommDrawItem.drawItemIcon(f.exsubs.icon,c[d].itemres)}},j=function(){a.setListTipCaller(a.items.saleList,l)},k=function(){a.setListTipCaller(a.items.myItemList,m)},l=function(a){return TIPM.getItemDesc(b[a.idx],"sys")},m=function(a){return TIPM.getItemDesc(c[a.idx])},n=function(){if(!a.dlg.isShow())return;g()},o=function(a,c){var d=b[c];if(!d)return;var e=UIM.getDlg("buyitem");e.openDlg({id:0,resid:d.resid,number:1e4})},p=function(b,d){var e=c[d];if(!e)return;var f=function(b){b==MB_IDYES&&ShopSender.sendSaleItem(a.g,e)},g=ItemNameColorGetter.getColorVal(e.itemres.level,e.itemres.name),h=TQ.format(rstr.armopdlg.buyarms.lbl.saleMyItem,g,e.itemres.salePrice);a.g.getGUI().msgBox(rstr.comm.msgts,h,MB_F_YESNO,{self:a,caller:f})},q=function(a){if(a.items)return;a.items=[];var b=a.sitemIds.split(",");for(var c=0;c<b.length;++c){var d=TQ.trim(b[c]);if(d!=""){var e=parseInt(d,10);a.items.push({resid:e,isBind:1,itemres:ItemResUtil.findItemres(e)})}}var f=function(a,b){return a.itemres.level==b.itemres.level?a.itemres.apos-b.itemres.apos:b.itemres.level-a.itemres.level};a.items.sort(f)},r=function(a){b=[];for(var c=0;c<a.length;++c){var d=a[c],e=SysItemMaker.make(c+1,d.itemres);e.isBind=d.isBind,b.push(e)}}}),SplitArmOpPanel=BaseArmOpPanel.extern(function(){var a=null,b=[],c="";this.myArms=[],this.initPanel=function(){a=this,d(),e(),f()},this.update=function(){g(),j()};var d=function(){a.g.regEvent(EVT.PKG_CHANGE,0,a,o),a.g.regEvent(EVT.NET,NETCMD.ITEMOP,a,p)},e=function(){a.items.selectAll.setCaller({self:a,caller:s}),a.items.armLevelDropList.setCaller({self:a,caller:t}),a.items.armList.setCaller({self:a,caller:u}),a.items.splitBtn.setCaller({self:a,caller:v})},f=function(){var b=rstr.armopdlg.splitarms.itemLevels;for(var c in b)a.items.armLevelDropList.addItem({text:b[c]});a.items.armLevelDropList.setCurSel(0)},g=function(){h(),a.sortArms(a.myArms),i(),l()},h=function(){var b=CanSplitArmFilter.snew(a.g),c=b.filter(),d=ItemLevelFilter.snew();a.myArms=d.filter({itemLevel:w(),items:c})},i=function(){a.setMyArmListItems(a.items.armList,a.myArms)},j=function(){k(),m()},k=function(){b=n(),a.items.essenceList.setItemCount(b.length);for(var c=0,d=a.items.essenceList.getCount();c<d;++c){var e=a.items.essenceList.getItem(c),f=b[c];CommDrawItem.drawIconAndNumber(e,f)}},l=function(){a.setListTipCaller(a.items.armList,q)},m=function(){a.setListTipCaller(a.items.essenceList,r)},n=function(){var b=[FIXID.ESSENCE_LVL1,FIXID.ESSENCE_LVL2,FIXID.ESSENCE_LVL3,FIXID.ESSENCE_LVL4,FIXID.ESSENCE_LVL5],c=[];for(var d=0;d<b.length;++d){var e=b[d],f=a.g.getImgr().getItemNumByResId(e),g=ItemResUtil.findItemres(e);g.nobindid&&(g=ItemResUtil.findItemres(g.nobindid)),c.push({number:f,resid:g.id,itemres:g})}return c},o=function(){if(!a.dlg.isShow())return;a.update()},p=function(b){if(!b.data.splitResults)return;for(var d=0;d<b.data.splitResults.length;++d){var e=b.data.splitResults[d];e.resid==FIXID.REFINESTONE?c+=TQ.format(rstr.armopdlg.splitarms.svr.returnResult,e.forceLevel,RStrUtil.getNameByResId(e.armResid),e.number):c+=TQ.format(rstr.armopdlg.splitarms.svr.splitResult,RStrUtil.getNameByResId(e.armResid),RStrUtil.getNameByResId(e.resid),e.number)}TQ.setHtml(a.items.result.getContainerObj(),c),a.items.result.refresh(),a.items.result.scrollEnd()},q=function(b){return TIPM.getItemDesc(a.myArms[b.idx])},r=function(a){return TIPM.getItemDesc(b[a.idx])},s=function(){var b=a.items.selectAll.getCheck();y(b)},t=function(a,b){g(),x()},u=function(b,c){if(c<0||c>=a.items.armList.getCount())return;var d=a.items.armList.getItem(c),e=d.exsubs.sel.getCheck()?0:1;d.exsubs.sel.setCheck(e)},v=function(){var b=[];for(var c=0;c<a.myArms.length;++c){var d=a.items.armList.getItem(c);d.exsubs.sel.getCheck()==1&&b.push(a.myArms[c].id)}b.length==0?a.g.getGUI().sysMsgTips(SMT_WARNING,rstr.ids[100025].msg):(ItemOpSender.sendDecomposeIds(a.g,b),x())},w=function(){return a.items.armLevelDropList.getCurSel()},x=function(){y(0)},y=function(b){for(var c=0,d=a.items.armList.getCount();c<d;++c){var e=a.items.armList.getItem(c);e.exsubs.sel.setCheck(b)}}}),IntensifyArmOpPanel=BaseArmOpPanel.extern(function(){var a=null,b=null;this.initPanel=function(){a=this,b=ArmListWithHerosAndArmPos.snew(this.g,this,this.items),c(),d(),e()},this.update=function(){b.updateHeroList(),b.updateArmList(),t()};var c=function(){a.g.regEvent(EVT.PKG_CHANGE,0,a,g),a.g.regEvent(EVT.NET,NETCMD.ITEMOP,a,h)},d=function(){a.items.armList.setCaller({self:a,caller:i}),a.items.buyMaterial1Btn.setCaller({self:a,caller:j}),a.items.buyMaterial2Btn.setCaller({self:a,caller:k}),a.items.intensifyBtn.setCaller({self:a,caller:l})},e=function(){TTIP.setCallerData(a.items.tooltips[TIP_PREFIX+"curarm"],{self:a,caller:f},{})},f=function(){return TIPM.getItemDesc(b.getCurSelArm())},g=function(){if(!a.dlg.isShow())return;b.updateArmList(),t()},h=function(b){if(!b.data.intensifyResult)return;var c=b.data.intensifyResult.forceLevel-1,d=res_force_arms[c],e=TQ.format(rstr.armopdlg.intensifyarms.svr.intensifyResult,RStrUtil.getNameByResId(b.data.intensifyResult.resid),d.effect);TQ.setTextEx(a.items.result,e)},i=function(a,c){var d=b.getCurSelArm();if(!d){m();return}n(d),o(d),p(d),q(d),r(d),s(d),t()},j=function(){var a=UIM.getDlg("buyitem");a.openDlg({id:0,resid:FIXID.REFINESTONE,number:1e5})},k=function(){var a=[3000074,3000075,3000076];UIM.getDlg("buyitemlist").openDlg(a)},l=function(){TQ.setTextEx(a.items.result,"");var c=b.getCurSelArm();if(!c){a.g.getGUI().sysMsgTips(SMT_WARNING,rstr.armopdlg.intensifyarms.tips.noselectArm);return}if(D(G(c))){a.g.getGUI().sysMsgTips(SMT_WARNING,rstr.armopdlg.intensifyarms.tips.maxForceLevel);return}if(!E(c))return;ItemOpSender.sendIntensifyArm(a.g,b.getCurHeroId(),c.id)},m=function(){v(),w(),x(),y(),z(),A(),B()},n=function(b){CommDrawItem.drawItemIconAndName(a.items.curIcon,a.items.curName,b.itemres)},o=function(b){TQ.setTextEx(a.items.strength,F(b,ATTR.ST_B,ATTR.ST_A)),TQ.setTextEx(a.items.agile,F(b,ATTR.AG_B,ATTR.AG_A)),TQ.setTextEx(a.items.physical,F(b,ATTR.PH_B,ATTR.PH_A))},p=function(b){TQ.setTextEx(a.items.curIntensifyLevel,TQ.format(rstr.armopdlg.intensifyarms.lbl.forceLevelTitle,G(b)));var c=H(G(b)),d=c?c.effect:0;TQ.setTextEx(a.items.curIntensifyEffect,TQ.format(rstr.armopdlg.intensifyarms.lbl.forceLevelEffect,d))},q=function(b){if(D(G(b))){u();return}var c=G(b)+1;TQ.setTextEx(a.items.nextIntensifyLevel,TQ.format(rstr.armopdlg.intensifyarms.lbl.forceLevelTitle,c));var d=I(G(b));TQ.setTextEx(a.items.nextIntensifyEffect,TQ.format(rstr.armopdlg.intensifyarms.lbl.forceLevelEffect,d.effect))},r=function(b){if(D(G(b))){z();return}var c=I(G(b));for(var d=0;d<2;++d){var e=c.expends[d];TQ.setTextEx(a.items["needMaterial"+(d+1)],TQ.format(rstr.armopdlg.intensifyarms.lbl.needItemNumber,RStrUtil.getNoBindNameByResId(e.resid),e.val))}},s=function(b){if(D(G(b))){TQ.setTextEx(a.items.succPro,"");return}var c=I(G(b));TQ.setTextEx(a.items.succPro,TQ.format(rstr.armopdlg.intensifyarms.lbl.successPro,c.succPro))},t=function(){var c=b.getCurSelArm();if(!c){A();return}if(D(G(c))){A();return}var d=I(G(c));for(var e=0;e<2;++e){var f=d.expends[e];TQ.setTextEx(a.items["hasMaterial"+(e+1)],TQ.format(rstr.armopdlg.intensifyarms.lbl.curHasItemNumber,a.g.getImgr().getItemNumByResId(f.resid)))}},u=function(){TQ.setTextEx(a.items.nextIntensifyLevel,rstr.armopdlg.intensifyarms.lbl.fullForceLevelTitle),TQ.setTextEx(a.items.nextIntensifyEffect,rstr.armopdlg.intensifyarms.lbl.fullForceLevelEffect)},v=function(){C(["curName"]),IMG.setBKImage(a.items.curIcon,""),TQ.setClass(a.items.curIcon,"")},w=function(){C(["strength","agile","physical"])},x=function(){C(["curIntensifyLevel","curIntensifyEffect"])},y=function(){C(["nextIntensifyLevel","nextIntensifyEffect"])},z=function(){C(["needMaterial1","needMaterial2"])},A=function(){C(["hasMaterial1","hasMaterial2"])},B=function(){C(["succPro"])},C=function(b){for(var c in b)TQ.setTextEx(a.items[b[c]],"")},D=function(a){return a>=res_max_forcelevel},E=function(b){var c=I(G(b));for(var d=0;d<2;++d){var e=c.expends[d];if(a.g.getImgr().getItemNumByResId(e.resid)<e.val)return a.g.getGUI().sysMsgTips(SMT_WARNING,TQ.format(rstr.armopdlg.intensifyarms.tips.noEnoughExpends,RStrUtil.getNoBindNameByResId(e.resid))),!1}return!0},F=function(a,b,c){if(!a||!a.attrs)return"";if(!a.attrs[b]||a.attrs[b].val==0)return"";var d=a.attrs[b].val;return a.attrs[c]&&a.attrs[c].val>0&&(d+=TQ.formatColorStr("(+"+a.attrs[c].val+")",COLORS.APPEND_ATTR)),d},G=function(a){return!a||!a.flevel?0:a.flevel},H=function(a){var b=a-1;return res_force_arms[b]},I=function(a){return H(a+1)}}),BesetGemOpPanel=BaseArmOpPanel.extern(function(){var a=null,b=null,c=0;this.initPanel=function(){a=this,b=ArmListWithHerosAndArmPos.snew(this.g,this,this.items),d(),e(),f(),g()},this.update=function(){b.updateHeroList(),b.updateArmList()},this.setListItemSecField=function(a,b){for(var c=0;c<MAX_GEMS_POS_COUNT;++c){var d=a.exsubs["gem"+(c+1)];if(b.gems&&b.gems[c]){var e=ItemResUtil.findItemres(b.gems[c]);IMG.setBKImage(d,IMG.makeSmallImg(e.smallpic)),TQ.setTextEx(d,e.gemLevel)}else IMG.setBKImage(d,""),TQ.setTextEx(d,"")}};var d=function(){a.g.regEvent(EVT.PKG_CHANGE,0,a,j),a.g.regEvent(EVT.NET,NETCMD.ITEMOP,a,k)},e=function(){a.items.buyGemBtn.setCaller({self:a,caller:m});for(var b=1;b<=MAX_GEMS_POS_COUNT;++b)a.items["upgradeGem"+b].setCaller({self:a,caller:n}),a.items["besetGem"+b].setCaller({self:a,caller:o});a.items.unbesetAllBtn.setCaller({self:a,caller:p}),a.items.armList.setCaller({self:a,caller:l})},f=function(){TTIP.setCallerData(a.items.tooltips[TIP_PREFIX+"curarm"],{self:a,caller:h},{})},g=function(){for(var b=0;b<MAX_GEMS_POS_COUNT;++b)TTIP.setCallerData(a.items.tooltips[TIP_PREFIX+"gem"+(b+1)],{self:a,caller:i},{idx:b})},h=function(){return TIPM.getItemDesc(b.getCurSelArm())},i=function(a){var c=s(b.getCurSelArm(),a.idx);if(!c)return"";var d={id:0,resid:c,itemres:ItemResUtil.findItemres(c)};return TIPM.getItemDesc(d)},j=function(){if(!a.dlg.isShow())return;b.updateArmList(),t()},k=function(a){},l=function(a,b){t()},m=function(){UIM.getDlg("buyitemlist").openDlg(res_canbuy_gems)},n=function(a){var c=s(b.getCurSelArm(),a);if(!c)return;var d=a;UIM.getDlg("upgradegem").openDlg(b.getCurHeroId(),b.getCurSelArm().id,d,c)},o=function(d){var e=b.getCurSelArm();if(!e)return;c=d;var f=s(e,c);f?ItemOpSender.sendUnbesetGem(a.g,b.getCurHeroId(),e.id,c):r()},p=function(){var c=b.getCurSelArm();if(!c)return;ItemOpSender.sendUnbesetAllGems(a.g,b.getCurHeroId(),c.id)},q=function(d){var e=b.getCurSelArm();return GemUtil.hasSameTypeGems(e,d.resid)?(a.g.getGUI().sysMsgTips(SMT_WARNING,rstr.armopdlg.besetGems.tip.hasSameGem),RET_CONTINUE):(ItemOpSender.sendBesetGem(a.g,b.getCurHeroId(),e.id,c,d.resid),RET_END)},r=function(){var b=UIM.getDlg("filteritemex");b.setCaller({self:a,caller:q}),b.openDlg({title:rstr.getmlistdlg.title,filter:"gem"})},s=function(a,b){return!a||!a.gems||!a.gems[b]?0:a.gems[b]},t=function(){var a=b.getCurSelArm();if(!a){u();return}v(a),w(a),x(a),y(a),z(a),A(a)},u=function(){IMG.setBKImage(a.items.curIcon,""),TQ.setClass(a.items.curIcon,"");for(var b=1;b<=MAX_GEMS_POS_COUNT;++b)IMG.setBKImage(a.items["gemIcon"+b],""),TQ.setClass(a.items["gemIcon"+b],""),a.items["upgradeGem"+b].enable(!1),a.items["besetGem"+b].enable(!1);a.items.unbesetAllBtn.enable(!1)},v=function(b){CommDrawItem.drawItemIcon(a.items.curIcon,b.itemres)},w=function(b){for(var c=0;c<MAX_GEMS_POS_COUNT;++c)IMG.setBKImage(a.items["gemIcon"+(c+1)],""),TQ.setClass(a.items["gemIcon"+(c+1)],"");for(var c=0;c<b.gems.length;++c){var d=b.gems[c];if(!d)continue;var e=ItemResUtil.findItemres(d);CommDrawItem.drawItemIcon(a.items["gemIcon"+(c+1)],e)}},x=function(b){for(var c=1;c<=MAX_GEMS_POS_COUNT;++c){var d=a.items["besetGem"+c];d.setText(b.gems[c-1]?rstr.armopdlg.besetGems.btn.removeGem:rstr.armopdlg.besetGems.btn.besetGem)}},y=function(b){for(var c=1;c<=MAX_GEMS_POS_COUNT;++c)a.items["besetGem"+c].enable(!0)},z=function(b){for(var c=1;c<=MAX_GEMS_POS_COUNT;++c){var d=a.items["upgradeGem"+c],e=b.gems[c-1];!e||GemUtil.isMaxGemLevel(e)?d.enable(!1):d.enable(!0)}},A=function(b){for(var c=0;c<MAX_GEMS_POS_COUNT;++c)if(b.gems[c]){a.items.unbesetAllBtn.enable(!0);return}a.items.unbesetAllBtn.enable(!1)}}),CombineGemOpPanel=BaseArmOpPanel.extern(function(){var a=2,b=4,c=null,d=[];this.initPanel=function(){c=this,e(),f(),g(),h()},this.update=function(){i()},this.setListItemSecField=function(a,b){TQ.setTextEx(a.exsubs.levelOrNumber,b.number)};var e=function(){c.g.regEvent(EVT.PKG_CHANGE,0,c,y),c.g.regEvent(EVT.NET,NETCMD.ITEMOP,c,z)},f=function(){TTIP.setCallerData(c.items.tooltips[TIP_PREFIX+"willGemIcon"],{self:c,caller:q},{}),c.items.lowGemsList.setItemCount(5);for(var a=0,b=c.items.lowGemsList.getCount();a<b;++a){var d=c.items.lowGemsList.getItem(a);TTIP.setCallerData(d.exsubs.tooltips[TIP_PREFIX+"item"],{self:c,caller:r},{idx:a})}c.items.gemClassDorpList.setCaller({self:c,caller:s}),c.items.myGemsList.setCaller({self:c,caller:t}),c.items.combineLevelList.setCaller({self:c,caller:u}),c.items.combineGem.setCaller({self:c,caller:v}),c.items.combineGems.setCaller({self:c,caller:w}),c.items.buyGem.setCaller({self:c,caller:x})},g=function(){var a=rstr.armopdlg.combineGems.gemClassNames;for(var b in a)c.items.gemClassDorpList.addItem({text:a[b]});c.items.gemClassDorpList.setCurSel(0)},h=function(){var a=rstr.armopdlg.combineGems.combineLevels;c.items.combineLevelList.setItemCount(a.length);for(var b=0;b<a.length;++b){var d=c.items.combineLevelList.getItem(b);TQ.setTextEx(d.exsubs.desc,a[b])}},i=function(){j(),k(),l(),m(),n(),o()},j=function(){var a=[RES_CLS.GEMITEM,RES_CLS.ST_GEMITEM,RES_CLS.AG_GEMITEM,RES_CLS.PH_GEMITEM,RES_CLS.CO_GEMITEM],b=ItemClassRangeFilter.snew(c.g),e=a[c.items.gemClassDorpList.getCurSel()];d=b.filter({classId:e})},k=function(){var a={};for(var b in d){var c=d[b];if(!a[c.resid]){var e={};TQ.dictCopy(e,c),a[c.resid]=e}else a[c.resid].number+=c.number}d=TQ.dictToList(a)},l=function(){var a=function(a,b){return a.resid-b.resid};d.sort(a)},m=function(){c.setMyArmListItems(c.items.myGemsList,d)},n=function(){c.resetListCurSel(c.items.myGemsList)},o=function(){c.setListTipCaller(c.items.myGemsList,p)},p=function(a){return TIPM.getItemDesc(d[a.idx])},q=function(a){return TIPM.getItemDesc(D())},r=function(a){return TIPM.getItemDesc(H(a.idx))},s=function(a,b){i()},t=function(a,b){K()},u=function(b,d){Q(),R(),N();if(d<0)return;if(G()==0)return;if(G()<a){c.g.getGUI().sysMsgTips(SMT_WARNING,rstr.ids[100032].msg);return}if(GemUtil.isMaxGemLevel(J())){c.g.getGUI().sysMsgTips(SMT_WARNING,rstr.ids[100031].msg);return}var e=d+1;F(e)>G()&&(c.g.getGUI().sysMsgTips(SMT_WARNING,rstr.ids[100032].msg),d=L()-1),M(d),S(),T()},v=function(){B()},w=function(){A()},x=function(){UIM.getDlg("buyitemlist").openDlg(res_canbuy_gems)},y=function(){if(!c.dlg.isShow())return;i()},z=function(a){},A=function(){if(!C())return;var a=Math.floor(G()/GemUtil.getCombineNeedNumber(O())),b=rstr.armopdlg.combineGems.combineLevelNames[O()-1],d=TQ.format(rstr.armopdlg.combineGems.batchCombine,b.name,a,b.pro);c.g.getGUI().msgBox(rstr.comm.msgts,d,MB_F_YESNO,{self:c,caller:function(a){a==MB_IDYES&&ItemOpSender.sendCombineGems(c.g,J(),O(),!0)}})},B=function(){if(!C())return;if(O()==4){ItemOpSender.sendCombineGems(c.g,J(),O(),!1);return}var a=rstr.armopdlg.combineGems.combineLevelNames[O()-1],b=TQ.format(rstr.armopdlg.combineGems.proCommCombine,a.pro);c.g.getGUI().msgBox(rstr.comm.msgts,b,MB_F_YESNO,{self:c,caller:function(a){a==MB_IDYES&&ItemOpSender.sendCombineGems(c.g,J(),O(),!1)}})},C=function(){return G()==0?!1:GemUtil.isMaxGemLevel(J())?(c.g.getGUI().sysMsgTips(SMT_WARNING,rstr.ids[100031].msg),!1):O()==0?(c.g.getGUI().sysMsgTips(SMT_WARNING,rstr.ids[100032].msg),!1):!0},D=function(){if(G()==0||GemUtil.isMaxGemLevel(J()))return null;var a=P(J());return{id:0,resid:a,itemres:ItemResUtil.findItemres(a)}},E=function(){return F(O())},F=function(a){var b={1:2,2:3,3:4,4:5},c=b[a];return c?c:0},G=function(){var a=I();return a?a.number?a.number:0:0},H=function(a){if(a>=E())return null;var b=I();return b?{id:0,resid:b.resid,itemres:b.itemres,number:1}:null},I=function(){return d[c.items.myGemsList.getCurSel()]},J=function(){var a=I();return a?a.resid:0},K=function(){var a=L()-1;c.items.combineLevelList.setCurSel(a)},L=function(){return Math.min(G()-a+1,b)},M=function(a){N(),c.items.combineLevelList.getItem(a).exsubs.sel.setCheck(1)},N=function(){for(var a=0,b=c.items.combineLevelList.getCount();a<b;++a){var d=c.items.combineLevelList.getItem(a);d.exsubs.sel.setCheck(0)}},O=function(){for(var a=0,b=c.items.combineLevelList.getCount();a<b;++a){var d=c.items.combineLevelList.getItem(a);if(d.exsubs.sel.getCheck()==1)return a+1}return 0},P=function(a){return a+1},Q=function(){IMG.setBKImage(c.items.willGemIcon,""),TQ.setClass(c.items.willGemIcon,""),c.items.combineGem.enable(!1),c.items.combineGems.enable(!1)},R=function(){c.items.lowGemsList.setItemCount(0)},S=function(){var a=D();CommDrawItem.drawItemIcon(c.items.willGemIcon,a.itemres),c.items.combineGem.enable(!0),c.items.combineGems.enable(!0)},T=function(){var a=I(),b=E();c.items.lowGemsList.setItemCount(b);for(var d=0;d<b;++d){var e=c.items.lowGemsList.getItem(d);CommDrawItem.drawItemIcon(e.exsubs.icon,a.itemres)}}}),UpgradeGemDlg=Class.extern(function(){var a=5,b=null,c=null,d=null,e={},f=0,g=0,h=0,i=0,j={},k={};this.init=function(a){b=a,c=this},this.openDlg=function(a,b,c,d){l(),m(),n(a,b,c,d)};var l=function(){if(d)return;d=Dialog.snew(b,{modal:!0,title:rstr.upgradegemdlg.title,pos:{x:"center",y:30}}),b.getGUI().initDlg(d,uicfg.upgradegemdlg,e),u(),v()},m=function(){d.show()},n=function(a,b,c,d){i=d,f=a,g=b,h=c,o(),p(),q(),r(),s(),t()},o=function(){j=w(i)},p=function(){k=w(B(i))},q=function(){x(e.srcIcon,e.srcName,j)},r=function(){x(e.desIcon,e.desName,k)},s=function(){e.upgradeBtn.enable(y())},t=function(){TQ.setCSS(e.canDesc,"display",y()?"block":"none"),TQ.setCSS(e.needDesc,"display",y()?"none":"block");if(!y()){var b=rstr.upgradegemdlg.lbl.needDesc,c=TQ.format(b,a,j.itemres.name,A());TQ.setTextEx(e.needDesc,HyperLinkMgr.formatLink(c))}},u=function(){e.upgradeBtn.setCaller({self:c,caller:C})},v=function(){TTIP.setCallerData(e.tooltips[TIP_PREFIX+"src"],{self:c,caller:D},{}),TTIP.setCallerData(e.tooltips[TIP_PREFIX+"des"],{self:c,caller:E},{})},w=function(a){return{resid:a,itemres:ItemResUtil.findItemres(a)}},x=function(a,b,c){IMG.setBKImage(a,IMG.makeBigImg(c.itemres.bigpic)),TQ.setTextEx(b,c.itemres.name)},y=function(){return z()<=0},z=function(){return a-A()},A=function(){return b.getImgr().getItemNumByResId(j.resid)+1},B=function(a){return a+1},C=function(){ItemOpSender.sendUpgradeGem(b,f,g,h,j.resid),d.hide()},D=function(){return TIPM.getItemDesc(j)},E=function(){return TIPM.getItemDesc(k)}})