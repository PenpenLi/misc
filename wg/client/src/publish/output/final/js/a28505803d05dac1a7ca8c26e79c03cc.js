SoldierDlgView=Class.extern(function(){var a,b,c,d={},e=null;this.init=function(c){a=c,b=this},this.getCtrl=function(a){return d[a]},this.openDlg=function(){f(),g(),this.refreshNewcomerSpirit()},this.closeDlg=function(){c&&c.hide()},this.setPresenter=function(a){e=a},this.isShow=function(){return c&&c.isShow()},this.updateView=function(){h()},this.refreshNewcomerSpirit=function(){HelpGuider.getNewcomerSpirit().onDlgOpen("soldier",{parent:c.getParent(),items:d})};var f=function(){c||(c=Dialog.snew(a,{modal:!1,title:rstr.soldierdlg.title,pos:{x:"center",y:30}}),a.getGUI().initDlg(c,uicfg.soldier.soldierdlg,d),e&&e.initDlg(),c.setCaller({self:b,caller:function(a){a==C_SYS_DLG_HIDE&&HelpGuider.getNewcomerSpirit().onDlgClose("soldier")}})),c.show()},g=function(){h(),d.cantraininglist.setCurSel(0),d.isoldiernum.setVal(1)},h=function(){if(!b.isShow())return;i(),j(),k(),l()},i=function(){var b=a.getImgr();TQ.setTextEx(d.newsoldier,TQ.format(rstr.soldierdlg.lbl.newsoldier,b.getRoleAttrVal(ATTR.NAF),b.getRoleAttrVal(ATTR.MNAF))),TQ.setTextEx(d.totalsoldier,TQ.format(rstr.soldierdlg.lbl.totalsoldier,b.getRoleAttrVal(ATTR.AF),b.getRoleAttrVal(ATTR.MAF))),TQ.setTextEx(d.soldieroutput,TQ.format(rstr.soldierdlg.lbl.soldieroutput,b.getRoleAttrVal(ATTR.NAFO)))},j=function(){var b=d.hassoldierlist.getCount(),c=a.getImgr().getSoldiers();d.hassoldierlist.setItemCount(c.length);for(var f=0;f<c.length;++f){var g=c[f],h=d.hassoldierlist.getItem(f);TQ.setText(h.exsubs.name,RStrUtil.getSoldierNameByResId(g.id)),TQ.setText(h.exsubs.num,g.number)}b!=d.hassoldierlist.getCount()&&e.resetHasSoldierListCaller()},k=function(){var b=d.cantraininglist.getCount();for(var c=0;c<b;++c){var e=d.cantraininglist.getItem(c),f=a.getImgr().getTrainCultureByIdx(c),g=FIXID.FIRSTSOLDIER+c,h=ItemResUtil.findItemres(g);IMG.setBKImage(e.exsubs.icon,IMG.makeBigImg(h.bigpic));var i=ItemResUtil.makeLevelResid(g,Math.max(1,f.level));TQ.setText(e.exsubs.name,RStrUtil.getSoldierNameByResIdAndLevel(i,f.level))}},l=function(){var b=a.getImgr();TQ.setText(d.curmoney,b.getMoney()),TQ.setText(d.curfood,b.getCityRes().cres.food),TQ.setText(d.curnewsoldier,b.getRoleAttrVal(ATTR.NAF))}}),SoldierDlgModel=Class.extern(function(){var a=null,b=null,c=null;this.init=function(c){a=c,b=this},this.setView=function(a){c=a},this.handleSoldierSvrPkg=function(b){if(b.soldiers){var d=a.getImgr().getSoldiers();TQ.dictCopy(d,b.soldiers),a.sendEvent({eid:EVT.SOLDIERRES,sid:0}),c.updateView()}}}),SoldierDlgPresenter=Class.extern(function(){var m_g=null,m_this=null,m_view=null,m_model=null,m_curTrainIdx=-1;this.init=function(a,b,c){m_g=a,m_this=this,m_view=b,m_model=c,m_view.setPresenter(m_this),m_model.setView(m_view),m_g.regEvent(EVT.ROLEBASE,0,m_this,_onRolebaseChange),m_g.regEvent(EVT.CITYRES,0,m_this,_onCityResChange),m_g.regEvent(EVT.LOGIN_OK,0,m_this,_onLoginOk),m_g.regEvent(EVT.NET,NETCMD.SOLDIERRES,m_this,_onSoldierSvrPkg)},this.openDlg=function(){m_view.openDlg()},this.closeDlg=function(){m_view.closeDlg()},this.hideDlg=function(){this.closeDlg()},this.initDlg=function(){_setCallers()},this.getView=function(){return m_view},this.resetHasSoldierListCaller=function(){var a=m_view.getCtrl("hassoldierlist");for(var b=0;b<a.getCount();++b){var c=a.getItem(b);c.exsubs.updsoldier.setId(b),c.exsubs.updsoldier.setCaller({self:m_this,caller:_onClickUpdSoldierBtn})}};var _setCallers=function(){m_view.getCtrl("addnewsoldier").setCaller({self:m_this,caller:_onClickAddNewSoldierListItem}),m_view.getCtrl("cantraininglist").setCaller({self:m_this,caller:_onClickCanTrainSoldierListItem}),m_view.getCtrl("isoldiernum").setCaller({self:m_this,caller:_onTrainSoldierNumberChange}),m_view.getCtrl("isoldiernum").setLimit(_onGetTrainSoldierNumberLimit),m_view.getCtrl("trainingbtn").setCaller({self:m_this,caller:_onClickTrainBtn})},_onRolebaseChange=function(){m_view.updateView()},_onCityResChange=function(){m_view.updateView()},_onLoginOk=function(){SoldierSender.sendGetSoldiers(m_g)},_onSoldierSvrPkg=function(a){m_model.handleSoldierSvrPkg(a.data)},_onClickAddNewSoldierListItem=function(){var a=m_g.getImgr().getRoleRes(),b=UIM.getDlg("uselistitem");b.openDlg([RES_EFF.ADD_NEWSOLDIER],{id:a.id,name:a.name,type:RES_TRG.SELF_ROLE})},_onClickCanTrainSoldierListItem=function(e,idx){m_curTrainIdx=idx;var res=_getCurSelTrainRes(),LV=_getCurSelCanTrainLevel();TQ.setText(m_view.getCtrl("strattr"),Math.round(eval(res.str))),TQ.setText(m_view.getCtrl("phyattr"),Math.round(eval(res.phy))),TQ.setText(m_view.getCtrl("agileattr"),Math.round(eval(res.agile))),TQ.setText(m_view.getCtrl("mspeedattr"),Math.round(eval(res.mspeed))),TQ.setText(m_view.getCtrl("arangeattr"),Math.round(eval(res.arange))),TQ.setText(m_view.getCtrl("aspeedattr"),Math.round(eval(res.aspeed))),m_view.getCtrl("isoldiernum").setVal(1),m_view.refreshNewcomerSpirit()},_onGetTrainSoldierNumberLimit=function(){var a=_getCurSelCanTrainLevel(),b=TQ.qfind(res_soldiers_upd,"level",a),c=m_g.getImgr(),d=parseInt(c.getMoney()/b.money,10),e=parseInt(c.getCityRes().cres.food/b.food,10),f=c.getRoleAttrVal(ATTR.NAF),g=c.getRoleAttrVal(ATTR.MAF)-c.getRoleAttrVal(ATTR.AF),h=Math.min(d,e,f,g);return h=Math.max(1,h),{min:1,max:h}},_onTrainSoldierNumberChange=function(a){_setNeedResLabels(a),m_view.refreshNewcomerSpirit()},_getCurSelCanTrainLevel=function(){var a=m_g.getImgr().getTrainCultureByIdx(m_curTrainIdx);return a.level>0?a.level:1},_getCurSelTrainRes=function(){return ItemResUtil.findItemres(FIXID.FIRSTSOLDIER+m_curTrainIdx)},_setNeedResLabels=function(a){var b=_getCurSelCanTrainLevel(),c=TQ.qfind(res_soldiers_upd,"level",b);TQ.setText(m_view.getCtrl("needfood"),c.food*a),TQ.setText(m_view.getCtrl("needmoney"),c.money*a),TQ.setText(m_view.getCtrl("neednewsoldier"),a)},_onClickTrainBtn=function(){var a=m_g.getImgr(),b=_getCurSelTrainRes(),c=_getCurSelCanTrainLevel(),d=m_view.getCtrl("isoldiernum").getVal(),e=function(){return d<=a.getRoleAttrVal(ATTR.NAF)},f=function(){var b=TQ.qfind(res_soldiers_upd,"level",c);return b.money*d<=a.getMoney()},g=function(){var b=TQ.qfind(res_soldiers_upd,"level",c);return b.food*d<=a.getCityRes().cres.food},h=function(){var a=m_g.getImgr().getTrainCultureByIdx(m_curTrainIdx);return a.level>0},i=function(){var b=a.getRoleAttrVal(ATTR.MAF)-a.getRoleAttrVal(ATTR.AF);return d<=b};if(!e()){m_g.getGUI().sysMsgTips(SMT_WARNING,rstr.soldierdlg.err.noNewSoldier);return}if(!f()){m_g.getGUI().sysMsgTips(SMT_WARNING,rstr.soldierdlg.err.noMoney);return}if(!g()){m_g.getGUI().sysMsgTips(SMT_WARNING,rstr.soldierdlg.err.noFood);return}if(!i()){m_g.getGUI().sysMsgTips(SMT_WARNING,rstr.soldierdlg.err.noCapacity);return}if(!h()){var j=m_g.getImgr().getTrainCultureByIdx(m_curTrainIdx),k=ItemResUtil.findItemres(j.id);m_g.getGUI().sysMsgTips(SMT_WARNING,TQ.format(rstr.soldierdlg.err.noCulture,k.name));return}SoldierSender.sendTraining(m_g,FIXID.FIRSTSOLDIER+m_curTrainIdx,d),m_view.getCtrl("isoldiernum").setVal(1)},_onClickUpdSoldierBtn=function(a){var b=m_g.getImgr().getSoldiers();UIM.getDlg("soldierop").openDlg(b[a])}})