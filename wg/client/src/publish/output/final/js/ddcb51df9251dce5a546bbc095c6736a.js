ChatDlg=Class.extern(function(){var a=1,b=2,c=255,d="<BR/>",e="#FFFFFF",f="#FFFFFF",g=500,h=337,i=18,j=1,j=1,k=[7,57,323,146],l=[7,29,323,174],m=1e3,n=50,o=null,p=null,q=null,r=null,s=null,t={},u=0,v=0,w=null,x=null;this.init=function(a){o=a,p=this,q=ChatConScroller.snew(o),w=FaceUtil.snew(o)},this.setUpCaller=function(a){x=a,s&&s.setUpCaller(x)},this.openDlg=function(a){y(a),z(),J(),K()},this.getCore=function(){return s},this.clear=function(){if(!s)return;q.clear(),W()},this.focus=function(){if(!s)return;t.ichat.getContainerObj().focus()},this.handleChatPkg=function(a){return X(a)};var y=function(a){r=a},z=function(){if(s)return;A(),B(),C(),D(),F(),E(),G(),H(),I()},A=function(){s=Dialog.snew(o,{modal:!1,canDrag:!0,dragTitleH:35,pos:{x:"center",y:80},uiback:uiback.dlg.friendmain}),o.getGUI().initDlg(s,uicfg.friend.chatdlg,t),s.setUpCaller(x)},B=function(){t.colorbtn=ColorPanelBtn.snew(o,t.colorbtn),t.colorbtn.setCaller({self:p,caller:P}),t.colorbtn.setDefaultColor(15)},C=function(){t.sizebtn=FontSizePanelBtn.snew(o,t.sizebtn),t.sizebtn.setCaller({self:p,caller:Q}),t.sizebtn.setDefaultSize(0)},D=function(){t.facebtn=FacePanelBtn.snew(o,t.facebtn),t.facebtn.setCaller({self:p,caller:O})},E=function(){InputLimit.maxGBKBytes(t.ichat.getContainerObj(),c)},F=function(){var a=function(a){var b=TQ.getValidEvent(a),c=TQ.getKeyCode(b);b.ctrlKey&&c==VK_KEY.RETURN&&(U(),TQ.preventDefault(b))};TQ.addEvent(t.ichat.getContainerObj(),"keydown",a)},G=function(){var a=t.ichat.getContainerObj();TQ.saveTextareaPos(a)},H=function(){q.initScroller(t.con,m,n)},I=function(){t.dlgclosebtn.setCaller({self:p,caller:R}),t.sendbtn.setCaller({self:p,caller:S}),t.clearbtn.setCaller({self:p,caller:T})},J=function(){if(s.isShow()){o.getGUI().upDlg(UI_ZORDER_DLG,s);return}s.show()},K=function(){L(),M(),N()},L=function(){var a=ItemResUtil.findItemres(r.icon);IMG.setBKImage(t.icon,IMG.makeBigImg(a.bigpic))},M=function(){TQ.setTextEx(t.name,r.roleName),TQ.setTextEx(t.level,RStrUtil.getCityNameByLevel(r.buildval.level)),TQ.setTextEx(t.sex,rstr.comm.sexs[r.sex])},N=function(){var a=FieldUtil.getPosByGridId(r.gridId),b=FieldUtil.getCityResIdByGridId(r.gridId),c=ItemResUtil.findItemres(b),d="#[m:"+a.x+":"+a.y+"]",e=c.name+" "+HyperLinkMgr.formatLink(d);TQ.setTextEx(t.city,e)},O=function(a){TQ.insertAtCursor(t.ichat.getContainerObj(),a.face)},P=function(a){u=a.idx},Q=function(a){v=a},R=function(){s.hide()},S=function(){U()},T=function(){q.clear()},U=function(){var a=V();if(a==""){W();return}FriendSender.sendFriendChat(o,r.roleId,a),Y(COLORS.FRIENDCHAT_MYCOLOR,o.getImgr().getRoleName(),o.getSvrTimeS(),a),W()},V=function(){var a=TQ.trimRight(t.ichat.getContainerObj().value);return a==""?"":(a=o.getGUI().encodeFont(a,u,v),TQ.encodeMessage(a))},W=function(){var a=t.ichat,b=a.getContainerObj();b.focus(),b.value="",a.refresh()},X=function(a){return Z()?a.roleId!=r.roleId?EVENT_RET_OK:(Y(COLORS.FRIENDCHAT_OTHERCOLOR,a.roleName,a.time,a.msg),EVENT_RET_BREAK):EVENT_RET_OK},Y=function(a,b,c,e){e=TQ.decodeMessage(e),e=o.getGUI().decodeFont(e),e=w.faceFormat(e);var f='<font color="'+a+'">'+b+" "+TQ.formatDateTime(c)+"</font>"+d,g='<div style="PADDING-LEFT:12px;">'+e+"</div>";q.append(f+g)},Z=function(){return s?s.isShow():!1}})