SelCityTool=Class.extern(function(){var a=-1,b=null,c=null,d=null;this.init=function(a,c){b=this,e(a,c),f()},this.setCurLoadCity=function(b){var c=a;g(b)?c=d.myCityBtn.getId():h(b)?c=d.outFieldBtn.getId():i(b)?c=d.myFarmBtn.getId():j(b)&&(c=d.myStateCityBtn.getId()),k(c),HelpGuider.getNewcomerSpirit().refreshCurNewcomerTask()},this.getBtn=function(a){if(a=="mycity")return d.myCityBtn;if(a=="myfarm")return d.myFarmBtn;if(a=="statecity")return d.myStateCityBtn;if(a=="outfield")return d.outFieldBtn};var e=function(a,b){c=a,d=b},f=function(){d.myCityBtn.setCaller({self:b,caller:l}),d.myFarmBtn.setCaller({self:b,caller:n}),d.myStateCityBtn.setCaller({self:b,caller:o}),d.outFieldBtn.setCaller({self:b,caller:m})},g=function(a){return a==FIXID.MAINCITY},h=function(a){return a==FIXID.OUTFIELD},i=function(a){return a!=FIXID.FARMMAP?!1:UIM.getPanel("farm").isMyCurFarm()},j=function(a){return c.getImgr().getStateCity()==a},k=function(a){var b=[d.myCityBtn,d.myFarmBtn,d.myStateCityBtn,d.outFieldBtn];for(var c=0;c<b.length;++c){var e=b[c];e.setPress(e.getId()==a)}},l=function(){UIM.closeMapPanels(),UIM.getPanel("inbuild").open()},m=function(){UIM.closeMapPanels(),UIM.getPanel("field").open(),HelpGuider.sendHelpTip(c,HelpGuider.HELP_TIP.FIGHT_OUTFIELD)},n=function(){UIM.closeMapPanels(),UIM.getPanel("farm").open()},o=function(){MapSender.sendEnterCity(c,c.getImgr().getStateCity())}}),MainPanel=function(){var a=24,b=128,c=20,d=20,e=18,f=40,g,h,i={},j,k,l,m,n=null,o,p,q,r,s,t,u,v,w=null,x=null,y=null,z=null,A=null,B=null,C=null;this.init=function(a){g=a,h=this,D()},this.getItems=function(){return i},this.getToolbar=function(){return m},this.getSmallMapBtnBar=function(){return n},this.getQueueMsgBar=function(){return p},this.getSelCityTool=function(){return v},this.getTraceBar=function(){return B},this.getSubCityBtnsBar=function(){return w},this.getSubCityPanels=function(){return x},this.getStateBuffBar=function(){return y},this.getResPanel=function(){return m_respanel},this.getTaskGuide=function(){return z},this.getOnlineTask=function(){return A},this.getOnlineGoods=function(){return C},this.getTeamGroup=function(){return new function(){this.openDlg=function(){},this.upDlg=function(){},this.downDlg=function(){}}},this.notifyTraceClose=function(a){a!="task"&&a=="building"&&i.trackbuildingbtn.setPress(!1)},this.hideGuestBindBtn=function(){TQ.setCSS(i.bindGuestUser.getParent(),"display","none")},this.regEvents=function(){g.regEvent(EVT.CITYRES,0,h,M)};var D=function(){var a=TQ.getUiBody();g.getGUI().initPanel(a,uicfg.main.mainpanel,i),j=RoleBasePanel.snew(g,i.role),UIM.regPanel("role",j),k=new SysMsgPanel(g,i),UIM.regPanel("sysmsg",k),TQ.isMobile()?(l=MiniChatPanel.snew(g,i.chat),UIM.regPanel("chat",l)):(l=new ChatPanel(g,i.chat),UIM.regPanel("chat",l)),s=SmallMapPanel.snew(g,i.smallmap),UIM.regPanel("smallmap",s),q=StateCityPanel.snew(g,i.map),UIM.regPanel("statecity",q),t=InBuildPanel.snew(g,i.map),UIM.regPanel("inbuild",t),r=BriefResPanel.snew(g,i),UIM.regPanel("briefres",r),u=FarmPresenter.snew(g,FarmView.snew(g,i.map),FarmModel.snew(g)),UIM.regPanel("farm",u),m_fieldpanel=FieldMapView.snew(g,i),UIM.regPanel("field",m_fieldpanel),z=TaskGuide.snew(g,i),C=OnlineGoodsPanel.snew(g,i),v=SelCityTool.snew(g,i),m=new MainToolbar(g,i),n=SmallMapBtnBar.snew(g,i),p=new QueueMsgBtn(g),w=SubCityBtnsBar.snew(g,i),x=SubCityPanels.snew(g,i.map),y=StateBuffBar.snew(g,i.buffBar),m_actBar=ActBar.snew(g,i.actBar),i.vipBtn.setCaller({self:h,caller:F}),i.rechargebtn.setCaller({self:h,caller:G}),i.officialbtn.setCaller({self:h,caller:H}),i.gonggaobtn.setCaller({self:h,caller:I}),TQ.isMobile()||(i.togglesyschat.setPress(!0),i.togglesyschat.setCaller({self:h,caller:E})),TQ.isMobile()&&(TQ.setCSS(i.smbtn_toggle_bgsound.getParent(),"display","none"),TQ.setCSS(i.smbtn_exchange.getParent(),"display","none"),TQ.setCSS(i.minitoolbar,"display","none")),B=TrackToolbar.snew(g,i),i.gameSuggestBtn.setCaller({self:h,caller:J}),h.regEvents(),g_isguest?i.bindGuestUser.setCaller({self:h,caller:K}):h.hideGuestBindBtn()},E=function(a){TQ.setCSS(i.sysmsg,"display",i.togglesyschat.isPress()?"block":"none"),k.refresh()},F=function(){UIM.openDlg("vip"),L(HelpGuider.HELP_TIP.OPEN_VIPDLG)},G=function(){JMISC.openPayWnd(),L(HelpGuider.HELP_TIP.OPEN_PAYDLG)},H=function(){JMISC.openOfficialWnd()},I=function(){UIM.openDlg("gonggao")},J=function(){var a=UIM.getDlg("inputareatext");a.openDlg(rstr.gameSuggest.title,"",rstr.gameSuggest.desc,512),a.setCaller({self:h,caller:function(a){LogSender.sendSuggest(g,a)}})},K=function(){UIM.getDlg("bindguest").openDlg()},L=function(a){var b=HDRM.getHdr("clientcfg").getHelpTipTimes(a);b<=2&&ClientCfgSender.sendSetHelpTip(g,a),HelpGuider.hideTipDlgById(a)},M=function(){var a=g.getImgr().getCityRes();a.buildval.cur<2e3?TQ.isMobile()?i.gameSuggestBtn.resetUIBack(uiback.mb.btn10_suggest_new):i.gameSuggestBtn.resetUIBack(uiback.btn.suggest_new):TQ.isMobile()?i.gameSuggestBtn.resetUIBack(uiback.mb.btn10_suggest):i.gameSuggestBtn.resetUIBack(uiback.btn.suggest)},N=function(){};this.init.apply(this,arguments)},TrackToolbar=Class.extern(function(){this.g_=null,this.items_=null,this.init=function(a,b){this.g_=a,this.items_=b,this._setCallers()},this.getBtn=function(a){if(a=="act")return this.items_.trackactbtn;if(a=="autobuild")return this.items_.trackautobuildbtn;if(a=="building")return this.items_.trackbuildingbtn},this._setCallers=function(){this.items_.trackactbtn.setCaller({self:this,caller:this._onClickTrackAct}),this.items_.trackbuildingbtn.setCaller({self:this,caller:this._onClickTrackBuilding}),this.items_.trackautobuildbtn.setCaller({self:this,caller:this._onClickTrackAutoBuild})},this._onClickTrackAct=function(){this._toggleDlg("activityval")},this._onClickTrackBuilding=function(){this.items_.trackbuildingbtn.isPress()?UIM.openDlg("buildingtrace"):UIM.getDlg("buildingtrace").closeDlg()},this._onClickTrackAutoBuild=function(){this._toggleDlg("autobuild")},this._toggleDlg=function(a){var b=UIM.getDlg(a);b.isShow()?b.hideDlg():UIM.openDlg(a)}}),MainToolbar=function(){var a=0,b=1,c=2,d=3,e=4,f=5,g=6,h=7,i=8,j=9,k=10,l=1e4,m,n,o,p=[],q={};this.init=function(a,b){m=a,n=this,o=b,s()};var r=function(){q={allianceBtn:o.mbtn_alli}};this.show=function(){},this.hide=function(){},this.startAllianceBlinking=function(a){o.mbtn_alli.startBlinking(a)},this.stopAllianceBlinking=function(){o.mbtn_alli.stopBlinking()},this.startTaskBlinking=function(a){o.mbtn_task.startBlinking(a)},this.stopTaskBlinking=function(){o.mbtn_task.stopBlinking()},this.getBtn=function(a){if(a=="role")return o.mbtn_role;if(a=="task")return o.mbtn_task;if(a=="hero")return o.mbtn_hero;if(a=="alli")return o.mbtn_alli;if(a=="exped")return o.mbtn_exped;if(a=="military")return o.mbtn_military;if(a=="pkg")return o.mbtn_pkg};var s=function(){o.mbtn_role.setCaller({self:n,caller:t}),o.mbtn_task.setCaller({self:n,caller:u}),o.mbtn_hero.setCaller({self:n,caller:v}),o.mbtn_alli.setCaller({self:n,caller:w}),o.mbtn_exped.setCaller({self:n,caller:x}),o.mbtn_military.setCaller({self:n,caller:y}),o.mbtn_pkg.setCaller({self:n,caller:z})},t=function(){A("role")},u=function(){A("task")},v=function(){A("hero")},w=function(){A("alli")},x=function(){A("expedition")},y=function(){A("military")},z=function(){A("package")},A=function(a){var b=UIM.getDlg(a);b.isShow()?b.hideDlg():UIM.openDlg(a)};this.init.apply(this,arguments)},SmallMapBtnBar=Class.extern(function(){var a=26,b=26,c=2e4,d=null,e=null,f=null;this.init=function(a,b){d=a,e=this,f=b,g(),h()},this.getBtnSize=function(){return{cx:a,cy:b}},this.getBtn=function(a){if(a=="shop")return f.smbtn_shop;if(a=="rank")return f.smbtn_rank;if(a=="letter")return f.smbtn_letter;if(a=="exchange")return f.smbtn_exchange;if(a=="bgsound")return f.smbtn_toggle_bgsound};var g=function(){f.smbtn_shop.setCaller({self:e,caller:i}),f.smbtn_rank.setCaller({self:e,caller:j}),f.smbtn_letter.setCaller({self:e,caller:k}),f.smbtn_exchange.setCaller({self:e,caller:l}),f.smbtn_toggle_bgsound.setCaller({self:e,caller:m})},h=function(){d.regEvent(EVT.NEW_MAIL,0,e,n)},i=function(){p("shop"),o("shop",0)},j=function(){p("rank"),o("rank")},k=function(){p("letter"),o("letter"),f.smbtn_letter.stopBlinking()},l=function(){TQ.isMobile()||p("exchange"),o("exchange")},m=function(){SoundMgr.toggleBackSound()},n=function(a){a.start?f.smbtn_letter.startBlinking(c):a.stop&&f.smbtn_letter.stopBlinking()},o=function(a,b){var c=UIM.getDlg(a);c.isShow()?c.hideDlg():isNull(b)?UIM.openDlg(a):UIM.openDlg(a,b)},p=function(a){var b=UIM.getDlg(a);if(b.isShow())return;var c={shop:HelpGuider.HELP_TIP.OPEN_SHOPDLG,rank:HelpGuider.HELP_TIP.OPEN_RANKDLG,letter:HelpGuider.HELP_TIP.OPEN_LETTERDLG,exchange:HelpGuider.HELP_TIP.OPEN_EXCHANGEDLG},e=c[a],f=HDRM.getHdr("clientcfg").getHelpTipTimes(e);f<=2&&ClientCfgSender.sendSetHelpTip(d,e),HelpGuider.hideTipDlgById(e)}}),QueueMsgBtn=function(){var a=[700,427,32,32],b,c,d,e,f,g=[];this.init=function(a){b=a,c=this,b.regEvent(EVT.NET,NETCMD.TEAM,c,k),b.regEvent(EVT.NET,NETCMD.ALLIANCE,c,l),h()},this.setPosition=function(a){if(!d)return;TQ.setDomPos(d,a.x,a.y)},this.setSize=function(a){};var h=function(){var g=TQ.getUiBody();d=TQ.createDom("div"),TQ.append(g,d),TQ.setCSS(d,"position","absolute"),TQ.setCSS(d,"zIndex","1000"),TQ.setDomRect(d,a[0],a[1],a[2],a[3]),e=new ComButton(b,d,{uiback:uiback.btn.queuemsg}),e.setCaller({self:c,caller:m}),f=BlinkingCtrl.snew(b),f.bind(d,null),j()},i=function(){TQ.setCSS(d,"display","block"),f.start(-1)},j=function(){f.stop(),TQ.setCSS(d,"display","none")},k=function(a){var b=a.data;b.invite&&(g.push({cmd:NETCMD.TEAM,invite:b.invite}),i()),b.applyleader&&(g.push({cmd:NETCMD.TEAM,applyleader:b.applyleader}),i()),b.changeleader&&(g.push({cmd:NETCMD.TEAM,changeleader:b.changeleader}),i())},l=function(a){var b=a.data;b.invite&&(g.push({cmd:NETCMD.ALLIANCE,invite:b.invite}),i())},m=function(a){if(g.length>0){var b=g[0];TQ.removeElement(g,0),g.length==0&&j(),b.cmd==NETCMD.TEAM?n(b):b.cmd==NETCMD.ALLIANCE&&o(b)}},n=function(a){a.invite?HDRM.getHdr("team").inviteMe(a.invite):a.applyleader?HDRM.getHdr("team").applyLeaderFromMe(a.applyleader):a.changeleader&&HDRM.getHdr("team").changeLeaderToMe(a.changeleader)},o=function(a){a.invite&&UIM.getDlg("alliinvite").inviteMe(a.invite)};this.init.apply(this,arguments)},SubCityBtnsBar=Class.extern(function(){var a=null,b=null,c=null,d=null,e=null,f=0;this.init=function(a,b){g(this,a,b),h(),i(),o()},this.setCurSubCityId=function(a){x(a),y(),z()},this.getCurSubCityId=function(){return f},this.getEmptySubCity=function(){for(var a=0;a<e.length;++a){var b=e[a],c=b.getId();if(!s(c)&&u(c))return b}return null};var g=function(f,g,h){b=f,a=g,c=h,d=[BUILDCITY_ID.SUB1,BUILDCITY_ID.SUB2,BUILDCITY_ID.SUB3,BUILDCITY_ID.SUB4],e=[c.city1btn,c.city2btn,c.city3btn,c.city4btn]},h=function(){for(var a=0;a<e.length;++a)e[a].setCaller({self:b,caller:q});c.myfieldsBtn.setCaller({self:b,caller:r})},i=function(){a.regEvent(EVT.CITYTYPES,0,b,j),a.regEvent(EVT.SETCITYLEVEL,0,b,k)},j=function(){HelpGuider.getNewcomerSpirit().refreshCurNewcomerTask(),l()},k=function(){HelpGuider.getNewcomerSpirit().refreshCurNewcomerTask(),l()},l=function(){for(var a=0;a<e.length;++a){var b=e[a];m(b),n(b)}},m=function(a){var b=a.getId();s(b)||u(b)?a.enable(!0):a.enable(!1)},n=function(b){var c=null,d=b.getId(),e=a.getImgr().getCityTypeByCityId(d);e==CITY_TYPE.SUBRES?c=uiback.btn.subCityBtns.resBtn:e==CITY_TYPE.SUBARMY?c=uiback.btn.subCityBtns.militaryBtn:c=uiback.btn.subCityBtns.emptyBtn,b.resetUIBack(c)},o=function(){for(var a=0;a<e.length;++a)TTIP.setCallerData(c.tooltips[TIP_PREFIX+"city"+(a+1)+"Btn"],{self:b,caller:p},{idx:a})},p=function(a){var b=d[a.idx];if(s(b))return rstr.createSubCity.tip.enterCity;if(u(b))return rstr.createSubCity.tip.createCity;var c=res_create_subcity_needcitylevels[b],e=RStrUtil.getCityNameByLevel(c);return TQ.format(rstr.createSubCity.tip.needCityLevel,e)},q=function(a){s(a)?v(a):t(a)},r=function(){UIM.openDlg("selffieldslist"),HelpGuider.sendHelpTip(a,HelpGuider.HELP_TIP.OPEN_MYFIELD)},s=function(b){return a.getImgr().getCityTypeByCityId(b)!=CITY_TYPE.NONE},t=function(b){if(!u(b)){var c=res_create_subcity_needcitylevels[b],d=RStrUtil.getCityNameByLevel(c),e=TQ.format(rstr.createSubCity.needCityLevel,d);a.getGUI().sysMsgTips(SMT_WARNING,e);return}UIM.openDlg("createsubcity",b,"create")},u=function(b){var c=res_create_subcity_needcitylevels[b];return c<=a.getImgr().getCityLevel()},v=function(a){UIM.closeMapPanels(),w(a).open()},w=function(a){return UIM.getPanel("main").getSubCityPanels().getPanel(a)},x=function(a){f=a},y=function(){for(var a=0;a<e.length;++a)e[a].setPress(!1)},z=function(){if(!TQ.find(d,null,b.getCurSubCityId()))return;e[TQ.getLastFindIdx()].setPress(!0)}}),SubCityPanels=Class.extern(function(){var a=null,b=null,c=null,d={};this.init=function(a,b){e(this,a,b),f()},this.getIterator=function(){return DictIterator.snew(d)},this.getPanel=function(a){return d[a]},this.hideAllPanels=function(){for(var a in d){var b=d[a];if(b==null)continue;b.hide(),b.setActive(!1)}};var e=function(d,e,f){b=d,a=e,c=f},f=function(){a.regEvent(EVT.CITYTYPES,0,b,g)},g=function(){var a=[BUILDCITY_ID.SUB1,BUILDCITY_ID.SUB2,BUILDCITY_ID.SUB3,BUILDCITY_ID.SUB4];for(var b=0;b<a.length;++b){var c=a[b];if(!h(c))continue;i(c),j(c),k(c)}},h=function(c){var d=a.getImgr().getCityTypeByCityId(c);if(d==CITY_TYPE.NONE)return!1;var e=b.getPanel(c);return e?e.getCityType()!=d:!0},i=function(a){d[a]&&d[a].destroy()},j=function(b){var e=a.getImgr().getCityTypeByCityId(b);e==CITY_TYPE.SUBRES?d[b]=ResSubBuildPanel.snew(a,c,b):e==CITY_TYPE.SUBARMY?d[b]=MilitarySubBuildPanel.snew(a,c,b):d[b]=null},k=function(b){var c=d[b];if(!c)return;c.open(),c.resize(a.getWinSizer().getCurSize()),c.resetViewPos()}})