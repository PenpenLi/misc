InnerUseItem=function(){var a,b,c,d,e,f,g,h=-1;this.initialize=function(d,e){a=d,b=this,c=e,i()},this.setItems=function(a){g=a,j()},this.setCurIdx=function(a){d.select(a)},this.getItemId=function(){return h};var i=function(){TQ.appendClass(c,"inneruseitem"),TQ.setHtml(c,rui.useitem.useinner.con),e=TQ.getSubDom(c,rui.useitem.useinner.items.uselist),f=TQ.getSubDom(c,rui.useitem.useinner.items.desc),d=new RadioGroup(!0),d.setCaller({self:b,caller:k})},j=function(){for(var b=0;b<g.length;++b){var c=g[b],f=new RadioBox(a,e);d.append(f);var h=ItemResUtil.findItemres(c.id);h!=null&&(f.setId(b),f.setText(h.name))}},k=function(a){l(a)},l=function(a){h=-1;if(a>=0&&a<g.length){var b=g[a],c=ItemResUtil.findItemres(b.id);c!=null&&(h=b.id,TQ.setHtml(f,c.desc))}h<0&&g.length>=2&&TQ.setHtml(f,rstr.useitem.innerpanel.defaultdesc)};this.initialize.apply(this,arguments)},BuyPrice=Class.extern(function(){this.getPrice=function(a,b){if(a>=0)return b[a];for(var c=0;c<b.length;++c)if(b[c]>0)return b[c];return 0},this.getUnit=function(a,b){if(a>=0)return rstr.shop.buyitem.paynames[a];var c="";for(var d=0;d<b.length;++d){if(b[d]==0)continue;c!=""&&(c+="/"),c+=rstr.shop.buyitem.paynames[d]}return c}}).snew(),BuyItemDlg=Class.extern(function(){var a=null,b=null,c={},d=null,e=null,f=null,g=null,h=null,i=999;this.init=function(c){a=c,b=this},this.openDlg=function(a,b){n(a);if(!m())return;j(),k()},this.hideDlg=function(){d&&d.hide()};var j=function(){d?d.show():(d=Dialog.snew(a,{modal:!1,title:rstr.shop.buyitem.title,pos:{x:"center",y:25},btns:[{btn:{id:0,text:rstr.comm.buyAndUse},caller:{self:b,caller:r}},{btn:{id:0,text:rstr.comm.buy},caller:{self:b,caller:q}},{btn:{id:0,text:rstr.comm.cancel},caller:{self:b,caller:u}}]}),a.getGUI().initDlg(d,uicfg.buy.buyitemdlg,c),c.inum.setCaller({self:b,caller:v}),c.inum.setLimit(w))},k=function(){var b=a.getImgr();g=[b.getMoney(),b.getGold(),b.getGiftGold(),b.getPrestige(),b.getRoleRes().cityhonor],CommDrawItem.drawItemIconAndName(c.icon,c.name,f),TQ.setText(c.price,p()),TQ.setTextEx(c.desc.getContainerObj(),f.desc),c.desc.refresh(),c.inum.setVal(1),c.payment.select(c.payment.getRadio(0).getId()),l()},l=function(){!f.targets||f.targets.length==0||!f.canBuyAndUse?d.getBtns()[0].hidden():d.getBtns()[0].visible()},m=function(){return o()?!0:(a.getGUI().msgBox(rstr.comm.msgts,rstr.shop.buyitem.cannotbuy,MB_F_CLOSE,null),!1)},n=function(a){e=a,i=e.number?e.number:i,f=ItemResUtil.findItemres(a.resid),f.nobindid&&!a.fixed&&(e.resid=f.nobindid,f=ItemResUtil.findItemres(e.resid)),h=e.buyprice?e.buyprice:f.buyprice},o=function(){if(!h)return!1;for(var a=0;a<h.length;++a)if(h[a]>0)return!0;return!1},p=function(){var a=0;for(var b=0;b<h.length;++b){if(h[b]==0)continue;a=h[b]}return BuyPrice.getPrice(-1,h)+" "+BuyPrice.getUnit(-1,h)},q=function(){s()&&d.hide()},r=function(){s()&&(t(),d.hide())},s=function(){var b=B();if(x()<=0){var d=TQ.format(rstr.shop.buyitem.lessmoney,rstr.shop.buyitem.paynames[b]);return a.getGUI().sysMsgTips(SMT_ERROR,d),!1}var f=c.inum.getVal();return ShopSender.sendBuyItem(a,b,f,e),!0},t=function(){var b=c.inum.getVal();UseItemSender.send(a,e,b,{type:f.targets[0]})},u=function(){d.hide()},v=function(a){y(a)},w=function(){var a=x();return a<=0&&(a=1),{min:1,max:a}},x=function(){var a=i,b=B();if(b>=0){var c=parseInt(g[b]/h[b],10);c<a&&(a=c)}return a},y=function(a){z(),A(a)},z=function(){for(var a=0;a<4;++a)c.payment.getRadio(a).hide(),c.payment.getRadio(a).setId(a+100)},A=function(a){for(var b=0,d=0;b<h.length;++b){if(h[b]==0)continue;var e=c.payment.getRadio(d++),f=rstr.shop.buyitem.paynames[b]+" "+h[b]*a+" ("+rstr.comm.have+":"+g[b]+")";e.setText(f),e.setId(b),e.show()}},B=function(){return c.payment.getCurSelId()}}),BuyItemListDlg=function(){this.init=function(a){f=a,g=this,i={},j=[],h=null},this.openDlg=function(c){j=c,a(),b(),h.show()};var a=function(){h||(h=Dialog.snew(f,{modal:!1,title:rstr.shop.buyitemlist.title,pos:{x:"center",y:40}}),f.getGUI().initDlg(h,uicfg.buy.buyitemlistdlg,i),h.hide(),i.list.setCaller({self:g,caller:d}))},b=function(){i.list.setItemCount(j.length),c()},c=function(){for(var a=0;a<j.length;++a){var b=i.list.getItem(a),c=ItemResUtil.findItemres(j[a]);CommDrawItem.drawItemIconAndName(b.exsubs.icon,b.exsubs.name,c),TTIP.setCallerData(b.exsubs.tooltips.$item,{self:g,caller:e},{res:c})}},d=function(a,b){UIM.getDlg("buyitem").openDlg({id:0,resid:j[b],number:1e4})},e=function(a){var b=SysItemMaker.make(0,a.res);return TIPM.getItemDesc(b,"sys")},f,g,h,i,j=[];this.init.apply(this,arguments)},ManageShopDlg=function(){this.init=function(a){t=a,u=this,w={},v=null,x=[],t.regEvent(EVT.NET,NETCMD.DEAL,u,c)},this.openDlg=function(){a(),b(),v.show()};var a=function(){v||(v=Dialog.snew(t,{modal:!0,title:rstr.shop.manageshop.title,pos:{x:"center",y:40}}),t.getGUI().initDlg(v,uicfg.shop.manageshop,w),v.hide(),h(),i())},b=function(){},c=function(a){var b=a.data;d(b),e(b)},d=function(a){if(!a.manageshop)return;u.openDlg(),w.list.setItemCount(a.poscnt),f()},e=function(a){if(!a.dealitems)return;x=a.dealitems,g(a.dealitems),j(),k(a.dealitems),m(a.dealitems)},f=function(){var a="{cmd="+NETCMD.DEAL+",subcmd=2}";t.send(null,a)},g=function(a){for(var b=0;b<a.length;++b)a[b].itemres=ItemResUtil.findItemres(a[b].resid)},h=function(){for(var a=0,b=w.list.getCount();a<b;++a){var c=w.list.getItem(a);TTIP.setCallerData(c.exsubs.tooltips.$item,{self:u,caller:n},{idx:a})}},i=function(){for(var a=0,b=w.list.getCount();a<b;++a){var c=w.list.getItem(a);c.exsubs.opbtn.setId(a),c.exsubs.opbtn.setCaller({self:u,caller:o})}},j=function(){for(var a=0,b=w.list.getCount();a<b;++a)l(w.list.getItem(a),null)},k=function(a){for(var b=0;b<a.length;++b)l(w.list.getItem(b),a[b])},l=function(a,b){IMG.setBKImage(a.exsubs.icon,b?IMG.makeBigImg(b.itemres.bigpic):""),TQ.setTextEx(a.exsubs.fnum,b?b.number:""),TQ.setTextEx(a.exsubs.bnum,b?b.number:""),TQ.setTextEx(a.exsubs.name,b?b.itemres.name:""),TQ.setTextEx(a.exsubs.price,b?b.buyprice:""),a.exsubs.opbtn[b?"show":"hide"](),a.exsubs.opbtn.setText(b?rstr.shop.manageshop.btn.downitem:"")},m=function(a){if(a.length<w.list.getCount()){var b=w.list.getItem(a.length);b.exsubs.opbtn.show(),b.exsubs.opbtn.setText(rstr.shop.manageshop.btn.upitem)}},n=function(a){if(x[a.idx])return TIPM.getItemDesc(x[a.idx],"sys")},o=function(a){a<x.length?p(a):q()},p=function(a){t.getGUI().msgBox(rstr.comm.msgts,rstr.shop.manageshop.lbl.conformdown,MB_F_YESNO,{self:u,caller:function(b){b==MB_IDYES&&r(a)}})},q=function(){UIM.getDlg("cansaleitem").openDlg({self:u,caller:function(a,b){s(a,b)}})},r=function(a){var b="{cmd="+NETCMD.DEAL+",subcmd=3,idx="+a+"}";t.send(null,b)},s=function(a,b){var c="{cmd="+NETCMD.DEAL+",subcmd=4,id="+a.id+",resid="+a.resid+",number="+a.number+",price="+b+"}";t.send(null,c)},t,u,v,w,x;this.init.apply(this,arguments)},CanSaleItemDlg=function(){var a,b,c,d,e;this.initialize=function(c){b=this,a=c},this.openDlg=function(a){d=a,c=UIM.getDlg("filteritemex"),c.setCaller({self:b,caller:f}),c.openDlg({title:rstr.military.expeddlg.soldiertitle,filter:"cansaleitem"})};var f=function(a){var c=function(b,c){a={},a.id=e.id,a.resid=e.itemres.id,a.number=b?b:1,c=c?c:1,d&&d.caller.call(d.self,a,c)};e=a;var f=UIM.getDlg("saleupinput");f.openDlg(a.number,g()),f.setCaller({self:b,caller:c})},g=function(){var a=99999999;if(e.itemres.buyprice&&(e.itemres.buyprice[0]>0||e.itemres.buyprice[1]>0)){var b=e.itemres.buyprice[0]>0?e.itemres.buyprice[0]:e.itemres.buyprice[1];a=parseInt(b*1.2,10)}return a};this.initialize.apply(this,arguments)},SaleUpInputDlg=function(){var a,b,c,d={},e=1,f=1,g;this.initialize=function(c){a=c,b=this},this.openDlg=function(a,b){h(),k(a,b),c.show(),d.inum.focus()},this.setCaller=function(a){g=a};var h=function(){c||(c=Dialog.snew(a,{modal:!0,pos:{x:"center",y:60},uiback:uiback.dlg.npc}),a.getGUI().initDlg(c,uicfg.shop.saleupinput,d),c.hide(),i(),j())},i=function(){d.inum.setLimit(l),d.iprice.setLimit(m)},j=function(){var a={okbtn:n,cancelbtn:o};for(var c in a)d[c].setCaller({self:b,caller:a[c]})},k=function(a,b){e=a,f=b,d.inum.setVal(e),d.iprice.setVal(1)},l=function(){return{min:0,max:e}},m=function(){return{min:0,max:f}},n=function(){if(g){var a=d.inum.getVal(),b=d.iprice.getVal();g.caller.call(g.self,a,b)}c.hide()},o=function(){c.hide()};this.initialize.apply(this,arguments)},ShopsListDlg=function(){this.init=function(a){p=a,q=this,s={},r=null,p.regEvent(EVT.NET,NETCMD.DEAL,q,e),p.regSendDelay("cmd_getshopslist",200)},this.openDlg=function(){a(),d(),r.show()};var a=function(){r||(r=Dialog.snew(p,{modal:!0,title:rstr.shop.shopslist.title,pos:{x:"center",y:40}}),p.getGUI().initDlg(r,uicfg.shop.shopslist,s),r.hide(),b(),c())},b=function(){s.list.setCaller(null,null,null,{self:q,caller:f}),s.pagebar.setCaller({self:q,caller:g}),s.findbtn.setCaller({self:q,caller:m})},c=function(){TQ.maxLength(s.iname,JVALID.getMaxShopLen())},d=function(){s.pagebar.activePage(1,!0)},e=function(a){var b=a.data;h(b),i(b)},f=function(a,b){n(b)},g=function(a){j(a)},h=function(a){if(!a.showshops)return;q.openDlg()},i=function(a){if(!a.shopslist)return;t=a.shopslist,t.pagecnt&&s.pagebar.setPageCnt(t.pagecnt),s.list.setItemCount(t.list.length);for(var b=0;b<t.list.length;++b){var c=s.list.getItem(b),d=t.list[b];TQ.setTextEx(c.exsubs.name,d.name),TQ.setTextEx(c.exsubs.cnt,d.cnt),c.exsubs.seeop.setId(b),c.exsubs.seeop.setCaller({self:q,caller:k}),c.exsubs.letterop.setId(b),c.exsubs.letterop.setCaller({self:q,caller:l})}t.pageidx&&s.pagebar.activePage(t.pageidx,!1,!1),t.selidx!=undefined&&s.list.setCurSel(t.selidx)},j=function(a){var b="{cmd="+NETCMD.DEAL+",subcmd=5,pageidx="+a+"}";p.send("cmd_getshopslist",b)},k=function(a){n(a)},l=function(a){HDRM.getHdr("letter").writeLetter({name:t.list[idx].rolename})},m=function(){JVALID.checkShopName(s.iname.value)?o(s.iname.value):p.getGUI().sysMsgTips(SMT_ERROR,rstr.shop.shopslist.err.invaildshop)},n=function(a){UIM.getDlg("saleshop").openDlg(t.list[a])},o=function(a){var b="{cmd="+NETCMD.DEAL+',subcmd=8,name="'+a+'"}';p.send(null,b)},p,q,r,s,t;this.init.apply(this,arguments)},SaleShopDlg=function(){this.init=function(a){o=a,p=this,r={},q=null,s=[],o.regEvent(EVT.NET,NETCMD.DEAL,p,c)},this.openDlg=function(c){t=c,a(),b(),q.show()};var a=function(){q||(q=Dialog.snew(o,{modal:!0,title:rstr.shop.manageshop.title,pos:{x:"center",y:40}}),o.getGUI().initDlg(q,uicfg.shop.manageshop,r),q.hide(),g(),h())},b=function(){e(),q.setTitle(t.name)},c=function(a){var b=a.data;d(b)},d=function(a){if(!a.shopitems)return;s=a.shopitems,f(a.shopitems),i(),j(a.shopitems)},e=function(){var a="{cmd="+NETCMD.DEAL+",subcmd=6}";o.send(null,a)},f=function(a){for(var b=0;b<a.length;++b)a[b].itemres=ItemResUtil.findItemres(a[b].resid)},g=function(){for(var a=0,b=r.list.getCount();a<b;++a){var c=r.list.getItem(a);TTIP.setCallerData(c.exsubs.tooltips.$item,{self:p,caller:l},{idx:a})}},h=function(){for(var a=0,b=r.list.getCount();a<b;++a){var c=r.list.getItem(a);c.exsubs.opbtn.setId(a),c.exsubs.opbtn.setCaller({self:p,caller:m})}},i=function(){for(var a=0,b=r.list.getCount();a<b;++a)k(r.list.getItem(a),null)},j=function(a){r.list.setItemCount(a.length);for(var b=0;b<a.length;++b)k(r.list.getItem(b),a[b])},k=function(a,b){IMG.setBKImage(a.exsubs.icon,b?IMG.makeBigImg(b.itemres.bigpic):""),TQ.setTextEx(a.exsubs.fnum,b?b.number:""),TQ.setTextEx(a.exsubs.bnum,b?b.number:""),TQ.setTextEx(a.exsubs.name,b?b.itemres.name:""),TQ.setTextEx(a.exsubs.price,b?b.buyprice:""),a.exsubs.opbtn[b?"show":"hide"](),a.exsubs.opbtn.setText(b?rstr.shop.manageshop.btn.buy:"")},l=function(a){if(s[a.idx])return TIPM.getItemDesc(s[a.idx],"sys")},m=function(a){var b={};TQ.dictCopy(b,s[a]),b.buyprice=[s[a].buyprice,0,0,0],UIM.getDlg("buyitem").openDlg(b,{self:p,caller:n})},n=function(a,b,c){var d="{cmd="+NETCMD.DEAL+',subcmd=7,name="'+t.rolename+'",id='+c.id+",resid="+c.resid+",number="+b+"}";o.send(null,d)},o,p,q,r,s,t;this.init.apply(this,arguments)},ShopDlg=JBaseDlg.ex({_innerInit:function(){this.HOTLIST_MAX_COUNT_=6,this.FINDINPUT_MAX_LEN_=16,this.TAB_PRESTIGE_IDX=5,this.TAB_HONOR_IDX=6,this.g_.regEvent(EVT.NET,NETCMD.SHOP,this,this._onSvrPkg),this.g_.regEvent(EVT.PKG_CHANGE,1,this,this._onGoldChanged),this.g_.regEvent(EVT.ROLEBASE,0,this,this._onPrestigeAndCityhonorChanged)},_getDlgCfg:function(){return{modal:!1,title:rstr.shop.shopdlg.title,pos:{x:"center",y:40},uicfg:uicfg.shop.shopdlg}},_afterCreate:function(){TQ.maxLength(this.items_.findItemInput,this.FINDINPUT_MAX_LEN_),this._simulateSendSvrPkg()},_simulateSendSvrPkg:function(){this.g_.sendEvent({eid:EVT.NET,sid:NETCMD.SHOP,data:{sales:res_shops_class}})},_setCallers:function(){this.items_.rechargeBtn.setCaller({self:this,caller:this._onClickRecharge}),this.items_.openPkgBtn.setCaller({self:this,caller:this._onClickOpenPkg}),this.items_.findItemBtn.setCaller({self:this,caller:this._onFindItem}),this.items_.cdkeyBtn.setCaller({self:this,caller:this._onClickCDKey})},_initInfo:function(){this._getSalesList(),this._updateTabList(),this._updateGold(),this._updatePrestigeAndCityhonor(),this._updateHotList(),this._updateGuangGao(),this.items_.tablist.activeTab(0)},_getSalesList:function(){ShopSender.sendGetShopSalesList(this.g_)},_updateTabList:function(){if(!this.isShow())return;var a=this.g_.getImgr().getShopSales();this._setTabsText(a);for(var b=0;b<a.length;++b){var c=this.items_.tablist.getTabItems(b);this._updateItemList(b,c.list,a[b].list)}},_setTabsText:function(a){for(var b=0;b<a.length;++b)this.items_.tablist.setTabText(b,a[b].name)},_updateItemList:function(a,b,c){b.setItemCount(c.length);for(var d=0;d<b.getCount();++d){var e=c[d],f=b.getItem(d);CommDrawItem.drawItemIconAndName(f.exsubs.icon,f.exsubs.name,e.itemres),e.itemnumsec&&e.itemnumsec==2?(IMG.setBKImage(f.exsubs.flag,IMG.getBuyLimitFlag()),TQ.fixIE6Png(f.exsubs.flag)):IMG.setBKImage(f.exsubs.flag,"");if(!e.itemres.buyprice)var g=1;var h=-1;a==this.TAB_PRESTIGE_IDX?h=3:a==this.TAB_HONOR_IDX&&(h=4),TQ.setTextEx(f.exsubs.price,BuyPrice.getUnit(h,e.itemres.buyprice)+" "+BuyPrice.getPrice(h,e.itemres.buyprice)),f.exsubs.buybtn.setId(e.id),f.exsubs.buybtn.setCaller({self:this,caller:this._onClickBuyItem}),TTIP.setCallerData(f.exsubs.tooltips.$item,{self:this,caller:this._onGetItemTip},{sale:e})}},_updateGold:function(){if(!this.isShow())return;TQ.setTextEx(this.items_.gold,this.g_.getImgr().getGold()),TQ.setTextEx(this.items_.giftgold,this.g_.getImgr().getGiftGold())},_updatePrestigeAndCityhonor:function(){if(!this.isShow())return;var a=this.g_.getImgr().getRoleRes();TQ.setTextEx(this.items_.prestige,a.prestige),TQ.setTextEx(this.items_.cityhonor,a.cityhonor)},_updateHotList:function(){var a=Math.min(this.HOTLIST_MAX_COUNT_,res_shophot_tags.length);this.items_.hotList.setItemCount(a);for(var b=0;b<a;++b){var c=res_shophot_tags[b],d=this.items_.hotList.getItem(b);d.exsubs.tagBtn.setId(b),d.exsubs.tagBtn.setText(c.name),d.exsubs.tagBtn.setCaller({self:this,caller:this._onClickHotTag})}},_updateGuangGao:function(){var a={qzone:"shopdlg/yd.gif",3366:"shopdlg/bd.gif",other:"shopdlg/ot.gif"},b=a[g_platform];b||(b=a.other),IMG.setBKImage(this.items_.guanggao,IMG.makeImg(b))},_onSvrPkg:function(a){a.data.sales&&(TQ.dictCopy(this.g_.getImgr().getShopSales(),a.data.sales),this._initSaleIdsRes(this.g_.getImgr().getShopSales()),this._updateTabList())},_initSaleIdsRes:function(a){for(var b=0;b<a.length;++b){var c=a[b];ItemResUtil.initItemsres(c.list,"id")}},_onGoldChanged:function(){this._updateGold()},_onPrestigeAndCityhonorChanged:function(){this._updatePrestigeAndCityhonor()},_onClickBuyItem:function(a){UIM.getDlg("buyitem").openDlg({id:0,resid:a,fixed:1,number:1e5})},_onGetItemTip:function(a){var b={itemnumsec:0,itemnum:0};a.sale.itemnumsec&&a.sale.itemnumsec==2&&(b.itemnumsec=a.sale.itemnumsec,b.itemnum=a.sale.itemnum);var c=SysItemMaker.make(0,a.sale.itemres,b);return TIPM.getItemDesc(c,"sys")},_onClickRecharge:function(){JMISC.openPayWnd()},_onClickOpenPkg:function(){UIM.openDlg("package")},_onClickHotTag:function(a){var b=this._collectValidIds(res_shophot_tags[a].ids);b.length==1?UIM.getDlg("buyitem").openDlg({id:0,resid:b[0],number:1e5}):UIM.getDlg("buyitemlist").openDlg(b)},_collectValidIds:function(a){var b=[];for(var c=0;c<a.length;++c)a[c]>0&&b.push(a[c]);return b},_onFindItem:function(){var a=this.g_.getImgr().getShopSales();for(var b=0;b<a.length;++b){var c=a[b];for(var d=0;d<c.list.length;++d)if(c.list[d].itemres.name==this.items_.findItemInput.value){UIM.getDlg("buyitem").openDlg({id:0,resid:c.list[d].id,number:1e5});return}}this.g_.getGUI().sysMsgTips(SMT_WARNING,rstr.shop.shopdlg.tip.noFind)},_onClickCDKey:function(){var a=UIM.getDlg("inputtext");a.openDlg(rstr.shop.shopdlg.lbl.inputcdkey,JVALID.getMaxCDKeyLen()),a.setCaller({self:this,caller:this._onInputCDKey})},_onInputCDKey:function(a){var b=a.match("^([0-9A-F]{"+JVALID.getMaxCDKeyLen()+"})$");if(b==null){this.g_.getGUI().sysMsgTips(SMT_WARNING,rstr.shop.shopdlg.tip.validcdkey);return}var c=0,d=["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F"],e={0:0,1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,A:10,B:11,C:12,D:13,E:14,F:15};for(var f=0;f<a.length-1;++f){var g=a.charAt(f);c+=e[g]}if(a.charAt(a.length-1)!=d[c%16]){this.g_.getGUI().sysMsgTips(SMT_WARNING,rstr.shop.shopdlg.tip.validcdkey);return}CDKeySender.send(this.g_,a)}})