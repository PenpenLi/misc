ExchangeDlg=JBaseDlg.ex({_innerInit:function(){this.listSelects=[-1,-1]},hasCanExChangeItem:function(a){var b=this._collectByType(a);for(var c=0;c<b.length;++c)if(this._hasEnoughMaterials(b[c].materials))return!0;return!1},_getDlgCfg:function(){return{modal:!1,title:rstr.exchangedlg.title,pos:{x:"center",y:40},uicfg:uicfg.exchangedlg}},_afterCreate:function(){this._setTabsText(),this.g_.regEvent(EVT.PKG_CHANGE,0,this,this._onItemChanged)},_setCallers:function(){this.items_.tabList.setCaller({self:this,caller:this._onActiveTab});for(var a=0;a<this.items_.tabList.getTabCount();++a){var b=this.items_.tabList.getTabItems(a);b.allList.setCaller({self:this,caller:this._onClickListItem}),TTIP.setCallerData(b.tooltips.$target,{self:this,caller:this._onGetTargetTip},{}),b.inum.setLimit(this._getExchangeLimit()),b.exchangeBtn.setCaller({self:this,caller:this._onClickExchangeBtn})}},_initInfo:function(){this.items_.tabList.activeTab(0),this._setTabBtnRedDot()},_setTabsText:function(){for(var a=0;a<rstr.exchangedlg.tabs.length;++a)this.items_.tabList.setTabText(a,rstr.exchangedlg.tabs[a])},_setTabBtnRedDot:function(){for(var a=0;a<2;++a)this.items_.tabList.getTabBtn(a).setNewFlag(this.hasCanExChangeItem(a))},_onActiveTab:function(a){var b=this.items_.tabList.getTabItems(a),c=this._collectByType(a);this._setAllListItem(b.allList,c);var d=this.listSelects[a];d<0?b.allList.setCurSel(0):b.allList.setCurSel(d)},_onClickListItem:function(a,b){this._savetListSelected(b),this._updateCurSelectPage()},_onGetTargetTip:function(a){var b=this._getCurSelRes();return TIPM.makeItemTip(b.tips)},_onClickExchangeBtn:function(){var a=this._getCurSelRes(),b=this._getCurItems();ExchangeSender.sendExchange(this.g_,a.dropId,b.inum.getVal())},_onItemChanged:function(){if(!this.isShow())return;this._updateCurSelectPage();var a=this.items_.tabList.getActiveTab(),b=this.items_.tabList.getTabItems(a),c=this._collectByType(a);this._setAllListItem(b.allList,c),this._setTabBtnRedDot()},_setAllListItem:function(a,b){a.setItemCount(b.length);for(var c=0;c<a.getCount();++c){var d=a.getItem(c),e=b[c];TQ.setRichText(d.exsubs.name,e.name),this._hasEnoughMaterials(e.materials)?TQ.setCSS(d.exsubs.canFlag,"display","block"):TQ.setCSS(d.exsubs.canFlag,"display","none")}},_hasEnoughMaterials:function(a){for(var b=0;b<a.length;++b){material=a[b];if(material.itemId==0)break;var c=this.g_.getImgr().getItemNumByResId(material.itemId);if(material.number>c)return!1}return!0},_savetListSelected:function(a){var b=this.items_.tabList.getActiveTab();this.listSelects[b]=a},_updateCurSelectPage:function(){var a=this._getCurSelRes(),b=this._getCurItems();IMG.setBKImage(b.target,IMG.makeBigImg(a.icon)),CommDrawItem.drawItemIcon(b.target,{bigpic:a.icon,level:a.level}),this._updateNeedMaterials(b.needList,a),b.inum.setVal(1e4),b.exchangeBtn.enable(this._getCanExchangeMaxCount()>0),TQ.setCSS(b.inumPanel,"display",this._isArmTab()?"none":"block")},_updateNeedMaterials:function(a,b){for(var c=0;c<a.getCount();++c){var d=a.getItem(c),e=b.materials[c];if(e&&e.itemId>0){var f=ItemResUtil.findItemres(e.itemId);CommDrawItem.drawItemIcon(d.exsubs.icon,f),TQ.setRichText(d.exsubs.name,f.name);var g=this.g_.getImgr().getItemNumByResId(e.itemId),h="";g>=e.number?h=TQ.format(rstr.exchangedlg.needNumber,TQ.formatColorStr(g,COLORS.ENOUGH_ITEM),TQ.formatColorStr(e.number,COLORS.ENOUGH_ITEM)):h=TQ.format(rstr.exchangedlg.needNumber,TQ.formatColorStr(g,COLORS.NO_ENOUGH_ITEM),e.number),TQ.setRichText(d.exsubs.number,h)}else IMG.setBKImage(d.exsubs.icon,""),TQ.setClass(d.exsubs.icon,""),TQ.setRichText(d.exsubs.name,""),TQ.setRichText(d.exsubs.number,"")}},_getCurSelRes:function(){var a=this.items_.tabList.getActiveTab(),b=this.items_.tabList.getTabItems(a),c=b.allList.getCurSel(),d=this._collectByType(a);return d[c]},_getCurItems:function(){var a=this.items_.tabList.getActiveTab();return this.items_.tabList.getTabItems(a)},_collectByType:function(a){var b=[];for(var c=0;c<res_exchanges.length;++c){var d=res_exchanges[c];d.type==a&&b.push(d)}return b},_getExchangeLimit:function(){var a=this;return function(){var b=a._getCanExchangeMaxCount();return b>0?{min:1,max:b}:{min:0,max:0}}},_getCanExchangeMaxCount:function(){var a=this._isArmTab()?1:1e4,b=this._getCurSelRes();for(var c=0;c<b.materials.length;++c){material=b.materials[c];if(material.itemId==0)break;var d=this.g_.getImgr().getItemNumByResId(material.itemId),e=Math.floor(d/material.number);e<a&&(a=e)}return a},_isArmTab:function(){return this.items_.tabList.getActiveTab()==1}})