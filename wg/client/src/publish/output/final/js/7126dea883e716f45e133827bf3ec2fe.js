PackageDlg=ListenerBaseDlg.extern(function(){var a=0,b=1,c=2,d=3,e=null,f=null,g=null,h={},i=null,j=null,k=null,l=null;this._init=function(){e=this.g_,f=this,i=PackageClassifyItems.snew(e),j=ItemsOpHdr.snew(e),e.regEvent(EVT.NET,NETCMD.PKG,f,y),e.regEvent(EVT.LOGIN_OK,0,f,x),O()},this.getCore=function(){return g},this.getCtrl=function(a){return h[a]},this.getOpMenu=function(){return k},this.openDlg=function(){m(),r(),s(),HelpGuider.getNewcomerSpirit().onDlgOpen("package",{parent:g.getParent(),items:h}),this._notifyOpenDlg()},this.hideDlg=function(){g&&g.hide()},this.isShow=function(){return g?g.isShow():!1},this.getIdxByTabIdxAndItemResId=function(a,b){var c=i.getClassItems(a).items;for(var d=0;d<c.length;++d){var e=c[d];if(e.itemres.id==b||e.itemres.bindid==b||e.itemres.nobindid==b)return d}return-1};var m=function(){g?g.show():(g=Dialog.snew(e,{modal:!1,title:rstr.pkgdlg.title,pos:{x:"center",y:25}}),e.getGUI().initDlg(g,uicfg.pkgdlg,h),g.setCaller({self:f,caller:w}),n(),o(),p(),q())},n=function(){for(var a=0;a<rstr.pkgdlg.tabs.length;++a)h.tab.setTabText(a,rstr.pkgdlg.tabs[a]);h.tab.setCaller({self:f,caller:D})},o=function(){for(var a=0;a<rstr.pkgdlg.tabs.length;++a)h.tab.getTabItems(a).list.setCaller({self:f,caller:H})},p=function(){h.paybtn.setCaller({self:f,caller:E}),h.shopbtn.setCaller({self:f,caller:F}),h.exchangebtn.setCaller({self:f,caller:G})},q=function(){k=new Menu(e,{width:86}),k.addMenuItem({id:a,icon:null,text:rstr.pkgdlg.menuops[0]}),k.addMenuItem({id:b,icon:null,text:rstr.pkgdlg.menuops[1]}),k.addMenuItem({id:c,icon:null,text:rstr.pkgdlg.menuops[2]}),k.addMenuItem({id:d,icon:null,text:rstr.pkgdlg.menuops[3]}),k.setCaller({self:f,caller:I})},r=function(){h.tab.activeTab(1),u(),t()},s=function(){var a=UIM.getDlg("exchange").hasCanExChangeItem(0)||UIM.getDlg("exchange").hasCanExChangeItem(1);h.exchangebtn.setNewFlag(a)},t=function(){if(!g||!g.isShow())return;var a=e.getImgr();TQ.setTextEx(h.gridnum,a.getPkgs().items.length+"/"+a.getMaxGrids())},u=function(){if(!g||!g.isShow())return;var a=e.getImgr();TQ.setTextEx(h.gold,a.getGold()),TQ.setTextEx(h.giftgold,a.getGiftGold())},v=function(){if(!g||!g.isShow())return;L(h.tab.getActiveTab())},w=function(a){a==C_SYS_DLG_HIDE&&HelpGuider.getNewcomerSpirit().onDlgClose("package")},x=function(){var a="{cmd="+NETCMD.PKG+",subcmd=0}";e.send(null,a)},y=function(a){var b=a.data;if(!b.pkg)return;z(b.pkg.items),B(b.pkg.misc),C(b.pkg.salveMax),u(),t(),v(),f.isShow()&&HelpGuider.getNewcomerSpirit().onDlgOpen("package",{parent:g.getParent(),items:h})},z=function(a){if(!a)return;A(a),O(),N(a);var b=e.getImgr().getPkgs();TQ.dictCopy(b.items,a),i.refresh(),ItemResUtil.initItemsres(b.items),e.sendEvent({eid:EVT.PKG_CHANGE,sid:0})},A=function(a){var b=a.length;for(var c=a.length-1;c>=0;--c){var d=a[c];d.resid==0&&a.splice(c,1)}b!=a.length&&LogSender.sendLog(e,"pkg item resid==0")},B=function(a){if(!a)return;var b=e.getImgr().getPkgs();TQ.dictCopy(b.misc,a),e.sendEvent({eid:EVT.PKG_CHANGE,sid:1})},C=function(a){if(!a)return;var b=e.getImgr().getSalveInfo();b.max=a,e.sendEvent({eid:EVT.PKG_CHANGE,sid:2})},D=function(a){L(a)},E=function(){JMISC.openPayWnd()},F=function(){UIM.openDlg("shop",0)},G=function(){UIM.openDlg("exchange")},H=function(a,b){var c=TQ.mouseCoords(a);k.show({x:c.x+3,y:c.y}),J()},I=function(f){var g=!0,h=K();if(!h)return;f==a?g=j.useItem(h):f==b?g=j.useItems(h):f==c?g=j.dropItem(h):f==d&&(g=j.sendChat(h)),g&&e.getGUI().hideAllMenu()},J=function(){var d=K();if(!d)return;k.enableItem(a,d.itemres.canUse?!0:!1),k.enableItem(b,d.itemres.canUses?!0:!1),k.enableItem(c,d.itemres.canDrop?!0:!1)},K=function(){var a=h.tab.getActiveTab(),b=h.tab.getTabItems(a).list.getCurSel();return i.getItem(a,b)},L=function(a){if(!l[a])return;var b=i.getClassItems(a),c=h.tab.getTabItems(a).list;c.setItemCount(b.items.length);for(var d=0;d<b.items.length;++d){var e=c.getItem(d);CommDrawItem.drawPkgItem(e,b.items[d]),TTIP.setCallerData(e.exsubs.tooltips.$item,{self:f,caller:M},{tabidx:a,idx:d})}c.scrollPos(0),l[a]=!1},M=function(a){var b=i.getItem(a.tabidx,a.idx);return b?TIPM.getItemDesc(b):null},N=function(a){var b=e.getImgr().getPkgs();for(var c=0;c<a.length;++c){var d=a[c];if(d.resid)continue;var f=TQ.find(b.items,"id",d.id);if(!f)continue;d.resid=f.resid}},O=function(){l=[!0,!0,!0,!0,!0,!0,!0]}}),BaseClassifyItems=JClass.ex({init:function(a){this.g_=a,this.classitems_=[],this._initClassItems(),this._initIdRanges()},getCount:function(){return this.classitems_.length},getClassItems:function(a){return this.classitems_[a]},getItem:function(a,b){var c=this.getClassItems(a);return c.items[b]},refresh:function(){this._clearItems(),this._recollectItems(),this._resortItems()},_clearItems:function(){for(var a=0;a<this.classitems_.length;++a){var b=this.classitems_[a];b.items=[]}},_recollectItems:function(){var a=this._getItems();for(var b=0;b<a.length;++b){var c=a[b],d=this._getClassItems(c);for(var e=0;e<d.length;++e)d[e].items.push(c)}},_resortItems:function(){for(var a=0;a<this.classitems_.length;++a){var b=this.classitems_[a];b.items.sort(this._sortFun)}},_getClassItems:function(a){var b=[];for(var c=0;c<this.classitems_.length;++c){var d=this.classitems_[c];this._isSatisfiedBy(d,a)&&b.push(d)}return b},_isInRange:function(a,b){return b.resid>=a.idrange.min&&b.resid<a.idrange.max},_initIdRanges:function(){for(var a=0;a<this.classitems_.length;++a){var b=this.classitems_[a];b.idrange=ItemClassRange.getRange(b.classid).idrange}},_initClassItems:function(){},_getItems:function(){return[]},_isSatisfiedBy:function(a,b){return!0},_sortFun:function(a,b){return!0}}),PackageClassifyItems=BaseClassifyItems.ex({_initClassItems:function(){this.classitems_=[{classid:RES_CLS.PKGITEM,items:[]},{classid:RES_CLS.CANUSEITEM,items:[]},{classid:RES_CLS.EQUIPITEM,items:[]},{classid:RES_CLS.SPEEDITEM,items:[]},{classid:RES_CLS.BOOKITEM,items:[]},{classid:RES_CLS.GEMITEM,items:[]},{classid:RES_CLS.TASKITEM,items:[]}]},_getItems:function(){return this.g_.getImgr().getPkgs().items},_isSatisfiedBy:function(a,b){return this._isInRange(a,b)},_sortFun:function(a,b){return a.resid-b.resid}}),ItemsOpHdr=Class.extern(function(){this.init=function(a){this.g=a},this.useItem=function(a){if(a.itemres.id==FIXID.PAICHENGKA||a.itemres.bindid==FIXID.PAICHENGKA||a.itemres.nobindid==FIXID.PAICHENGKA||HelpGuider.isUsePaiChengKa)HelpGuider.isUsePaiChengKa=!1,UIM.getDlg("package").hideDlg();var b=DirectUseItemHdrMgr.getHdr(a.itemres);return b.useItem(this.g,a)},this.useItems=function(a){var b=this.g.getImgr().getItemNumByResId(a.resid);if(b==1)return this.useItem(a);var c=function(b){UseItemSender.send(this.g,a,b,{type:a.itemres.targets[0]})},d=UIM.getDlg("inputnum");return d.openDlg(rstr.pkgdlg.lbl.useitems,Math.min(res_max_canuseitem_number,b)),d.setCaller({self:this,caller:c}),!0},this.dropItem=function(a){var b=this.g,c=function(c){c==MB_IDYES&&ItemOpSender.sendDropItem(b,a)};return this.g.getGUI().msgBox(rstr.comm.msgts,rstr.pkgdlg.lbl.dropitem,MB_F_YESNO,{self:this,caller:c}),!0},this.sendChat=function(a){var b="#[i:"+a.resid+":"+a.id+":"+this.g.getImgr().getRoleId()+"]";return UIM.getPanel("chat").sendMessageToCurChannel(b),!0}}),DirectCommUseItemHdr=Class.extern(function(){this.useItem=function(a,b){return UseItemSender.send(a,b,1,{type:b.itemres.targets[0]}),!0}}),DirectSendWorldBlessUseItemHdr=Class.extern(function(){var a=40;this.useItem=function(b,c){var d=function(a){var a=TQ.encodeMessage(a);UseItemSender.send(b,c,1,{type:c.itemres.targets[0],msg:a})},e=UIM.getDlg("inputtext");return e.setCaller({self:this,caller:d}),e.openDlg(rstr.pkgdlg.lbl.inputbless,a),!0}}),DirectSetPosMoveCityUseItemHdr=Class.extern(function(){var a=200;this.useItem=function(a,b){this._g=a;var c=function(c,d){UseItemSender.send(a,b,1,{type:b.itemres.targets[0],posX:c,posY:d}),OutFieldSender.sendRefreshFieldsByLastViewPos(a)},d=UIM.getDlg("inputcood");d.setCaller({self:this,caller:c});var e=a.getImgr().getRoleRes().pos,f=this._g.getImgr().getMapView(),g={min:f.x1,max:f.x2-1},h={min:f.y1,max:f.y2-1},i=TQ.format(rstr.pkgdlg.lbl.inputcood,e.x,e.y,g.min,g.max,h.min,h.max),j=TQ.format(rstr.pkgdlg.lbl.coodoutrange,g.min,g.max,h.min,h.max);return d.openDlg(i,g,h,j),!0}}),DirectUseItemHdrMgr=Class.extern(function(){var a={};this.init=function(){a[RES_EFF.SEND_WORLD_BLESS]=DirectSendWorldBlessUseItemHdr.snew(),a[RES_EFF.SETPOS_MOVECITY]=DirectSetPosMoveCityUseItemHdr.snew()},this.getHdr=function(b){return this.isSpec(b)?a[b.effects[0].id]:DirectCommUseItemHdr.snew()},this.isSpec=function(b){return!b||!b.effects||b.effects.length!=1?!1:a[b.effects[0].id]!=null}}).snew()