BuildsOpHdr=Class.extern(function(){var a=null,b=null,c=null,d=null,e=null,f=null,g=null,h=null,i={},j=null;this.init=function(d,i){a=d,b=this,c=i,j=BlinkingPanel.snew(a,{borderw:2}),f={110001:!0,110007:!0},g={110013:!0,110018:!0},e={110001:["BUILDINGINFO"],110002:[],110003:[],110004:["TRADINGAREA"],110005:["RECRUITHERO"],110006:["SOLDIER"],110007:["CITYDEF"],110008:["HEROTREAT"],110009:["HEROSTEEL"],110010:["CULTURE"],110011:["BUYARM","RESOLVE","INTENSIFY","COMPOSE","BESET"],110012:["JOINALLIANCE","REINFORCEMENT"],110013:["CHANGESUBCITY"],110014:[],110015:["RESPROTECT"],110016:[],110017:["EXCHANGEHEROEXP"],110018:["CHANGESUBCITY"],110019:[],110020:[],110021:[],110022:["TOWERDEF"]},h=[{text:rstr.inbuild.panel.btns.buildinfo,id:"BUILDINGINFO",icon:null,opCaller:w},{text:rstr.inbuild.panel.btns.soldier,id:"SOLDIER",icon:null,opCaller:x},{text:rstr.inbuild.panel.btns.culture,id:"CULTURE",icon:null,opCaller:y},{text:rstr.inbuild.panel.btns.recruithero,id:"RECRUITHERO",icon:null,opCaller:z},{text:rstr.inbuild.panel.btns.resprotect,id:"RESPROTECT",icon:null,opCaller:A},{text:rstr.inbuild.panel.btns.herosteel,id:"HEROSTEEL",icon:null,opCaller:B},{text:rstr.inbuild.panel.btns.buyarm,id:"BUYARM",icon:null,opCaller:C,params:{tabIdx:0}},{text:rstr.inbuild.panel.btns.resolve,id:"RESOLVE",icon:null,opCaller:C,params:{tabIdx:1}},{text:rstr.inbuild.panel.btns.intensify,id:"INTENSIFY",icon:null,opCaller:C,params:{tabIdx:2}},{text:rstr.inbuild.panel.btns.compose,id:"COMPOSE",icon:null,opCaller:C,params:{tabIdx:3}},{text:rstr.inbuild.panel.btns.beset,id:"BESET",icon:null,opCaller:C,params:{tabIdx:4}},{text:rstr.inbuild.panel.btns.treat,id:"HEROTREAT",icon:null,opCaller:D},{text:rstr.inbuild.panel.btns.citydef,id:"CITYDEF",icon:null,opCaller:E,params:{tabIdx:0}},{text:rstr.inbuild.panel.btns.citydef,id:"TOWERDEF",icon:null,opCaller:E,params:{tabIdx:2}},{text:rstr.inbuild.panel.btns.exchangeHeroExp,id:"EXCHANGEHEROEXP",icon:null,opCaller:F},{text:rstr.inbuild.panel.btns.changeSubCity,id:"CHANGESUBCITY",icon:null,opCaller:G},{text:rstr.inbuild.panel.btns.joinAlliance,id:"JOINALLIANCE",icon:null,opCaller:H},{text:rstr.inbuild.panel.btns.seeReinforcement,id:"REINFORCEMENT",icon:null,opCaller:I},{text:rstr.inbuild.panel.btns.tradingArea,id:"TRADINGAREA",icon:null,opCaller:J},{text:rstr.inbuild.panel.btns.up,id:"UPGRADE",icon:null,opCaller:K},{text:rstr.inbuild.panel.btns.del,id:"DOWN",icon:null,opCaller:L},{text:rstr.inbuild.panel.btns.sp,id:"SPEED",icon:null,opCaller:M},{text:rstr.inbuild.panel.btns.cs,id:"CANCEL",icon:null,opCaller:N}]},this.createOpMenu=function(){d=r(),d.setDisableCanClick(!0),d.setCaller({self:b,caller:s});for(var a=0;a<h.length;++a){var c=h[a],e=d.addMenuItem({id:a,icon:c.icon,text:c.text});if(c.id=="UPGRADE"||c.id=="DOWN"){var f=TTIP.addTip(e.item,".");TTIP.setCallerData(f,{self:b,caller:t},{id:c.id})}}},this.isShow=function(){return d?d.isShow():!1},this.show=function(a){if(!d)return!1;d.show(a),k()},this.resetOpMenuItemsShow=function(){i={};var a=c.getCurBlock().getItem();if(!a)return;n(a),o(a),p(a),q()},this.updateOpMenuItem=function(){if(!d.isShow())return;if(!i.UPGRADE)return;var a=c.getCurBlock().getItem();if(!a)return;var b=TIPM.isCanBuildUpgrade(a.cityId,a);d.enableItem(m("UPGRADE"),b)},this.opSpeed=function(a){UIM.openDlg("uselistitem",[RES_EFF.ACCELERATE],{id:a.id,cid:a.cityId,stoptime:a.stoptime,resid:a.resid,type:RES_TRG.BUILDING_IBUILD})},this.opCancel=function(b){CityBuildSender.sendCancelBuild(a,b.cityId,b.id)};var k=function(){var a=c.getCurBlock().getItem();if(!a||HelpGuider.buildOpMenu.itemId==""||HelpGuider.buildOpMenu.buildId!=a.resid||HelpGuider.buildOpMenu.buildState>=0&&HelpGuider.buildOpMenu.buildState!=a.state){j.unbind();return}var b=l(HelpGuider.buildOpMenu.itemId),e=d.getItem(m(HelpGuider.buildOpMenu.itemId)).vitem.item;j.bind(e,e,BLINKING_TYPE.INSERT,0,b*TQ.getDomHeight(e),TQ.getDomWidth(e),TQ.getDomHeight(e)),j.start(-1)},l=function(a){var b=0;for(var c=0;c<d.getCount();++c){var e=h[c].id;if(a==e)break;i[e]&&b++}return b},m=function(a){return TQ.find(h,"id",a),TQ.getLastFindIdx()},n=function(a){if(a.state==BUILD_STATE.COMM)i.UPGRADE=!0,i.DOWN=!0;else if(a.state==BUILD_STATE.UPGRADE||a.state==BUILD_STATE.DOWN)i.SPEED=!0,i.CANCEL=!0},o=function(a){if(!a.level)return;var b=e[a.itemres.id].length>0;if(!b)return;i.SEP=!0;var c=e[a.itemres.id];for(var d=0;d<c.length;++d)i[c[d]]=!0},p=function(b){if(!b.level)return;if(b.itemres.id!=FIXID.ALLIINBUILD)return;a.getImgr().isInAlliance()?(i.JOINALLIANCE=!1,i.REINFORCEMENT=!0):(i.JOINALLIANCE=!0,i.REINFORCEMENT=!1)},q=function(){for(var a=0;a<d.getCount();++a){var b=h[a].id;d.showItem(a,i[b]?!0:!1)}},r=function(){return new Menu(a,{width:112,className:"build_menu_panel"})},s=function(b){a.getGUI().hideAllMenu();var c=h[b];if(!c||!c.opCaller)return;c.opCaller(b,c.params)},t=function(a){var b=v(a.id);if(b!="")return b;var d=c.getCurBlock().getItem();return d?TIPM.getBuildDesc(d.cityId,u(a.id),d):""},u=function(a){return a=="UPGRADE"?"up":"down"},v=function(a){if(a!="DOWN")return"";var b=c.getCurBlock().getItem();return b?f[b.resid]?TQ.formatLine(TQ.format(rstr.inbuild.panel.tips.undown,b.itemres.name)):b.level==1&&g[b.resid]?TQ.formatLine(TQ.format(rstr.inbuild.panel.tips.undownWhenOneLevel,b.itemres.name)):"":""},w=function(){UIM.openDlg("buildinginfo")},x=function(){UIM.openDlg("soldier")},y=function(){UIM.openDlg("culture")},z=function(){UIM.openDlg("recruithero")},A=function(){UIM.openDlg("resprotect")},B=function(){UIM.openDlg("steellist")},C=function(a,b){UIM.openDlg("armop",b.tabIdx)},D=function(){UIM.openDlg("hospital")},E=function(a,b){UIM.openDlg("citydef",b.tabIdx)},F=function(){UIM.openDlg("jitan")},G=function(){var b=UIM.getPanel("main").getSubCityBtnsBar().getCurSubCityId(),c=a.getImgr().getBuildsByCityId(b);if(c.length>1){a.getGUI().sysMsgTips(SMT_WARNING,rstr.ids[100068].msg);return}if(c[0].level>1){a.getGUI().sysMsgTips(SMT_WARNING,rstr.ids[100069].msg);return}UIM.openDlg("createsubcity",b,"change")},H=function(){UIM.getDlg("allicreate").openDlg(),UIM.getPanel("main").getToolbar().stopAllianceBlinking()},I=function(){UIM.getDlg("reinforcement").openDlg()},J=function(){UIM.getDlg("tradingarea").openDlg()},K=function(){var b=c.getCurBlock().getItem(),d=TIPM.getSimpleBuildUpTip(b.cityId,b);d!=""?a.getGUI().msgBox(rstr.comm.msgts,d,MB_F_CLOSE,null):CityBuildSender.sendUpgradeBuild(a,b.cityId,b.id)},L=function(){var d=c.getCurBlock().getItem();if(f[d.resid]){var e=TQ.format(rstr.inbuild.panel.tips.undown,d.itemres.name);a.getGUI().sysMsgTips(SMT_WARNING,e);return}if(d.level==1&&g[d.resid]){var e=TQ.format(rstr.inbuild.panel.tips.undownWhenOneLevel,d.itemres.name);a.getGUI().sysMsgTips(SMT_WARNING,e);return}var h=function(b){b==MB_IDYES&&CityBuildSender.sendDownBuild(a,d.cityId,d.id)};a.getGUI().msgBox(rstr.comm.msgts,rstr.inbuild.panel.tips.confirmDown,MB_F_YESNO,{self:b,caller:h})},M=function(){b.opSpeed(c.getCurBlock().getItem())},N=function(){var d=function(a){a==MB_IDYES&&b.opCancel(c.getCurBlock().getItem())};a.getGUI().msgBox(rstr.comm.msgts,rstr.inbuild.panel.tips.confirmCancelUp,MB_F_YESNO,{self:b,caller:d})}})