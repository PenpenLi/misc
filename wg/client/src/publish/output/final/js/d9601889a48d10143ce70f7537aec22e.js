AssignHerosDlg=Class.extern(function(){var a=180001,b=null,c=null,d=null,e={},f=null,g=[0,0,0,0,0],h={canEmpty:!1};this.init=function(a){b=a,c=this,b.regEvent(EVT.HERO_UPDATE,0,c,r)},this.getCtrl=function(a){return e[a]},this.openDlg=function(a){a&&(h=a),i(),n(),HelpGuider.getNewcomerSpirit().onDlgOpen("assignheros",{parent:d.getParent(),items:e})},this.closeDlg=function(){d&&d.hide()},this.isShow=function(){return d&&d.isShow()},this.setCaller=function(a){f=a},this.click=function(){s()},this.hasAssignedHero=function(){return L()},this.getCoreDlg=function(){return d};var i=function(){d||(d=Dialog.snew(b,{modal:!1,title:rstr.assignherosdlg.title,pos:{x:"center",y:30},btns:[{btn:{id:0,text:rstr.comm.confirm},caller:{self:c,caller:s}},{btn:{id:0,text:rstr.comm.cancel},caller:{self:c,caller:t}}]}),b.getGUI().initDlg(d,uicfg.expedition.assignherosdlg,e),j()),d.show()},j=function(){d.setCaller({self:c,caller:q}),k(),l(),m()},k=function(){e.herolist.setCaller({self:c,caller:u})},l=function(){e.lineuplist.setCaller({self:c,caller:x})},m=function(){e.autosel.setCaller({self:c,caller:y}),e.cancelsel.setCaller({self:c,caller:z}),e.assignsoldier.setCaller({self:c,caller:A}),e.team1.setCaller({self:c,caller:B}),e.team2.setCaller({self:c,caller:B}),e.team3.setCaller({self:c,caller:B})},n=function(){H(),o(),D(),p()},o=function(){var a=b.getImgr().collectFreeHeros();e.herolist.setItemCount(a.length);for(var c=0;c<a.length;++c){var d=a[c],f=e.herolist.getItem(c);TQ.setText(f.exsubs.name,d.name);var g=b.getImgr().getHeroAttrVal(d,ATTR.HEALTH);TQ.setTextEx(f.exsubs.health,RStrUtil.getHealthStr(g)),TQ.setTextEx(f.exsubs.prof,rstr.comm.heroprofs[d.prof]),TQ.setTextEx(f.exsubs.level,d.level),TQ.setTextEx(f.exsubs.soldiertype,RStrUtil.getSoldierNameByResId(d.soldier.resid)),TQ.setTextEx(f.exsubs.soldiernumber,d.soldier.number),TQ.setRichText(f.exsubs.state,rstr.comm.herostate[d.state]),f.exsubs.sel.setId(d.id)}},p=function(){var a=b.getImgr().getLineups();e.lineuplist.setItemCount(a.length);for(var c=0;c<a.length;++c){var d=e.lineuplist.getItem(c),f=a[c],g=ItemResUtil.findItemres(f);TQ.setText(d.exsubs.name,g.name),IMG.setBKImage(d.exsubs.icon,IMG.makeSmallImg(g.smallpic))}e.lineuplist.setCurSel(0)},q=function(a){a==C_SYS_DLG_HIDE&&HelpGuider.getNewcomerSpirit().onDlgClose("assignheros")},r=function(){if(!c.isShow())return;o()},s=function(){if(e.herolist.getCount()==0&&!h.canEmpty){b.getGUI().sysMsgTips(SMT_WARNING,rstr.assignherosdlg.err.noFreeHero),d.hide();return}if(!L()&&!h.canEmpty){b.getGUI().sysMsgTips(SMT_WARNING,rstr.assignherosdlg.err.noHero);return}f&&f.caller.call(f.self,K(),g),d.hide()},t=function(){d.hide()},u=function(a,b){var c=e.herolist.getItem(b);if(!c)return;var d=c.exsubs.sel.getCheck(),f=d==0;f?v(c):w(c),D()},v=function(a){var c=TQ.find(g,null,0)!=null,d=TQ.getLastFindIdx();if(!c){b.getGUI().sysMsgTips(SMT_WARNING,rstr.assignherosdlg.err.fullHeros);return}var e=a.exsubs.sel.getId(),f=b.getImgr().getHero(e);if(!f.soldier||f.soldier.resid==0||f.soldier.number==0){b.getGUI().sysMsgTips(SMT_WARNING,rstr.assignherosdlg.err.noCarrySoldiers);return}var h=TQ.find(g,null,e)!=null;h||(g[d]=e,a.exsubs.sel.setCheck(1),a.exsubs.sel.setText(" "+(d+1)))},w=function(a){var b=a.exsubs.sel.getId(),c=TQ.find(g,null,b)!=null;c&&(g[TQ.getLastFindIdx()]=0),a.exsubs.sel.setCheck(0),a.exsubs.sel.setText("")},x=function(a,b){C(),D()},y=function(){H(),I(),D()},z=function(){H(),D()},A=function(){UIM.openDlg("assignsoldiers")},B=function(a){if(!L()){b.getGUI().sysMsgTips(SMT_WARNING,rstr.assignherosdlg.err.noHero);return}MilitarySender.sendDefaultTeam(b,a,K(),g)},C=function(){var a=J();TQ.setText(e.lineupdesc,a.desc)},D=function(){E(),F(),G(),HelpGuider.getNewcomerSpirit().onDlgOpen("assignheros",{parent:d.getParent(),items:e})},E=function(){for(var a=0,b=e.tablelist.getCount();a<b;++a){var c=e.tablelist.getItem(a);IMG.setBKImage(c.exsubs.icon,""),IMG.setBKImage(c.exsubs.icon.parentNode,IMG.makeImg("expedition/forcetab/small_disablebak.gif"))}},F=function(){var a=J();for(var b=0;b<a.grids.length;++b){var c=a.grids[b],d=e.tablelist.getItem(c);IMG.setBKImage(d.exsubs.icon,""),IMG.setBKImage(d.exsubs.icon.parentNode,IMG.makeImg("expedition/forcetab/small_emptybak.gif"))}},G=function(){var a=J();for(var c=0;c<a.grids.length;++c){var d=a.grids[c],f=g[c];if(f==0)continue;var h=e.tablelist.getItem(d),i=b.getImgr().getHero(f);IMG.setBKImage(h.exsubs.icon,IMG.makeSmallImg(i.icon))}},H=function(){g=[0,0,0,0,0];for(var a=0,b=e.herolist.getCount();a<b;++a){var c=e.herolist.getItem(a);c.exsubs.sel.setCheck(0),c.exsubs.sel.setText("")}},I=function(){var a=b.getImgr().collectFreeHeros(),c=e.herolist.getCount();for(var d=0,f=0;d<c&&f<g.length;++d){var h=e.herolist.getItem(d),i=a[d];if(i.soldier.resid==0||i.soldier.number==0)continue;h.exsubs.sel.setCheck(1),h.exsubs.sel.setText(" "+(f+1)),g[f]=i.id,f++}},J=function(){var a=K();return ItemResUtil.findItemres(a)},K=function(){var c=e.lineuplist.getCurSel(),d=b.getImgr().getLineups(),f=d[c];return f?f:a},L=function(){for(var a=0;a<g.length;++a)if(g[a]>0)return!0;return!1}})