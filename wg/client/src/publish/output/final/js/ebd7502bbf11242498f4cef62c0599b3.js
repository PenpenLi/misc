ConvertFightRounds=Class.extern(function(){var a={};this.init=function(){a.fightstart=FightFightStartActionConvertor.snew(),a.round=FightRoundStartActionConvertor.snew(),a.move=FightMoveActionConvertor.snew(),a.attack=FightAttackActionConvertor.snew(),a.miss=FightMissActionConvertor.snew(),a["default"]=FightDefaultActionConvertor.snew()},this.convert=function(a,c){for(var d=0,e=0;d<c.length;++d){var f=c[d];f.seq=++e,f.subseq=0;var g=b(f.event);d=g.convert(a,a.length-1,c,d)}},this.splitRounds=function(a){var b=[];for(var c=0;c<a.length;++c){var d=a[c];b.push([]);var e=b[b.length-1];for(var f=0;f<d.length;++f){var g=d[f];g.event=="movestart"||g.event=="movesplit"||g.event=="moveend"?(b.push([]),e=b[b.length-1],e.push(d[0])):e.push(g)}}return b};var b=function(b){var c=a[b];return c?c:a["default"]}}),FightDefaultActionConvertor=Class.extern(function(){this.convert=function(a,b,c,d){return a[b].push(c[d]),d}}),FightFightStartActionConvertor=Class.extern(function(){this.convert=function(a,b,c,d){return d}}),FightRoundStartActionConvertor=Class.extern(function(){var a=FightDefaultActionConvertor.snew();this.convert=function(b,c,d,e){return b.push([]),a.convert(b,b.length-1,d,e)}}),FightMoveActionConvertor=Class.extern(function(){this.convert=function(c,d,e,f){var g=e[f],h={};TQ.dictCopy(h,g);var i=a(e,f);return b(h.paths,e,f,i),c[d].push(h),i};var a=function(a,b){var c=a[b];for(var d=b+1;d<a.length;++d){var e=a[d];if(e.event!="move")return d-1;if(e.id!=c.id)return d-1}return a.length-1},b=function(a,b,c,d){for(var e=c+1;e<=d;++e){var f=b[e];a.push(f.paths[0])}}}),FightAttackActionConvertor=Class.extern(function(){this.convert=function(f,g,i,j){var k=f[g],l=i[j].seq;j=a(i,j);var m=h(i,j),n=0;for(var o=j;o<m;++o)isNull(i[o].seq)&&(i[o].seq=l),isNull(i[o].subseq)&&(i[o].subseq=n),n=i[o].subseq+1;var p={effects:[]},q=i[j];TQ.dictCopy(p,q),b(p.effects,q),c(p.effects,i,j,m),k.push(p);var r=d(i,j,m);for(var o=0;o<r.length;++o)this.convert(f,g,r[o],0);var s=e(i,j,m);for(var o=0;o<s.length;++o)k.push(s[o]);return m};var a=function(a,b){return a[b+1]&&a[b+1].event=="berserk"?b+1:b},b=function(a,b){a.push({userid:b.userid,targetid:b.targetid,effid:b.event=="berserk"?RES_EFF.F_CLT_BERSERK_SUBHP:RES_EFF.F_CLT_SUBHP,val:b.val})},c=function(a,b,c,d){for(var e=c+1;e<d;++e){var h=b[e];!f(h.effid)&&!g(h)&&a.push(h)}},d=function(a,b,c){var d=[];for(var e=b+1;e<c;++e){var g=a[e];if(f(g.effid)){var h={event:"attack",userid:g.userid,targetid:g.targetid,val:g.val,seq:g.seq,subseq:g.subseq};d.push([h,{event:"attackend"}])}}return d},e=function(a,b,c){var d=[];for(var e=b+1;e<c;++e){var f=a[e];g(f)&&d.push(f)}return d},f=function(a){return isNull(a)?!1:a==RES_EFF.F_LIANJI||a==RES_EFF.F_FANJI},g=function(a){return a.event&&a.event=="die"},h=function(a,b){for(var c=b+1;c<a.length;++c)if(a[c].event=="attackend")return c;return b}}),FightMissActionConvertor=Class.extern(function(){this.convert=function(a,b,c,d){var e=a[b],f={effects:[]},g=c[d];return TQ.dictCopy(f,g),f.effects.push({userid:g.userid,targetid:g.targetid,effid:RES_EFF.F_CLT_MISS,val:rstr.fight.effect.miss}),e.push(f),d}})