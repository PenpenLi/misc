HERODLG_TAB_INFO_IDX=0,HERODLG_TAB_ARM_IDX=1,HERODLG_TAB_JINGMAI_IDX=2,HERODLG_TAB_SKILL_IDX=3,HERODLG_TAB_OFFI_IDX=4,MAX_BASESKILL_GRIDCNT=6,MAX_TACTICSKILL_GRIDCNT=2,MAX_SPECSKILL_GRIDCNT=5,AddLevelByHeroFiveElemAttr=Class.extern(function(){this.init=function(){this.fiveElemMapAttrIds={},this.fiveElemMapAttrIds[FIVEELEM_TYPE.JIN]=ATTR.JIN_SKILL_LEVEL,this.fiveElemMapAttrIds[FIVEELEM_TYPE.MU]=ATTR.MU_SKILL_LEVEL,this.fiveElemMapAttrIds[FIVEELEM_TYPE.SHUI]=ATTR.SHUI_SKILL_LEVEL,this.fiveElemMapAttrIds[FIVEELEM_TYPE.HUO]=ATTR.HUO_SKILL_LEVEL,this.fiveElemMapAttrIds[FIVEELEM_TYPE.TU]=ATTR.TU_SKILL_LEVEL},this.getAddLevel=function(a,b,c){var d=this.fiveElemMapAttrIds[c.fiveelem];return d?a.getImgr().getHeroAttrVal(b,d):0}}).snew(),TreatmentHeroHdr=Class.extern(function(){var a=null,b=null;this.init=function(){b=this},this.treatmentHeros=function(a,b){var c=this.getNeedItemNumber(a,b);if(c==0){a.getGUI().sysMsgTips(SMT_NORMAL,rstr.herodlg.tips.fullhealth);return}var d=a.getImgr().getItemNumByResId(FIXID.SALVE);if(c>d){var e=RStrUtil.makeNoSalveBuyMsg(FIXID.PKG_SALVE,c,d);a.getGUI().msgBox(rstr.comm.msgts,e,MB_F_CLOSE,null);return}HeroSender.sendTreatments(a,b)},this.getNeedItemNumber=function(b,d){a=b;var e=0;for(var f=0;f<d.length;++f){var g=d[f],h=a.getImgr().getHero(g);if(!h)continue;e+=c(h)}return e};var c=function(b){var c=a.getImgr(),d=c.getHeroAttrVal(b,ATTR.HEALTH),e=c.getHeroAttrVal(b,ATTR.MHEALTH);if(d==e)return 0;var f=ItemResUtil.findEffectres(FIXID.SALVE,RES_EFF.ADDHEROHEALTH);if(f==null)return log("*error salve item effect is invalid, has no RES_EFF.ADDHEROHEALTH"),1e6;var g=e-d,h=parseInt((g+f.val-1)/f.val,10);return h}}).snew(),HeroDlgView=ListenerBaseDlg.extern(function(){var a,b,c,d={},e=null,f=null,g=null,h=null,i=null;this._init=function(){a=this.g_,b=this,f=HeroInfoTabView.snew(a,this),g=HeroArmTabView.snew(a,this),i=HeroOffiTabView.snew(a,this),h=HeroSkillTabView.snew(a,this),m_jingmaitab=HeroJingmaiTabView.snew(a,this)},this.getArmView=function(){return g},this.getCtrl=function(a){return d[a]},this.beforeChangeHero=function(){f.beforeChangeHero()},this.heroUpdate=function(){n(),f.update(),g.update(),i.update(),h.update(),m_jingmaitab.update()},this.openDlg=function(){j(),k(),l(),this._notifyOpenDlg()},this.closeDlg=function(){c&&c.hide()},this.setPresenter=function(a){e=a,f.setPresenter(e),g.setPresenter(e),i.setPresenter(e),h.setPresenter(e),m_jingmaitab.setPresenter(e)},this.setModel=function(a){f.setModel(a),g.setModel(a),i.setModel(a),h.setModel(a),m_jingmaitab.setModel(a)},this.isShow=function(){return c&&c.isShow()};var j=function(){c||(c=Dialog.snew(a,{modal:!1,title:rstr.herodlg.title,pos:{x:"center",y:30}}),a.getGUI().initDlg(c,uicfg.hero.herodlg,d),c.setCaller({self:b,caller:m}),f.initDlg(d.tablist.getTabItems(HERODLG_TAB_INFO_IDX)),g.initDlg(d.tablist.getTabItems(HERODLG_TAB_ARM_IDX)),m_jingmaitab.initDlg(d.tablist.getTabItems(HERODLG_TAB_JINGMAI_IDX)),h.initDlg(d.tablist.getTabItems(HERODLG_TAB_SKILL_IDX)),i.initDlg(d.tablist.getTabItems(HERODLG_TAB_OFFI_IDX)),e&&e.initDlg()),c.show()},k=function(){h.openDlg(),m_jingmaitab.openDlg()},l=function(){d.herolist.setCurSel(0)},m=function(a){a==C_SYS_DLG_HIDE&&(h.closeDlg(),m_jingmaitab.closeDlg())},n=function(){if(!b.isShow())return;var c=a.getImgr(),e=d.herolist.getCurSel(),f=c.getHeros().list;d.herolist.setItemCount(f.length);for(var g=0;g<f.length;++g){var h=d.herolist.getItem(g),i=f[g];TQ.setRichText(h.exsubs.name,HeroNameColorGetter.getColorName(i)),TQ.setText(h.exsubs.level,i.level),TQ.setRichText(h.exsubs.state,rstr.comm.herostate[i.state]),TQ.setRichText(h.exsubs.fightcap,TQ.format(rstr.herodlg.lbl.fmt2fightcap,c.getHeroAttrVal(i,ATTR.SFC)))}e>=f.length&&d.herolist.setCurSel(f.length-1)}}),HeroInfoTabView=Class.extern(function(){var a,b,c=null,d=null,e=null,f=null,g=null;this.init=function(d,e){b=this,a=d,c=e,f=HeroTabViewAttr.snew(a)},this.setPresenter=function(a){d=a},this.setModel=function(a){g=a},this.initDlg=function(a){e=a,f.setItems(e)},this.beforeChangeHero=function(){},this.update=function(){if(!c.isShow())return;var b=g.getCurHero();if(!b){m();return}if(!a.getImgr().isDetailHero(b))return;n(!0),h(b),i(b),j(b),l(b)};var h=function(b){f.setHeroIcon(b),f.setHeroName(b),f.setOfficialName(b);var c=a.getImgr();TQ.setTextEx(e.level,TQ.format(rstr.herodlg.lbl.fmtlevel,b.level)),TQ.setTextEx(e.fightcap,TQ.format(rstr.herodlg.lbl.fmtfightcap,c.getHeroAttrVal(b,ATTR.SFC))),TQ.setTextEx(e.innerforce,c.getHeroAttrVal(b,ATTR.IF)),TQ.setTextEx(e.health,RStrUtil.getColorHealthVal(c.getHeroAttrVal(b,ATTR.HEALTH))),TQ.setTextEx(e.credit,c.getHeroAttrVal(b,ATTR.CRE)),TQ.setTextEx(e.prof,rstr.comm.heroprofs[b.prof]),TQ.setTextEx(e.command,c.getHeroAttrVal(b,ATTR.CO))},i=function(b){o(PROGBAR_SHOWFLAG_PER);var c=a.getImgr();e.expbar.setRange(c.getHeroAttrVal(b,ATTR.NXP)),e.expbar.setValue(0,c.getHeroAttrVal(b,ATTR.XP))},j=function(a){var b="";for(var c in a.subjects)b+=rstr.recruitherodlg.subjects[c]+":"+SubjectColorGetter.getColorVal(a.subjects[c])+"  ";TQ.setTextEx(e.subject,b)},l=function(b){var c=a.getImgr();TQ.setText(e.hurt,c.getHeroAttrVal(b,ATTR.HU)),TQ.setText(e.def,c.getHeroAttrVal(b,ATTR.DE)),TQ.setText(e.agile,c.getHeroAttrVal(b,ATTR.AG)),TQ.setText(e.physical,c.getHeroAttrVal(b,ATTR.PS))},m=function(){n(!1),o(PROGBAR_SHOWFLAG_NONE),IMG.setBKImage(e.icon,"");var a=["name","level","fightcap","innerforce","health","official","prof","credit","command","subject","hurt","def","agile","physical"];for(k in a)TQ.setText(e[a[k]],"")},n=function(a){var b=["assignexp","treatment","appoint"];for(k in b)e[b[k]].enable(a)},o=function(a){e.expbar.setShowFlag(a),e.expbar.setRange(1),e.expbar.setValue(0,0)}}),HeroArmTabView=Class.extern(function(){var a,b,c=null,d=null,e=null,f=null,g=null,h=[{x:38,y:8},{x:6,y:84},{x:71,y:84},{x:6,y:164},{x:71,y:164},{x:6,y:244},{x:71,y:244}];this.init=function(d,e){b=this,a=d,c=e,b.setItemChanged()},this.setPresenter=function(a){e=a},this.setModel=function(a){f=a},this.initDlg=function(a){d=a,i(),j()},this.update=function(){if(!c.isShow())return;l(),p()},this.updateArmList=function(){if(!c.isShow())return;p()},this.setItemChanged=function(){g=[!0,!0,!0,!0,!0,!0,!0,!0]};var i=function(){for(var a=0;a<d.wearList.getCount();++a){var b=d.wearList.getItem(a).item;TQ.setCSS(b,"float","none"),TQ.setCSS(b,"position","absolute"),TQ.setDomPos(b,h[a].x,h[a].y)}},j=function(){k(),d.armsTab.activeTab(1),d.armsTab.hideTabCtrl()},k=function(){for(var a=0;a<d.armsTab.getTabCount();++a)d.armsTab.setTabText(a,rstr.herodlg.armTabs[a])},l=function(){var a=f.getCurHero();if(!a||!a.wears){m();return}n(a)},m=function(){for(var a=0;a<d.wearList.getCount();++a){var b=d.wearList.getItem(a);o(b)}},n=function(a){for(var b=0;b<d.wearList.getCount();++b){var c=d.wearList.getItem(b),e=b+1,f=a.wears[e];if(f){var g=ItemResUtil.findItemres(f.resid);CommDrawItem.drawItemIcon(c.exsubs.icon,g)}else o(c)}},o=function(a){IMG.setBKImage(a.exsubs.icon,""),TQ.setClass(a.exsubs.icon,"")},p=function(){var b=d.armsTab.getActiveTab();if(!g[b])return;g[b]=!1;var c=d.armsTab.getTabItems(b).armList,h=ArmPosFilter.snew(a),i=h.filter({armPos:b}),j=ItemClassRangeFilter.snew(a),k=j.filter({classId:RES_CLS.HEROEQUIPITEM,items:i});f.setArmPosArms(b,k),c.setItemCount(k.length);for(var l=0;l<k.length;++l){var m=k[l],n=c.getItem(l);CommDrawItem.drawItemIcon(n.exsubs.icon,m.itemres)}e.getArmPresenter().setArmListTipCaller()}}),HeroOffiTabView=Class.extern(function(){var a,b,c=null,d=null,e=null,f=null,g=null;this.init=function(d,e){b=this,a=d,c=e,g=HeroTabViewAttr.snew(a)},this.setPresenter=function(a){d=a},this.setModel=function(a){e=a},this.initDlg=function(a){f=a,g.setItems(f),TQ.setText(f.desc,rstr.herodlg.lbl.getCreditDesc)},this.update=function(){if(!c.isShow())return;var b=e.getCurHero();if(!b){h();return}if(!a.getImgr().isDetailHero(b))return;f.conge.enable(b.official>0),g.setHeroIcon(b),g.setHeroName(b),g.setOfficialName(b);var d=a.getImgr();TQ.setText(f.credit,d.getHeroAttrVal(b,ATTR.CRE)),TQ.setText(f.command,d.getHeroAttrVal(b,ATTR.CO)),i()};var h=function(){f.conge.enable(!1),IMG.setBKImage(f.icon,""),TQ.setText(f.name,""),TQ.setText(f.official,""),TQ.setText(f.credit,""),TQ.setText(f.command,""),f.list.setItemCount(0)},i=function(){var a=e.getOfficialRes();f.list.setItemCount(j(a));for(var b=0;b<a.nums.length;++b){var c=a.nums[b];if(c==0)break;var d=b+1,g=TQ.qfind(res_heroofficials,"id",d),h=f.list.getItem(b);TQ.setText(h.exsubs.name,g.name),TQ.setText(h.exsubs.num,e.getOfficialCnt(d)+"/"+c),TQ.setText(h.exsubs.add,TQ.format(rstr.herodlg.lbl.officialcomadd,g.addcom)),TQ.setText(h.exsubs.need,TQ.format(rstr.herodlg.lbl.officialneed,g.needcredit,g.needitem))}},j=function(a){var b=0;for(var c=0;c<a.nums.length;++c){if(a.nums[c]==0)break;b++}return b}}),HeroJingmaiTabView=Class.extern(function(){var a,b,c=null,d=null,e=null,f=null,g=!1;this.init=function(d,e){b=this,a=d,c=e,a.regEvent(EVT.PKG_CHANGE,0,b,i)},this.setPresenter=function(a){d=a},this.setModel=function(a){e=a},this.initDlg=function(a){f=a},this.openDlg=function(){a.regUpdater(b,j,1e3),g=!0},this.closeDlg=function(){a.unregUpdater(b,j),g=!1},this.update=function(){if(!c.isShow())return;var b=e.getCurHero();if(!b){k();return}if(!a.getImgr().isDetailHero(b))return;if(b.level<res_hero_hasjingmai_minlevel){u();return}v(),TQ.setClass(f.jingmaibk,b.icon<200?"jingmaibk_nan":"jingmaibk_nv");var d=a.getImgr();TQ.setText(f.curinnerforce,d.getHeroAttrVal(b,ATTR.IF)),TQ.setText(f.maxinnerforce,d.getHeroAttrVal(b,ATTR.MIF)),l(b.id),h(),TQ.setHtml(f.steeldesc,t(b)),f.istrtimes.setVal(1),f.buyitem.enable(!0),f.strengthen.enable(!0),m(b),n(b),o(b),p(b)};var h=function(){TQ.setHtml(f.hasstritem,rstr.herodlg.lbl.hasstritem+a.getImgr().getItemNumByResId(FIXID.CHILINGDAN))},i=function(){if(!g)return;h()},j=function(a){var b=e.getCurHero();if(!b)return;m(b)},k=function(){f.istrtimes.setVal(1),TQ.setText(f.curinnerforce,""),TQ.setText(f.maxinnerforce,""),TQ.setHtml(f.hasstritem,""),TQ.setTextEx(f.strdesc.getContainerObj(),""),f.strdesc.refresh(),TQ.setText(f.steeldesc,""),TQ.setText(f.steeltime,""),f.buyitem.enable(!1),f.strengthen.enable(!1),f.steeljingmai.enable(!1),f.speedsteel.hide(),TQ.setClass(f.jingmaibk,"jingmaibk_nan"),q(),u()},l=function(a){TQ.setTextEx(f.strdesc.getContainerObj(),d.getStrIFResult(a)),f.strdesc.refresh()},m=function(b){if(r(b)){var c=Math.max(0,b.skeleton.stoptime-a.getSvrTimeS());TQ.setText(f.steeltime,rstr.herodlg.lbl.ssteeltime+TQ.formatTime(0,c))}else TQ.setText(f.steeltime,"")},n=function(a){f.speedsteel[r(a)?"show":"hide"]()},o=function(a){r(a)?(f.steeljingmai.show(),f.steeljingmai.enable(!1),f.steeljingmai.setText(rstr.herodlg.btns.ssteeling)):s(a)?f.steeljingmai.hide():(f.steeljingmai.show(),f.steeljingmai.enable(!0),f.steeljingmai.setText(rstr.herodlg.btns.steeljingmai))},p=function(a){for(var b=1;b<=res_herojingmai.length;++b){var c="";b<=a.skeleton.level?c="hero/mailuo/normal.gif":b==a.skeleton.level+1?c="hero/mailuo/sel.gif":c="hero/mailuo/disable.gif",IMG.setBKImage(f["jingmai"+b],IMG.makeImg(c))}},q=function(){for(var a=1;a<=res_herojingmai.length;++a){var b="hero/mailuo/disable.gif";IMG.setBKImage(f["jingmai"+a],IMG.makeImg(b))}},r=function(a){return a.skeleton.stoptime?!0:!1},s=function(a){return a.skeleton.level>=res_herojingmai.length},t=function(a){if(!a.skeleton)return"";var b=e.getMaiLuoNodeDesc(a.skeleton.level);return b!=""&&(b+="<br/>"),b+=e.getNextMaiLuoNodeDesc(a.skeleton.level),b},u=function(){TQ.setCSS(f.nojingmailabel,"display","block"),TQ.setCSS(f.innerForcePanel,"display","none"),TQ.setCSS(f.jingmaibk,"display","none"),TQ.setCSS(f.jingMaiInfoPanel,"display","none")},v=function(){TQ.setCSS(f.nojingmailabel,"display","none"),TQ.setCSS(f.innerForcePanel,"display","block"),TQ.setCSS(f.jingmaibk,"display","block"),TQ.setCSS(f.jingMaiInfoPanel,"display","block")}}),HeroSkillTabView=Class.extern(function(){var a,b,c=null,d=null,e=null,f=null,g=null;this.init=function(d,e){b=this,a=d,c=e,g=HeroTabViewAttr.snew(a)},this.setPresenter=function(a){d=a},this.setModel=function(a){e=a},this.initDlg=function(a){f=a,h(),g.setItems(f)},this.openDlg=function(){a.regUpdater(b,j,1e3)},this.closeDlg=function(){a.unregUpdater(b,j)},this.update=function(){if(!c.isShow())return;var b=e.getCurHero();if(!b){i();return}if(!a.getImgr().isDetailHero(b))return;if(b.level<res_hero_hasskill_minlevel){g.setHeroIcon(b),z();return}g.setHeroIcon(b),A(),n(),k(b),l(b),m(b),o(b),p(b),q(b),u(b),v(b),w(b)};var h=function(){f.steelmenu=new Menu(a,{width:80}),f.steelmenu.addMenuItem({id:0,icon:null,text:rstr.herodlg.menu.steelbaseskill}),f.learntskillmenu=new Menu(a,{width:80}),f.learntskillmenu.addMenuItem({id:0,icon:null,text:rstr.herodlg.menu.learntskill}),f.weartskillmenu=new Menu(a,{width:80}),f.weartskillmenu.addMenuItem({id:0,icon:null,text:rstr.herodlg.menu.weartskill}),f.unweartskillmenu=new Menu(a,{width:80}),f.unweartskillmenu.addMenuItem({id:0,icon:null,text:rstr.herodlg.menu.unweartskill}),f.learnsskillmenu=new Menu(a,{width:80}),f.learnsskillmenu.addMenuItem({id:0,icon:null,text:rstr.herodlg.menu.learnsskill})},i=function(){x(),z()},j=function(a){var b=e.getCurHero();if(!b)return;l(b)},k=function(a){if(a.skillsteel.id==0)TQ.setTextEx(f.whichskillsteel,rstr.herodlg.lbl.noskillsteel);else{var b=ItemResUtil.findItemres(a.skillsteel.id),c=TQ.format(rstr.herodlg.lbl.whichskillsteel,b.name);TQ.setTextEx(f.whichskillsteel,c)}},l=function(b){if(!b.skillsteel)return;if(b.skillsteel.stoptime==0)TQ.setTextEx(f.steellefttime,"");else{var c=Math.max(0,b.skillsteel.stoptime-a.getSvrTimeS());TQ.setTextEx(f.steellefttime,rstr.herodlg.lbl.skillsteellefttime+TQ.formatTime(0,c))}},m=function(a){var b=a.skillsteel.id>0&&a.skillsteel.stoptime>0;b?f.speedsteel.show():f.speedsteel.hide()},n=function(){var b=a.getImgr().getCanUseSkillSteelTime();TQ.setTextEx(f.cansteeltime,TQ.format(rstr.herodlg.lbl.leftskillsteeltime,b))},o=function(a){f.specskilllist.setItemCount(a.prof==1?MAX_SPECSKILL_GRIDCNT:0),f.baseskilllist.setItemCount(MAX_BASESKILL_GRIDCNT),f.tacticskilllist.setItemCount(MAX_TACTICSKILL_GRIDCNT)},p=function(a){if(a.curtskill){var b=ItemResUtil.findItemres(a.curtskill);IMG.setBKImage(f.curtacticskill,IMG.makeSmallImg(b.smallpic))}else IMG.setBKImage(f.curtacticskill,"")},q=function(a){r(a),s(a),t(a)},r=function(a){var b=res_get_basegridcnt_by_herolevel(a.level);for(var c=0;c<b;++c){var d=f.baseskilllist.getItem(c);IMG.setBKImage(d.exsubs.icon,""),TQ.setTextEx(d.exsubs.num,""),TQ.setTextEx(d.exsubs.bnum,"")}},s=function(b){for(var c=0,d=0;c<b.skills.length;++c){var e=b.skills[c];if(e.id<res_hero_baseskill_id_first||e.id>res_hero_baseskill_id_last)continue;var g=ItemResUtil.findItemres(e.id),h=f.baseskilllist.getItem(d++);IMG.setBKImage(h.exsubs.icon,IMG.makeSmallImg(g.smallpic));var i="",j="",k=AddLevelByHeroFiveElemAttr.getAddLevel(a,b,g);k>0&&(i="("+TQ.formatColorStr("+"+k,COLORS.APPEND_ATTR)+")",j="(+"+k+")");var l=e.level+"#addLevel#/"+res_hero_baseskill_maxlevel;TQ.setTextEx(h.exsubs.num,l.replace("#addLevel#",i)),TQ.setTextEx(h.exsubs.bnum,l.replace("#addLevel#",j))}},t=function(a){var b=res_get_basegridcnt_by_herolevel(a.level);for(var c=b;c<MAX_BASESKILL_GRIDCNT;++c){var d=f.baseskilllist.getItem(c);IMG.setBKImage(d.exsubs.icon,IMG.makeImg("hero/skilllock.gif")),TQ.setTextEx(d.exsubs.num,""),TQ.setTextEx(d.exsubs.bnum,"")}},u=function(b){for(var c=0;c<MAX_TACTICSKILL_GRIDCNT;++c){var d=a.getImgr().getTacticSkillByIdx(b,c),e=ItemResUtil.findItemres(d.id),g=f.tacticskilllist.getItem(c);IMG.setBKImage(g.exsubs.icon,IMG.makeSmallImg(e.smallpic));var h=d.level+"/"+res_hero_tacticskill_maxlevel;TQ.setTextEx(g.exsubs.num,h),TQ.setTextEx(g.exsubs.bnum,h)}},v=function(a){TQ.setCSS(f.zhuanjingskillLbl,"display",a.prof==1?"block":"none")},w=function(b){for(var c=0;c<f.specskilllist.getCount();++c){var d=a.getImgr().getSpecSkillByIdx(b,c),e=ItemResUtil.findItemres(d.id),g=f.specskilllist.getItem(c);IMG.setBKImage(g.exsubs.icon,IMG.makeSmallImg(e.smallpic));var h=d.level+"/"+res_hero_specskill_maxlevel;TQ.setTextEx(g.exsubs.num,h),TQ.setTextEx(g.exsubs.bnum,h)}},x=function(){IMG.setBKImage(f.icon,"")},y=function(){f.baseskilllist.setItemCount(0),f.tacticskilllist.setItemCount(0),f.specskilllist.setItemCount(0)},z=function(){TQ.setCSS(f.noskilllabel,"display","block"),TQ.setCSS(f.hasskillpanel,"display","none")},A=function(){TQ.setCSS(f.noskilllabel,"display","none"),TQ.setCSS(f.hasskillpanel,"display","block")}}),HeroTabViewAttr=Class.extern(function(){var a=null,b=null;this.init=function(b){a=b},this.setItems=function(a){b=a},this.setHeroIcon=function(a){IMG.setBKImage(b.icon,IMG.makeBigImg(a.icon))},this.setHeroName=function(a){TQ.setText(b.name,a.name)},this.setOfficialName=function(a){var c=TQ.qfind(res_heroofficials,"id",a.official),d=c?c.name:rstr.herodlg.lbl.noofficial;TQ.setText(b.official,d)}}),HeroDlgModel=Class.extern(function(){var a=null,b=null,c=-1,d={};this.init=function(c){a=c,b=this},this.handleHeroSvrData=function(b){if(b.data.heros){var c=a.getImgr(),d=c.getHeros();TQ.dictCopy(d.list,b.data.heros);var f=function(a,b){if(b.level!=a.level)return b.level-a.level;var d=c.getHeroAttrVal(a,ATTR.FC),e=c.getHeroAttrVal(b,ATTR.FC);if(e!=d)return e-d;var f=c.getHeroAttrVal(a,ATTR.SFC),g=c.getHeroAttrVal(b,ATTR.SFC);return g-f};d.list.sort(f),e(d.list),c.setHerosDefaultInfo(),a.pendReplaceEvent({eid:EVT.HERO_UPDATE,sid:0,pendtime:50})}b.data.canusesstime!=undefined&&(a.getImgr().setCanUseSkillSteelTime(b.data.canusesstime),a.pendReplaceEvent({eid:EVT.HERO_UPDATE,sid:0,pendtime:50}))},this.getOfficialRes=function(){var b=a.getImgr().getRoleLevel();for(var c=0;c<res_roleofficials.length;++c){var d=res_roleofficials[c];if(b<=d.level)return d}return null},this.getOfficialCnt=function(b){var c=0,d=a.getImgr().getHeros().list;for(var e=0;e<d.length;++e)b==d[e].official&&c++;return c},this.getStrIFNeedItemNumber=function(b){var c=a.getImgr();return res_get_str_if_need_itemnum(b.skeleton.level)},this.getSubjectTip=function(b){var c=a.getImgr(),d=c.getHeroByIdx(b);if(d==null)return"";var e="<div class=subjecttip>";e+=rstr.herodlg.lbl.subjecttitle+"<br/>";for(var g=0;g<d.subjects.length;++g)e+=rstr.recruitherodlg.subjects[g]+rstr.comm.colon+f(d.subjects[g])+"<br/>";return e+="</div>",e},this.getExpBarTip=function(b){var c=a.getImgr(),d=c.getHeroByIdx(b);if(d==null)return"";var e="<div class=heroexpbartip>";return e+=rstr.herodlg.tips.curexp+c.getHeroAttrVal(d,ATTR.XP),e+="<br/>",d.level<res_max_hero_level?e+=rstr.herodlg.tips.needexp+c.getHeroAttrVal(d,ATTR.NXP):e+=rstr.herodlg.tips.fulllevel,e+="</div>",e},this.getMaiLuoNodeDesc=function(a){var b="",c=TQ.qfind(res_herojingmai,"id",a);return c&&(b+="<center>"+c.name+"</center>",b+=g(c),b+=h(c)),b},this.getNextMaiLuoNodeDesc=function(a){var b="",c=TQ.qfind(res_herojingmai,"id",a+1);return c&&(b+="<center>"+rstr.herodlg.lbl.nextjingmaidesc+c.name+"</center>",b+=g(c),b+=h(c),b+=i(c),b+=j(c)),b},this.setCurHeroIdx=function(a){c=a},this.getCurHero=function(){return a.getImgr().getHeroByIdx(c)},this.setArmPosArms=function(a,b){d[a]=b},this.getArmsByArmPos=function(a){return d[a]};var e=function(a){for(var b=0;b<a.length;++b){var c=a[b];if(!c.wears)continue;for(var d in c.wears){if(!c.wears[d])continue;ItemResUtil.initItemres(c.wears[d],"resid")}}},f=function(a){var b="";for(var c=0;c<a;++c)b+=rstr.comm.star;return b},g=function(a){var b="",c={addhurt:ATTR.HU,adddef:ATTR.DE,addmps:ATTR.MPS,addes:ATTR.ES,addber:ATTR.BER,addhit:ATTR.HI};for(var d in c){var e=a[d];if(!e||!e.val)continue;var f=c[d],g=TQ.qfind(res_attrs,"id",f).name;b+=g+rstr.comm.colon+" +"+e.val,e.unit==VAL_UNIT.PER&&(b+="%"),b+="<br/>"}return TQ.formatColorStr(b,"#22ff22")},h=function(a){var b=rstr.herodlg.lbl.maxifdesc+a.maxif+"<br/>";return TQ.formatColorStr(b,"#22ff22")},i=function(a){var b="<br/>";return b+=TQ.format(rstr.herodlg.lbl.nextprecond,a.prelevel,a.preif)+"<br/>",TQ.formatColorStr(b,"#f0e000")},j=function(a){var b=TQ.format(rstr.herodlg.lbl.nextexpendmoney,a.needmoney)+"<br/>";return a.needitem&&(itemRes=ItemResUtil.findItemres(a.itemid),b+=TQ.format(rstr.herodlg.lbl.nextexpenditem,itemRes.name,a.needitem)+"<br/>"),TQ.formatColorStr(b,"#f0a000")}}),HeroDlgPresenter=Class.extern(function(){var a=null,b=null,c=null,d=null,e=null,f=null,g=null,h=null,i={};this.init=function(i,j,k){a=i,b=this,c=j,d=k,c.setPresenter(b),c.setModel(d),e=HeroInfoTabPresenter.snew(a,this,j,k),f=HeroArmTabPresenter.snew(a,this,j,k),g=HeroOffiTabPresenter.snew(a,this,j,k),h=HeroJingmaiTabPresenter.snew(a,this,j,k),m_skilltab=HeroSkillTabPresenter.snew(a,this,j,k),a.regEvent(EVT.LOGIN_OK,0,b,l),a.regEvent(EVT.NET,NETCMD.HERORES,b,m),a.regEvent(EVT.HERO_UPDATE,0,b,n)},this.getArmPresenter=function(){return f},this.openDlg=function(){c.openDlg()},this.initDlg=function(){j(),k()},this.hideDlg=function(){c.closeDlg()},this.isShow=function(){return c.isShow()},this.getStrIFResult=function(a){return i[a]?i[a]:rstr.herodlg.lbl.ifstrdesc};var j=function(){for(var a=0;a<rstr.herodlg.tabs.length;++a)c.getCtrl("tablist").setTabText(a,rstr.herodlg.tabs[a]);c.getCtrl("tablist").activeTab(0)},k=function(){c.getCtrl("herolist").setCaller({self:b,caller:o}),e.setCaller(),f.setCaller(),g.setCaller(),h.setCaller(),m_skilltab.setCaller()},l=function(){HeroSender.sendGetAllHeros(a)},m=function(a){d.handleHeroSvrData(a),p(a.data.strifresult)},n=function(){c.heroUpdate()},o=function(b,e){d.setCurHeroIdx(e),c.beforeChangeHero(),c.heroUpdate();var f=d.getCurHero();if(!f)return;if(a.getImgr().isDetailHero(f))return;HeroSender.sendGetDetail(a,f.id)},p=function(b){if(!b)return;var c=d.getCurHero();if(!c)return;var e="";for(var f=0;f<b.length;++f){var g=b[f];g>0?e+=TQ.format(rstr.herodlg.lbl.resultsuccstrif,g)+"<br/>":e+=rstr.herodlg.lbl.resultsuccstriffull+"<br/>"}i[c.id]||(i[c.id]=""),i[c.id]=i[c.id]+e,a.sendEvent({eid:EVT.HERO_STRIF_RESULT,sid:0})}}),HeroInfoTabPresenter=Class.extern(function(){var a=null,b=null,c=null,d=null,e=null,f=null;this.init=function(f,g,h,i){a=f,b=this,c=g,d=h,e=i},this.setCaller=function(){f=d.getCtrl("tablist").getTabItems(HERODLG_TAB_INFO_IDX);var a=TTIP.getTipById(f.tooltips[TIP_PREFIX+"subject"]);a.setCaller({self:b,caller:g});var a=TTIP.getTipById(f.tooltips[TIP_PREFIX+"expbar"]);a.setCaller({self:b,caller:h}),f.assignexp.setCaller({self:b,caller:j}),f.treatment.setCaller({self:b,caller:k}),f.appoint.setCaller({self:b,caller:l})};var g=function(){var a=d.getCtrl("herolist").getCurSel();return e.getSubjectTip(a)},h=function(){var a=d.getCtrl("herolist").getCurSel();return e.getExpBarTip(a)},i=function(b){var c=e.getCurHero();if(!c)return;var d=a.getImgr();return d.getHeroAttrVal(c,b)},j=function(){var a=e.getCurHero();if(!a)return;UIM.openDlg("roleassignexp",a.id)},k=function(){var b=e.getCurHero();if(!b)return;var c=TreatmentHeroHdr.getNeedItemNumber(a,[b.id]);if(c==0){a.getGUI().sysMsgTips(SMT_NORMAL,rstr.herodlg.tips.fullhealth);return}var d=a.getImgr().getItemNumByResId(FIXID.SALVE);if(c>d){var f=RStrUtil.makeNoSalveBuyMsg(FIXID.SALVE,c,d);a.getGUI().msgBox(rstr.comm.msgts,f,MB_F_CLOSE,null);return}HeroSender.sendTreatment(a,b.id)},l=function(){d.getCtrl("tablist").activeTab(HERODLG_TAB_OFFI_IDX)}}),HeroArmTabPresenter=Class.extern(function(){var a=null,b=null,c=null,d=null,e=null,f=null;this.init=function(f,g,h,i){a=f,b=this,c=g,d=h,e=i},this.setCaller=function(){g(),h(),i(),j(),k(),l(),m()},this.setArmListTipCaller=function(){m()};var g=function(){f=d.getCtrl("tablist").getTabItems(HERODLG_TAB_ARM_IDX)},h=function(){a.regEvent(EVT.PKG_CHANGE,0,b,n)},i=function(){f.wearList.setCaller({self:b,caller:o})},j=function(){f.armsTab.setCaller({self:b,caller:p})},k=function(){for(var a=0,c=f.armsTab.getTabCount();a<c;++a){var d=f.armsTab.getTabItems(a).armList;d.setCaller({self:b,caller:q})}},l=function(){for(var a=0,c=f.wearList.getCount();a<c;++a){var d=f.wearList.getItem(a);TTIP.setCallerData(d.exsubs.tooltips[TIP_PREFIX+"item"],{self:b,caller:r},{idx:a})}},m=function(){for(var a=0,c=f.armsTab.getTabCount();a<c;++a){var d=f.armsTab.getTabItems(a).armList;for(var e=0,g=d.getCount();e<g;++e){var h=d.getItem(e);TTIP.setCallerData(h.exsubs.tooltips[TIP_PREFIX+"item"],{self:b,caller:s},{idx:e})}}},n=function(){d.getArmView().setItemChanged()},o=function(b,c){var d=e.getCurHero();if(!d)return;var g=c+1;f.armsTab.activeTab(g);var h=d.wears[g];h&&HeroSender.sendUnWearArm(a,d.id,g)},p=function(){d.getArmView().updateArmList()},q=function(b,c){var d=e.getCurHero();if(!d)return;var g=f.armsTab.getActiveTab(),h=e.getArmsByArmPos(g),i=h[c];i&&HeroSender.sendWearArm(a,d.id,i.id)},r=function(a){var b=a.idx+1;return t(b)},s=function(a){var b=u(a.idx);if(!b)return"";var c=TIPM.getItemDesc(b),d=t(b.itemres.apos);return d!=""?d+"<split>"+c:c},t=function(a){var b=e.getCurHero();return!b||!b.wears?"":b.wears[a]?TIPM.getItemDesc(b.wears[a],null,!0):""},u=function(a){var b=f.armsTab.getActiveTab(),c=e.getArmsByArmPos(b);return c[a]}}),HeroOffiTabPresenter=Class.extern(function(){var a=null,b=null,c=null,d=null,e=null,f=null;this.init=function(f,g,h,i){a=f,b=this,c=g,d=h,e=i},this.setCaller=function(){f=d.getCtrl("tablist").getTabItems(HERODLG_TAB_OFFI_IDX),g(),h()};var g=function(){f.conge.setCaller({self:b,caller:i}),f.buyitem.setCaller({self:b,caller:j})},h=function(){f.list.setItemCount(res_heroofficials.length);for(var a=0;a<res_heroofficials.length;++a){var c=f.list.getItem(a).exsubs.confer;c.setId(a),c.setCaller({self:b,caller:k})}f.list.setItemCount(0)},i=function(){var c=e.getCurHero();if(!c)return;if(!l(c)){a.getGUI().sysMsgTips(SMT_WARNING,rstr.herodlg.err.conge.freestate);return}if(m(c)){a.getGUI().sysMsgTips(SMT_WARNING,rstr.herodlg.err.conge.nosoldier);return}var d=function(b){b==MB_IDYES&&HeroSender.sendConge(a,c.id)};a.getGUI().msgBox(rstr.comm.msgts,TQ.format(rstr.herodlg.lbl.congehero,c.name),MB_F_YESNO,{self:b,caller:d})},j=function(){UIM.openDlg("buyitem",{id:0,resid:FIXID.TIGERCARD,number:1e4})},k=function(b){var c=e.getCurHero();if(!c)return;var d=b+1;if(!l(c)){a.getGUI().sysMsgTips(SMT_WARNING,rstr.herodlg.err.confer.freestate);return}if(n(c)){a.getGUI().sysMsgTips(SMT_WARNING,rstr.herodlg.err.confer.hasofficial);return}if(o(d)){a.getGUI().sysMsgTips(SMT_WARNING,rstr.herodlg.err.confer.fullofficial);return}if(!p(c,d)){a.getGUI().sysMsgTips(SMT_WARNING,rstr.herodlg.err.confer.noenoughcredit);return}if(!q(d)){a.getGUI().sysMsgTips(SMT_WARNING,rstr.herodlg.err.confer.noenoughitem);return}HeroSender.sendConfer(a,c.id,d)},l=function(a){return a.state==HERO_STATE.FREE},m=function(a){return a.soldier.number>0},n=function(a){return a.official!=0},o=function(a){var b=e.getOfficialRes(),c=b.nums[a-1];return e.getOfficialCnt(a)==c},p=function(b,c){var d=a.getImgr(),e=res_heroofficials[c-1];return d.getHeroAttrVal(b,ATTR.CRE)>=e.needcredit},q=function(b){var c=a.getImgr(),d=res_heroofficials[b-1];return c.getItemNumByResId(FIXID.TIGERCARD)>=d.needitem}}),HeroJingmaiTabPresenter=Class.extern(function(){var a=null,b=null,c=null,d=null,e=null,f=null;this.init=function(f,g,h,i){a=f,b=this,c=g,d=h,e=i,a.regEvent(EVT.HERO_STRIF_RESULT,0,b,j)},this.setCaller=function(){f=d.getCtrl("tablist").getTabItems(HERODLG_TAB_JINGMAI_IDX),g(),h(),i()};var g=function(){for(var a=1;a<=res_herojingmai.length;++a){var c=f.tooltips[TIP_PREFIX+"jingmai"+a];TTIP.setCallerData(c,{self:b,caller:k},{idx:a})}},h=function(){f.buyitem.setCaller({self:b,caller:l}),f.strengthen.setCaller({self:b,caller:m}),f.steeljingmai.setCaller({self:b,caller:n}),f.speedsteel.setCaller({self:b,caller:o})},i=function(){f.istrtimes.setLimit(p),f.istrtimes.setCaller({self:b,caller:q})},j=function(a){var b=0,d=e.getCurHero();d&&(b=d.id),TQ.setTextEx(f.strdesc.getContainerObj(),c.getStrIFResult(b)),f.strdesc.refresh(),f.strdesc.scrollEnd()},k=function(a){var b=e.getCurHero();if(!b)return"";var c=e.getMaiLuoNodeDesc(a.idx);return"<div class=itemtip>"+c+"</div>"},l=function(){UIM.openDlg("buyitem",{id:0,resid:FIXID.CHILINGDAN,number:1e4})},m=function(){var b=e.getCurHero();if(!b)return;if(!r(b)){a.getGUI().sysMsgTips(SMT_WARNING,rstr.herodlg.err.strengthen.freestate);return}if(!s(b)){a.getGUI().msgBox(rstr.comm.msgts,RStrUtil.makeNoItemBuyMsg(a,FIXID.CHILINGDAN,t(b)),MB_F_CLOSE,null);return}if(u(b)){a.getGUI().sysMsgTips(SMT_WARNING,rstr.herodlg.err.strengthen.arrivemaxval);return}var c=f.istrtimes.getVal(),d=e.getStrIFNeedItemNumber(b)*c;UseItemSender.send(a,{id:0,resid:FIXID.CHILINGDAN},d,{type:RES_TRG.SELF_HERO,id:b.id})},n=function(){var b=e.getCurHero();if(!b)return;var c=v(b);if(!c)return;if(b.level<c.prelevel){a.getGUI().sysMsgTips(SMT_WARNING,rstr.herodlg.err.skeleton.lowherolevel);return}if(a.getImgr().getHeroAttrVal(b,ATTR.IF)<c.preif){a.getGUI().sysMsgTips(SMT_WARNING,rstr.herodlg.err.skeleton.noenoughif);return}if(a.getImgr().getMoney()<c.needmoney){a.getGUI().sysMsgTips(SMT_WARNING,rstr.herodlg.err.skeleton.noenoughmoney);return}if(a.getImgr().getItemNumByResId(c.itemid)<c.needitem){a.getGUI().msgBox(rstr.comm.msgts,RStrUtil.makeNoItemBuyMsg(a,c.itemid,c.needitem),MB_F_CLOSE,null);return}HeroSender.sendSteelSkeleton(a,b.id)},o=function(){var a=e.getCurHero();if(!a)return;var b=UIM.getDlg("uselistitem");b.openDlg([RES_EFF.ACC_STEELMAILUO],{id:a.id,stoptime:a.skeleton.stoptime,name:a.name,type:RES_TRG.SELF_HERO})},p=function(){var b=e.getCurHero();if(!b)return{min:1,max:1};var c=e.getStrIFNeedItemNumber(b),d=a.getImgr().getItemNumByResId(FIXID.CHILINGDAN),f=Math.max(parseInt(d/c,10),1);return{min:1,max:f}},q=function(a){var b=e.getCurHero();if(!b){TQ.setHtml(f.strneeditem,"");return}TQ.setHtml(f.strneeditem,rstr.herodlg.lbl.strneeditem+e.getStrIFNeedItemNumber(b)*a)},r=function(a){return a.state==HERO_STATE.FREE},s=function(b){return t(b)<=a.getImgr().getItemNumByResId(FIXID.CHILINGDAN)},t=function(a){var b=f.istrtimes.getVal();return e.getStrIFNeedItemNumber(a)*b},u=function(b){var c=a.getImgr();return c.getHeroAttrVal(b,ATTR.IF)==c.getHeroAttrVal(b,ATTR.MIF)},v=function(a){return TQ.qfind(res_herojingmai,"id",a.skeleton.level+1)}}),HeroSkillTabPresenter=Class.extern(function(){var a=null,b=null,c=null,d=null,e=null,f=null,g=null;this.init=function(f,g,h,i){a=f,b=this,c=g,d=h,e=i},this.setCaller=function(){f=d.getCtrl("tablist").getTabItems(HERODLG_TAB_SKILL_IDX),h(),i(),j(),l(),m(),n(),o()};var h=function(){f.baseskilllist.setItemCount(MAX_BASESKILL_GRIDCNT);for(var a=0;a<MAX_BASESKILL_GRIDCNT;++a){var c=f.baseskilllist.getItem(a);TTIP.setCallerData(c.exsubs.tooltips[TIP_PREFIX+"item"],{self:b,caller:t},{idx:a})}},i=function(){f.specskilllist.setItemCount(MAX_SPECSKILL_GRIDCNT);for(var a=0;a<MAX_SPECSKILL_GRIDCNT;++a){var c=f.specskilllist.getItem(a);TTIP.setCallerData(c.exsubs.tooltips[TIP_PREFIX+"item"],{self:b,caller:u},{idx:a})}},j=function(){f.tacticskilllist.setItemCount(MAX_TACTICSKILL_GRIDCNT);for(var a=0;a<MAX_TACTICSKILL_GRIDCNT;++a){var c=f.tacticskilllist.getItem(a);TTIP.setCallerData(c.exsubs.tooltips[TIP_PREFIX+"item"],{self:b,caller:v},{idx:a})}},l=function(){TTIP.setCallerData(f.tooltips[TIP_PREFIX+"curtskill"],{self:b,caller:w},{})},m=function(){f.insight.setCaller({self:b,caller:p}),f.learn.setCaller({self:b,caller:q}),f.speedsteel.setCaller({self:b,caller:r}),f.addtime.setCaller({self:b,caller:s})},n=function(){f.baseskilllist.setCaller({self:b,caller:B}),f.tacticskilllist.setCaller({self:b,caller:C}),f.specskilllist.setCaller({self:b,caller:D}),TQ.addEvent(f.curtacticskill,"click",E)},o=function(){f.steelmenu.setCaller({self:b,caller:F}),f.learntskillmenu.setCaller({self:b,caller:G}),f.weartskillmenu.setCaller({self:b,caller:I}),f.unweartskillmenu.setCaller({self:b,caller:J}),f.learnsskillmenu.setCaller({self:b,caller:H})},p=function(){var c=e.getCurHero();if(!c)return"";if(z(c)==A(c)){a.getGUI().sysMsgTips(SMT_WARNING,rstr.herodlg.err.insight.noemptygrid);return}if(a.getImgr().getItemNumByResId(FIXID.LINGWUDAN)==0){a.getGUI().msgBox(rstr.comm.msgts,rstr.herodlg.err.insight.noenoughitem,MB_F_CLOSE,null);return}var d=function(b){b==MB_IDYES&&HeroSender.sendInsightSkill(a,c.id)};a.getGUI().msgBox(rstr.comm.msgts,rstr.herodlg.lbl.insightskill,MB_F_YESNO,{self:b,caller:d})},q=function(){var b=e.getCurHero();if(!b)return"";if(b.skillsteel.id>0){a.getGUI().sysMsgTips(SMT_WARNING,rstr.herodlg.err.learn.skillsteeling);return}var c=function(c){var d=c.itemres.effects[0].val;return TQ.find(b.skills,"id",d)==null?!0:(a.getGUI().sysMsgTips(SMT_WARNING,rstr.herodlg.err.learn.existskill),!1)},d=UIM.getDlg("uselistitem");d.openDlg([RES_EFF.LEARN_HERO_BSKILL],{id:b.id,name:b.name,type:RES_TRG.SELF_HERO}),d.setPreUseCaller(c)},r=function(){var a=e.getCurHero();if(!a)return"";var b=UIM.getDlg("uselistitem");b.openDlg([RES_EFF.ACC_STEELSKILL],{id:a.id,stoptime:a.skillsteel.stoptime,name:a.name,type:RES_TRG.SELF_HERO})},s=function(){var a=e.getCurHero();if(!a)return"";var b=UIM.getDlg("uselistitem");b.openDlg([RES_EFF.ADD_CANSTEELSKILL],{type:RES_TRG.SELF_ROLE})},t=function(a){var b=e.getCurHero();if(!b)return"";if(x(b,a.idx))return rstr.herodlg.tips.skill.lockedskill[a.idx];var c=y(b,a.idx);return c==null?"":TIPM.getSkillDesc(b,c)},u=function(b){var c=e.getCurHero();if(!c)return"";var d=a.getImgr().getSpecSkillByIdx(c,b.idx);return d==null?"":TIPM.getSpecSkillDesc(d,!0)},v=function(b){var c=e.getCurHero();if(!c)return"";var d=a.getImgr().getTacticSkillByIdx(c,b.idx);return d==null?"":TIPM.getTacticSkillDesc(d,"original")},w=function(b){var c=e.getCurHero();if(!c)return"";if(!c.curtskill)return rstr.herodlg.tips.skill.noweartacticskill;var d=a.getImgr().getHeroSkillById(c,c.curtskill);return d==null?rstr.herodlg.tips.skill.noweartacticskill:TIPM.getTacticSkillDesc(d,"weared")},x=function(a,b){var c=res_get_basegridcnt_by_herolevel(a.level);return b>=c&&b<MAX_BASESKILL_GRIDCNT},y=function(a,b){for(var c=0,d=0;c<a.skills.length;++c){var e=a.skills[c];if(e.id<res_hero_baseskill_id_first)continue;if(e.id>res_hero_baseskill_id_last)continue;if(d==b)return e;d++}return null},z=function(a){return res_get_basegridcnt_by_herolevel(a.level)},A=function(a){var b=0;for(var c=0;c<a.skills.length;++c){var d=a.skills[c];d.id>=res_hero_baseskill_id_first&&d.id<=res_hero_baseskill_id_last&&b++}return b},B=function(a,b){var c=e.getCurHero();if(!c)return;g=y(c,b);if(g==null)return;if(g.level==res_hero_baseskill_maxlevel)return;f.steelmenu.show(TQ.offsetPoint(TQ.mouseCoords(a),5,5))},C=function(b,c){var d=e.getCurHero();if(!d)return;g=a.getImgr().getTacticSkillByIdx(d,c);if(g==null)return;g.level==0?f.learntskillmenu.show(TQ.offsetPoint(TQ.mouseCoords(b),5,5)):f.weartskillmenu.show(TQ.offsetPoint(TQ.mouseCoords(b),5,5))},D=function(b,c){var d=e.getCurHero();if(!d)return;g=a.getImgr().getSpecSkillByIdx(d,c);if(g==null)return;g.level==0&&f.learnsskillmenu.show(TQ.offsetPoint(TQ.mouseCoords(b),5,5))},E=function(a){var b=e.getCurHero();if(!b)return;b.curtskill>0&&f.unweartskillmenu.show(TQ.offsetPoint(TQ.mouseCoords(a),5,5))},F=function(){a.getGUI().hideAllMenu();var c=e.getCurHero();if(!c)return;if(c.skillsteel.id>0){a.getGUI().sysMsgTips(SMT_WARNING,rstr.herodlg.err.ssteel.issteeling);return}if(a.getImgr().getCanUseSkillSteelTime()==0){a.getGUI().sysMsgTips(SMT_WARNING,rstr.herodlg.err.ssteel.nosstime);return}var d=function(b){HeroSender.sendSkillSteel(a,c.id,g.id,b)},f=a.getImgr().getCanUseSkillSteelTime(),h=res_canuse_sstime_maxnum,i=UIM.getDlg("inputnum");i.openDlg(rstr.herodlg.lbl.inputssitem,Math.min(f,h)),i.setCaller({self:b,caller:d})},G=function(){a.getGUI().hideAllMenu();var b=e.getCurHero();if(!b)return;var c=L(g.id),d=a.getImgr().getItemNumByResId(c);if(d==0){a.getGUI().msgBox(rstr.comm.msgts,RStrUtil.makeNoItemBuyMsg(a,c,1),MB_F_CLOSE,null);return}UseItemSender.send(a,{id:0,resid:c},1,{type:RES_TRG.SELF_HERO,id:b.id})},H=function(){a.getGUI().hideAllMenu();var b=e.getCurHero();if(!b)return;var c=M(g.id),d=a.getImgr().getItemNumByResId(c);if(d==0){a.getGUI().msgBox(rstr.comm.msgts,RStrUtil.makeNoItemBuyMsg(a,c,1),MB_F_CLOSE,null);return}UseItemSender.send(a,{id:0,resid:c},1,{type:RES_TRG.SELF_HERO,id:b.id})},I=function(){a.getGUI().hideAllMenu();var b=e.getCurHero();if(!b)return;HeroSender.sendWearTSkill(a,b.id,g.id)},J=function(){a.getGUI().hideAllMenu();var b=e.getCurHero();if(!b)return;HeroSender.sendUnWearTSkill(a,b.id)},K=function(a,b){var c=ItemResUtil.findEffectItems(a);for(k in c.items){var d=c.items[k],e=ItemResUtil.findItemres(d);for(ek in e.effects){var f=e.effects[ek];if(f.id!=a)continue;if(f.val==b)return d}}return 0},L=function(a){return K(RES_EFF.LEARN_HERO_TSKILL,a)},M=function(a){return K(RES_EFF.LEARN_HERO_SSKILL,a)}})