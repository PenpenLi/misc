calAngleByVector=function(a,b){var c=b.x-a.x,d=b.y-a.y,e=Math.sqrt(c*c+d*d),f=Math.acos(c/e);d<0&&(f=6.2831852-f);var g=parseInt(f*180/3.1415926);return g};var S_DIRMAPS=[[0,1,7,2,6,3,5,4],[1,0,2,3,7,4,6,5],[2,1,3,0,4,5,7,6],[3,2,4,1,5,9,6,7],[4,3,5,2,6,1,7,0],[5,4,6,3,7,0,2,1],[6,5,7,0,4,1,3,2],[7,0,6,1,5,2,4,3]];getDirByAngle=function(a,b){if(a.length==1)return a[0];var c=[0,0,0,0,0,0,0,0];for(var d=0;d<a.length;++d)c[a[d]]=1;var e=parseInt((b+22.5)/45)%8,f=S_DIRMAPS[e];for(var d=0;d<f.length;++d){var g=f[d];if(c[g]==1)return g}return 0},ActionShows=function(){var a=0,b=1,c=2,d=3,e=4,f=2147483646,g=100,h=30,i,j,k,l=[],m=[],n=0,o=0,p=!1;this.init=function(a,b){i=this,j=a,k=b},this.isCanPush=function(a){for(var b=0;b<l.length;++b){var c=l[b];if(!c.node.actor)continue;if(a.id==c.node.actor)return!1;if(a.targetid==c.node.actor)return!1;if(TQ.find(a.behits,"targetid",c.node.actor))return!1}return!0},this.push=function(b){q(),l.push({status:a,stime:EUPD.getTime(),effect:null,actionseq:0,node:b})},this.newSeq=function(){return++n%f},this.update=function(a){s(a)},this.isEnd=function(){return l.length==0},this.clear=function(){I()};var q=function(){p||(p=!0,EUPD.appendEffect(i,r))},r=function(a){p=!1},s=function(a){m.length>0&&o==1?(m=[],o=0):m.length>0&&++o;for(var b=0;b<l.length;++b){var c=l[b];c.node.type=="action"?t(a,c):c.node.type=="effect"?u(a,c):c.node.type=="event"?v(a,c):c.node.type=="flyevent"?w(a,c):c.node.type=="changeval"?x(a,c):c.node.type=="addstate"?y(a,c):c.node.type=="removestate"&&z(a,c)}B()},t=function(a,b){var c=function(a,b,c){c.setAction(b.node.action),b.actionseq=c.getActionSeq(),b.stime=a,b.status=d},f=function(a,b,c){if(!H(a,b))return;var c=j.getActorMgr().getActorById(b.node.actor);b.node.action=="die"?j.getActorMgr().destroyActor(b.node.actor):b.node.action=="coma"&&b.actionseq==c.getActionSeq()?c.setAction("coma"):b.actionseq==c.getActionSeq()&&c.setAction("stand"),b.status=e};A(a,b,c,f)},u=function(a,b){var c=function(a,b,c){var e=c.getPos(),f=j.getEntityfactory().allocEffect(k),g=TQ.qfind(res_effectclts,"id",b.node.effectid);e.x=e.x+16-g.corner.x,e.y=e.y+32-g.corner.y,f.setSize(g.size),f.setPos(e);var h=getDirByAngle(g.dirs,c.getAngle());f.setRes(b.node.effectid,h,0),f.setZOrder(ZORDER_EFFECT),b.effect=f,b.stime=a,b.status=d},f=function(a,b){if(!H(a,b))return;j.getEntityfactory().freeEffect(b.effect),b.effect=null,b.status=e};A(a,b,c,f)},v=function(a,b){var c=function(a,b,c){m.push(b.node.sendseq),b.status=e};A(a,b,c,null)},w=function(a,b){var c=function(a,b,c){var e=j.getEntityfactory().allocEffect(k),f=TQ.qfind(res_effectclts,"id",b.node.effectid);e.setSize(f.size),b.node.from.x=b.node.from.x+16-f.corner.x,b.node.from.y=b.node.from.y+32-f.corner.y,b.node.to.x=b.node.to.x+16-f.corner.x,b.node.to.y=b.node.to.y+32-f.corner.y,e.setPos(b.node.from);var g=calAngleByVector(b.node.from,b.node.to),h=getDirByAngle(f.dirs,g);e.setRes(b.node.effectid,h,0),e.setZOrder(ZORDER_EFFECT),b.effect=e,b.stime=a,b.status=d},f=function(a,b){var c=a-b.stime,d=b.node.to.x-b.node.from.x,f=b.node.to.y-b.node.from.y,g=Math.sqrt(d*d+f*f),h=parseInt(c*b.node.speed/1e3);if(h>=g)j.getEntityfactory().freeEffect(b.effect),b.effect=null,m.push(b.node.sendseq),b.status=e;else{var i=parseInt(h*d/g),k=parseInt(h*f/g);b.effect.setPos({x:b.node.from.x+i,y:b.node.from.y+k})}};A(a,b,c,f)},x=function(a,b){var c=function(a,b,c){var e={cx:64,cy:12},f=c.getPos(),g=j.getEntityfactory().allocNumEffect(k);g.setSpeed(h),g.setSize(e),g.setPos({x:f.x-16,y:f.y-6}),g.setZOrder(ZORDER_NUMBER);var i={};i[ATTACK_EFFECT.ADDHP]={cname:"upaddhp",val:b.node.value},i[ATTACK_EFFECT.SUBHP]={cname:"upsubhp",val:b.node.value},i[ATTACK_EFFECT.ADDMP]={cname:"upaddmp",val:b.node.value},i[ATTACK_EFFECT.SUBMP]={cname:"upsubmp",val:b.node.value},i[ATTACK_EFFECT.MISS]={cname:"upsubhp",val:rstr.fight.missatt},g.getEntity().setClass(i[b.node.attr].cname),g.setNumber(i[b.node.attr].val),b.effect=g,g.start(),b.status=d},f=function(a,b){b.effect.update(a),b.effect.isEnd()&&(j.getEntityfactory().freeNumEffect(b.effect),b.effect=null,b.status=e)};A(a,b,c,f)},y=function(a,b){var c=function(a,b,c){c.addState(b.node.state,b.node.duration),b.status=e};A(a,b,c,null)},z=function(a,b){var c=function(a,b,c){c.removeState(b.node.state),b.status=e};A(a,b,c,null)},A=function(a,b,c,e){if(b.status<d){if(!F(a,b))return;if(!c)return;var f=null;b.node.actor?(f=G(b))!=null&&c(a,b,f):c(a,b,null)}else b.status==d&&e&&e(a,b)},B=function(){for(var a=l.length-1;a>=0;--a){var b=l[a];b.status==e&&TQ.removeElement(l,a)}},C=function(a){return a==-1?!0:TQ.find(m,null,a)!=null},D=function(a,c){if(c.status<b){if(!C(c.node.waitseq))return!1;c.node.waitseq>=0&&(c.stime=a),c.status=b}return!0},E=function(a,b){if(b.status<c){if(a-b.stime<b.node.wait)return!1;b.status=c}return!0},F=function(a,b){return D(a,b)?E(a,b)?!0:!1:!1},G=function(a){if(!a.node.actor)return null;var b=j.getActorMgr().getActorById(a.node.actor);return b||(a.status=e),b},H=function(a,b){var c=a-b.stime;return c>=b.node.duration?!0:!1},I=function(){j.getActorMgr().clearAll();for(var a=0;a<l.length;++a){var b=l[a];b.node.type=="effect"||b.node.type=="flyevent"?j.getEntityfactory().freeEffect(b.effect):b.node.type=="changeval"&&j.getEntityfactory().freeNumEffect(b.effect)}l=[],m=[],n=0,o=0,p=!1};this.init.apply(this,arguments)},AttackShowHandler=function(){var a,b,c,d=[],e;this.init=function(d,f){a=this,b=d,c=new ActionShows(b,f),e=function(){return!0}},this.push=function(a){d.push(a)},this.setCheckCanPushCaller=function(a){e=a},this.update=function(a){f(a)},this.clear=function(){d=[],c.clear()},this.isEmpty=function(){return d.length==0&&c.isEnd()};var f=function(a){if(d.length==0)return;c.isCanPush(d[0])&&e(d[0])&&(g(d[0]),log("_handle m_nodes[0]"),TQ.removeElement(d,0))},g=function(a){var c=b.getActorMgr().getActorById(a.id),d=b.getActorMgr().getActorById(a.targetid),e=TQ.qfind(res_skillclts,"id",a.skillid);h(c,d);var f=-1;f=i(e,a,f),f=j(e,a,f),f=l(e,c,d,f),m(e,a,f)},h=function(a,b){a!=b&&a.faceToPos(b.getPos())},i=function(a,b,c){return k(a.prephase,b,c)},j=function(a,b,c){return k(a.atkphase,b,c)},k=function(a,b,d){if(!a)return d;var e=c.newSeq();return p(a,b.id,d,e),d=e,d},l=function(a,b,d,e){if(a.flyphase&&b!=d&&d){var f=a.flyphase.effect,g=c.newSeq();c.push({type:"flyevent",wait:f.wait,waitseq:e,from:b.getPos(),to:d.getPos(),effectid:f.id,speed:f.speed,sendseq:g}),e=g}return e},m=function(a,b,d){if(!a.hitphase)return;for(var e=0;e<b.behits.length;++e){var f=b.behits[e],g=c.newSeq();n(a.hitphase,f,d,g),o(f,d,g)}},n=function(a,b,c,d){var e=a[q(b.effects)];p(e,b.targetid,c,d)},o=function(a,b,d){for(var e=0;e<a.effects.length;++e){var f=a.effects[e];f.id>=ATTACK_EFFECT.MISS&&f.id<=ATTACK_EFFECT.SUBMP?c.push({type:"changeval",wait:0,waitseq:d,actor:a.targetid,attr:f.id,value:f.val}):f.id==ATTACK_EFFECT.DEAD?c.push({type:"action",wait:30,waitseq:d,actor:a.targetid,action:"die",duration:2e3}):f.id==ATTACK_EFFECT.COMA?(c.push({type:"action",wait:30,waitseq:d,actor:a.targetid,action:"coma",duration:100}),c.push({type:"addstate",wait:30,waitseq:d,actor:a.targetid,state:f.id,duration:f.val})):f.id==ATTACK_EFFECT.REVIVE?(c.push({type:"action",wait:30,waitseq:d,actor:a.targetid,action:"stand",duration:100}),c.push({type:"effect",wait:0,waitseq:d,actor:a.targetid,effectid:1e5,duration:2e3}),c.push({type:"removestate",wait:30,waitseq:d,actor:a.targetid,state:ATTACK_EFFECT.COMA})):alert("error: 3965")}},p=function(a,b,d,e){a.action&&c.push({type:"action",wait:a.action.wait,waitseq:d,actor:b,action:a.action.name,duration:a.action.duration}),a.effect&&c.push({type:"effect",wait:a.effect.wait,waitseq:d,actor:b,effectid:a.effect.id,duration:a.effect.duration}),a.event&&c.push({type:"event",wait:a.event.wait,waitseq:d,sendseq:e})},q=function(a){var b=0;return r(a,ATTACK_EFFECT.STRONG)?b=1:r(a,ATTACK_EFFECT.MISS)&&(b=2),b},r=function(a,b){return TQ.find(a,"id",b)!=null};this.init.apply(this,arguments)}