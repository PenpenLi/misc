FightResultDlg=Class.extern(function(){var a=0,b=1,c=null,d=null,e=null,f={},g=0,h=0,i=null,j=null,k=null;this.init=function(a){c=a,d=this},this.getCtrl=function(a){return f[a]},this.openDlg=function(a,b){l(a,b),m(),p()},this.closeDlg=function(){e.hide()},this.setHideCaller=function(a){k=a},this.isShow=function(){return e?e.isShow():!1};var l=function(a,b){g=a,h=b},m=function(){e||(e=Dialog.snew(c,{modal:!0,title:rstr.military.fightresult.title,pos:{x:"center",y:40}}),c.getGUI().initDlg(e,uicfg.military.fightresult,f),e.setCaller({self:d,caller:q}),n(),o()),e.show()},n=function(){for(var a=0;a<rstr.military.fightresult.tabs.length;++a)f.tabList.setTabText(a,rstr.military.fightresult.tabs[a])},o=function(){var d=f.tabList.getTabItems(a);i=FightResultTabPanel.snew(c,d);var e=f.tabList.getTabItems(b);j=FightRoundShowTabPanel.snew(c,e)},p=function(){f.tabList.activeTab(a),i.updateFightResults(c.getImgr().getFightDemoResult(g,h)),j.updateFightActions(c.getImgr().getFightDemoRounds(g,h))},q=function(a){a==C_SYS_DLG_HIDE&&k&&k.caller.call(k.self)}}),FRTAttackCampDom=Class.extern(function(){var a=null;this.init=function(b){a=b},this.getRoleInfoDoms=function(){return{icon:a.attackIcon,name:a.attackName,level:a.attackLevel,alliance:a.attackAlliance}},this.getHeroList=function(){return a.attackList},this.getHeroListAddAttrTitle=function(){return a.attackerAddAttrHead},this.getResPanel=function(){return a.attackRes}}),FRTTargetCampDom=Class.extern(function(){var a=null;this.init=function(b){a=b},this.getRoleInfoDoms=function(){return{icon:a.targetIcon,name:a.targetName,level:a.targetLevel,alliance:a.targetAlliance}},this.getHeroList=function(){return a.targetList},this.getHeroListAddAttrTitle=function(){return a.targetAddAttrHead},this.getResPanel=function(){return a.targetRes}}),FightResultTabPanel=Class.extern(function(){var a=null,b=null,c=null,d=null,e=null;this.init=function(f,g){a=f,c=g,b=this,e=FightResultMaker.snew(a),d={attacker:FRTAttackCampDom.snew(c),defender:FRTTargetCampDom.snew(c)}},this.updateFightResults=function(a){if(a==null)return;g("attacker",a.attacker),g("defender",a.defender),h(a),j("attacker",a.attacker),j("defender",a.defender),m(a),i(a),n("attacker",a.attacker),n("defender",a.defender)};var f=function(a){return d[a]},g=function(a,b){var c=f(a).getRoleInfoDoms();IMG.setBKImage(c.icon,IMG.makeBigImg(b.role.icon)),TQ.setText(c.name,b.role.name),TQ.setText(c.level,b.role.level),TQ.setText(c.alliance,b.role.alli)},h=function(a){var b="";e.isMySucc(a)?b="fight/retwin.gif":b="fight/retfail.gif",IMG.setBKImage(c.fightResult,IMG.makeImg(b))},i=function(a){var b=e.getGetOrLostResTitle(a);TQ.setText(c.attackResTitle,b.attack),TQ.setText(c.targetResTitle,b.target)},j=function(a,b){var c=f(a).getHeroList(),d=f(a).getHeroListAddAttrTitle(),e="";c.setItemCount(b.heros.length);for(var g=0;g<b.heros.length;++g){var h=c.getItem(g),i=b.heros[g];l(h,i),e=k(i,e)}TQ.setText(d,e)},k=function(a,b){return a.addExp>0?rstr.military.fightresult.lbl.exp:a.addCredit>0?rstr.military.fightresult.lbl.credit:b},l=function(a,b){TQ.setText(a.exsubs.name,b.name),TQ.setText(a.exsubs.level,b.level),TQ.setText(a.exsubs.soldierName,RStrUtil.getSoldierNameByResId(b.soldier.resid)),TQ.setText(a.exsubs.soldierNumber,b.soldier.number),TQ.setText(a.exsubs.lostNumber,b.soldier.loss),TQ.setText(a.exsubs.reviveNumber,b.soldier.revive);var c=0;b.addExp>0?c=b.addExp:b.addCredit>0&&(c=b.addCredit),TQ.setText(a.exsubs.addAttrNumber,c)},m=function(a){var b=e.getHonorString(a)+e.getDefExpend(a.defender.defexpend);TQ.setRichText(c.targetLostDefRes,b)},n=function(a,b){var c=f(a).getResPanel(),d=e.getGetOrLostResString(b),g=e.getDropItemsString(b);TQ.setTextEx(c,d+"<br/>"+g)}}),FightRoundShowTabPanel=Class.extern(function(){var a=null,b=null,c=null,d={},e=null,f="",g=null;this.init=function(d,e){a=d,c=e,b=this,g=FightResultMaker.snew(a),h()},this.updateFightActions=function(a){if(a==null)return;e=a,C(),i(),j();for(var b=0;b<e.rounds.length;++b){var d=e.rounds[b];for(var g=0;g<d.length;++g){var h=d[g];l(h)}}TQ.setHtml(c.rounds.getContainerObj(),f),c.rounds.refresh()};var h=function(){d.round=m,d.move=n,d.miss=o,d.attack=p,d.berserk=q,d.die=s,d.addeff=t,d.removeeff=u,d.effect=v},i=function(){f=g.getResultTitle(e)+rstr.military.fightresult.actions.roundDetail},j=function(){if(!IS_DEBUG)return;for(var a=0;a<e.attacker.actors.length;++a){var b=e.attacker.actors[a];k(rstr.military.fightresult.actions.attackCamp,b)}for(var a=0;a<e.defender.actors.length;++a){var b=e.defender.actors[a];k(rstr.military.fightresult.actions.defendCamp,b)}},k=function(a,b){if(!b.detail)return;b.type==ACTOR_TYPE.WALL?f+=a+TQ.format(rstr.military.fightresult.actions.wallActorDetail,b.detail.attrs[ATTR.HP],b.detail.attrs[ATTR.MHP],b.detail.attrs[ATTR.DE],b.detail.attackSpeed,b.detail.attackRange):b.type==ACTOR_TYPE.HERO?f+=a+TQ.format(rstr.military.fightresult.actions.heroActorDetail,b.name,b.detail.attrs[ATTR.HP],b.detail.attrs[ATTR.HI],b.detail.attrs[ATTR.HU],b.detail.attrs[ATTR.DE],b.detail.attrs[ATTR.ES],b.detail.attrs[ATTR.BER],b.detail.attackSpeed,b.detail.attackRange):b.type==ACTOR_TYPE.SOLDIER?f+=a+TQ.format(rstr.military.fightresult.actions.soldierActorDetail,b.name,b.detail.attrs[ATTR.HP],b.detail.attrs[ATTR.HI],b.detail.attrs[ATTR.HU],b.detail.attrs[ATTR.DE],b.detail.attrs[ATTR.ES],b.detail.attrs[ATTR.BER],b.detail.attrs[ATTR.UHP],b.detail.attackSpeed,b.detail.attackRange):b.type==ACTOR_TYPE.DEF&&(f+=a+TQ.format(rstr.military.fightresult.actions.defActorDetail,b.name,b.detail.attrs[ATTR.HU],b.detail.unitNumber,b.detail.attackSpeed,b.detail.attackRange))},l=function(a){var b=d[a.event];b&&b(a)},m=function(a){f+=TQ.format(rstr.military.fightresult.actions.round,a.round)},n=function(a){var b=B(a.id);E(b)?f+=TQ.format(rstr.military.fightresult.actions.myMove,b.name):f+=TQ.format(rstr.military.fightresult.actions.enemyMove,b.name)},o=function(a){var b=B(a.userid),c=B(a.targetid);E(b)?f+=TQ.format(rstr.military.fightresult.actions.myMiss,b.name,c.name):f+=TQ.format(rstr.military.fightresult.actions.enemyMiss,b.name,c.name)},p=function(a){r(!1,a)},q=function(a){r(!0,a)},r=function(a,b){var c=B(b.userid),d=B(b.targetid),e="";a&&E(c)?e=rstr.military.fightresult.actions.myBerserk:a?e=rstr.military.fightresult.actions.enemyBerserk:E(c)?e=rstr.military.fightresult.actions.myAttack:e=rstr.military.fightresult.actions.enemyAttack;var g=x(d,b.val);f+=TQ.format(e,c.name,d.name,z(d.type),g)},s=function(a){var b=B(a.id);E(b)?f+=TQ.format(rstr.military.fightresult.actions.myDie,b.name):f+=TQ.format(rstr.military.fightresult.actions.enemyDie,b.name)},t=function(a){var b=TQ.find(res_fighteffects,"effectid",a.effid);if(!b)return b;var c=B(a.id);E(c)?f+=TQ.format(rstr.military.fightresult.actions.myAddEffect,c.name,b.desc):f+=TQ.format(rstr.military.fightresult.actions.enemyAddEffect,c.name,b.desc)},u=function(a){var b=TQ.find(res_fighteffects,"effectid",a.effid);if(!b)return b;var c=B(a.id);E(c)?f+=TQ.format(rstr.military.fightresult.actions.myRemoveEffect,c.name,b.desc):f+=TQ.format(rstr.military.fightresult.actions.enemyRemoveEffect,c.name,b.desc)},v=function(a){var b=TQ.find(res_fighteffects,"effectid",a.effid);if(!b)return b;var c=B(a.userid),d=B(a.targetid),e=a.userid==a.targetid,g=E(c);g&&e?f+=TQ.format(rstr.military.fightresult.actions.myUseToSelfEffect,c.name,b.desc,w(b.isHelpful,a)):g&&!e?f+=TQ.format(rstr.military.fightresult.actions.myUseToOtherEffect,c.name,d.name,b.desc,w(b.isHelpful,a)):!g&&e?f+=TQ.format(rstr.military.fightresult.actions.enemyUseToSelfEffect,c.name,b.desc,w(b.isHelpful,a)):!g&&!e&&(f+=TQ.format(rstr.military.fightresult.actions.enemyUseToOtherEffect,c.name,d.name,b.desc,w(b.isHelpful,a)))},w=function(a,b){var c=TQ.qfind(res_attrs,"id",b.attr);if(b.attr==ATTR.HP){var d=B(b.targetid);if(b.val>0){if(a){var e=y(d,b.val);return TQ.format(rstr.military.fightresult.actions.addHPAttr,A(d.type),e)}var e=x(d,b.val);return TQ.format(rstr.military.fightresult.actions.subHPAttr,z(d.type),e)}var e=x(d,-b.val);return TQ.format(rstr.military.fightresult.actions.subHPAttr,z(d.type),e)}return b.val>0?TQ.format(rstr.military.fightresult.actions.addAttr,b.val,c.name):TQ.format(rstr.military.fightresult.actions.subAttr,-b.val,c.name)},x=function(a,b){var c=Math.ceil(b/a.fordesc.uhp);return c>a.fordesc.facthp?(c=a.fordesc.facthp,a.fordesc.facthp=0):a.fordesc.facthp-=c,c},y=function(a,b){var c=Math.ceil(b/a.fordesc.uhp);return c+a.fordesc.facthp>a.fordesc.factmhp?(c=a.fordesc.factmhp-a.fordesc.facthp,a.fordesc.facthp=a.fordesc.factmhp):a.fordesc.facthp+=c,c},z=function(a){return a==ACTOR_TYPE.SOLDIER?rstr.military.fightresult.actions.subSoldierLable:rstr.military.fightresult.actions.subHPLable},A=function(a){return a==ACTOR_TYPE.SOLDIER?rstr.military.fightresult.actions.addSoldierLable:rstr.military.fightresult.actions.addHPLable},B=function(a){var b=TQ.find(e.attacker.actors,"id",a);return b!=null?(b.camp="attacker",D(b),b):(b=TQ.find(e.defender.actors,"id",a),b.camp="defender",D(b),b)},C=function(){for(var a=0;a<e.attacker.actors.length;++a){var b=e.attacker.actors[a];b.fordesc=null,D(b)}for(var a=0;a<e.defender.actors.length;++a){var b=e.defender.actors[a];b.fordesc=null,D(b)}},D=function(a){a.fordesc||(a.fordesc={hp:1,mhp:1,uhp:1,fmax:1,facthp:1,factmhp:1},a.detail&&(a.fordesc.hp=a.detail.attrs[ATTR.HP],a.fordesc.mhp=a.detail.attrs[ATTR.HP],a.fordesc.uhp=a.detail.attrs[ATTR.UHP],a.fordesc.facthp=Math.floor(a.fordesc.hp/a.fordesc.uhp),a.fordesc.factmhp=a.fordesc.facthp))},E=function(a){return a.camp=="attacker"&&e.myIsAttacker?!0:a.camp=="defender"&&!e.myIsAttacker?!0:!1}})