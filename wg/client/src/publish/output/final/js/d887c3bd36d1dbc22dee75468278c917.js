GSTATE={ERROR:-1,CLOSE:0,CONNECT:1,LOGIN:2,BEGIN:3,CREATEROLE:4,GETDATA:5,STARTGAME:6,INGAME:7,LOSTCONN:8,RECONN:9},SST_NORMAL=0,SST_BAD=1,SST_GOOD=2,NETCMD_GM=3,NETCMD_RECONN=4,NETCMD_SETCLTKEY=5,NETCMD_RECONNECTED_OK=6,NETCMD={ERROR:50,LOGIN:51,CREATEROLE:52,ROLEBASE:53,RES:54,HEARTBEAT:56,USEITEM:59,CITYRES:60,BUILDRES:61,GENRES:62,SOLDIERRES:63,DEFRES:64,CHAT:65,PKG:66,SHOP:67,DEAL:68,REPORT:69,LETTER:70,STORE:71,TASK:72,MAP:73,MILITARY:74,FAVORITES:75,FIGHT:76,RESPLANE:77,HERORES:78,SVRCFG:79,FRIEND:80,TEAM:81,SYSMSG:82,ITEM:83,FARM:84,CULTURE:85,STRATEGY:86,RANKING:87,ALLIANCE:88,MAKE:89,NPCTALK:90,MAPPLAYERS:91,BATTLE:92,MAIL:93,CITYDEF:94,TOWER:95,SELFFIELD:96,ITEMOP:97,OUTFIELD:98,EXCHANGEEXP:99,FIGHTREFSTATE:100,ROLESTATE:101,OTHERPLAYERINFO:102,TRADING_AREA:103,ACT_TOWER:104,ACT_TERRACE:105,ACTIVITY_VAL:106,NEWCOMERHELP:107,PAYMENT:111,START_BuyByGold:112,RESULT_BuyByGold:113,EXCHANGE:200,CLT_LOG:201,FULL_ROLES:202,YELLOWDIAMOND:203,CLT_CFG:204,VIP:205,AUTOBUILD:206,PAYGOLD:207,BLUEDIAMOND:208,CDKEY:209,WORLDBOSS:210,SEND_REWARD:211},EVENT_RET_BREAK=1,EVENT_RET_OK=0,RET_OK=0,RET_CONTINUE=0,RET_END=1,EVT={GEN_DETAIL:0,TACTICAL_CHANGE:1,EXERCISE:2,ARMYDYN:3,ARMYDYNDETAIL:4,RES_CHANGE:5,INBUILD_CHANGE:6,MOUSEDOWN:7,HERO_DETAIL:8,PKG_CHANGE:9,NET:10,LOGIN_OK:11,TASKCHANGE:12,CFGDOWNLOAD:13,LETTERUPDATE:14,SCRIPTLOADED:15,CSSLOADED:16,SHOWHELPBYID:17,NEWHELPTASKNEXT:18,HERO_UPDATE:19,NEW_CHAT:20,TEAMINFO_CHANGE:21,NEWAPPLY_TEAM:22,UPDATER:23,FARMINFO:24,ROLEBASE:25,FRIENDLIST:26,FIGHT_CDLIST:27,FIGHT_ROUND:28,FIGHT_MOVE:29,FIGHT_OPMENU:30,FIGHT_ATTACK:31,FIGHT_RESULT:32,ARMYDYN_SELF:33,ARMYDYN_ENEMY:34,ARMYDYN_ALLI:35,ARMYDYN_SELF_DETAIL:36,ARMYDYN_ENEMY_DETAIL:37,ARMYDYN_ALLI_DETAIL:38,NEW_MILITARY:39,MANUAL_FIGHT:40,NEW_ALLIAPPLY:41,SOLDIERRES:42,SETCITYLEVEL:43,HERO_STRIF_RESULT:44,CITYRES:45,CULTURE_UPDATE:46,BATTLETIMES_UPDATE:47,BDEFAULT_TEAMS_UPDATE:48,FAVORITE_UPDATE:49,PERSONAL_ARMY_UPDATE:50,SALLIANCE_ARMY_UPDATE:53,NEW_MAIL:54,OUTFIELD_DETAIL:55,SELFFIELD_UPDATE:56,CITYTYPES:57,ENEMY_UPDATE:58,ROLESPECSTATE_CHANGE:59,SELFALLIMEM_CHANGE:60,SELFALLI_DETAIL:61,ACTIVITY_VAL:62,PAYACT:63,AUTOBUILD:64,WORLDBOSS:65,SELLING_ITEMS:66,SAVE_FORCES:67,UPD_ACT_VAL_REDDOT:68},MT_CHAT=1,MT_FIGHT=2,CUR_NORMAL=0,CUR_F_ATTACK=1,CUR_F_RESCUE=2,CUR_F_SEL_ATTACK=3,CUR_F_SEL_RESCUE=4,CUR_F_SEL_CANNOT=5,Network=function(){var a=2147483646,b=100,c,d,e={},f=!0,g=0,h=null,i="",j="fheurdh6537aj1HG";this.init=function(a,e){c=this,d=a,h=e,h.setGameObj(d),this.initKey(),d.regUpdater(c,l,b)},this.regSendLimit=function(a,b){e[a]={limit:b,delay:0,last:0,msg:null}},this.regSendDelay=function(a,b){e[a]?e[a].delay=b:e[a]={limit:0,delay:b,last:0,msg:null}},this.send=function(a,b){return o(a,b)},this.sendRaw=function(a){h.send(a)},this.setKey=function(a){h.setKey(a),i=a},this.setMaxPackLen=function(a){h.setMaxPackLen(a)},this.connect=function(){h.connect()},this.close=function(){h.close()},this.initKey=function(){h.setKey(j)},this.resetKey=function(){h.setKey(i)};var l=function(a){f&&m(a)&&(f=!1)},m=function(a){var b=!0;for(k in e){var c=e[k];c.msg&&a-c.last>=c.delay?(h.send(c.msg),c.msg=null):c.msg&&(b=!1)}return b},n=function(){return++g%a},o=function(a,b){var c=d.getCurTimeMs(),g=n();return b=p(b,g),b==""?alert("send msg is empty!"):a?e[a]?e[a].delay>0?(e[a].msg=b,e[a].last=c,f=!0):e[a].last==0||c-e[a].last>=e[a].limit?(h.send(b),e[a].last=c):g=-1:h.send(b):h.send(b),g},p=function(a,b){return a=TQ.trim(a),a!=""&&(a=a.substr(0,a.length-1)+",_s="+b+"}"),a};this.init.apply(this,arguments)},GlobalPub=function(){var C_UPDATE_INTERVAL=100,C_RECONN_TIMES=3;this.init=function(a,b){m_this=this,m_sig=a,_init(b)},this.setId=function(a){m_id=a},this.setKey=function(a){m_network.setKey(a)},this.setMaxPackLen=function(a){m_network.setMaxPackLen(a)},this.getSig=function(){return m_sig},this.getImgr=function(){return m_imgr},this.getGUI=function(){return m_gui},this.getState=function(){return m_state},this.setState=function(a){_setState(a)},this.setSvrTimeMs=function(a){m_diffTimeMs=a-m_curTimeMs},this.regEvent=function(a,b,c,d){_regEvent(a,b,c,d)},this.sendEvent=function(a){_sendEvent(a)},this.pendEvent=function(a){m_pendevents.push({lasttime:m_curTimeMs,pendtime:a.pendtime,event:a})},this.pendReplaceEvent=function(a){for(var b=m_pendevents.length-1;b>=0;--b){var c=m_pendevents[b];if(c.event.eid!=a.eid||c.event.sid!=a.sid)continue;c.lasttime=m_curTimeMs,c.pendtime=a.pendtime;return}this.pendEvent(a)},this.regUpdater=function(a,b,c,d){if(_hasRegUpdater(a,b))return;var e=d?m_curTimeMs:0;m_updater.push({self:a,fun:b,interval:c,lasttime:e})},this.unregUpdater=function(a,b){_unregUpdater(a,b)},this.getCurTimeMs=function(){return m_curTimeMs},this.getSvrTimeMs=function(){return m_curTimeMs+m_diffTimeMs},this.getSvrTimeS=function(){return parseInt(this.getSvrTimeMs()/1e3,10)},this.regSendLimit=function(a,b){m_network.regSendLimit(a,b)},this.regSendDelay=function(a,b){m_network.regSendDelay(a,b)},this.send=function(a,b){return m_network.send(a,b)},this.connG=function(){_connectGame()},this.onResize=function(){m_windowResizer&&m_windowResizer.resize()},this.onConnect=function(a){m_state==GSTATE.CONNECT?_onFirstConnect(a):m_state==GSTATE.LOSTCONN&&_onReConnect(a)},this.onData=function(a){_onData(a)},this.onClose=function(){_onClose()},this.closeG=function(){m_network.close()},this.getEntityfactory=function(){return m_entityfactory},this.getActorMgr=function(){return m_actormgr},this.getWinSizer=function(){return m_windowResizer},this.getAnimMgr=function(){return m_pngAnimMgr};var _init=function(a){log("....1"),_initEnvironment(),log("....2"),_createObjects(a),log("....3"),_initObjects(),log("....4"),_createPopMenu(),log("....5"),_startUpdater(),log("....6"),_addCursors(),log("....7"),_hideGameBody(),log("....8"),m_windowResizer.regPanelSizer(),log("....9"),TQ.setCSS(TQ.getDomById("g_body"),"select","none"),log("....10")},_initEnvironment=function(){document.body.oncontextmenu=_onRightClick},_createObjects=function(a){m_windowResizer=WindowResizer.snew(m_this),m_network=new Network(m_this,a),m_imgr=new ItemMgrEx(m_this),m_gui=new UI(m_this),m_entityfactory=new EntityFactory(m_this),m_actormgr=ActorManager.snew(m_this),m_pngAnimMgr=PngAnimMgr.snew(m_this),m_redDot=RedDot.snew(m_this),TTIP.create(m_this)},_initObjects=function(){log("***....1"),IMG.setGameObj(m_this),log("***....2"),TIPM.init(m_this),log("***....3"),UIM.initOneTime(m_this),log("***....4"),HDRM.initOneTime(m_this),log("***....5"),JMISC.initOneTime(m_this),log("***....6"),HyperLinkMgr.initOneTime(m_this),log("***....7"),EUPD.initOneTime(m_this),log("***....8"),SelfFieldUtil.initOneTime(m_this),log("***....9"),CityBuildUtil.initOneTime(m_this),log("***....10"),SkillManager.initOneTime(m_this),log("***....11"),SkillPhaseFactory.initOneTime(m_this),log("***....12"),StateFactory.initOneTime(m_this),log("***....13"),EffectManager.initOneTime(m_this),log("***....14"),HeroNameColorGetter.initOneTime(m_this),log("***....15"),HeroNAttrFactorColorGetter.initOneTime(m_this),log("***....16"),FixTimer.initOneTime(m_this),log("***....17"),Payment.initOneTime(m_this),log("***....18"),HelpGuider.initOneTime(m_this),log("***....19"),SoundMgr.initOneTime(m_this),log("***....20"),RStrUtil.initOneTime(m_this),log("***....21")},_createPopMenu=function(){m_popmenu=new Menu(m_this,{width:110});for(var a=0;a<rstr.comm.rightmenu.length;++a)m_popmenu.addMenuItem({id:a,icon:null,text:rstr.comm.rightmenu[a]});m_popmenu.setCaller({self:m_this,caller:_onSysCommand})},_startUpdater=function(){m_timer=window.setInterval(_onUpdate,C_UPDATE_INTERVAL)},_addCursors=function(){m_this.getGUI().addCursor("normal",null,"default")},_setState=function(a){a==GSTATE.CREATEROLE?(_showGameBody(),g_loading.setTipText(rstr_loading.loginok)):a==GSTATE.GETDATA?_hideGameBody():a==GSTATE.STARTGAME&&(_showGameBody(),g_loading.setTipText(rstr_loading.loginok)),m_state=a},_unregUpdater=function(a,b){for(var c=0;c<m_updater.length;++c)if(m_updater[c].self==a&&m_updater[c].fun==b){TQ.removeElement(m_updater,c);break}},_hasRegUpdater=function(a,b){for(var c=0;c<m_updater.length;++c)if(m_updater[c].self==a&&m_updater[c].fun==b)return!0;return!1},_connectGame=function(){m_state=GSTATE.CONNECT,m_network.connect()},_reconnectGame=function(){m_state=GSTATE.LOSTCONN,m_network.connect()},_onFirstConnect=function(a){a?(_loginGame(),g_loading.setPercent(100),g_loading.setTipText(rstr_loading.connectok)):m_reconnectedTimes<C_RECONN_TIMES?(window.setTimeout(m_this.connG,2e3),m_reconnectedTimes++):(g_loading.setTipText(rstr_loading.connectfailed),_connectFailed())},_onReConnect=function(a){a?(m_reconnectedTimes=0,_reLoginGame(),UIM.getDlg("waiting").openDlg({tip:rstr_loading.reconnecting,callback:Caller.snew(this,function(){m_gui.noTitleMsgBox(rstr_loading.deconn),m_state=GSTATE.CLOSE})})):m_reconnectedTimes<C_RECONN_TIMES?(window.setTimeout(_reconnectGame,m_reconnectedTimes*1e3),UIM.getDlg("waiting").openDlg({tip:rstr_loading.reconnecting}),m_reconnectedTimes++):(m_gui.noTitleMsgBox(rstr_loading.deconn),m_state=GSTATE.CLOSE,_connectFailed())},_onData=function(a){var b=_safeEval(a);!b||(b.cmd&&b.cmd==NETCMD.ERROR?_handErrorCmd(b):b.cmd&&b.cmd==NETCMD.FULL_ROLES?(_clearTime(),m_state=GSTATE.CLOSE,g_loading.isShow()&&g_loading.setTipText(rstr_loading.fullroles)):b.cmd?_sendEvent({eid:EVT.NET,sid:b.cmd,data:b}):log("error cmd id!"))},_onClose=function(){m_state==GSTATE.INGAME?(window.setTimeout(_reconnectGame,1e3),UIM.getDlg("waiting").openDlg({tip:rstr_loading.reconnecting})):(_clearTime(),g_loading.isShow()?g_loading.setTipText(rstr_loading.deconn):m_gui.noTitleMsgBox(rstr_loading.deconn),m_state=GSTATE.CLOSE)},_onUpdate=function(){m_state!=GSTATE.CLOSE&&(m_curTimeMs=(new Date).getTime(),_updateUpdaterList(),_handlePendEvents())},_updateUpdaterList=function(){for(var a=0;a<m_updater.length;++a){var b=m_updater[a];m_curTimeMs-b.lasttime>=b.interval&&(b.fun.call(b.self,m_curTimeMs),b.lasttime=m_curTimeMs)}},_handlePendEvents=function(){for(var a=0;a<m_pendevents.length;++a){var b=m_pendevents[a];m_curTimeMs-b.lasttime>=b.pendtime&&(m_this.sendEvent(b.event),m_pendevents[a]=null,TQ.removeElement(m_pendevents,a),--a)}},_sendEvent=function(a){var b=a.eid+"."+a.sid,c=m_eventregs[b];if(c)try{_sendNodeEvent(c,a)}catch(a){var d="send event error: key["+b+"] "+ErrorGetter.getCommErr(a);m_this.getGUI().msgBox("error",d,MB_F_CLOSE,null),LogSender.sendLog(m_this,d)}},_sendNodeEvent=function(a,b){for(var c=0;c<a.length;++c){if(!a[c].fun)for(var d in a[c].self)alert(d);if(a[c].fun.call(a[c].self,b)==EVENT_RET_BREAK)break}},_regEvent=function(a,b,c,d){var e=a+"."+b,f=m_eventregs[e];f||(m_eventregs[e]=[],f=m_eventregs[e]),f.push({self:c,fun:d})},_showGameBody=function(){var a=TQ.getUiBody();TQ.setCSS(a,"visibility","visible"),TQ.setCSS(a,"display","block")},_hideGameBody=function(){var a=TQ.getUiBody();TQ.setCSS(a,"visibility","hidden"),TQ.setCSS(a,"display","none")},_loginGame=function(){m_state=GSTATE.LOGIN,m_network.sendRaw(m_sig),m_reconnectedTimes=0},_reLoginGame=function(){m_network.initKey(),m_network.send(null,"{cmd=4,userId="+m_imgr.getRoleRes().userId+',cltKey="'+m_imgr.getRoleRes().cltKey+'"}'),m_network.resetKey(),m_reconnectedTimes=0},_onRightClick=function(a){return!0},_onSysCommand=function(a){m_gui.hideAllMenu()},_clearTime=function(){m_timer&&(window.clearInterval(m_timer),m_timer=null)},_safeEval=function(pkg){var cmdPkg=null,jPkg=LUA.toJSON(pkg);try{cmdPkg=eval("("+jPkg+")")}catch(err){log("pkg error: "+err.description+"\nlua: "+pkg+"\njson: "+jPkg)}return cmdPkg},_handErrorCmd=function(a){g_loading.isShow()||m_state==GSTATE.LOGIN?g_loading.setTipText(a.msg):m_gui.msgBox(rstr.comm.msgts,a.msg,MB_F_CLOSE,null),a.closeflag&&(_clearTime(),m_state=GSTATE.CLOSE)},_connectFailed=function(){_clearTime(),m_reconnectedTimes=0,m_state=GSTATE.CLOSE},m_this,m_sig,m_state=GSTATE.CLOSE,m_updater=[],m_eventregs={},m_network=null,m_imgr=null,m_gui=null,m_actormgr=null,m_reconnectedTimes=0,m_curTimeMs=(new Date).getTime(),m_diffTimeMs=0,m_pendevents=[],m_popmenu=null,m_entityfactory,m_timer,m_id=0,m_windowResizer=null,m_pngAnimMgr=null,m_redDot=null;this.init.apply(this,arguments)},EffectUpdater=function(){var a=50;this.init=function(){g=this},this.initOneTime=function(a){f=a},this.appendEffect=function(a,b){d(a,b)},this.removeEffect=function(a){e(a)},this.getTime=function(){return k},this.update=function(){b()};var b=function(){k+=a;for(var b=i.length-1;b>=0;--b){var c=i[b].effect,d=i[b].endHdr;c.update(k),c.isEnd()&&(TQ.removeElement(i,b),d&&d(c))}i.length==0&&h&&(window.clearInterval(h),h=null,k=0)},c=function(){return j=j==2147483647?1:j+1,j},d=function(d,e){h||(h=window.setInterval(b,a)),c(),i.push({id:j,effect:d,endHdr:e})},e=function(a){TQ.find(i,"id",a)&&TQ.removeElement(i,TQ.getLastFindIdx())},f,g,h=null,i=[],j=0,k=0;this.init.apply(this,arguments)},EUPD=new EffectUpdater