CommBuildBlock=function(){var a,b,c,d=null,e=0,f=0,g=0,h=0,i=0,j=0,k=0,l=0,m=0,n=!0,o="comm";this.init=function(d,e,f){a=d,b=this,c=e,o=f?f:"comm",TQ.setClass(c,"inbldblock"),p()},this.clear=function(){b.setItem(null)},this.getORect=function(){return{x:i,y:j,w:k,h:l}},this.isInRect=function(a){return n?o=="rect"?TQ.isInRect(b.getORect(),a):o=="rhombus"?TQ.isInRhombus(b.getORect(),a):d?d.itemres.irects?q(d.itemres.irects,a):TQ.isInRect({x:e,y:f,w:TQ.getDomWidth(c),h:TQ.getDomHeight(c)},a):TQ.isInRhombus({x:e,y:f,w:TQ.getDomWidth(c),h:TQ.getDomHeight(c)},a):!1},this.setItem=function(a){d=a;var b=h,j=g;d&&(b=d.itemres.imgh,j=d.itemres.imgw),e=i+(k-j)/2,f=m-b,TQ.setCSS(c,"left",e+"px"),TQ.setCSS(c,"top",f+"px"),TQ.setDomWidth(c,j),TQ.setDomHeight(c,b)},this.getItem=function(){return d},this.show=function(){TQ.setCSS(c,"visibility","visible"),n=!0},this.hide=function(){TQ.setCSS(c,"visibility","hidden"),n=!1},this.isShow=function(){return n},this.getDom=function(){return c};var p=function(){i=e=parseInt(TQ.curCSS(c,"left"),10),j=f=parseInt(TQ.curCSS(c,"top"),10),l=h=TQ.getDomHeight(c),k=g=TQ.getDomWidth(c),m=parseInt(TQ.curCSS(c,"top"))+h},q=function(a,b){for(var c=0;c<a.length;++c){var d=a[c];if(TQ.isInRect({x:d[0]+e,y:d[1]+f,w:d[2],h:d[3]},b))return!0}return!1};this.init.apply(this,arguments)},FarmBuildBlock=function(){var a=null,b=null,c=null,d=null,e=null,f=null,g=null;this.init=function(e,f,g){a=e,b=this,c=f,d=new CommBuildBlock(a,c,g),h(),i()},this.clear=function(){d.setItem(null),a.unregUpdater(b,p)},this.getORect=function(){return d.getORect()},this.isInRect=function(a){return d.isInRect(a)},this.setItem=function(a){l(a),d.setItem(a),b.normal(),m(),n()},this.hot=function(){j()},this.normal=function(){k()},this.getItem=function(){return d.getItem()},this.show=function(){d.show()},this.hide=function(){d.hide(),TQ.setCSS(f,"visibility","hidden"),TQ.setCSS(g,"visibility","hidden"),a.unregUpdater(b,p)},this.isShow=function(){return d.isShow()},this.getDom=function(){return d.getDom()};var h=function(){f=TQ.createDom("div"),TQ.append(c,f),TQ.setClass(f,"farmblockcangather")},i=function(){g=TQ.createDom("div"),TQ.append(c,g),TQ.setClass(g,"farmblockprotect")},j=function(){IMG.setBKImage(c,IMG.makeFarmBuildImg(e.itemres.img,!0,e.state))},k=function(){IMG.setBKImage(c,IMG.makeFarmBuildImg(e.itemres.img,!1,e.state))},l=function(a){e=a},m=function(){e&&e.canGather?TQ.setCSS(f,"visibility","visible"):TQ.setCSS(f,"visibility","hidden")},n=function(){if(o()){TQ.setCSS(g,"visibility","visible");var c=(e.pStopTime-a.getSvrTimeS())*1e3;a.regUpdater(b,p,c,!0)}else TQ.setCSS(g,"visibility","hidden"),a.unregUpdater(b,p)},o=function(){return e&&e.state&&e.state==FARM_STATE.COMPLETE&&e.pStopTime&&a.getSvrTimeS()<e.pStopTime},p=function(){TQ.setCSS(g,"visibility","hidden"),a.unregUpdater(b,p)};this.init.apply(this,arguments)},NullBuildBlocks=Class.extern(function(){this.init=function(){},this.setCanUseBlockCnt=function(a){},this.getCanUseBlockCnt=function(){return 0},this.setViewPos=function(a,b){},this.getViewPos=function(){return{x:0,y:0}},this.getCount=function(){return 0},this.getBlock=function(a){return null},this.getCurBlock=function(){return null},this.getCurSel=function(){return-1},this.hideAllBlock=function(){},this.updateTip=function(){},this.setCaller=function(a){},this.setTipCaller=function(a){},this.click=function(a){},this.getTip=function(a){return null},this.getShowBlocks=function(){return 0}}).snew(),BuildBlocks=Class.extern(function(){var a=null,b=null,c=null,d=null,e=[],f=[],g=100,h=54,i=!1,j=!1,k=-1,l={x:0,y:0},m=null,n=null,o=null,p=-1,q="comm",r=null,s={x:0,y:0},t=0;this.init=function(f,i,j){a=f,b=this,c=i.map,d=i.mousemap,e=i.poss,g=i.blockw,h=i.blockh,n=i.clickcaller,o=i.tipcaller,r=i.blockclass,q=j?j:"comm",t=e.length,u(),v(),w()},this.setCanUseBlockCnt=function(a){t=a;for(var b=0;b<f.length;++b){var c=f[b];c.setDisable(b>=t),c.normal()}},this.getCanUseBlockCnt=function(){return t},this.setViewPos=function(a,b){s.x=a,s.y=b},this.getViewPos=function(){return s},this.getCount=function(){return f.length},this.getBlock=function(a){return f[a]},this.getCurBlock=function(){return b.getBlock(p)},this.getCurSel=function(){return p},this.hideAllBlock=function(){for(var a=0;a<f.length;++a)f[a].hide()},this.updateTip=function(){I()},this.setCaller=function(a){n=a},this.setTipCaller=function(a){o=a},this.click=function(a){n.caller.call(n.self,null,a)},this.getTip=function(a){return C({idx:a})},this.getShowBlocks=function(){var a=0;for(var b=0;b<f.length;++b){var c=f[b];c.isShow()&&a++}return a};var u=function(){for(var b=0;b<e.length;++b){var d=TQ.createDom("div");TQ.append(c,d),TQ.setCSS(d,"position","absolute"),TQ.setCSS(d,"zIndex",e[b].y),TQ.setDomRect(d,e[b].x,e[b].y,g,h),f.push(new r(a,d,q))}},v=function(){TQ.addEvent(d,"mouseover",x),TQ.addEvent(d,"mousemove",y),TQ.addEvent(d,"mouseout",z),TQ.addEvent(d,"mouseup",A),TQ.captureTouchEvent(d,{self:b,touchEnd:B})},w=function(){var a=TTIP.addTip(d,"no");m=TTIP.getTipById(a),m.setFlag(TIP_FLAG.CUSTOM),m.setCaller({self:b,caller:C})},x=function(a){i=!0,l=TQ.mouseCoords(a),E(a)},y=function(a){i&&(E(a),l=TQ.mouseCoords(a),j&&m.show(l))},z=function(a){i=!1,D(-1)},A=function(a){a=a?a:window.event;if(!i)return;p=J(a),n.caller.call(n.self,a,p)},B=function(a,b,c){i=!0,A(TQ.makeMouseEvent(b.pageX,b.pageY,BTN_LEFT,c))},C=function(a){return o.caller.call(o.self,a)},D=function(a){H(k),G(a),k=a},E=function(a){F(a)},F=function(a){if(DragMapChecker.isDragging())return;var b=J(a);k!=b&&D(b)},G=function(a){a>=0&&(f[a].hot(),m.setData({idx:a}),m.show(l),j=!0)},H=function(a){a>=0&&(f[a].normal(),m.hide(),j=!1)},I=function(){j&&(m.reset(),m.show(l))},J=function(a){var b=TQ.mouseRelativeCoords(d,a);b.x+=s.x,b.y+=s.y;for(var c=0;c<e.length;++c)if(f[c].isInRect(b))return c;return-1}}),SelPipDlg=function(){var a=null,b=null,c=null,d={},e=[],f=null;this.init=function(c){a=c,b=this},this.toggle=function(){this.isShow()?this.closeDlg():this.openDlg()},this.openDlg=function(){g(),c.show(),HelpGuider.getNewcomerSpirit().refreshCurNewcomerTask(),this.refreshNewComerSpirit()},this.closeDlg=function(){c&&(c.hide(),HelpGuider.getNewcomerSpirit().onDlgClose("selpip"))},this.setCaller=function(a){f=a},this.isShow=function(){return c?c.isShow():!1},this.click=function(a){j(null,a)},this.refreshNewComerSpirit=function(){HelpGuider.getNewcomerSpirit().onDlgOpen("selpip",{parent:c.getParent(),items:d})};var g=function(){c||(c=Dialog.snew(a,{modal:!1,canDrag:!0,dragTitleH:35,pos:{x:0,y:300},uiback:uiback.dlg.minihelp}),a.getGUI().initDlg(c,uicfg.farm.selpipdlg,d),d.closebtn.setCaller({self:b,caller:function(){b.closeDlg()}}),c.hide(),h())},h=function(){for(var a=FIXID.PIPSTART;a<=FIXID.PIPEND;++a)e.push({itemres:ItemResUtil.findItemres(a)});d.list.setItemCount(e.length);for(var c=0;c<e.length;++c){var f=d.list.getItem(c),g=e[c];IMG.setBKImage(f.exsubs.icon,IMG.makeBigImg(g.itemres.bigpic));var h=d.list.getSubItem(f,"tooltips")[TIP_PREFIX+"item"],k=TTIP.getTipById(h);k.setCaller({self:b,caller:i}),k.setData({idx:c})}d.list.setCaller({self:b,caller:j})},i=function(a){return TIPM.getFarmPipDesc(e[a.idx])},j=function(a,b){f&&f.caller.call(f.self,e[b].itemres.id,b)};this.init.apply(this,arguments)},FarmInfoDlg=function(){var a=null,b=null,c=null,d={},e={ver:-1,list:[]};this.init=function(c){a=c,b=this,FarmSender.initg(a),a.regEvent(EVT.NET,NETCMD.FARM,b,h)},this.openDlg=function(){f(),g(),c.show()},this.closeDlg=function(){c&&c.hide()},this.isShow=function(){return c!=null&&c.isShow()};var f=function(){c||(c=Dialog.snew(a,{modal:!1,title:rstr.farm.farminfo.title,pos:{x:"center",y:50}}),a.getGUI().initDlg(c,uicfg.farm.infolistdlg,d),c.hide())},g=function(){i(),FarmSender.sendGetFarmLog(e.ver)},h=function(a){var b=a.data;b.farminfo&&(e.ver=b.farminfo.ver,e.list=b.farminfo.list,i())},i=function(){d.list.setItemCount(e.list.length);for(var a=0;a<e.list.length;++a){var b=d.list.getItem(a);TQ.setTextEx(b.exsubs.con,j(e.list[a]))}},j=function(a){var b=a[0],c=a[1],d=TQ.formatDateTime(a[2]),e=a[3],f=a[4],g=a[5],h=a[6];return b==FARMLOG_TYPE.GETSELF?TQ.format(rstr.farm.farminfo.getmy,d,e,f,g,h):b==FARMLOG_TYPE.GETOTHER?TQ.format(rstr.farm.farminfo.getother,d,c,e,f,g,h):b==FARMLOG_TYPE.OTHERGET?TQ.format(rstr.farm.farminfo.otherget,d,c,e,f,g,h):""};this.init.apply(this,arguments)},FarmBlockTip=Class.extern(function(){var a=null,b=null,c=null;this.init=function(d,e){a=d,b=this,c=e},this.getBlockTip=function(a){var b=c.getBlock(a);return b?b.resid==FIXID.EMPTYFARMBLOCK?d():b.resid==FIXID.NEXTFARMBLOCK?e():b.state==FARM_STATE.COMPLETE?g(b):f(b):""};var d=function(){return c.isMyCurFarm()?TQ.formatLine(rstr.farm.tips.empty):TQ.formatLine(rstr.farm.tips.otherempty)},e=function(){if(c.isMyCurFarm()){var b=a.getImgr().getCityLevel();return TQ.formatLine(TQ.format(rstr.farm.tips.nextlevel,RStrUtil.getCityNameByLevel(b+1)))}return TQ.formatLine(rstr.farm.tips.othernextlevel)},f=function(a){if(c.isMyCurFarm()){var b=c.getBlockResInfo(a);return TQ.format(rstr.farm.tips.itemcontinue,a.itemres.outputname,TQ.formatTime(2,b.lefttime),b.res,parseInt(b.per*100,10))}var b=c.getBlockResInfo(a);return TQ.formatLine(TQ.format(rstr.farm.tips.othergreenblock,a.itemres.outputname,TQ.formatTime(2,b.lefttime)))},g=function(b){return b.pStopTime&&a.getSvrTimeS()<b.pStopTime?TQ.format(rstr.farm.tips.itemokex,b.itemres.outputname,b.leftres,b.totalres,TQ.formatTime(2,b.pStopTime-a.getSvrTimeS())):TQ.format(rstr.farm.tips.itemok,b.itemres.outputname,b.leftres,b.totalres)}}),FarmModel=Class.extern(function(){var a=null,b=null,c=null,d={ver:-1,role:{uid:-1,citylevel:-1},blocks:[]},e=null,f=FARMOP_STATE.SEL,g=0;this.init=function(d){a=d,b=this,c=FarmBlockTip.snew(a,this),FarmSender.initg(a)},this.regObserver=function(a){e=a},this.getOpState=function(){return f},this.setOpState=function(a){f=a,e&&e.onSetOpState(f),HelpGuider.getNewcomerSpirit().refreshCurNewcomerTask()},this.getPipResid=function(){return g},this.setPipResid=function(a){g=a},this.handleFarmSvrData=function(a){o(a.data.farm),p(a.data.farminput),q(a.data.farmgets),HelpGuider.getNewcomerSpirit().refreshCurNewcomerTask()},this.updateBlocks=function(){var b=a.getSvrTimeS(),c=[],f=[];for(var g=0;g<d.blocks.length;++g){var h=d.blocks[g];if(h.resid==FIXID.EMPTYFARMBLOCK)continue;if(h.resid==FIXID.NEXTFARMBLOCK)continue;if(h.state==FARM_STATE.COMPLETE)continue;h.stoptime<=b&&!this.isMyCurFarm()&&c.push(h.id);if(h.state==FARM_STATE.SAPLING){var i=h.stoptime-h.starttime,j=b-h.starttime;j>=i/2&&(f.push(h.id),h.state=FARM_STATE.GROWUP)}}FarmSender.sendCompleteFarmBlocks(d.role.uid,c),e&&e.updateBlocksState(f)},this.getCurFarm=function(){return d},this.isMyFarm=function(b){if(!b.role||!b.role.uid)return!1;var c=a.getImgr().getRoleRes().uid;return c==b.role.uid},this.isMyCurFarm=function(){return this.isMyFarm(this.getCurFarm())},this.getCanGetMyRes=function(b){var c=0,d=a.getImgr().getMyFarm();for(var e=0;e<d.blocks.length;++e){var f=d.blocks[e];if(f.resid!=b)continue;var g=this.getBlockResInfo(f);if(g.state!=FARM_STATE.COMPLETE)continue;c+=g.res}return c},this.getBlockCount=function(a){var b=0;for(var c=0;c<d.blocks.length;++c){var e=d.blocks[c];if(e.resid!=a)continue;b++}return b},this.getTotalBlockCount=function(){return m(d.role.citylevel)},this.getNextBlockCount=function(){return n(d.role.citylevel)},this.getBlock=function(a){return TQ.find(d.blocks,"id",a)},this.getBlockTip=function(a){return c.getBlockTip(a)},this.getBlockRes=function(a){return this.getBlockResInfo(a).res},this.getBlockResInfo=function(b){if(b.state==FARM_STATE.COMPLETE)return{lefttime:0,per:1,res:b.leftres,state:b.state};var c=b.stoptime-b.starttime,d=b.stoptime-a.getSvrTimeS();d<=0?d=0:d>c&&(d=c);var e=c-d,f=e/c,g=parseInt(f*b.totalres*res_getfarmres_pre,10);return{lefttime:d,per:f,res:g,state:b.state}};var h=function(a,b){if(!a.role||a.role.citylevel==undefined)return;if(a.role.citylevel==b.role.citylevel)return;b.role.citylevel=a.role.citylevel,i(b),j(b)},i=function(a){k(a);var c=a.blocks.length,d=b.getTotalBlockCount();if(c>=d)a.blocks.length=d;else for(var e=c;e<d;++e)a.blocks.push({id:e+1,resid:FIXID.EMPTYFARMBLOCK,state:0})},j=function(a){var c=b.getTotalBlockCount(),d=b.getNextBlockCount();for(var e=c;e<c+d;++e)a.blocks.push({id:e+1,resid:FIXID.NEXTFARMBLOCK,state:0})},k=function(a){var b=n(a.role.citylevel-1);a.blocks.length=a.blocks.length>=b?a.blocks.length-b:0},l=function(a,b){if(!a.role||!a.role.uid)return;if(a.role.uid==b.role.uid)return;for(var c=0;c<b.blocks.length;++c){var d=b.blocks[c];if(d.resid==FIXID.NEXTFARMBLOCK)continue;d.resid=FIXID.EMPTYFARMBLOCK,d.state=0,d.canGather=0}},m=function(a){var b=TQ.qfind(res_citylevelneeds,"level",a);return b?b.farmBlock:0},n=function(a){return a<res_max_city_level?m(a+1)-m(a):0},o=function(c){if(!c)return;h(c,d),l(c,d),TQ.dictCopy(d,c),r(),ItemResUtil.initItemsres(d.blocks);if(b.isMyFarm(d)){var e=a.getImgr().getMyFarm();h(c,e),TQ.dictCopy(e,c),ItemResUtil.initItemsres(e.blocks),a.sendEvent({eid:EVT.FARMINFO,sid:2})}a.sendEvent({eid:EVT.FARMINFO,sid:0})},p=function(b){b&&b.result!=0&&a.sendEvent({eid:EVT.FARMINFO,sid:1,result:b.result})},q=function(a){a&&e&&e.onGetResNums(a.nums)},r=function(){if(!UIM.getPanel("farm").getView().isShow())return;UIM.getPanel("main").getSelCityTool().setCurLoadCity(FIXID.FARMMAP)}}),FarmPresenter=Class.extern(function(){var a=null,b=null,c=null,d=null;this.init=function(h,i,j){a=h,b=this,c=i,d=j,c.setModel(d),FarmSender.initg(a),d.regObserver(this),E(),e(),f(),g()},this.open=function(d){c.open(),a.unregUpdater(b,y),a.regUpdater(b,y,5e3),J(d),SoundMgr.playBackSound(res_baksounds.farm)},this.hide=function(){c.hide(),a.unregUpdater(b,y)},this.setActive=function(a){},this.getView=function(){return c},this.getModel=function(){return d},this.isMyCurFarm=function(){return d.isMyCurFarm()},this.getCanGetMyRes=function(a){return d.getCanGetMyRes(a)},this.onGetResNums=function(a){c.popGetResNum(a)},this.onSetOpState=function(a){F(a),G(a)},this.updateBlocksState=function(a){var b=c.getCtrl("buildblocks");for(var d=0;d<a.length;++d){var e=b.getBlock(a[d]-1);e.normal()}};var e=function(){a.regEvent(EVT.NET,NETCMD.FARM,b,h),a.regEvent(EVT.FARMINFO,0,b,i),a.regEvent(EVT.FARMINFO,1,b,j),a.regEvent(EVT.ROLEBASE,0,b,k)},f=function(){c.getCtrl("myfarmbtn").setCaller({self:b,caller:l}),c.getCtrl("farminfobtn").setCaller({self:b,caller:m}),c.getCtrl("farmrefreshbtn").setCaller({self:b,caller:n}),c.getCtrl("farmrulebtn").setCaller({self:b,caller:o}),c.getCtrl("opsel").setCaller({self:b,caller:p}),c.getCtrl("opinput").setCaller({self:b,caller:q}),c.getCtrl("opinit").setCaller({self:b,caller:r}),c.getCtrl("opget").setCaller({self:b,caller:s}),c.getCtrl("oppre").setCaller({self:b,caller:t}),c.getCtrl("opall").setCaller({self:b,caller:u}),c.getCtrl("opgetother").setCaller({self:b,caller:s}),c.getCtrl("opallother").setCaller({self:b,caller:u}),c.getCtrl("buildblocks").setCaller({self:b,caller:w}),UIM.getDlg("selpip").setCaller({self:b,caller:v})},g=function(){c.getCtrl("buildblocks").setTipCaller({self:b,caller:x})},h=function(a){d.handleFarmSvrData(a)},i=function(){c.refreshFarm()},j=function(){d.setOpState(FARMOP_STATE.SEL)},k=function(){c.refreshTitle()},l=function(){J(a.getImgr().getRoleId())},m=function(){UIM.getDlg("farminfo").openDlg()},n=function(){var a=d.getCurFarm();J(a.role.uid)},o=function(){UIM.getDlg("minihelp").openDlg(1,{x:"center",y:100})},p=function(){d.setOpState(FARMOP_STATE.SEL)},q=function(){UIM.getDlg("selpip").toggle()},r=function(){d.setOpState(FARMOP_STATE.INIT)},s=function(){d.setOpState(FARMOP_STATE.GET)},t=function(){d.setOpState(FARMOP_STATE.PREGET)},u=function(){var a=d.getCurFarm();FarmSender.sendGatherAllFarmRes(a.role.uid)},v=function(a,b){d.setPipResid(a),d.setOpState(FARMOP_STATE.INPUT)},w=function(a,b){var e=d.getBlock(I(b));if(!e||e.resid==FIXID.NEXTFARMBLOCK)return;if(c.isDragged(a))return;var f=d.getOpState();f==FARMOP_STATE.SEL?z(e):f==FARMOP_STATE.INPUT?A(e):f==FARMOP_STATE.INIT?B(e):f==FARMOP_STATE.PREGET?C(e):f==FARMOP_STATE.GET&&D(e)},x=function(a){var b=I(a.idx);return d.getBlockTip(b)},y=function(a){c.getCtrl("buildblocks").updateTip(),d.updateBlocks(),c.refreshPopu()},z=function(a){if(a.resid!=FIXID.EMPTYFARMBLOCK)return;UIM.getDlg("selpip").openDlg()},A=function(a){if(a.resid!=FIXID.EMPTYFARMBLOCK)return;var b=d.getPipResid();FarmSender.sendInputFarm(a.id,b)},B=function(b){if(b.resid==FIXID.EMPTYFARMBLOCK)return;FarmSender.sendInitFarm(a.getImgr().getRoleId(),b.id)},C=function(b){if(b.resid==FIXID.EMPTYFARMBLOCK)return;if(!d.isMyCurFarm())return;var c=d.getBlockRes(b);c==0?H(b.id):FarmSender.sendPreGatherFarmRes(a.getImgr().getRoleId(),b.id)},D=function(a){if(a.resid==FIXID.EMPTYFARMBLOCK)return;if(a.state!=FARM_STATE.COMPLETE){UIM.getPanel("sysmsg").append(CHAT_TAG.SYS,rstr.farm.tips.getgreenblock);return}var b=d.getCurFarm();FarmSender.sendGatherFarmRes(b.role.uid,a.id)},E=function(){var b=c.getCtrl("mousemap");a.getGUI().addCursor("farm_sel",b,"default"),TQ.isIE()?(a.getGUI().addCursor("farm_init",b,IMG.getCursorImg("farm/cursor/init.cur",0,0)),a.getGUI().addCursor("farm_get",b,IMG.getCursorImg("farm/cursor/get.cur",0,0)),a.getGUI().addCursor("farm_preget",b,IMG.getCursorImg("farm/cursor/preget.cur",0,0))):(a.getGUI().addCursor("farm_init",b,IMG.getCursorImg("farm/cursor/init.png",10,13)),a.getGUI().addCursor("farm_get",b,IMG.getCursorImg("farm/cursor/get.png",11,14)),a.getGUI().addCursor("farm_preget",b,IMG.getCursorImg("farm/cursor/preget.png",11,14)));var d=[{x:32,y:27},{x:33,y:27},{x:32,y:24},{x:32,y:27},{x:32,y:27},{x:33,y:27},{x:32,y:24},{x:32,y:27},{x:32,y:27},{x:33,y:27},{x:32,y:24},{x:32,y:27},{x:32,y:27},{x:33,y:27},{x:32,y:24},{x:32,y:27}];for(var e=FIXID.PIPSTART;e<=FIXID.PIPEND;++e)hot=d[e-FIXID.PIPSTART],TQ.isIE()?a.getGUI().addCursor("farm_pip_"+e,b,IMG.getCursorImg("farm/cursor/"+e+".cur",0,0)):a.getGUI().addCursor("farm_pip_"+e,b,IMG.getCursorImg("farm/cursor/"+e+".png",hot.x,hot.y))},F=function(b){var c=a.getGUI();if(b==FARMOP_STATE.SEL)c.setCursor("farm_sel");else if(b==FARMOP_STATE.INIT)c.setCursor("farm_init");else if(b==FARMOP_STATE.GET)c.setCursor("farm_get");else if(b==FARMOP_STATE.PREGET)c.setCursor("farm_preget");else if(b==FARMOP_STATE.INPUT){var e=d.getPipResid();e>0&&c.setCursor("farm_pip_"+e)}},G=function(a){a!=FARMOP_STATE.SEL},H=function(b){var c={cmd:NETCMD.FARM,farmgets:{nums:[{id:b,num:0}]}};a.sendEvent({eid:EVT.NET,sid:NETCMD.FARM,data:c})},I=function(a){return a+1},J=function(b){b=b?b:a.getImgr().getRoleId();var c=d.getCurFarm(),e=c.role.uid==b,f=e?c.ver:-1;FarmSender.sendGetFarm(f,b)}}),FarmView=CommMapPanel.extern(function(){var a=100,b=54,c=442,d=32,e=70,f=240,g=50,h=null,i=null,j=null,k=!0;this.items=null,this.init=function(a,b){h=a,i=this,this.Super.init(a,b),l(),this.hide()},this.getCtrl=function(a){return this.items[a]},this.setModel=function(a){j=a},this.open=function(){this.show(),this._initViewPortWhenFirstOpen(),this.loadMap(FIXID.FARMMAP,rstr.farm.myfarm),h.getImgr().setCurLoadCity(FIXID.FARMMAP),this.resetSMapCaller(),n(),s(),u(),v(),HelpGuider.getNewcomerSpirit().refreshCurNewcomerTask(),UIM.closeMainCityDlgs(),UIM.closeStateCityDlgs()},this._initViewPortWhenFirstOpen=function(){if(k){k=!1;var a={x:995,y:690},b=h.getWinSizer().getValidClientSize(),c=Math.max(0,a.x-b.cx/2),d=Math.max(0,a.y-b.cy/2);this.setLastViewport({x:c,y:d})}},this.hide=function(){this.Super.hide(),o()},this.refreshTitle=function(){u()},this.refreshPopu=function(){j.isMyCurFarm()&&TQ.setText(i.items.freepopu,h.getImgr().getIdlePopu())},this.refreshFarm=function(){u(),s(),v(),HelpGuider.getNewcomerSpirit().refreshCurNewcomerTask()},this.popGetResNum=function(a){for(var b=0;b<a.length;++b){var c=a[b],d=x(c.id);w(i.items.buildblocks.getBlock(d),c.num)}},this.getMainToolBarSize=function(){return{cx:c,cy:e}},this.getSecToolBarSize=function(){return{cx:f,cy:g}},this.setMainToolBarPos=function(a){TQ.setDomPos(i.items.opbtnbar,a.x,a.y),TQ.setDomPos(i.items.roleinfobar,a.x,a.y+d)},this.setSecToolBarPos=function(a){TQ.setDomPos(i.items.infohelpbar,a.x,a.y)},this.getFirstBlock=function(){if(!this.isShow())return null;var a=this.items.buildblocks.getShowBlocks();return a==0?null:this.items.buildblocks.getBlock(0)},this.getEmptyBlock=function(){if(!this.isShow())return null;var a=this.items.buildblocks.getShowBlocks();for(var b=0;b<a;++b){var c=this.items.buildblocks.getBlock(b),d=c.getItem();if(d.empty)return c}return null},this.getBuildblocks=function(){return this.items.buildblocks};var l=function(){if(i.items)return;i.create(),i.items=i.getItems(),p(),q(),r()},m=function(a){i.items.buildblocks.setViewPos(a.x,a.y)},n=function(){var a=UIM.getPanel("briefres");a&&a.hide();var b=UIM.getPanel("main");b&&b.getToolbar().hide()},o=function(){var a=UIM.getPanel("briefres");a&&a.show();var b=UIM.getPanel("main");b&&b.getToolbar().show()},p=function(){TQ.appendClass(i.items.gamemap,"farmpanel");var a=uicfg.farm.maindlg.t_;for(var b=0;b<a.length;++b)h.getGUI().buildDomItems(i.items.gamemap,a[b],null,i.items)},q=function(){for(var c=0;c<res_farm_block_poss.length;++c){var d=res_farm_block_poss[c];d.x+=260,d.y+=320}i.items.buildblocks=BuildBlocks.snew(h,{map:i.items.mapscene,mousemap:i.items.mousemap,blockclass:FarmBuildBlock,poss:res_farm_block_poss,blockw:a,blockh:b,clickcaller:null,tipcaller:null},"rhombus"),i.items.buildblocks.hideAllBlock(),i.setViewportCaller({self:i,caller:m})},r=function(){var a=[{tag:"foodtag",resid:FIXID.FOOD},{tag:"woodtag",resid:FIXID.WOOD},{tag:"stonetag",resid:FIXID.STONE},{tag:"irontag",resid:FIXID.IRON}];for(var b=0;b<a.length;++b){var c=a[b],d=ItemResUtil.findItemres(c.resid);IMG.setBKImage(i.items[c.tag],IMG.makeSmallImg(d.smallpic))}},s=function(){if(!i.isShow())return;var a=[{name:"opgetother",ismyfarm:!1},{name:"opallother",ismyfarm:!1},{name:"opinput",ismyfarm:!0},{name:"opinit",ismyfarm:!0},{name:"opget",ismyfarm:!0},{name:"oppre",ismyfarm:!0},{name:"opall",ismyfarm:!0}];for(var b=0;b<a.length;++b){t=a[b];var c=i.items[t.name].getParent();TQ.setCSS(c,"display",t.ismyfarm==j.isMyCurFarm()?"block":"none")}},u=function(){if(!i.isShow())return;var a=h.getImgr().getRoleAttrVal(ATTR.PS);TQ.setText(i.items.rolephy,a);var b=rstr.farm.myfarm;if(j.isMyCurFarm()){TQ.setText(i.items.freepopu,h.getImgr().getIdlePopu());var c=j.getBlockCount(FIXID.FARM)+j.getBlockCount(FIXID.TIMBERYARD)+j.getBlockCount(FIXID.QUARRY)+j.getBlockCount(FIXID.IRONORE);TQ.setText(i.items.blockcnt,c+"/"+j.getTotalBlockCount()),TQ.setText(i.items.foodcnt,j.getBlockCount(FIXID.FARM)),TQ.setText(i.items.woodcnt,j.getBlockCount(FIXID.TIMBERYARD)),TQ.setText(i.items.stonecnt,j.getBlockCount(FIXID.QUARRY)),TQ.setText(i.items.ironcnt,j.getBlockCount(FIXID.IRONORE))}else{var d=j.getCurFarm();b=TQ.format(rstr.farm.whofarm,d.role.name)}UIM.getPanel("smallmap").setTitle(b),TQ.setCSS(i.items.otherinfo,"display",j.isMyCurFarm()?"block":"none")},v=function(){if(!i.isShow())return;var a=i.items.buildblocks.getShowBlocks(),b=j.getCurFarm();for(var c=0;c<b.blocks.length;++c){var d=b.blocks[c];d.empty=d.resid==FIXID.EMPTYFARMBLOCK,d.next=d.resid==FIXID.NEXTFARMBLOCK;var e=i.items.buildblocks.getBlock(x(d.id));e.setItem(d),e.show()}for(var c=b.blocks.length;c<a;++c){var e=i.items.buildblocks.getBlock(c);e.hide()}},w=function(a,b){var c=a.getItem();if(!c)return;var d=a.getORect(),e=h.getEntityfactory().allocNumEffect(i.items.mapscene),f=d.x+d.w/2-40,g=d.y+d.h/2;e.setSize({cx:180,cy:20}),e.setPos({x:f,y:g}),e.setZOrder(8e4),e.getEntity().setClass("upfarmresnum"),e.getBakEntity().setClass("upfarmresnumback"),e.setNumber(c.itemres.outputname+"+"+b),e.start(),EUPD.appendEffect(e,h.getEntityfactory().freeNumEffect)},x=function(a){return a-1}})