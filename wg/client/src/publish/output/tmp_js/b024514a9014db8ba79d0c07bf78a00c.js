MilitaryDlg=ListenerBaseDlg.extern(function(){var a=0,b=1,c=null,d=null,e=null,f={},g={};this._init=function(){c=this.g_,d=this,g[ARMY_TYPE.SELF]="selfarmy",g[ARMY_TYPE.ENEMY]="enemyarmy",g[ARMY_TYPE.ALLI]="alliancearmy",h()},this.getCtrl=function(a){return f[a]},this.openDlg=function(){i(),l(),HelpGuider.getNewcomerSpirit().onDlgOpen("military",{parent:e.getParent(),items:f}),this._notifyOpenDlg()},this.closeDlg=function(){e&&e.hide()},this.hideDlg=function(){this.closeDlg()},this.isShow=function(){return e&&e.isShow()};var h=function(){c.regEvent(EVT.PERSONAL_ARMY_UPDATE,0,d,m),c.regEvent(EVT.SALLIANCE_ARMY_UPDATE,0,d,n)},i=function(){e||(e=Dialog.snew(c,{modal:!1,title:rstr.military.militarydlg.title,pos:{x:"center",y:40}}),c.getGUI().initDlg(e,uicfg.military.maindlg,f),j(),k()),e.show()},j=function(){for(var a=0;a<rstr.military.militarydlg.tabs.length;++a)f.tabList.setTabText(a,rstr.military.militarydlg.tabs[a])},k=function(){e.setCaller({self:d,caller:p})},l=function(){c.regUpdater(d,o,1e3),f.tabList.activeTab(a),t(),u()},m=function(){if(!d.isShow())return;t()},n=function(){if(!d.isShow())return;u()},o=function(a){w()},p=function(a){a==C_SYS_DLG_HIDE&&(c.unregUpdater(d,o),HelpGuider.getNewcomerSpirit().onDlgClose("military"))},q=function(a){var b=c.getImgr().getArmys().list,d=b[a];if(!d)return;UIM.openDlg("fightmap",d.id,-1)},r=function(a){var b=c.getImgr().getArmys().list,d=b[a];if(!d)return;UIM.openDlg("militaryop",d)},s=function(a){var b=c.getImgr().getArmys().samealli,d=b[a];if(!d)return;var e={};e.type=OBJ_TYPE.ROLE,e.name=d.target.role,e.pos=d.target.pos,e.alliance=c.getImgr().getRoleRes().alliance,UIM.openDlg("expedition",e)},t=function(){try{var b=c.getImgr().getArmys().list;f.tabList.getTabBtn(a).setNewFlag(b.length);var e=f.tabList.getTabItems(a).list;e.setItemCount(b.length);for(var h=0;h<b.length;++h){var i=b[h],j=e.getItem(h),k=g[i.armyType],l=TQ.format(rstr.military.militarydlg.playerName,i.sourceRole,i.sourcePos.x,i.sourcePos.y);IS_DEBUG&&(l+=" "+i.id),v(j.exsubs.intent,k,rstr.military.militarydlg.intents[i.expedType]),v(j.exsubs.sourcePlayer,k,l),v(j.exsubs.state,k,rstr.military.militarydlg.states[i.state]),v(j.exsubs.targetPlayer,k,TQ.format(rstr.military.militarydlg.playerName,i.targetRole,i.targetPos.x,i.targetPos.y)),v(j.exsubs.leftTime,k,y(i));var m=i.fighted==1;j.exsubs.seebtn.enable(m),j.exsubs.seebtn.setId(h),j.exsubs.seebtn.setCaller({self:d,caller:q}),j.exsubs.opbtn.setId(h),j.exsubs.opbtn.setCaller({self:d,caller:r})}}catch(n){var o="armys error: "+ErrorGetter.getCommErr(n);LogSender.sendLog(c,o)}},u=function(){var a=c.getImgr().getArmys().samealli;f.tabList.getTabBtn(b).setNewFlag(a.length);var e=f.tabList.getTabItems(b).list;e.setItemCount(a.length);for(var g=0;g<a.length;++g){var h=a[g],i=e.getItem(g),j="enemyarmy";v(i.exsubs.attackPlayer,j,h.source.role),v(i.exsubs.attackAlliance,j,h.source.alliance),v(i.exsubs.state,j,rstr.military.militarydlg.states[h.state]),v(i.exsubs.enemyPlayer,j,h.source.role),v(i.exsubs.alliancePlayer,j,h.target.role),v(i.exsubs.leftTime,j,y(h)),i.exsubs.reinforcebtn.setId(g),i.exsubs.reinforcebtn.setCaller({self:d,caller:s})}},v=function(a,b,c){TQ.setText(a,c),TQ.setClass(a,b)},w=function(){var b=c.getImgr().getArmys().list,d=f.tabList.getTabItems(a).list;for(var e=0,g=d.getCount();e<g;++e){var h=b[e],i=d.getItem(e);TQ.setTextEx(i.exsubs.leftTime,y(h))}},x=function(){return c.getImgr().getArmys().samealli},y=function(a){if(a.state!=ARMYDYN_STATE.GOTO&&a.state!=ARMYDYN_STATE.RETURN)return"-:-:-";var b=a.stopTime-c.getSvrTimeS();return b<0&&(b=0),TQ.formatTime(0,b)}}),MilitaryOpHandlerFactory=Class.extern(function(){this.createOpHdr=function(a,b,c){var d=null;return a.getImgr().isSelfArmy(c.id)?this._isDispatchFieldState(c)?d=MilitaryOpDispatchSelfFieldArmyHdr.snew(a,b,c):d=MilitaryOpSelfArmyHdr.snew(a,b,c):a.getImgr().isEnemyArmy(c.id)?d=MilitaryOpEnemyArmyHdr.snew(a,b,c):a.getImgr().isAlliArmy(c.id)?d=MilitaryOpAlliArmyHdr.snew(a,b,c):d=NullMilitaryOpArmyHdr.snew(a,b,c),d},this._isDispatchFieldState=function(a){return a.state!=ARMYDYN_STATE.DISPATCH?!1:a.targetType==OBJ_TYPE.FIELD||a.targetType==OBJ_TYPE.OWNERFIELD}}),MilitaryOpHandler=Class.extern(function(){this.init=function(a,b,c){this.g=a,this.dlg=b,this.army=c},this.getBtnTitle=function(){},this.getSourceRoleName=function(){return this.army.sourceRole},this.operate=function(){}}),MilitaryOpDispatchSelfFieldArmyHdr=MilitaryOpHandler.extern(function(){this.getBtnTitle=function(){return rstr.military.opdlg.btn.enterfield},this.operate=function(){var a=UIM.getDlg("selffield"),b=this.g.getImgr().getSelfFieldByGridId(this.army.targetId),c=FieldUtil.makeFieldFromSelfField(b);a.openDlg(c),this.dlg.closeDlg()}}),MilitaryOpSelfArmyHdr=MilitaryOpHandler.extern(function(){this.getBtnTitle=function(){return rstr.military.opdlg.btn.callback},this.operate=function(){if(!this._preOperate())return;var a=this.g,b=this.army.id,c=this.dlg,d=function(d){d==MB_IDYES&&(MilitarySender.sendCallBackArmy(a,b),c.closeDlg())};this.g.getGUI().msgBox(rstr.comm.msgts,rstr.military.opdlg.lbl.confirmCallBack,MB_F_YESNO,{self:this,caller:d})},this._preOperate=function(){return this.army.state==ARMYDYN_STATE.RETURN?(this.g.getGUI().sysMsgTips(SMT_WARNING,rstr.ids[100044].msg),!1):!0}}),MilitaryOpEnemyArmyHdr=MilitaryOpHandler.extern(function(){this.getBtnTitle=function(){return rstr.military.opdlg.btn.callback},this.operate=function(){this.g.getGUI().sysMsgTips(SMT_WARNING,rstr.ids[100043].msg)}}),MilitaryOpAlliArmyHdr=MilitaryOpHandler.extern(function(){this.getBtnTitle=function(){return rstr.military.opdlg.btn.repatriate},this.operate=function(){var a=this.g,b=this.army.id,c=this.dlg,d=function(d){d==MB_IDYES&&(MilitarySender.sendRepatriateArmy(a,b),c.closeDlg())};this.g.getGUI().msgBox(rstr.comm.msgts,rstr.military.opdlg.lbl.confirmRepatriate,MB_F_YESNO,{self:this,caller:d})}}),NullMilitaryOpArmyHdr=MilitaryOpHandler.extern(function(){this.getBtnTitle=function(){return""},this.getSourceRoleName=function(){return""},this.operate=function(){}}),ArmyHeroGetter=Class.extern(function(){this.init=function(a,b){this.g=a,this.army=b,this.heros=this.collectValidHeros(this.army.heros)},this.getFightCap=function(){var a=0,b=this.g.getImgr();for(var c=0;c<this.army.heros.length;++c){var d=this.getHeroByIdx(c);a+=b.getHeroAttrVal(d,ATTR.FC)}return a},this.getHeroCount=function(){return this.heros.length},this.getHeroByIdx=function(a){return this.heros[a]},this.collectValidHeros=function(a){var b=[];for(var c=0;c<a.length;++c){var d=a[c];if(d.id==0)continue;b.push(d)}return b}}),MilitaryOpDlg=Class.extern(function(){var a,b,c,d={},e,f=null,g=null;this.init=function(c){a=c,b=this},this.openDlg=function(c){e=c,h(),i(),j(),k(),l(),a.regUpdater(b,v,1e3)},this.closeDlg=function(){c.hide()};var h=function(){f=MilitaryOpHandlerFactory.snew().createOpHdr(a,b,e)},i=function(){g=ArmyHeroGetter.snew(a,e)},j=function(){c||(c=Dialog.snew(a,{modal:!0,title:rstr.military.opdlg.title,pos:{x:"center",y:50}}),a.getGUI().initDlg(c,uicfg.military.opdlg,d),c.hide(),m())},k=function(){c.show()},l=function(){p(),q(),r(),s(),u()},m=function(){d.strategybtn.setCaller({self:b,caller:n}),d.opbtn.setCaller({self:b,caller:o}),c.setCaller({self:b,caller:w})},n=function(){a.getGUI().sysMsgTips(SMT_NORMAL,rstr.ids[100042].msg)},o=function(){f.operate()},p=function(){TQ.setTextEx(d.roleName,f.getSourceRoleName())},q=function(){TQ.setTextEx(d.fightCap,g.getFightCap())},r=function(){d.heroList.setItemCount(g.getHeroCount());for(var b=0,c=d.heroList.getCount();b<c;++b){var e=d.heroList.getItem(b),f=g.getHeroByIdx(b);TQ.setText(e.exsubs.name,f.name),TQ.setText(e.exsubs.level,f.level),TQ.setText(e.exsubs.health,a.getImgr().getHeroAttrVal(f,ATTR.HEALTH)),TQ.setText(e.exsubs.soldier,RStrUtil.getSoldierNameByResId(f.soldier.resid)),TQ.setText(e.exsubs.number,f.soldier.number)}},s=function(){if(t()>0){var a=rstr.military.opdlg.lbl.arriveTime+TQ.formatTime(0,t());TQ.setTextEx(d.leftTime,a)}else TQ.setTextEx(d.leftTime,"")},t=function(){var b=0;if(e.state==ARMYDYN_STATE.GOTO||e.state==ARMYDYN_STATE.RETURN)b=Math.max(0,e.stopTime-a.getSvrTimeS());return b},u=function(){d.opbtn.setText(f.getBtnTitle())},v=function(){s()},w=function(c){c==C_SYS_DLG_HIDE&&a.unregUpdater(b,v)}})