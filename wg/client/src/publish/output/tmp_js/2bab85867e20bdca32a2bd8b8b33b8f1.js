StateBuffBar=Class.extern(function(){var C_ICON_W=36,C_SPACE=0,m_this,m_states=[];this.init=function(a,b){m_this=this,this.g_=a,this.buffList_=b,this.g_.regEvent(EVT.ROLESPECSTATE_CHANGE,0,this,this._onStateChange),_update()},this._onStateChange=function(){_update()};var _update=function(){m_states=_getCanShowStates(),m_this.buffList_.setItemCount(m_states.length),_setListItems(),_setListWidth()},_getCanShowStates=function(){var a=[],b=m_this.g_.getImgr().getRoleStates();for(var c=0;c<b.length;++c){var d=b[c],e=TQ.find(res_state_effects,"effectid",d.id);if(!e)continue;if(!e.isshow)continue;d.res=e,a.push(d)}return a},_setListItems=function(){for(var a=0;a<m_this.buffList_.getCount();++a){var b=m_this.buffList_.getItem(a);IMG.setBKImage(b.exsubs.icon,IMG.makeSmallImg(m_states[a].res.smallpic)),TTIP.getTipById(b.exsubs.tooltips.$item).setFlag(TIP_FLAG.TIMER),TTIP.setCallerData(b.exsubs.tooltips.$item,{self:m_this,caller:_onGetTooltip},{idx:a})}},_setListWidth=function(){var a=m_this.buffList_.getCount()*C_ICON_W+C_SPACE;TQ.setDomWidth(m_this.buffList_.getParent(),a)},_onGetTooltip=function(a){var b=m_states[a.idx],c=Math.max(0,b.stoptime-m_this.g_.getSvrTimeS()),d=b.res.desc.replace(/{val}/g,b.val);return d=_replaceDescByEval(d),TIPM.makeItemTip(d+C_TIP_NEWLINE+TQ.format(rstr.buffBar.tip.leftTime,TQ.formatTime(0,c)))},_replaceDescByEval=function(desc){var replaces={},evals=desc.match(/eval\[[^\]]+\]/g);for(var i=0;evals&&i<evals.length;++i){var oneEval=evals[i];oneEval=oneEval.replace(/eval\[([^\]]+)\]/g,"$1"),replaces[evals[i]]=eval(oneEval)}return _replaceDescByPairs(desc,replaces)},_replaceDescByPairs=function(a,b){for(var c in b)while(a.indexOf(c)>=0)a=a.replace(c,b[c]);return a}})