var MAX_SIGNIN_COUNT=20;ActivityValCanGetOrSignChecker=JClass.ex({init:function(a){this.g_=a},hasCanGetReward:function(){for(var a=0;a<res_activityval_rewards.length;++a){var b=this.getCanGetInfo(a);if(b.isCanGet)return!0}return!1},hasCanSign:function(){var a=this.g_.getImgr().getActivityVal().signin;return a.todaySign==0&&a.days<MAX_SIGNIN_COUNT},hasCanGetSignReward:function(){for(var a=0;a<res_signin_rewards.length;++a){var b=this.getCanGetSignInfo(a);if(b.isCanGet)return!0}return!1},getCanGetInfo:function(a){var b=this.g_.getImgr().getActivityVal(),c=res_activityval_rewards[a],d=TQ.find(b.gotActRewards,null,c.id)!=null,e=b.val>=c.val,f=!d&&e;return{isCanGet:f,isGot:d,isEnoughVal:e}},getCanGetSignInfo:function(a){var b=this.g_.getImgr().getActivityVal().signin,c=res_signin_rewards[a],d=TQ.find(b.gotRewards,null,c.id)!=null,e=b.days>=c.days,f=!d&&e;return{isCanGet:f,isGot:d,isEnoughDays:e}}}),ActivityValBasePanel=Class.extern(function(){this.g_=null,this.items_=null,this.init=function(a,b,c){this.g_=a,this.dlg_=b,this.items_=c,this.canGetChecker_=ActivityValCanGetOrSignChecker.snew(this.g_),this._regEvents(),this._setCallers()},this._regEvents=function(){},this._setCallers=function(){}}),ActivityValActivityValPanel=ActivityValBasePanel.extern(function(){this.update=function(){var a=this.g_.getImgr().getActivityVal();TQ.setTextEx(this.items_.activityVal,a.val),this.items_.activityProg.setRange(100),this.items_.activityProg.setValue(0,a.val),TQ.setTextEx(this.items_.curActivityTip,this._getActivityValTip(a.val))},this._getActivityValTip=function(a){for(var b=res_activityval_tips.length-1;b>=0;--b){var c=res_activityval_tips[b];if(a>=c.val)return c.tip}return""}}),ActivityValBaseInfoPanel=ActivityValBasePanel.extern(function(){this._regEvents=function(){this.g_.regEvent(EVT.ROLEBASE,0,this,this._onRolebaseChange),this.g_.regEvent(EVT.LETTERUPDATE,0,this,this._onMailChange)},this._setCallers=function(){this.items_.newMailNumber.setCaller({self:this,caller:this._onClickMailNumber}),this.items_.rolePs.setCaller({self:this,caller:this._onClickRolePs})},this.update=function(){this._updateMailNumber(),this._updateRolePs()},this._updateMailNumber=function(){if(!this.dlg_.isShow())return;this.items_.newMailNumber.setText(String(this.g_.getImgr().getLetterRes().un.length))},this._updateRolePs=function(){if(!this.dlg_.isShow())return;var a=this.g_.getImgr().getRoleAttrVal(ATTR.PS);this.items_.rolePs.setText(String(a))},this._onRolebaseChange=function(){this._updateRolePs()},this._onMailChange=function(){this._updateMailNumber()},this._onClickMailNumber=function(){UIM.openDlg("letter")},this._onClickRolePs=function(){UIM.openDlg("task","role")}}),ActivityValTaskUtil=JClass.ex({_init:function(a){this.g_=a},hasRedDot:function(){var a=this.collectNoFinishTasks();for(var b=0;b<a.length;++b){var c=a[b];if(c.reddot)return!0}return!1},collectNoFinishTasks:function(){var a=[],b=this.g_.getImgr().getTask().activityVals;for(var c=0;c<res_activityval_tasks.length;++c){var d=res_activityval_tasks[c],e=TQ.find(b,"id",d.id);if(e==null||e.times<d.times){var f=this._getHasRedDot(d.id);a.push({res:d,curTimes:e?e.times:0,reddot:f})}}return a.sort(function(a,b){return b.curTimes==a.curTimes?a.res.id-b.res.id:b.curTimes-a.curTimes}),a},_getHasRedDot:function(a){return a==FIXID.ACTVAL_OTHER_FARM?this._getOtherFarmHasRedDot():a==FIXID.ACTVAL_ROLE_TASK?this._getRoleTaskHasRedDot():a==FIXID.ACTVAL_GET_PRESTIGE?this._getGetPrestigeHasRedDot():a==FIXID.ACTVAL_DAY_TASK?this._getDayTaskHasRedDot():a==FIXID.ACTVAL_JOIN_TERRACE?this._getJoinTerraceHasRedDot():a==FIXID.ACTVAL_JOIN_TOWER?this._getJoinTowerHasRedDot():a==FIXID.ACTVAL_ALLI_CONTRIBUTE?this._getAlliContributeHasRedDot():a==FIXID.ACTVAL_GET_ALLI_GIFT?this._getGetAlliGiftHasRedDot():a==FIXID.ACTVAL_LAWLIGHT_FEED?this._getLawlightFeedHasRedDot():a==FIXID.ACTVAL_TRADING_AREA?this._getTradingAreaHasRedDot():a==FIXID.ACTVAL_HERO_STEEL?this._getHeroSteelHasRedDot():a==FIXID.ACTVAL_ASSIGN_HEROEXP?this._getAssignHeroExpHasRedDot():a==FIXID.ACTVAL_SPEED_BUILDING?this._getSpeedBuildingHasRedDot():a==FIXID.ACTVAL_ZHANLING_FIELD?this._getZhanlingFieldHasRedDot():a==FIXID.ACTVAL_GET_RES_FROMFIELD?this._getGetResFromFieldHasRedDot():a==FIXID.ACTVAL_PROVOKE_PLAYER?this._getProvokePlayerHasRedDot():a==FIXID.ACTVAL_FIGHT_PLAYER_FOR_HONOR?this._getFightHonorHasRedDot():!1},_getOtherFarmHasRedDot:function(){return this.g_.getImgr().getRoleAttrVal(ATTR.PS)>0},_getRoleTaskHasRedDot:function(){var a=this.g_.getImgr().getTask().roleTask.doing.id>0,b=this.g_.getImgr().getTask().roleTask.cdStopTime>0,c=!a&&!b;return this.g_.getImgr().getRoleAttrVal(ATTR.PS)>=50&&c},_getGetPrestigeHasRedDot:function(){return GetGiftByPrestigeChecker.snew(this.g_).hasCanGetGift()},_getDayTaskHasRedDot:function(){var a=this.g_.getImgr().getTask().everydays;for(var b=0;b<a.length;++b){var c=a[b];if(c.state==TASK_STATE.WAIT_COMPLETE)return!0}return!1},_getJoinTerraceHasRedDot:function(){return this.g_.getImgr().getRoleRes().level>=res_enter_terrace_need_rolelevel},_getJoinTowerHasRedDot:function(){return this.g_.getImgr().getRoleRes().level>=res_enter_tower_need_rolelevel},_getAlliContributeHasRedDot:function(){return this.g_.getImgr().isInAlliance()},_getGetAlliGiftHasRedDot:function(){if(!this.g_.getImgr().isInAlliance())return!1;var a=this.g_.getImgr().getMyAlliance().getSelfMember();return!a.isTodayGotRes()},_getLawlightFeedHasRedDot:function(){return this.g_.getImgr().isInAlliance()?AlliLawLightUtil.snew(this.g_).isCanFeed():!1},_getTradingAreaHasRedDot:function(){return UIM.getDlg("tradingarea").isCanTrade()},_getHeroSteelHasRedDot:function(){return this.g_.getImgr().getBuildLevelByResId(BUILDCITY_ID.ALL,FIXID.STEEL_BUILD)>0},_getAssignHeroExpHasRedDot:function(){return this.g_.getImgr().getRoleAttrVal(ATTR.XPS)>0},_getSpeedBuildingHasRedDot:function(){return!0},_getZhanlingFieldHasRedDot:function(){return!this.g_.getImgr().isNewPlayer()&&!this.g_.getImgr().isRestPlayer()},_getGetResFromFieldHasRedDot:function(){return this.g_.getImgr().getSelfFields().list.length>0},_getProvokePlayerHasRedDot:function(){return!this.g_.getImgr().isNewPlayer()&&!this.g_.getImgr().isRestPlayer()},_getFightHonorHasRedDot:function(){return this._getProvokePlayerHasRedDot()}}),ActivityValTaskListPanel=ActivityValBasePanel.extern(function(){var a=2,b=this.init;this.init=function(a,c,d){b.call(this,a,c,d),this.util_=ActivityValTaskUtil.snew(this.g_)},this._regEvents=function(){this.g_.regEvent(EVT.TASKCHANGE,0,this,this._onTaskChange)},this.update=function(){if(!this.dlg_.isShow())return;this.items_.taskList.setItemCount(res_activityval_tasks.length+a);var b=0,c=this._collectNoFinishTasks();this._setTaskListItemTitle(b++,TQ.format(rstr.activityValDlg.lbl.noFinishTaskTitle,c.length)),b=this._setTaskListItems(b,c);var d=this._collectFinishTasks();this._setTaskListItemTitle(b++,TQ.format(rstr.activityValDlg.lbl.finishTaskTitle,d.length)),b=this._setTaskListItems(b,d)},this._collectNoFinishTasks=function(){return this.util_.collectNoFinishTasks()},this._collectFinishTasks=function(){var a=[],b=this.g_.getImgr().getTask().activityVals;for(var c=0;c<res_activityval_tasks.length;++c){var d=res_activityval_tasks[c],e=TQ.find(b,"id",d.id);e&&e.times==d.times&&a.push({res:d,curTimes:d.times,reddot:!1})}return a},this._setTaskListItemTitle=function(a,b){var c=this.items_.taskList.getItem(a);c.exsubs.name.setText(b),c.exsubs.name.resetUIBack(uiback.btn.activityVal.nolink_title),c.exsubs.task=null,TTIP.setCallerData(c.exsubs.tooltips.$item,{self:this,caller:this._onGetTaskNameTip},{idx:a}),TQ.setCSS(c.exsubs.reddot,"display","none"),TQ.setTextEx(c.exsubs.number,""),TQ.setTextEx(c.exsubs.addNumber,"")},this._setTaskListItems=function(a,b){for(var c=0;c<b.length;++c){var d=b[c],e=this.items_.taskList.getItem(a),f=this._getTaskListItemStyle(d);e.exsubs.name.setText(d.res.name),e.exsubs.name.resetUIBack(f.name),TQ.setTextEx(e.exsubs.number,d.curTimes+"/"+d.res.times),TQ.setClass(e.exsubs.number,f.number),TQ.setTextEx(e.exsubs.addNumber,this._getStarOrAddNumber(d)),TQ.setClass(e.exsubs.addNumber,f.addNumber),TQ.setCSS(e.exsubs.reddot,"display",d.reddot?"block":"none"),e.exsubs.task=d,e.exsubs.name.setId(a),e.exsubs.name.setCaller({self:this,caller:this._onClickTaskListName}),TTIP.setCallerData(e.exsubs.tooltips.$item,{self:this,caller:this._onGetTaskNameTip},{idx:a}),a++}return a},this._getTaskListItemStyle=function(a){return a.curTimes==0?{number:"taskList_number_nofinish",addNumber:"taskList_addnumber_nofinish",name:uiback.btn.activityVal[this._getNameLinkTag(a)+"_nofinish"]}:a.curTimes<a.res.times?{number:"taskList_number_finishpart",addNumber:"taskList_addnumber_finishpart",name:uiback.btn.activityVal[this._getNameLinkTag(a)+"_finishpart"]}:{number:"taskList_number_finish",addNumber:"taskList_addnumber_finish",name:uiback.btn.activityVal.nolink_finish}},this._getNameLinkTag=function(a){return a.res.linkType?"link":"nolink"},this._getStarOrAddNumber=function(a){if(a.curTimes==0)return rstr.activityValDlg.lbl.stars[a.res.star];var b="";for(var c=0;c<a.curTimes;++c)b+="+",b+=a.res.val,this._needShowVipVal(a)&&(b+="+",b+=this._getShowVipVal(a)+"(VIP)");return b},this._needShowVipVal=function(a){return a.res.id!=FIXID.EVERYDAY_LOGIN_TASK?!1:this._getShowVipVal(a)>0},this._getShowVipVal=function(){var a=0,b=this.g_.getImgr().getTask().activityVals;for(var c=0;c<res_activityval_tasks.length;++c){var d=res_activityval_tasks[c],e=TQ.find(b,"id",d.id);e&&(a+=e.times*d.val)}var f=this.g_.getImgr().getActivityVal();return Math.max(0,f.val-a)},this._onClickTaskListName=function(a){var b=this.items_.taskList.getItem(a);if(!b.exsubs.task)return;if(b.exsubs.task.curTimes==b.exsubs.task.res.times)return;b.exsubs.task.res.linkType==ACTIVITYVAL_TASK_LINK.FARM?UIM.getPanel("farm").open():b.exsubs.task.res.linkType==ACTIVITYVAL_TASK_LINK.OTHERFARM?UIM.getPanel("field").open():b.exsubs.task.res.linkType==ACTIVITYVAL_TASK_LINK.ROLETASK?UIM.openDlg("task","role"):b.exsubs.task.res.linkType==ACTIVITYVAL_TASK_LINK.EVERYDAYTASK?UIM.openDlg("task","everyday"):b.exsubs.task.res.linkType==ACTIVITYVAL_TASK_LINK.ACT_TERRACE?UIM.openActTerraceDlg():b.exsubs.task.res.linkType==ACTIVITYVAL_TASK_LINK.ACT_TOWER?UIM.openActTowerDlg():b.exsubs.task.res.linkType==ACTIVITYVAL_TASK_LINK.ALLI_CONTRIBUTE?UIM.getDlg("alli").openSubscribeDlg():b.exsubs.task.res.linkType==ACTIVITYVAL_TASK_LINK.ALLI_GIFT?UIM.getDlg("alli").openGiftDlg():b.exsubs.task.res.linkType==ACTIVITYVAL_TASK_LINK.TRADING_AREA?UIM.openDlg("tradingarea"):b.exsubs.task.res.linkType==ACTIVITYVAL_TASK_LINK.STEEL_HERO?UIM.openDlg("steellist"):b.exsubs.task.res.linkType==ACTIVITYVAL_TASK_LINK.HEROS_DLG&&UIM.openDlg("hero")},this._onGetTaskNameTip=function(a){var b=this.items_.taskList.getItem(a.idx);return b.exsubs.task?TIPM.makeItemTip(b.exsubs.task.res.tip):""},this._onTaskChange=function(){this.update()}}),ActivityValRewardListPanel=ActivityValBasePanel.extern(function(){this.update=function(){var a=this.g_.getImgr().getActivityVal();this.items_.rewardList.setItemCount(res_activityval_rewards.length);for(var b=0;b<this.items_.rewardList.getCount();++b){var c=res_activityval_rewards[b],d=this.items_.rewardList.getItem(b);IMG.setBKImage(d.exsubs.icon,IMG.makeBigImg(c.icon)),TQ.setTextEx(d.exsubs.desc,TQ.format(rstr.activityValDlg.lbl.activityValDesc,c.val));var e=this.canGetChecker_.getCanGetInfo(b);e.isCanGet?(TQ.setCSS(d.exsubs.stateEffect,"display","block"),d.exsubs.get.enable(!0)):(TQ.setCSS(d.exsubs.stateEffect,"display","none"),d.exsubs.get.enable(!1)),e.isCanGet?(d.exsubs.get.setText(rstr.activityValDlg.btn.getActReward),d.exsubs.get.resetUIBack(uiback.btn.activityVal.actReward_canGet)):e.isGot?(d.exsubs.get.setText(rstr.activityValDlg.btn.gotActReward),d.exsubs.get.resetUIBack(uiback.btn.activityVal.actReward_got)):e.isEnoughVal||(d.exsubs.get.setText(rstr.activityValDlg.btn.activityValNoEnough),d.exsubs.get.resetUIBack(uiback.btn.activityVal.actReward_noEnough)),TTIP.setCallerData(d.exsubs.tooltips.$item,{self:this,caller:this._onGetActRewardTip},{idx:b}),TTIP.setCallerData(d.exsubs.tooltips.$item1,{self:this,caller:this._onGetActRewardTip},{idx:b}),d.exsubs.get.setId(c.id),d.exsubs.get.setCaller({self:this,caller:this._onClickActRewardGet})}},this._onGetActRewardTip=function(a){var b=res_activityval_rewards[a.idx];return TIPM.makeItemTip(b.tip)},this._onClickActRewardGet=function(a){ActivityValSender.sendGetActReward(this.g_,a)}}),ActivityValSignInPanel=ActivityValBasePanel.extern(function(){this._setCallers=function(){this.items_.signinBtn.setCaller({self:this,caller:this._onClickSignIn})},this.update=function(){this._updateSigninBtn(),this._updateSigninDays(),this._updateSignList()},this._updateSigninBtn=function(){var a=this.g_.getImgr().getActivityVal().signin;a.days==MAX_SIGNIN_COUNT?this.items_.signinBtn.enable(!1):a.todaySign==0?this.items_.signinBtn.enable(!0):this.items_.signinBtn.enable(!1)},this._updateSigninDays=function(){var a=this.g_.getImgr().getActivityVal().signin;TQ.setTextEx(this.items_.signinDays,TQ.format(rstr.activityValDlg.lbl.signinDays,a.days))},this._updateSignList=function(){var a=this.g_.getImgr().getActivityVal().signin;this.items_.signinList.setItemCount(res_signin_rewards.length);for(var b=0;b<this.items_.signinList.getCount();++b){var c=res_signin_rewards[b],d=this.items_.signinList.getItem(b);TQ.setTextEx(d.exsubs.desc,TQ.format(rstr.activityValDlg.lbl.signinDesc,c.days));var e=this.canGetChecker_.getCanGetSignInfo(b);e.isGot?(d.exsubs.get.enable(!1),d.exsubs.get.setText(rstr.activityValDlg.btn.signGot),TQ.setTextEx(d.exsubs.days,TQ.format(rstr.activityValDlg.lbl.signinItemDays,COLORS.ENOUGH_SIGNINDAYS,c.days,c.days))):e.isCanGet?(d.exsubs.get.enable(!0),d.exsubs.get.setText(rstr.activityValDlg.btn.signGet),TQ.setTextEx(d.exsubs.days,TQ.format(rstr.activityValDlg.lbl.signinItemDays,COLORS.ENOUGH_SIGNINDAYS,c.days,c.days))):(d.exsubs.get.enable(!1),d.exsubs.get.setText(rstr.activityValDlg.btn.signGet),TQ.setTextEx(d.exsubs.days,TQ.format(rstr.activityValDlg.lbl.signinItemDays,COLORS.NOENOUGH_SIGNINDAYS,a.days,c.days))),TTIP.setCallerData(d.exsubs.tooltips.$item,{self:this,caller:this._onGetSignRewardTip},{idx:b}),d.exsubs.get.setId(c.id),d.exsubs.get.setCaller({self:this,caller:this._onClickSignRewardGet})}},this._onGetSignRewardTip=function(a){var b=res_signin_rewards[a.idx];return TIPM.makeItemTip(b.tip)},this._onClickSignRewardGet=function(a){ActivityValSender.sendGetSignReward(this.g_,a)},this._onClickSignIn=function(){ActivityValSender.sendSignIn(this.g_)}}),ActivityValTodayActListPanel=ActivityValBasePanel.extern(function(){this.update=function(){var a=this.g_.getImgr().getActivityVal().dayacts,b=TQ.find(a,"day",0).acts;this.items_.todayActList.setItemCount(b.length);for(var c=0;c<this.items_.todayActList.getCount();++c){var d=TQ.qfind(res_dayact_defs,"type",b[c]),e=this.items_.todayActList.getItem(c);e.exsubs.res=d,TQ.setTextEx(e.exsubs.name,d.name),TTIP.setCallerData(e.exsubs.tooltips.$item,{self:this,caller:this._onGetTodayActTip},{idx:c})}},this._onGetTodayActTip=function(a){var b=this.items_.todayActList.getItem(a.idx);return TIPM.makeItemTip(b.exsubs.res.tip)}}),ActivityValDlg=BaseDlg.extern(function(){this.panels_=[],this._init=function(){this.g_.regEvent(EVT.LOGIN_OK,0,this,this._onLoginOk),this.g_.regEvent(EVT.NET,NETCMD.ACTIVITY_VAL,this,this._onSvrPkg)},this._getDlgCfg=function(){return{modal:!1,title:rstr.activityValDlg.title,pos:{x:"center",y:100},uicfg:uicfg.activityVal.mainDlg}},this._afterCreate=function(){this.panels_.push(ActivityValActivityValPanel.snew(this.g_,this,this.items_)),this.panels_.push(ActivityValBaseInfoPanel.snew(this.g_,this,this.items_)),this.panels_.push(ActivityValTaskListPanel.snew(this.g_,this,this.items_)),this.panels_.push(ActivityValRewardListPanel.snew(this.g_,this,this.items_)),this.panels_.push(ActivityValSignInPanel.snew(this.g_,this,this.items_)),this.panels_.push(ActivityValTodayActListPanel.snew(this.g_,this,this.items_))},this._initInfo=function(){this._update(),this.g_.sendEvent({eid:EVT.UPD_ACT_VAL_REDDOT,sid:0})},this._update=function(){if(!this.isShow())return;for(var a=0;a<this.panels_.length;++a)this.panels_[a].update()},this._onLoginOk=function(){ActivityValSender.sendGetAllInfo(this.g_),FixTimer.regTimer({hour:0,min:0,sec:5},{self:this,caller:this._onFixTimer})},this._onSvrPkg=function(a){var b=a.data;if(!b.actVal)return;TQ.dictCopy(this.g_.getImgr().getActivityVal(),b.actVal),this._filterPayAct(),this.g_.sendEvent({eid:EVT.ACTIVITY_VAL,sid:0}),this._update()},this._onFixTimer=function(){ActivityValSender.sendGetAllInfo(this.g_)},this._filterPayAct=function(){var a=this.g_.getImgr().getActivityVal().dayacts;for(var b=0;b<a.length;++b)TQ.find(a[b].acts,null,SVR_TODAY_ACT_TYPE.ACT_PAY_1)&&a[b].acts.splice(TQ.getLastFindIdx(),1)}})