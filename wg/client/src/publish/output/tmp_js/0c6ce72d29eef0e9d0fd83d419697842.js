var L_IS_DEBUG=!1;FieldBlock=function(){var a=C_OUTFIELD_BLOCK_W,b=C_OUTFIELD_BLOCK_H,c=a,d=250,e=d-b,f=90,g=16,h=80-e,i=80-e,j=80-e,k=24,l=25,m=11+e,n=82,o=55,p=14,q=10,r=40,s=40,t=null,u=null,v=null,w=null,x=null,y=[],z=null,A=null,B=null,C=null,D=null,E={x:-2e4,y:-2e4,w:a,h:b},F=-1;this.init=function(a,b,c){t=a,u=this,v=b,TQ.setCSS(v,"height",d+"px"),TQ.setClass(v,"fieldblock"),H(),I(),P()},this.clear=function(){},this.isInRect=function(a){var b={x:E.x,y:E.y+e,w:E.w,h:E.h};return TQ.isInRect(b,a)},this.setItem=function(a){G(a),T(),U()},this.getItem=function(){return D},this.show=function(){TQ.setCSS(v,"visibility","visible")},this.hide=function(){TQ.setCSS(v,"visibility","hidden")},this.getFieldGridId=function(){return F},this.setFieldGridId=function(a){F=a,Q(),ob()},this.normal=function(){},this.hot=function(){};var G=function(a){D={},TQ.dictCopy(D,a)},H=function(){w=TQ.createDom("div"),TQ.append(v,w),TQ.setClass(w,"cityBuild"),TQ.setCSS(w,"zIndex",2),x=TQ.createDom("div"),TQ.append(v,x),TQ.setClass(x,"name"),TQ.setCSS(x,"zIndex",10),z=TQ.createDom("div"),TQ.append(v,z),TQ.setClass(z,"myAlliFlag"),TQ.setCSS(z,"zIndex",10),A=TQ.createDom("div"),TQ.append(v,A),TQ.setClass(A,"enemyAlliFlag"),TQ.setCSS(A,"zIndex",10),C=TQ.createDom("div"),TQ.append(v,C),TQ.setClass(C,"noFieldFlag"),TQ.setCSS(C,"zIndex",11),L_IS_DEBUG&&(B=TQ.createDom("div"),TQ.append(v,B),TQ.setDomRect(B,50,50,200,100),TQ.setCSS(B,"zIndex",100));var a=[1,3,3,1];for(var b=0;b<4;++b){var c=TQ.createDom("div");TQ.append(v,c),y.push(c),TQ.setClass(c,"subCity"),TQ.setCSS(c,"zIndex",a[b])}},I=function(){J(),K(),L(),M(),O()},J=function(){TQ.setDomPos(w,0,0)},K=function(){var a=N();TQ.setDomPos(x,a.x,a.y)},L=function(){var a=N(),b=a.x-k,c=a.y+g-l;TQ.setDomPos(z,b,c)},M=function(){var a=N(),b=a.x+f,c=m;TQ.setDomPos(A,b,c)},N=function(){return nb(h)},O=function(){var c=a-r-s,d=b-p-q,f=r,g=p+e,h=[{x:0,y:0},{x:0,y:d-o},{x:c-n,y:d-o},{x:c-n,y:0}];for(var i=0;i<h.length;++i)TQ.setDomPos(y[i],h[i].x+f,h[i].y+g)},P=function(){TQ.setCSS(w,"display","none"),TQ.setCSS(x,"display","none"),TQ.setCSS(z,"display","none"),TQ.setCSS(A,"display","none"),TQ.setClass(C,"noFieldFlag");for(var a=0;a<4;++a)TQ.setCSS(y[a],"display","none")},Q=function(){var a=F-1,b=a%C_OUTFIELD_ROW_GRIDS,c=Math.floor(a/C_OUTFIELD_ROW_GRIDS);S(b,c),G(R(F)),E.x=b*C_OUTFIELD_BLOCK_W,E.y=c*C_OUTFIELD_BLOCK_H-e,TQ.setCSS(v,"zIndex",E.y),TQ.setDomPos(v,E.x,E.y)},R=function(a){return{gridId:a,objType:OBJ_TYPE.INVALID,resid:170005,modelId:17000501}},S=function(a,b){P(),IMG.setBKImage(v,IMG.makeImg("fields/block/17000501.jpg"),"0px "+e+"px")},T=function(){var a=0;D.objType==OBJ_TYPE.FIELD?a=D.modelId:a=res_fields[FIXID.PINGDIFIELDID-FIXID.FIRSTFIELDID].models[0],IMG.setBKImage(v,IMG.makeImg("fields/block/"+a+".jpg"),"0px "+e+"px"),ob()},U=function(){D.objType==OBJ_TYPE.ROLE?V():D.objType==OBJ_TYPE.NPCFIELD?ab():D.objType==OBJ_TYPE.FIELD?eb():D.objType==OBJ_TYPE.NONE?jb():P()},V=function(){W(),K(),X(),Y(),Z(),$(),_()},W=function(){P(),TQ.setCSS(w,"display","block"),TQ.setCSS(x,"display","block")},X=function(){if(D.vip>0){var a=Math.ceil(D.vip/2);IMG.setBKImage(w,IMG.makeImg("fields/rolecity/vip/"+a+".png"))}else IMG.setBKImage(w,IMG.makeImg("fields/rolecity/"+D.modelId+".gif"))},Y=function(){for(var a=0;a<D.subCitys.length;++a){var b=D.subCitys[a],c=CITYTYPE_MAP_RESIDS[b];IMG.setBKImage(y[a],IMG.makeImg("fields/rolecity/"+c+".gif")),TQ.setCSS(y[a],"display","block")}},Z=function(){var a=t.getImgr().getFightRefState(D.roleId);a==REF_ROLESTATE.DECLARING_FIGHT?TQ.setClass(x,"declaring_fight_name"):a==REF_ROLESTATE.FIGHTING?TQ.setClass(x,"fighting_name"):TQ.setClass(x,"role_name"),TQ.setTextEx(x,D.roleName)},$=function(){D.myAlliFlag&&(TQ.setCSS(z,"display","block"),TQ.setTextEx(z,D.myAlliFlag))},_=function(){D.enemyAlliFlag&&(TQ.setCSS(A,"display","block"),TQ.setTextEx(A,D.enemyAlliFlag))},ab=function(){W(),bb(),cb(),db()},bb=function(){var a=nb(i);TQ.setDomPos(x,a.x,a.y)},cb=function(){IMG.setBKImage(w,IMG.makeImg("fields/npccity/"+D.modelId+".gif"))},db=function(){var a=TQ.qfind(res_npcfields,"id",D.resid);TQ.setClass(x,"name"),TQ.setTextEx(x,a.name)},eb=function(){fb(),gb(),hb(),ib()},fb=function(){P(),TQ.setCSS(x,"display","block")},gb=function(){var a=nb(j);TQ.setDomPos(x,a.x,a.y)},hb=function(){var a=res_fields[D.resid-FIXID.FIRSTFIELDID];TQ.setClass(x,"name"),TQ.setTextEx(x,TQ.format(rstr.comm.flevelsomething,D.level,a.name))},ib=function(){var a="";D.roleId?t.getImgr().isSameRole(D.roleName)?a="myFieldFlag":t.getImgr().isSameAlliance(D.alliance.uid)?a="alliFieldFlag":a="noalliFieldFlag":a="noFieldFlag",TQ.setClass(C,a)},jb=function(){kb(),lb(),mb()},kb=function(){P(),TQ.setCSS(x,"display","block")},lb=function(){var a=nb(j);TQ.setDomPos(x,a.x,a.y)},mb=function(){TQ.setClass(x,"name"),TQ.setTextEx(x,rstr.field.lbl.emptyField)},nb=function(c){var d=(a-f)/2,e=b-g-c;return{x:d,y:e}},ob=function(){if(!L_IS_DEBUG)return;TQ.setTextEx(B,F)};this.init.apply(this,arguments)},MoveFieldBlocksHdr=Class.extern(function(){var a=null;this.init=function(b){a=b},this.moveBlocks=function(a){var c=b(a),g=d(c),h=e(c);f(c,g,h)};var b=function(a){var a=c(a),b=Math.floor(a.x/C_OUTFIELD_BLOCK_W),d=Math.floor((a.x+a.w)/C_OUTFIELD_BLOCK_W),e=Math.floor(a.y/C_OUTFIELD_BLOCK_H),f=Math.floor((a.y+a.h)/C_OUTFIELD_BLOCK_H),g={};for(var h=e;h<=f;++h)for(var i=b;i<=d;++i){var j=FieldUtil.getGridIdByPos({x:i,y:h});g[j]=!0}return g},c=function(a){var b=a.x>=0?a.x:0,c=a.y>=0?a.y:0;return{x:b,y:c,w:a.w,h:a.h}},d=function(b){var c=[],d=a.getCount();for(var e=0;e<d;++e){var f=a.getBlock(e);b[f.getFieldGridId()]||c.push(f)}return c},e=function(b){var c={},d=a.getCount();for(var e=0;e<d;++e){var f=a.getBlock(e),g=b[f.getFieldGridId()];g&&(c[f.getFieldGridId()]=!0)}return c},f=function(a,b,c){for(var d in a){if(c[d])continue;var d=parseInt(d,10),e=b[b.length-1];b.length=b.length-1,e.show(),e.setFieldGridId(d)}}}),MapBoundary=JClass.ex({init:function(a,b){this._g=a,this._map=b,this._xlines={pos:0,lines:[]},this._ylines={pos:0,lines:[]}},setViewPort:function(a){this._hideLines(this._xlines),this._hideLines(this._ylines),this._showLines(res_mapboundarys.xlines,this._checkXInRect,this._showXLine,a),this._showLines(res_mapboundarys.ylines,this._checkYInRect,this._showYLine,a)},_hideLines:function(a){a.pos=0;for(var b=0;b<a.lines.length;++b)TQ.setCSS(a.lines[b],"display","none")},_showLines:function(a,b,c,d){for(var e=0;e<a.length;++e){var f=a[e],g=f[0]*C_OUTFIELD_BLOCK_W,h=f[1]*C_OUTFIELD_BLOCK_H,i=f[2]*C_OUTFIELD_BLOCK_W,j=f[3]*C_OUTFIELD_BLOCK_H;if(!b.call(this,g,h,i,j,d))continue;var k=g;g<d.x&&(k=d.x-(d.x-g)%C_OUTFIELD_BLOCK_W);var l=Math.min(i,d.x+d.w),m=h;h<d.y&&(m=d.y-(d.y-h)%C_OUTFIELD_BLOCK_H);var n=Math.min(j,d.y+d.h);c.call(this,k,m,l,n)}},_checkXInRect:function(a,b,c,d,e){return b<e.y||b>e.y+e.h?!1:a>=e.x&&a<e.x+e.w||c>=e.x&&c<e.x+e.w||a<e.x&&c>=e.x+e.w},_checkYInRect:function(a,b,c,d,e){return a<e.x||a>e.x+e.w?!1:b>=e.y&&b<e.y+e.h||d>=e.y&&d<e.y+e.h||b<e.y&&d>=e.y+e.h},_showXLine:function(a,b,c,d){var e=this._allocLine(this._xlines,"mapboundary_h",1e5);TQ.setDomRect(e,a,b-5,c-a,14)},_showYLine:function(a,b,c,d){var e=this._allocLine(this._ylines,"mapboundary_v",100001);TQ.setDomRect(e,a-5,b,14,d-b)},_allocLine:function(a,b,c){if(a.pos==a.lines.length){var d=TQ.createDom("div");TQ.append(this._map,d),TQ.setCSS(d,"position","absolute"),TQ.setCSS(d,"zIndex",c),TQ.setClass(d,b),a.lines.push(d)}var d=a.lines[a.pos++];return TQ.setCSS(d,"display","block"),d}}),FieldGotoBar=Class.extern(function(){var a=null,b=null,c=null,d=null;this.init=function(f,g,h){a=f,b=this,c=g,d=h,e()},this.show=function(){TQ.setCSS(c.outFieldToolBar,"visibility","visible")},this.hide=function(){TQ.setCSS(c.outFieldToolBar,"visibility","hidden")},this.setViewport=function(a){var b=a.x+a.w/2,d=a.y+a.h/2,e=Math.floor(b/C_OUTFIELD_BLOCK_W),f=Math.floor(d/C_OUTFIELD_BLOCK_H);c.ifieldX.setVal(e),c.ifieldY.setVal(f)};var e=function(){c.goHomeBtn.setCaller({self:b,caller:f}),c.gotoPosBtn.setCaller({self:b,caller:g}),c.ifieldX.setLimit(h),c.ifieldY.setLimit(i)},f=function(){d.goHome()},g=function(){var a={x:c.ifieldX.getVal(),y:c.ifieldY.getVal()};d.gotoPos(a)},h=function(){var b=a.getImgr().getMapView();return{min:0,max:b.x2-1}},i=function(){var b=a.getImgr().getMapView();return{min:0,max:b.y2-1}}}),FieldSmallMapTip=Class.extern(function(){var a=null,b=null,c=null,d=!1,e=null;this.init=function(a,b){f(this,a,b),g(),h()},this.show=function(){d=!0},this.hide=function(){d=!1,e.hide()};var f=function(d,e,f){a=e,b=d,c=f},g=function(){var a=TTIP.addTip(c.getMapEventDom(),"no");e=TTIP.getTipById(a),e.setFlag(TIP_FLAG.CUSTOM),e.setCaller({self:b,caller:l})},h=function(){TQ.addEvent(c.getMapEventDom(),"mouseover",i),TQ.addEvent(c.getMapEventDom(),"mousemove",j),TQ.addEvent(c.getMapEventDom(),"mouseout",k)},i=function(a){if(!d)return;m(a)},j=function(a){if(!d)return;m(a)},k=function(){if(!d)return;e.hide()},l=function(a){return a.x+","+a.y},m=function(a){e.setData(n(a)),e.reset(),e.show(TQ.mouseCoords(a))},n=function(a){var b=TQ.mouseRelativeCoords(c.getMapEventDom(),a),d=c.convertSTLPos(b),e=Math.floor(d.x/C_OUTFIELD_BLOCK_W),f=Math.floor(d.y/C_OUTFIELD_BLOCK_H);return{x:e,y:f}}}),FieldMapBlockSelector=Class.extern(function(){var a=null,b=null,c=null,d=null;this.init=function(a,b){e(this,a,b),f(),g()};var e=function(d,e,f){b=d,a=e,c=f},f=function(){d=TQ.createDom("div"),TQ.append(c.getItems().mapscene,d),TQ.setClass(d,"fieldselectblock"),TQ.setDomSize(d,C_OUTFIELD_BLOCK_W,C_OUTFIELD_BLOCK_H)},g=function(){TQ.addEvent(c.getItems().mousemap,"mousemove",h)},h=function(a){var b=TQ.mouseRelativeCoords(c.getItems().mousemap,a),e=c.getViewport(),f=Math.floor((e.x+b.x)/C_OUTFIELD_BLOCK_W)*C_OUTFIELD_BLOCK_W,g=Math.floor((e.y+b.y)/C_OUTFIELD_BLOCK_H)*C_OUTFIELD_BLOCK_H;TQ.setDomPos(d,f,g)}}),FieldMapView=CommMapPanel.extern(function(){var a=null,b=null,c=!0,d=null,e=null,f=null,g=null,h=null;this.init=function(c,e){a=c,b=this,b.Super.init(c,e.map),b.create(),d=b.getItems(),f=FieldGotoBar.snew(a,e,b),g=FieldSmallMapTip.snew(a,UIM.getPanel("smallmap")),j(),k()},this.open=function(){this.isShow()||OutFieldSender.sendEnterOutField(a),this.show(),l(),this.loadMap(FIXID.OUTFIELD,rstr.citylist.outfield),a.getImgr().setCurLoadCity(FIXID.OUTFIELD),this.resetSMapCaller(),i(),this.setLastViewPort(),SoundMgr.playBackSound(res_baksounds.field),OutFieldSender.sendRefreshFieldsByLastViewPos(a)},this.show=function(){b.Super.show(),f.show(),g.show()},this.hide=function(){b.Super.hide(),f.hide(),g.hide()},this.goHome=function(){b.gotoPos(a.getImgr().getRoleRes().pos),OutFieldSender.sendRefreshFieldsByLastViewPos(a)},this.gotoPos=function(c){var e=a.getWinSizer().getValidClientSize(),f=Math.floor(c.x*C_OUTFIELD_BLOCK_W+C_OUTFIELD_BLOCK_W/2-e.cx/2),g=Math.floor(c.y*C_OUTFIELD_BLOCK_H+C_OUTFIELD_BLOCK_H/2-e.cy/2),h={x:f,y:g};b.setLastViewport(h),d.fieldBlocks.setViewPos(h.x,h.y),b.setViewportPos(h)};var i=function(){var c=a.getImgr().getMapView();b.setMapPixelRect(c.x1*C_OUTFIELD_BLOCK_W,c.y1*C_OUTFIELD_BLOCK_H,c.x2*C_OUTFIELD_BLOCK_W,c.y2*C_OUTFIELD_BLOCK_H)},j=function(){a.regEvent(EVT.NET,NETCMD.OUTFIELD,b,o)},k=function(){d.fieldBlocks=BuildBlocks.snew(a,{map:d.mapscene,mousemap:d.mousemap,blockclass:FieldBlock,poss:m(),blockw:C_OUTFIELD_BLOCK_W,blockh:C_OUTFIELD_BLOCK_H,clickcaller:{self:b,caller:r},tipcaller:{self:b,caller:s}},"rect"),d.mapBoundary=MapBoundary.snew(a,d.mapscene),e=MoveFieldBlocksHdr.snew(d.fieldBlocks),d.fieldBlocks.hideAllBlock(),b.setViewportCaller({self:b,caller:n})},l=function(){if(!c)return;h=FieldMapBlockSelector.snew(a,b),b.goHome(),c=!1},m=function(){var b=a.getWinSizer().getMaxClientSize(),c=Math.floor((b.cx+2*C_OUTFIELD_BLOCK_W)/C_OUTFIELD_BLOCK_W),d=Math.floor((b.cy+2*C_OUTFIELD_BLOCK_H)/C_OUTFIELD_BLOCK_H),e=[];for(var f=0;f<c*d;++f)e.push({x:0,y:0});return e},n=function(b){var c=a.getWinSizer().getMaxClientSize(),g={x:b.x,y:b.y,w:c.cx,h:c.cy};e.moveBlocks(g),d.mapBoundary.setViewPort(g),p(g),f.setViewport(b),d.fieldBlocks.setViewPos(b.x,b.y)},o=function(b){if(!b.data.outFields)return;var c=!1;for(var d=0;d<b.data.outFields.length;++d){var e=b.data.outFields[d];if(e._k)continue;e.isDetail&&(c=!0,a.getImgr().setCurDetailField(e));var f=q(e.gridId);if(!f)continue;f.setItem(e)}c&&(UIM.getDlg("rolecity").openDlg(a.getImgr().getCurDetailField()),a.sendEvent({eid:EVT.OUTFIELD_DETAIL,sid:0}))},p=function(b){var c={x:b.x+Math.floor(b.w/2),y:b.y+Math.floor(b.h/2)};OutFieldSender.sendGetFieldsByPos(a,c)},q=function(a){for(var b=0;b<d.fieldBlocks.getCount();++b){var c=d.fieldBlocks.getBlock(b);if(c.getFieldGridId()==a)return c}return null},r=function(c,e){if(b.isDragged(c))return;var f=d.fieldBlocks.getBlock(e);if(!f)return;var g=f.getItem();if(!g)return;g.objType==OBJ_TYPE.NONE?UIM.openDlg("emptyfield",g):g.objType==OBJ_TYPE.ROLE?UIM.openDlg("rolecity",g):g.objType==OBJ_TYPE.FIELD?UIM.openDlg("field",g):a.getGUI().sysMsgTips(SMT_WARNING,rstr.field.lbl.invalidField)},s=function(a){var b=d.fieldBlocks.getBlock(a.idx),c=b.getItem();return c?c.objType==OBJ_TYPE.ROLE?t(c):"":""},t=function(a){var b=FieldUtil.getPosByGridId(a.gridId),c=FieldUtil.getCityNameByGridId(a.gridId);return TQ.format(rstr.field.tip.roleInfo,a.roleName,a.alliance.name,b.x+","+b.y,c)}})