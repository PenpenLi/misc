try{require("../handler/tqAlliance.js")}catch(e){}ItemMgrEx=function(){var a,b,c=[ATTR.HEALTH,ATTR.MO],d={id:0,uid:-1,name:"--",state:0,cityid:9900001,allipos:ALLI_POS.NONE,level:0,prestige:0,alliproffer:0,pos:{x:0,y:0},attrs:{},skeleton:{level:0},alliance:{uid:0,name:"--"},introduction:"",gm:0,svrOpenTime:0,firstLoginTime:0,actTower:0,actTerrace:0,cityMaxLevel:0,ydInfo:{},bdInfo:{},vip:0,userId:0,cltKey:""},e={list:[],canusesstime:0},f={items:[],misc:{giftgold:0,gold:0,maxgrids:0}},g=[],h={list:[],samealli:[]},i={cityBuilds:{1:[],2:[],3:[],4:[],5:[]},abuild:[]},j={list:[]},k={fround:{},list:[]},l={list:[],learning:{id:0,isCulture:!0,state:0,level:0,stoptime:0}},m={defs:[0,0,0,0,0],building:{id:0,isCityDef:!0,state:0,level:"--",stoptime:0,number:0},defarmy:{heros:[0,0,0,0,0],lineupId:180001}},n={lineupId:180004,soldiers:[{resid:0,number:0},{resid:0,number:0},{resid:0,number:0},{resid:0,number:0},{resid:0,number:0}]},o={making:[{id:1,resid:0,number:100,stoptime:1287591460,itemres:{smallpic:1001,name:"we1"}},{id:2,resid:0,number:200,stoptime:1287591460,itemres:{smallpic:1001,name:"we2"}},{id:3,resid:0,number:300,stoptime:1287591460,itemres:{smallpic:1001,name:"we3"}}]},p=[],q={all:[],un:[],sys:[],com:[]},r={friends:[],enemys:[],groups:[],applys:[]},s={list:[]},t={ver:-1,role:{uid:-1,name:"",citylevel:-1},blocks:[]},u={list:[]},v={roles:{cnt:1,list:[]},allis:{cnt:1,list:[]}},w=null,x={money:{cur:0,max:0,output:1},buildval:{level:0,cur:0,max:0,hurt:10},cres:{food:0,wood:0,stone:0,iron:0,max:0},popu:{idle:0,work:0,max:0}},y={todaytimes:{taofa:0,cuihui:0,tiaoxin:0,fightowner:0},defaultteams:[{id:1,heros:[]},{id:2,heros:[]},{id:3,heros:[]}]},z={dict:{}},A=[],B={taofa:[]},C=[],D=[180001],E={list:[]},F=[1],G={max:0},H={todaytimes:{cur:0,max:0}},I=[],J=[],K=null,L={baseInfo:{today:{maxTimes:0,freeTimes:0,itemTimes:0},maxLayer:0}},M={baseInfo:{today:{maxTimes:0,freeTimes:0,itemTimes:0},maxGate:{gateId:0,subGateId:0},curGate:{gateId:0,subGateId:0}},results:[]},N={tasks:[],actives:[],growups:[],subGrowups:[],roles:[],everydays:[],activityVals:[],roleTask:{doing:{id:0,stopTime:0},cdStopTime:0},prestigeTask:{lastTime:0}},O={val:0,gotActRewards:[],signin:{days:0,gotRewards:[],todaySign:0},dayacts:[{day:0,acts:[]}],gotOnlineGoods:0,onlineGoodsId:0},P=[],Q={id:0,stopTime:0},R=[{type:1,lineup:0,heros:[]},{type:2,lineup:0,heros:[]},{type:3,lineup:0,heros:[]}],S={togglemap:[0,0,0,0],gongGaoVer:0},T={payGiftGots:[1,1,1,1,1,1],payActAllGold:0,payActTime:{start:0,stop:0}},U={starting:0,max:0,list:[]},V={x1:200,y1:200,x2:400,y2:400},W={events:[],today:{times:0,maxTimes:3,gotGift:0,gotPRankGift:0,guwu:0,maxGuwu:10},prank:[],arank:[],crankweek:0,crank:[],alligifts:[]},X=[],Y={honorcfg:{taofa:3,cuihui:5,tiaoxin:1,leveldiff:10}},Z=!1,$=!1;this.initialize=function(c){a=c,b=this,w=Alliance.snew(a)},this.getSvrCfg=function(){return Y},this.getWorldBoss=function(){return W},this.setFirstCreateGame=function(){Z=!0},this.isFirstCreateGame=function(){return Z},this.getMapView=function(){return V},this.copySellingItems=function(a){TQ.dictCopy(X,a),ItemResUtil.initItemsres(X)},this.getSellingItems=function(){return X},this.setMapView=function(a,b,c,d){V.x1=a,V.y1=b,V.x2=c,V.y2=d},this.multHeroSteelBySvrAct=function(){var a=0;return this.hasServerAct(SVR_TODAY_ACT_TYPE.HERO_STEEL_2)&&(a+=2),this.hasServerAct(SVR_TODAY_ACT_TYPE.HERO_STEEL_3)&&(a+=3),Math.max(1,a)},this.getAutoBuild=function(){return U},this.getVipLevel=function(){return d.vip},this.get3366GrowLevel=function(){var a=this.getRoleRes().bdInfo._3366_grow_level;return a?a:0},this.isCanPlayBackSound=function(){return S.togglemap[0]==0},this.setCanPlayBackSound=function(a){S.togglemap[0]=a?0:1},this.getCltCfg=function(){return S},this.getPayAct=function(){return T},this.getSaveForces=function(){return R},this.getSaveForceByType=function(a){return TQ.find(R,"type",a)},this.getOnlineTask=function(){return Q},this.getShopSales=function(){return P},this.collectFreeHeros=function(){var a={};return a[HERO_STATE.FREE]=!0,this.collectHeros(a)},this.collectHeros=function(a,b){var c=[],d=this.getHeros().list;for(var e=0;e<d.length;++e){var f=d[e];if(!a[f.state])continue;c.push(f)}return c},this.isArrivedMaxRoleLevel=function(){return d.level>=res_max_role_level},this.getActivityVal=function(){return O},this.getTask=function(){return N},this.getTaskById=function(a){return TQ.find(N.growups,"id",a)},this.getActTower=function(){return L},this.getActTerrace=function(){return M},this.getSalveInfo=function(){return G},this.getWears=function(){return z},this.getLineups=function(){return D},this.getPrestige=function(){return d.prestige},this.getSelfFields=function(){return E},this.getSelfFieldByGridId=function(a){return TQ.find(E.list,"id",a)},this.getSelfFieldByIdx=function(a){return E.list[a]},this.getFightDemos=function(){return g},this.getLastArmyIdAndFightId=function(){if(g.length==0)return null;var a=g[g.length-1];return{armyId:a.id,fightId:a.fightId}},this.getFightDemosByArmyId=function(a){for(var b in g){var c=g[b];if(c.id==a)return c}return null},this.getFightDemoResult=function(a,b){var c=this.getFightDemosByArmyId(a);if(!c)return null;b<0&&(b=c.fightId);var d=c.result[b-1];return d},this.getFightDemoActions=function(a,b){var c=this.getFightDemosByArmyId(a);if(!c)return null;b<0&&(b=c.fightId);var d=[];for(var e=0,f=0;e<c.actions.length;++e){var g=c.actions[e];g.event=="fightstart"&&f++,b==f&&d.push(g)}return d},this.getFightDemoRounds=function(a,b){var c=this.getFightDemoActions(a,b);if(c==null)return null;var d={attacker:{role:{},actors:[]},defender:{role:{},actors:[]},defenderParty:"",expedType:0,myIsAttacker:!0,mapId:this.getFightDemosByArmyId(a).mapId,rounds:[]};return this._initFightDemoBaseInfo(c,this.getFightDemoResult(a,b),d),this._initFightDemoRounds(c,d),d},this.hasServerAct=function(a){var b=this.getActivityVal().dayacts,c=TQ.find(b,"day",0).acts;for(var d=0;d<c.length;++d)if(c[d]==a&&this._serverActInTime(a))return!0;return!1},this._serverActInTime=function(b){if(b!=SVR_TODAY_ACT_TYPE.HERO_STEEL_2&&b!=SVR_TODAY_ACT_TYPE.HERO_STEEL_3)return!0;var c=new Date(a.getSvrTimeS()*1e3),d=c.getHours();return d<20||d>=23?!1:!0},this._initFightDemoBaseInfo=function(a,b,c){var e=a[0];if(!e)return;if(e.event!="fightstart")return;c.attacker=e.attacker,c.defender=e.defender,b.attacker&&TQ.dictCopy(c.attacker.role,b.attacker.role),b.defender&&TQ.dictCopy(c.defender.role,b.defender.role),c.result=b.result,c.defenderParty=b.defenderParty,c.expedType=b.expedType,c.myIsAttacker=d.name==c.attacker.role.name},this._initFightDemoRounds=function(a,b){ConvertFightRounds.snew().convert(b.rounds,a)},this.getSuccCopyFields=function(){return B},this.getTargetsFavorite=function(){return C},this.getTodayBattleTimes=function(){return y.todaytimes},this.getDefaultTeams=function(){return y.defaultteams},this.getRoleRes=function(){return d},this.getRoleId=function(){return d.uid},this.getRoleName=function(){return d.name},this.getAllianceId=function(){return d.alliance.uid},this.getAllianceName=function(){return d.alliance.name},this.isSameRole=function(a){return d.name==a},this.isSameAlliance=function(a){return a==0?!1:d.alliance.uid==a},this.isSameAllianceByName=function(a){return d.alliance.uid==0?!1:d.alliance.name==a},this.getRoleLevel=function(){return d.level},this.getMyFields=function(){return A},this.getCityRes=function(){return x},this.clearPkgItems=function(){f.items=[]},this.addItem=function(a){f.items.push(a)},this.getMoney=function(){return x.money.cur},this.setMoney=function(a){x.money.cur=a},this.getMaxMoney=function(){return x.money.max},this.setMaxMoney=function(a){x.money.max=a},this.getMoneyOutput=function(){return x.money.output},this.getGold=function(){return f.misc.gold},this.setGold=function(a){f.misc.gold=a},this.getGiftGold=function(){return f.misc.giftgold},this.setGiftGold=function(a){f.misc.giftgold=a},this.getMaxGrids=function(){return f.misc.maxgrids},this.getAllGold=function(){return this.getGold()+this.getGiftGold()},this.getCityDefs=function(){return m},this.getTower=function(){return n},this.getFightRes=function(){return k},this.getHeros=function(){return e},this.setHerosDefaultInfo=function(){for(var a=0;a<e.list.length;++a){var b=e.list[a];b.skills||(b.skills=[]),b.skeleton||(b.skeleton={level:0,stoptime:0}),b.official||(b.official=0),b.lockstate||(b.lockstate=0),b.unlocktime||(b.unlocktime=0),b.subjects||(b.subjects=[0,0,0,0,0]),b.attrs||(b.attrs={}),b.skillsteel||(b.skillsteel={id:0,stoptime:0}),b.curtskill||(b.curtskill=0)}},this.isDetailHero=function(a){return a.isDetail==1},this.getHerosCount=function(){return e.list.length},this.clearHeros=function(){e.list=[]},this.getHero=function(a){return TQ.find(e.list,"id",a)},this.getPkgs=function(){return f},this.getItemByResId=function(a){return TQ.find(f.items,"resid",a)},this.getItemById=function(a){return TQ.find(f.items,"id",a)},this.getItemNumByFixResId=function(a){var b=0;for(var c=0;c<f.items.length;++c){var d=f.items[c];d.resid==a&&(b+=d.number)}return b},this.getItemNumByResId=function(a){var b=ItemResUtil.findItemres(a);return b&&b.nobindid?this.getItemNumByFixResId(a)+this.getItemNumByFixResId(b.nobindid):b&&b.bindid?this.getItemNumByFixResId(a)+this.getItemNumByFixResId(b.bindid):this.getItemNumByFixResId(a)},this.getItemResByEffect=function(a){var b=TQ.qfind(res_efftiems_ex,"id",a);if(!b)return null;var c=null;for(var d=0;d<b.items.length;++d){c=ItemResUtil.findItemres(b.items[d]);if(c.isbind==0)return c}return c},this.getArmys=function(){return h},this.getBuilds=function(){return i},this.getBuildsByCityId=function(a){return i.cityBuilds[a]},this.getSoldiers=function(){return j.list},this.getSoldierNumber=function(a){var b=TQ.find(j.list,"id",a);return b==null?0:b.number},this.getCultures=function(){return l.list},this.getLearningCulture=function(){return l.learning},this.getCultureLevel=function(a){var b=TQ.find(l.list,"id",a);return b?b.level:0},this.getWeaponrys=function(){return o},this.getHeroByState=function(a){var b=TQ.find(e.list,"state",a);return b},this.getTaskRes=function(){return p},this.getLetterRes=function(){return q},this.getFriends=function(){return r},this.hasFriend=function(a){return TQ.find(r.friends,"roleName",a)!=null},this.getEnemys=function(){return r.enemys},this.getTeams=function(){return s},this.getMyFarm=function(){return t},this.isMyHero=function(a){return this.getHero(a)!=null},this.getBuildByResid=function(a,b){var c=null,d=this._getBuildsGroup();for(var e=0;e<d.length;e++){var f=d[e];for(var g=0;g<f.length;g++){var h=f[g];if(a!=BUILDCITY_ID.ALL&&h.cityId!=a)continue;if(h.resid!=b)continue;if(c&&c.level>=h.level)continue;c=h}}return c},this.getBuildsByResid=function(a,b){var c=[],d=this._getBuildsGroup();for(var e=0;e<d.length;e++){var f=d[e];for(var g=0;g<f.length;g++){var h=f[g];if(a!=BUILDCITY_ID.ALL&&h.cityId!=a)continue;if(h.resid!=b)continue;c.push(h)}}return c},this.getBuildCntByResid=function(a,b){var c=this.getBuildsByResid(a,b);return c.length},this.getBuildLevelByResId=function(a,b){var c=this.getBuildByResid(a,b);return c?c.level:0},this._getBuildsGroup=function(){return[i.cityBuilds[1],i.cityBuilds[2],i.cityBuilds[3],i.cityBuilds[4],i.cityBuilds[5],i.abuild]},this.getCityBuildsGroup=function(){return[i.cityBuilds[1],i.cityBuilds[2],i.cityBuilds[3],i.cityBuilds[4],i.cityBuilds[5]]},this.getAllBuildsGroup=function(){var a=[];a.push(l.learning);var b=[];return b.push(m.building),[i.cityBuilds[1],i.cityBuilds[2],i.cityBuilds[3],i.cityBuilds[4],i.cityBuilds[5],i.abuild,a,b]},this.getTypeInAllBuildsGroup=function(a){return a>=0&&a<=4?ALLBUILDSGROUP_TYPE.CITY:a==5?ALLBUILDSGROUP_TYPE.ALLI:a==6?ALLBUILDSGROUP_TYPE.CULTURE:a==7?ALLBUILDSGROUP_TYPE.CITYDEF:ALLBUILDSGROUP_TYPE.NONE},this.getItemBuffs=function(){return u},this.getRanking=function(){return v},this.getMyAlliance=function(){return w},this.isInAlliance=function(){return d.alliance.uid>0},this.setAllianceId=function(a){d.alliance.uid=a},this.addRoleAttr=function(a){d.attrs[a.id]={val:a.val}},this.getRoleAttr=function(a){return d.attrs[a]?d.attrs[a]:null},this.getRoleAttrVal=function(a){var b=this.getRoleAttr(a);return b?b.val:0},this.getRoleAttrs=function(){return d.attrs},this.getRoleInitAttrVal=function(a){var b=TQ.find(res_role_initdata.attrs,"attr",a);return b?b.val:0},this.isNewPlayer=function(){return d.state==ROLE_STATE.YOUNG},this.isRestPlayer=function(){return d.state==ROLE_STATE.REST},this.setHeroAttrVal=function(a,b,c){var d=this.getHeroAttr(a,b);if(!d)return;ab(b)&&(c*=ATTR_PRECISION),d.val=c},this.getHeroAttrVal=function(a,b){var c=this.getHeroAttr(a,b);if(!c)return 0;var d=c.val;return ab(b)&&(d=parseInt(d/ATTR_PRECISION,10)),d},this.getHeroAttr=function(b,c){return b?b.attrs?b.attrs[c]:(HeroSender.sendGetDetail(a,b.id),null):null},this.getHeroByIdx=function(a){return e.list[a]},this.getHeroIdxFromId=function(a){return TQ.find(e.list,"id",a),TQ.getLastFindIdx()},this.setCityLevel=function(a){x.buildval.level=a},this.getCityLevel=function(){return x.buildval.level},this.getGMFlag=function(){return d.gm},this.getFactBuildTime=function(a){a=this.__speedBuildByStateEffect(a);var b=this.getCultureLevel(FIXID.BUILDCBUILD),c=this.getBuildLevelByResId(BUILDCITY_ID.ALL,FIXID.GOV_BUILD),d=this.getRoleAttrVal(ATTR.IN_B)+this.getRoleAttrVal(ATTR.IN_A),e=res_calc_fact_inbuild_time(a,b,c,d);return parseInt(e,10)},this.__speedBuildByStateEffect=function(a){var b=this.getRoleState(RES_EFF.ADD_BUILD_SPEED);return b?a/(1+b.val/100):a},this.getFactLearnCultureTime=function(a){var b=this.getBuildLevelByResId(BUILDCITY_ID.ALL,FIXID.COLLEGEBUILD),c=this.getRoleAttrVal(ATTR.BR_B)+this.getRoleAttrVal(ATTR.BR_A),d=0,e=this.getRoleState(RES_EFF.ADD_CULTURE_SPEED_AND_MONEY_OUTPUT);e&&(d=e.val/100);var f=res_calc_fact_learn_culture_time(a,b,c,d);return Math.floor(f)},this.setCurLoadCity=function(a){var b=UIM.getPanel("main");b.getSelCityTool().setCurLoadCity(a),b.getSubCityBtnsBar().setCurSubCityId(BUILDCITY_ID.NONE)},this.getStateCity=function(){return d.cityid},this.getFarmRoleAddOutput=function(a){var b=this.getRoleAttrVal(ATTR.IN_B)+this.getRoleAttrVal(ATTR.IN_A);return parseInt(b*res_farm_roleinterior_addper*a,10)},this.getFarmCultureAddOutput=function(a,b){var c=this.getCultureLevel(a);return parseInt(c*res_farm_culture_addper*b,10)},this.getFarmBuildAddOutput=function(a){var b=this.getBuildsSumLevel(FIXID.WORKSHOPBUILD);return parseInt(b*res_farm_wsbuild_addper*a,10)},this.getBuildsSumLevel=function(a){var b=0,c=this.getBuildsByResid(BUILDCITY_ID.ALL,a);for(var d=0;d<c.length;++d)b+=c[d].level;return b},this.getFarmAlliAddOutput=function(a){return parseInt(w.getLevel()*res_farm_alli_addper*a,10)},this.getFarmBuffStateAddOutput=function(a){var b=this.getRoleState(RES_EFF.ADD_COMMRES_OUTPUT);return b?Math.floor(a*b.val/100):0},this.getFarmVipAddOutput=function(a){var b=this.getVipEffectVal(VIP_EFF.ADD_COMMRES_OUTPUT);return Math.floor(a*b/100)},this.hasVipEffectMinLevel=function(a){var b=TQ.find(res_vip,"effid",a);for(var c=0;c<b.effs.length;++c)if(b.effs[c]>0)return c;return 0},this.getVipEffectVal=function(a){var b=TQ.find(res_vip,"effid",a);return b.effs[this.getVipLevel()]},this.hasVipEffect=function(a){return this.getVipEffectVal(a)>0},this.setIdlePopu=function(a){x.popu.idle=a},this.getIdlePopu=function(){return x.popu.idle},this.setMaxPopu=function(a){x.popu.max=a},this.getMaxPopu=function(){return x.popu.max},this.setWorkPopu=function(a){x.popu.work=a},this.getWorkPopu=function(){return x.popu.work},this.getCanUseSkillSteelTime=function(){return e.canusesstime},this.setCanUseSkillSteelTime=function(a){e.canusesstime=a},this.getHeroSkillById=function(a,b){return a.skills?TQ.find(a.skills,"id",b):null},this.getCultureById=function(a){var b=TQ.find(l.list,"id",a);return b||(b={id:a,level:0}),b},this.getTacticSkillByIdx=function(a,b){var c=[6001001,6001002];return _(a,c,b)},this.getSpecSkillByIdx=function(a,b){var c=[6001003,6001004,6001005,6001006,6001007];return _(a,c,b)},this.getTrainCultureByIdx=function(a){var c=[120006,120011,120016,120021,120026],d=c[a];if(!d)return{id:0,level:0};var e=b.getCultureById(d);return e?e:{id:d,level:0}},this.isSelfArmy=function(a){var b=TQ.find(h.list,"id",a);return b?b.armyType==ARMY_TYPE.SELF:!1},this.isEnemyArmy=function(a){var b=TQ.find(h.list,"id",a);return b?b.armyType==ARMY_TYPE.ENEMY:!1},this.isAlliArmy=function(a){var b=TQ.find(h.list,"id",a);return b?b.armyType==ARMY_TYPE.ALLI:!1},this.getCityTypes=function(){return F},this.getCityTypeByCityId=function(a){var b=a-1,c=F[b];return c?c:CITY_TYPE.NONE},this.isMaxHeroLevel=function(a){return a.level==this.getMaxHeroLevel(a)},this.isMaxMaxHeroLevel=function(a){return a.level==res_max_hero_level},this.getMaxHeroLevel=function(a){var b=a.skeleton.level;return b==0?res_base_max_hero_level:res_herojingmai[b-1].maxLevel},this.getCityResValByIdx=function(a){var b=["food","wood","stone","iron"];return x.cres[b[a]]},this.getCityResResIdByIdx=function(a){var b=[FIXID.FOOD,FIXID.WOOD,FIXID.STONE,FIXID.IRON];return b[a]},this.getExchangeExp=function(){return H},this.getFightRefStates=function(){return I},this.getFightRefState=function(a){var b=TQ.find(I,"id",a);return b?b.state:REF_ROLESTATE.NORMAL},this.getFightRefStateStopTime=function(a){var b=TQ.find(I,"id",a);return b?b.stoptime:0},this.getRoleStates=function(){return J},this.getRoleState=function(a){return TQ.find(J,"id",a)},this.hasRoleState=function(a){return this.getRoleState(a)!=null},this.setCurDetailField=function(a){a==null?K=null:(K={},TQ.dictCopy(K,a))},this.getCurDetailField=function(){return K},this.isNewcomerHelpEnd=function(){return $},this.setNewcomerHelpEnd=function(){$=!0};var _=function(a,c,d){var e=c[d];if(!e)return null;var f=b.getHeroSkillById(a,e);return f?f:{id:e,level:0}},ab=function(a){return TQ.find(c,null,a)!=null};this.initialize.apply(this,arguments)}