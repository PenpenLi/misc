FriendDlg=ListenerBaseDlg.extern(function(){var a=12,b=1,c=2,d=24,e=20,f=20,g=24,h=3,i=153,j=18,k=49,l=45,m=45,n=50,o=3,p=127,q=18,r=50,s=29,t=127,u=18,v=0,w=1,x=2,y=1,z=2,A=3,B=4,C=5,D=100,E=5e3,F=210,G=192,H=24,I=97,J=50,K,L,M,N={toggleBtn:NullButton.snew()},O=[{resIdx:-1,uiItem:null},{resIdx:-1,uiItem:null}],P=[],Q=[],R,S=[],T=[],U=!1,V=[],W=null;this._init=function(a){K=a,L=this,K.regEvent(EVT.LOGIN_OK,0,L,Eb),K.regEvent(EVT.NET,NETCMD.FRIEND,L,Fb),K.regEvent(EVT.NET,NETCMD.FARM,L,Gb),K.regEvent(EVT.ENEMY_UPDATE,0,L,Hb)},this.resetPos=function(){if(!M)return;cc()},this.openDlg=function(){X(),fb(),gb(),cc(),this._notifyOpenDlg()},this.hideDlg=function(){M&&M.hide()};var X=function(){if(M)return;Y(),Z(),$(),_(),cb(),Vb(),eb()},Y=function(){TQ.isMobile()?M=Dialog.snew(K,{modal:!1,title:"xxx",pos:{x:"center",y:30}}):M=Dialog.snew(K,{modal:!1,pos:{x:784,y:30},uiback:uiback.dlg.friendmain}),K.getGUI().initDlg(M,uicfg.friend.maindlg,N),InputLimit.maxGBKBytes(N.addName,JVALID.getMaxUserLen())},Z=function(){if(TQ.isMobile())N.toggleBtn=UIM.getPanel("main").getItems().smbtn_friend;else{var a=TQ.createDom("div");TQ.setCSS(a,"position","absolute"),TQ.setCSS(a,"zIndex",9999),TQ.setDomRect(a,0,0,H,I),TQ.append(TQ.getUiBody(),a),N.toggleBtn=new ComButton(K,a,{uiback:uiback.btn.friendListtoggle}),N.toggleBtn.setType(BTN_TYPE.CHECK)}},$=function(){for(var a=0;a<rstr.friend.maindlg.tabs.length;++a)N.tablist.setTabText(a,rstr.friend.maindlg.tabs[a])},_=function(){N.toggleBtn.setCaller({self:L,caller:Yb}),N.addBtn.setCaller({self:L,caller:Zb}),N.applyListBtn.setCaller({self:L,caller:$b}),N.refreshBtn.setCaller({self:L,caller:_b}),TQ.addEvent(N.headiconname,"click",bc),ab(),bb()},ab=function(){for(var a=0;a<N.tablist.getTabCount();++a){var b=N.tablist.getTabItems(a);b.list.setCaller({self:L,caller:ac},null,null,{self:L,caller:qc})}},bb=function(){for(var a=0;a<N.tablist.getTabCount();++a){var b=N.tablist.getTabItems(a);b.pagebar.setCaller({self:L,caller:Db})}},cb=function(){var a=[{rect:[0,1,25,20],id:z,text:rstr.friend.maindlg.opbtns[z-1]},{rect:[30,1,25,20],id:A,text:rstr.friend.maindlg.opbtns[A-1]},{rect:[60,1,25,20],id:B,text:rstr.friend.maindlg.opbtns[B-1]},{rect:[90,1,25,20],id:C,text:rstr.friend.maindlg.opbtns[C-1]}];Q.push(db(a));var b=[{rect:[0,1,25,20],id:A,text:rstr.friend.maindlg.opbtns[A-1]},{rect:[30,1,25,20],id:B,text:rstr.friend.maindlg.opbtns[B-1]}];Q.push(db(b))},db=function(a){var b=[],c=TQ.createDom("div");TQ.setCSS(c,"position","absolute"),TQ.setDomRect(c,r,s,t,u);for(var d=0;d<a.length;++d){var e=a[d],f=TQ.createDom("div");TQ.setCSS(f,"position","absolute"),TQ.setDomRect(f,e.rect[0],e.rect[1],e.rect[2],e.rect[3]),TQ.append(c,f);var g=new ComButton(K,f,{uiback:uiback.btn.blinebtn});b.push(g),g.setText(e.text),g.setId(e.id),g.setCaller({self:L,caller:sc})}return{opDom:c,opBtns:b}},eb=function(){FriendSender.sendGetAllFriends(K)},fb=function(){M.show()},gb=function(){kb(),lb(),N.tablist.activeTab(0)},hb=function(a){ib(a),jb(a)},ib=function(a){var b=N.tablist.getTabItems(a).list;for(var c=0;c<b.getCount();++c){var d=b.getItem(c);IMG.setBKImage(d.exsubs.canGatherFlag,"")}},jb=function(a){var b=[],c=N.tablist.getTabItems(a).list;for(var d=0;d<c.getCount();++d){var e=c.getItem(d),f=Kc(e),g=Fc(a,f);b.push(g.roleId)}FarmSender.sendGetCanGatherFlags(K,b,a)},kb=function(){if(K.getImgr().getFriends().applys.length==0)return;N.applyListBtn.startBlinking(0)},lb=function(){var a=mb();if(a<=0)return;var b=Cc(a),c=Fc(b.tabidx,b.residx);if(!c)return;nb(c,b.tabidx,b.itemidx,b.residx)},mb=function(){return S.length==0?0:S[0].roleId},nb=function(a,b,c,d){ob(a),pb(b,c),Mb(d),qb(a.roleId)},ob=function(a){var b=Nc(a.roleId);b.openDlg(a),b.focus()},pb=function(a,b){var c=Lc(a,b);c&&(c.used=!1,c.b.stop());var d=Ec(a,b);d&&IMG.setBKImage(d.exsubs.talkflag,"")},qb=function(a){var b=[];for(var c=S.length-1;c>=0;--c){var d=S[c];d.roleId==a&&(TQ.removeElement(S,c),b.push(d))}for(var c=b.length-1;c>=0;--c){var e=b[c];Kb(e)}},rb=function(){if(!M)return;wb(),xb(),yb(),Cb()},sb=function(){tb(),ub()},tb=function(){var a=N.tablist.getTabItems(Pc()).list;for(var b=0;b<a.getCount();++b)pb(Pc(),b)},ub=function(){var a=N.tablist.getTabItems(Pc()).list;for(var b=0;b<a.getCount();++b){var c=a.getItem(b),d=Kc(c);if(!Nb(d))continue;if(zc(vb(d))){Mb(d);continue}Sb(Fc(Pc(),d),vb(d))}},vb=function(a){var b=Fc(Pc(),a);return b?(TQ.find(P,"roleId",b.roleId),TQ.getLastFindIdx()):-1},wb=function(){for(var b=0;b<x;++b){var c=Dc(b),d=N.tablist.getTabItems(b),e=Math.ceil(c.length/a);d.pagebar.setPageCnt(e>0?e:1)}},xb=function(){var a=function(a,b,c){ItemResUtil.initItemres(b,"icon"),IMG.setBKImage(c.exsubs.icon,IMG.makeSmallImg(b.itemres.mini_smallpic));var d=RStrUtil.makeXDiamondRoleName(b.roleName,b);TQ.setHtml(c.exsubs.name,d)};zb(a)},yb=function(){var a=function(a,b,c){c.exsubs.farmBtn.setId(a),c.exsubs.farmBtn.setCaller({self:L,caller:rc})};zb(a)},zb=function(a){for(var b=0;b<x;++b)Ab(b,a)},Ab=function(a,b){var c=N.tablist.getTabItems(a),d=Dc(a),e=c.pagebar.getCurPage(),f=Bb(d,e);c.list.setItemCount(f.count);for(var g=f.start;g<f.start+f.count;++g){var h=d[g],i=c.list.getItem(g-f.start);b(g,h,i)}},Bb=function(b,c){var d=c-1,e=d*a,f=Math.min(a,b.length-e);return{count:f,start:e}},Cb=function(){for(var a=0;a<x;++a)N.tablist.getTabItems(a).list.setCurSel(-1)},Db=function(a){rb(),sb(),hb(Pc())},Eb=function(){L.openDlg(),M.hide()},Fb=function(a){var b=a.data;if(b.friends){var c=K.getImgr().getFriends().friends;TQ.dictCopy(c,b.friends),rb(),K.sendEvent({eid:EVT.FRIENDLIST,sid:0})}return b.hasApply&&Jb(b.hasApply),b.chat&&Kb(b.chat),EVENT_RET_OK},Gb=function(a){var b=a.data;if(!b.farmflags)return;Ib(0,b.farmflags),Ib(1,b.farmflags)},Hb=function(){rb()},Ib=function(a,b){var c=N.tablist.getTabItems(a).list;for(var d=0;d<c.getCount();++d){var e=c.getItem(d),f=Kc(e),g=Fc(a,f),h=TQ.find(b,"roleId",g.roleId);if(!h)continue;h.flag==1?IMG.setBKImage(e.exsubs.canGatherFlag,IMG.makeImg("farm/cangather.gif")):IMG.setBKImage(e.exsubs.canGatherFlag,"")}},Jb=function(a){N.applyListBtn.startBlinking(0),Rb(-1)},Kb=function(a){var b=Ob(a);if(zc(b)){var c=Cc(a.roleId);pb(c.tabidx,c.itemidx),Mb(c.residx)}else{Pb(b,a),Qb(b,a),Sb(a,b);var c=Cc(a.roleId);Lb(c.residx)}},Lb=function(a){TQ.find(V,null,a),TQ.removeElement(V,TQ.getLastFindIdx()),V.push(a),Tb(a)},Mb=function(a){TQ.find(V,null,a),TQ.removeElement(V,TQ.getLastFindIdx()),Ub(a),Tb(V[V.length-1])},Nb=function(a){return TQ.find(V,null,a),TQ.getLastFindIdx()>=0},Ob=function(a){for(var b=0;b<P.length;++b)if(P[b].chat.handleChatPkg(a)==EVENT_RET_BREAK)return b;return-1},Pb=function(a,b){a<0&&S.push(b)},Qb=function(a,b){Rb(Rc(a))},Rb=function(a){if(Wb())return;N.toggleBtn.startBlinking(a)},Sb=function(a,b){if(!M)return;var c=Cc(a.roleId),d=Ec(c.tabidx,c.itemidx);if(!d)return;var e=Lc(c.tabidx,c.itemidx);e||(e=Mc()),e.tabidx=c.tabidx,e.itemidx=c.itemidx,e.b.bind(d.exsubs.icon,{tabidx:c.tabidx,itemidx:c.itemidx}),e.b.start(Rc(b)),e.b.setCaller({self:L,caller:Xb})},Tb=function(a){var b=Fc(Pc(),a);if(!b)return;ItemResUtil.initItemres(b,"icon"),IMG.setBKImage(N.headicon,IMG.makeSmallImg(b.itemres.mini_smallpic)),TQ.setTextEx(N.headname,b.roleName),W.start(-1)},Ub=function(a){IMG.setBKImage(N.headicon,""),TQ.setTextEx(N.headname,""),W.stop()},Vb=function(){W=BlinkingCtrl.snew(K),W.bind(N.headiconname,{})},Wb=function(){return M?M.isShow():!1},Xb=function(a){var b=Ec(a.tabidx,a.itemidx);if(!b)return;IMG.setBKImage(b.exsubs.talkflag,IMG.getItemTalk()),Bc(b)},Yb=function(){cc(),N.toggleBtn.stopBlinking(),TQ.isMobile()&&(Wb()?M.hide():(M.show(),hb(0),hb(1),L._notifyOpenDlg()))},Zb=function(){if(!JVALID.checkUsername(N.addName.value)){K.getGUI().sysMsgTips(SMT_WARNING,rstr.ids[100050].msg);return}FriendSender.sendApplyFriend(K,N.addName.value)},$b=function(){N.applyListBtn.stopBlinking(),UIM.openDlg("friendapplylist")},_b=function(){hb(0),hb(1)},ac=function(a,b){if(U){uc(),U=!1;return}hc(b),ic(b)},bc=function(){if(V.length==0)return;var a=V[V.length-1],b=Fc(Pc(),a);if(!b)return;var c=Cc(b.roleId);nb(b,Pc(),c.itemidx,a)},cc=function(){if(TQ.isMobile())return;ec(),dc(),fc(),gc()},dc=function(){if(TQ.isMobile())return;var a=K.getWinSizer().getValidClientSize(),b={x:a.cx-F,y:G};M.setPosition(b)},ec=function(){N.toggleBtn.isPress()?(M.show(),hb(0),hb(1)):M.hide()},fc=function(){if(TQ.isMobile())return;var a=K.getWinSizer().getValidClientSize(),b={x:a.cx-H,y:G+J};N.toggleBtn.isPress()&&(b.x-=F),TQ.setDomPos(N.toggleBtn.getParent(),b.x,b.y)},gc=function(){if(!Wb()||TQ.isMobile())return;TQ.setCSS(N.toggleBtn.getParent(),"zIndex",M.getZIndex())},hc=function(){var a=O[Pc()];if(a.resIdx==Jc())return;if(!a.uiItem)return;jc(a.uiItem,d),kc(a.uiItem,e,f,g,h,i,j),mc(a.uiItem,Pc(),Kc(a.uiItem)),nc(a.uiItem,Pc()),Bc(a.uiItem)},ic=function(){var a=O[Pc()];if(a.resIdx==Jc())return;a.resIdx=Jc(),a.uiItem=Hc();if(!a.uiItem)return;var b=a.uiItem;jc(b,k),kc(b,l,l,n,o,p,q),lc(b,Pc(),Jc()),oc(b,Pc(),Ic()),Bc(b)},jc=function(a,b){TQ.setDomHeight(a.item,b),TQ.setDomHeight(a.item.childNodes[0],b)},kc=function(a,b,c,d,e,f,g){TQ.setDomSize(a.exsubs.icon,b,c),TQ.setDomRect(a.exsubs.name,d,e,f,g)},lc=function(a,b,c){var d=Fc(b,c);if(!d)return;IMG.setBKImage(a.exsubs.icon,IMG.makeSmallImg(d.itemres.mid_smallpic))},mc=function(a,b,c){var d=Fc(b,c);if(!d)return;IMG.setBKImage(a.exsubs.icon,IMG.makeSmallImg(d.itemres.mini_smallpic))},nc=function(a,b){var c=a.item.childNodes[0];TQ.remove(c,Q[b].opDom)},oc=function(a,b,c){var d=a.item.childNodes[0];TQ.append(d,Q[b].opDom);var e=Q[b].opBtns;for(var f=0;f<e.length;++f){var g=e[f];g.setId(g.getId()%D+c*D)}},pc=function(a){var b=Cc(a.roleId);pb(b.tabidx,b.itemidx),Mb(b.residx)},qc=function(a,b){if(Pc()!=v)return;vc()},rc=function(a){U=!0},sc=function(a){Qc(a);var b=a%D;if(tc(b)){K.getGUI().sysMsgTips(SMT_WARNING,rstr.friend.maindlg.tip.opDiedFriend);return}b==y?uc():b==z?vc():b==A?wc():b==B?xc():b==C&&yc()},tc=function(a){if(a==y||a==z||a==B){var b=Gc();if(b.died==1)return!0}return!1},uc=function(){var a=Gc();UIM.closeMapPanels(),UIM.getPanel("farm").open(a.roleId)},vc=function(){nb(Gc(),Pc(),Ic(),Jc())},wc=function(){var a=Gc();OutFieldSender.sendGetFieldDetail(K,a.gridId)},xc=function(){var a=UIM.getDlg("writeletter");a.openDlg(),a.clear(),a.setRecv(Gc().roleName),a.setFocus("title")},yc=function(){var a=Gc(),b=function(b){b==MB_IDYES&&FriendSender.sendDeleteFriend(K,a.roleId)};K.getGUI().msgBox(rstr.comm.msgts,TQ.format(rstr.friend.maindlg.dels[Pc()],a.roleName),MB_F_YESNO,{self:L,caller:b})},zc=function(a){if(a<0)return!1;var b=P[a].chat,c=Ac();return b.getCore().getZIndex()>=c},Ac=function(){var a=0;for(var b=0;b<P.length;++b){var c=P[b].chat.getCore();if(!c.isShow())continue;if(c.getZIndex()<=a)continue;a=c.getZIndex()}return a},Bc=function(a){var b=a.exsubs.icon,c=TQ.getDomWidth(b),d=TQ.getDomHeight(b),e=a.exsubs.talkflag,f=TQ.getDomWidth(e),g=TQ.getDomHeight(e);TQ.setCSS(e,"left",c-f+"px"),TQ.setCSS(e,"top",d-g+"px")},Cc=function(b){var c=[v,w];for(var d=0;d<c.length;++d){var e=c[d],f=Dc(e);if(TQ.find(f,"roleId",b)){var g=N.tablist.getTabItems(e),h=g.pagebar.getCurPage(),i=Bb(f,h),j=TQ.getLastFindIdx()-i.start;return j<0&&(j=-1),j>=a&&(j=-1),{tabidx:c[d],residx:TQ.getLastFindIdx(),itemidx:j}}}return{tabidx:0,residx:-1,itemidx:-1}},Dc=function(a){var b=K.getImgr().getFriends(),c={0:b.friends,1:b.enemys};return c[a]},Ec=function(a,b){var c=N.tablist.getTabItems(a).list;return c.getItem(b)},Fc=function(a,b){var c=Dc(a);return c[b]},Gc=function(){return Fc(Pc(),Jc())},Hc=function(){return Ec(Pc(),Ic())},Ic=function(){var a=Pc();return N.tablist.getTabItems(a).list.getCurSel()},Jc=function(){var a=Ec(Pc(),Ic());return Kc(a)},Kc=function(a){return a?a.exsubs.farmBtn.getId():-1},Lc=function(a,b){for(var c=0;c<T.length;++c){var d=T[c];if(!d.used)continue;if(d.tabidx!=a)continue;if(d.itemidx!=b)continue;return d}return null},Mc=function(){for(var a=0;a<T.length;++a){var b=T[a];if(b.used)continue;return b.used=!0,b}var b=BlinkingCtrl.snew(K);return T.push({used:!0,tabidx:0,itemidx:0,b:b}),T[T.length-1]},Nc=function(a){var b=TQ.find(P,"roleId",a);return b?b.chat:Oc(a)},Oc=function(a){var b=null;for(var c=0;c<P.length;++c){var d=P[c].chat;if(d.getCore().isShow())continue;P[c].roleId=a,b=d;break}return b||(b=ChatDlg.snew(K),b.setUpCaller(Caller.snew(L,pc)),P.push({chat:b,roleId:a})),b.clear(),b},Pc=function(){return N.tablist.getActiveTab()},Qc=function(a){var b=Math.floor(a/D),c=N.tablist.getTabItems(Pc()).list;c.setCurSel(b)},Rc=function(a){return a<0?-1:E}})