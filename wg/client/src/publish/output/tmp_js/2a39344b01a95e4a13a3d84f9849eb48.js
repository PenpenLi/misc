PngAnimMgr=Class.extern(function(){this.init=function(a){this.g=a,this.freeAmins={}},this.alloc=function(a,b){var b=b?b:TQ.getUiBody(),c=this._allocFromFreeAmin(a);c?c.attachTo(b):c=this._createAmin(a,b);var d=PngAnimProxy.snew(c);return d.addCaller({self:this,caller:this._onStop}),d},this.allocAvatar=function(a,b,c,d){var e=[{resId:a,dir:b,actionId:c},{resId:a,dir:1,actionId:c},{resId:a,dir:1,actionId:1}];return this._tryAlloc(e,d)},this.allocEffect=function(a,b,c){var d=[{resId:a,dir:b,actionId:0},{resId:a,dir:1,actionId:0}];return this._tryAlloc(d,c)},this.makeAvatarAnimId=function(a,b,c){return a*1e4+b*100+c},this._tryAlloc=function(a,b){var c=0;for(var d=0;d<a.length;++d){c=this.makeAvatarAnimId(a[d].resId,a[d].dir,a[d].actionId);var e=TQ.qfind(res_animations,"id",c);if(e)break}return this.alloc(c,b)},this._allocFromFreeAmin=function(a){var b=this._getFreeAminsByAnimId(a);if(b.length==0)return null;var c=b[b.length-1];return b.length--,c},this._createAmin=function(a,b){var c=TQ.qfind(res_animations,"id",a);return c?PngAnimation.snew(this.g,b,c):NullPngAnim.snew(a)},this._onStop=function(a){if(a.isNull)return;var b=this._getFreeAminsByAnimId(a.getId());b.push(a)},this._getFreeAminsByAnimId=function(a){return this.freeAmins[a]||(this.freeAmins[a]=[]),this.freeAmins[a]}}),NullPngAnim=Class.extern(function(){var a=!1,b=!1;this.isNull=!0,this.init=function(a){a>0&&a!=1503010101&&a!=1503020101&&a!=1503030101&&a!=1503040101&&a!=1503050101&&log(a)},this.attachTo=function(a){},this.addCaller=function(a){},this.regCaller=function(a){},this.removeCaller=function(a){},this.getId=function(){return 0},this.setZIndex=function(a){},this.setPosition=function(a){},this.getSize=function(){return{cx:1,cy:1}},this.play=function(){b=!0},this.stop=function(){},this.isTriggerTime=function(){return b&&!a},this.isTriggered=function(){return a},this.setTriggered=function(){a=!0},this.isEnd=function(){return b}}),PngAnimProxy=Class.extern(function(){this.anim=null,this.callers=[],this.init=function(a){this.anim=a,this.anim.regCaller({self:this,caller:this._onStop})},this.attachTo=function(a){this.anim.attachTo(a)},this.addCaller=function(a){if(this._hasCaller(a))return;this.callers.push(a)},this.removeCaller=function(a){if(!this._hasCaller(a))return;this.callers.splice(this._getCallerIdx(a),1)},this._hasCaller=function(a){return this._getCallerIdx(a)>=0},this._getCallerIdx=function(a){for(var b=0;b<this.callers.length;++b){var c=this.callers[b];if(c.self==a.self&&c.caller==a.caller)return b}return-1},this.regCaller=function(a){this.callers=[],this.addCaller(a)},this.getId=function(){return this.anim.getId()},this.setZIndex=function(a){this.anim.setZIndex(a)},this.setPosition=function(a){this.anim.setPosition(a)},this.getSize=function(){return this.anim.getSize()},this.play=function(){this.anim.play()},this.stop=function(){this.anim.stop(),this._clearCallers()},this.isEnd=function(){return this.anim.isEnd()},this.isTriggerTime=function(){return this.anim.isTriggerTime()},this.setTriggered=function(){this.anim.setTriggered()},this.isTriggered=function(){return this.anim.isTriggered()},this._onStop=function(a){this.anim=NullPngAnim.snew(0),this.anim.play(),a.isTriggered()&&this.anim.setTriggered();for(var b=0;b<this.callers.length;++b){var c=this.callers[b];c.caller.call(c.self,a)}},this._clearCallers=function(){this.callers=[]}}),PngAnimation=Class.extern(function(){var a=50,b=null,c=null,d=null,e=null,f=null,g=null,h=0,i=0,j=0,k=0,l=!1,m=[],n=null,o=!1,p=!1;this.init=function(a,f,g){b=this,c=a,d=g,d.playTimes||(d.playTimes=4294967295),e=f,s(f),t(),w()},this.attachTo=function(a){r(),TQ.append(a,f),e=a,w()},this.regCaller=function(a){n=a},this.getId=function(){return d.id},this.setZIndex=function(a){TQ.setCSS(f,"zIndex",a)},this.setPosition=function(a){var b=a.x-d.center.x,c=a.y-d.center.y;TQ.setDomPos(f,b,c)},this.getSize=function(){return{cx:d.frameSize.cx,cy:d.frameSize.cy}},this.play=function(){g||(g=window.setInterval(y,a)),TQ.setCSS(f,"display","block"),w(),x(),F()},this.stop=function(){q(),TQ.setCSS(f,"display","none"),r(),n&&n.caller.call(n.self,this)},this.isTriggerTime=function(){var a=d.keyFrame?d.keyFrame:0;return p&&h>=a&&!o},this.setTriggered=function(){o=!0},this.isTriggered=function(){return o},this.isEnd=function(){return p&&g==null};var q=function(){g&&(window.clearInterval(g),g=null)},r=function(){if(!e)return;TQ.remove(e,f),e=null},s=function(a){f=TQ.createDom("div"),TQ.setCSS(f,"position","absolute"),TQ.setDomSize(f,d.frameSize.cx,d.frameSize.cy),TQ.append(a,f)},t=function(a){for(var b=0;b<D();++b){var c=u(b);v(b,c)}},u=function(a){var b=TQ.createDom("div");return TQ.setDomSize(b,d.frameSize.cx,d.frameSize.cy),TQ.setCSS(b,"zIndex",a),TQ.setCSS(b,"position","absolute"),TQ.setCSS(b,"display","none"),TQ.append(f,b),m.push(b),b},v=function(a,b){var c=TQ.formatNumber(d.path+TQ.formatNumber(a,3)+".png"),e=IMG.makeImg(c);IMG.setBKImage(b,e)},w=function(){h=0,l=!0,i=0,j=0,k=0,o=!1,p=!1},x=function(){p=!0},y=function(){z(),B()&&C();if(A()){b.stop();return}F()},z=function(){i+=a},A=function(){return k==d.playTimes},B=function(){return i>=j},C=function(){h==D()-1&&k++,h=(h+1)%D(),j+=E(),l=!0},D=function(){return d.frameCount?d.frameCount:d.frames.length},E=function(){return d.frameInterval?d.frameInterval:d.frames[h]},F=function(){if(!l)return;l=!1;for(var a=0;a<D();++a)TQ.setCSS(m[a],"display",a==h?"block":"none")}})