ExpedUtil=Class.extern(function(){this.expedTo=function(a){UIM.getDlg("expedition").openDlg(this.makeExpedTarget(a))},this.makeExpedTarget=function(d){return d?d.objType==OBJ_TYPE.ROLE?a(d):d.objType==OBJ_TYPE.FIELD?b(d):d.objType==OBJ_TYPE.COPYFIELD?c(d):null:null};var a=function(a){var b=FieldUtil.getPosByGridId(a.gridId);return{id:a.roleId,roleId:a.roleId,type:a.objType,resid:0,name:a.roleName,pos:b,alliance:a.alliance,fightcap:"--",sfightcap:"--"}},b=function(a){var b=ItemResUtil.findItemres(a.resid),c=FieldUtil.getPosByGridId(a.gridId),f={id:a.gridId,type:a.objType,resid:a.resid,level:a.level,roleId:a.roleId,name:b.name,pos:c,alliance:a.alliance};if(a.roleId>0)f.name+="."+a.roleName,f.fightcap="--",f.sfightcap="--";else{var g=ItemResUtil.findFieldLevelres(a.resid,a.level);f.name+="."+TQ.format(rstr.comm.flevel,a.level),f.fightcap=d(g.heros),f.sfightcap=e(g.heros)}return f},c=function(a){var b=a;return b.pos={x:0,y:0},b.resid=b.id,b.fightcap=d(b.heros),b.sfightcap=e(b.heros),b.type=OBJ_TYPE.COPYFIELD,b},d=function(a){var b=0;for(var c=0;c<a.length;++c){var d=a[c];if(d==0)continue;var e=ItemResUtil.findItemres(d);b+=e.fightcap}return b},e=function(a){for(var b=0;b<a.length;++b){var c=a[b];if(c==0)continue;var d=ItemResUtil.findItemres(c);return d.singlefightcap}return 0}}).snew(),BaseFieldOpHdr=Class.extern(function(){this.btnCount=0,this.g=null,this.dlg=null,this.items=null,this.field=null,this.btnTexts=[],this.callers=[],this.init=function(a,b,c,d,e){this.setParams(a,b,c,d,e),this.initBtnsText(),this.setBtnsText(),this.initBtnsCaller(),this.setBtnsCaller(),this.setAllBtnsVisible(),this.setSomeBtnsHidden()},this.update=function(){},this.setParams=function(a,b,c,d,e){this.g=a,this.dlg=b,this.btnCount=c,this.items=d,this.field=e},this.initBtnsText=function(){},this.setBtnsText=function(){for(var a=0;a<this.btnTexts.length;++a)this.items["opbtn"+(a+1)].setText(this.btnTexts[a])},this.initBtnsCaller=function(){},this.setBtnsCaller=function(){for(var a=0;a<this.callers.length;++a)this.items["opbtn"+(a+1)].setCallerEx({self:this,caller:this.callers[a]})},this.setAllBtnsVisible=function(){for(var a=0;a<this.btnCount;++a)this.items["opbtn"+(a+1)].visible()},this.setSomeBtnsHidden=function(){},this.onAddFavorite=function(){MilitarySender.sendAddFavorite(this.g,this.field.gridId)},this.onExped=function(){ExpedUtil.expedTo(this.field),this.dlg.closeDlg()},this.onSendMail=function(){UIM.getDlg("writeletter").writeLetterTo(this.field.roleName),this.dlg.closeDlg()},this.onTalkTo=function(){UIM.getPanel("chat").setChatTarget(this.field.roleName),this.dlg.closeDlg()},this.onAddFriend=function(){FriendSender.sendApplyFriend(this.g,this.field.roleName)},this.onEnterFarm=function(){UIM.closeMapPanels(),UIM.getPanel("farm").open(this.field.roleId),this.dlg.closeDlg()}}),NoOwnerFieldOpHdr=BaseFieldOpHdr.extern(function(){this.initBtnsText=function(){this.btnTexts=rstr.field.fielddlg.btn.noOwnerField},this.initBtnsCaller=function(){this.callers=[this.onAddFavorite,null,this.onExped]},this.setSomeBtnsHidden=function(){this.items.opbtn2.hidden()}}),SelfFieldOpHdr=BaseFieldOpHdr.extern(function(){this.initBtnsText=function(){this.btnTexts=rstr.field.fielddlg.btn.selfField},this.initBtnsCaller=function(){this.callers=[this.onAddFavorite,this.onEnterSelfField,this.onOpenSelfFieldList]},this.onEnterSelfField=function(){var a=UIM.getDlg("selffield");a.openDlg(this.field),this.dlg.closeDlg()},this.onOpenSelfFieldList=function(){var a=UIM.getDlg("selffieldslist");a.openDlg(this.field),this.dlg.closeDlg()}}),AlliFieldOpHdr=BaseFieldOpHdr.extern(function(){this.initBtnsText=function(){this.btnTexts=rstr.field.fielddlg.btn.alliOwnerField},this.initBtnsCaller=function(){this.callers=[this.onAddFavorite]},this.setSomeBtnsHidden=function(){this.items.opbtn2.hidden(),this.items.opbtn3.hidden()}}),OtherOwnerFieldOpHdr=BaseFieldOpHdr.extern(function(){this.initBtnsText=function(){this.btnTexts=rstr.field.fielddlg.btn.otherOwnerField},this.initBtnsCaller=function(){this.callers=[this.onAddFavorite,null,this.onExped]},this.setSomeBtnsHidden=function(){this.items.opbtn2.hidden()}}),FieldDlg=Class.extern(function(){var a=3,b=null,c=null,d=null,e=null,f=null,g={};this.init=function(a){b=a,c=this},this.openDlg=function(a){UIM.closeAllFieldDlg(),h(a),i(),j(),k()},this.closeDlg=function(){if(!e)return;e.hide()};var h=function(a){d=a},i=function(){if(e)return;e=Dialog.snew(b,{modal:!1,title:"...",pos:{x:"center",y:50}}),b.getGUI().initDlg(e,uicfg.field.fielddlg,g)},j=function(){e.show()},k=function(){l(),m(),n()},l=function(){d.roleId?b.getImgr().isSameRole(d.roleName)?f=SelfFieldOpHdr.snew(b,c,a,g,d):b.getImgr().isSameAlliance(d.alliance.uid)?f=AlliFieldOpHdr.snew(b,c,a,g,d):f=OtherOwnerFieldOpHdr.snew(b,c,a,g,d):f=NoOwnerFieldOpHdr.snew(b,c,a,g,d)},m=function(){e.setTitle(FieldUtil.getFieldName(d))},n=function(){o(),p(),s()},o=function(){var a=FieldUtil.getPosByGridId(d.gridId),b=FieldUtil.getCityResIdByGridId(d.gridId),c=ItemResUtil.findItemres(b),e=TQ.format(rstr.field.emptyfielddlg.lbl.cityNamePos,c.name,a.x,a.y);TQ.setTextEx(g.cityNamePos,e)},p=function(){var a=TQ.format(rstr.field.fielddlg.lbl.desc,FieldUtil.getFieldName(d),q(),r());TQ.setTextEx(g.desc,a)},q=function(){var a=ItemResUtil.findFieldLevelres(d.resid,d.level),b="",c=[{fieldName:"getfood",resName:rstr.comm.food},{fieldName:"getwood",resName:rstr.comm.wood},{fieldName:"getstone",resName:rstr.comm.stone},{fieldName:"getiron",resName:rstr.comm.iron}];for(var e=0;e<c.length;++e){var f=c[e];if(!a[f.fieldName])continue;b!=""&&(b+=","),b+=f.resName+a[f.fieldName]}return b},r=function(){var a=ItemResUtil.findFieldLevelres(d.resid,d.level);return DropItemUtil.getProItemsDesc(a.peardropid)},s=function(){TQ.setTextEx(g.role,d.roleName?d.roleName:rstr.comm.norole),TQ.setTextEx(g.alliance,d.alliance&&d.alliance.name?d.alliance.name:rstr.comm.noalli)}})