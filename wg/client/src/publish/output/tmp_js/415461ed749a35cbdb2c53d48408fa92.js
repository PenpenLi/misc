AutoBuildDlg=BaseDlg.extern(function(){this._init=function(){this.collectBuilds_=[],this.autoBuilds_=[],this.isModify_=!1,this.g_.regEvent(EVT.NET,NETCMD.AUTOBUILD,this,this._onSvrPkg)},this._getDlgCfg=function(){return{modal:!1,title:rstr.autobuilddlg.title,pos:{x:"center",y:40},uicfg:uicfg.inbuild.autobuilddlg}},this._afterCreate=function(){for(var a=0;a<rstr.autobuilddlg.types.length;++a)this.items_.cityType.addItem({text:rstr.autobuilddlg.types[a]})},this._setCallers=function(){this.items_.startBtn.setCaller({self:this,caller:this._onClickStartBtn}),this.items_.cityType.setCaller({self:this,caller:this._onSelCityType})},this._initInfo=function(){this._update(),this.items_.cityType.setCurSel(0)},this._update=function(){if(!this.isShow())return;this._reset(),this._updateStartBtn(),this._updateAutoBuildsList(!0),this._updateCanBuildsList(),this._updateNumber()},this._reset=function(){this.isModify_=!1},this._updateStartBtn=function(){this.imgr_.getAutoBuild().starting==0||this.isModify_?(this.items_.startBtn.enable(!0),this.items_.startBtn.setText(rstr.autobuilddlg.btn.start),this.isModify_&&this.autoBuilds_.length==0&&this.items_.startBtn.setText(rstr.autobuilddlg.btn.confirm)):(this.items_.startBtn.enable(!1),this.items_.startBtn.setText(rstr.autobuilddlg.btn.starting))},this._updateCanBuildsList=function(){this.collectBuilds_=this._collectCanBuilds(),this.items_.canBuildsList.setItemCount(this.collectBuilds_.length);for(var a=0;a<this.items_.canBuildsList.getCount();++a){var b=this.items_.canBuildsList.getItem(a),c=this.collectBuilds_[a];TQ.setRichText(b.exsubs.name,TQ.format(rstr.autobuilddlg.lbl.buildname,c.itemres.name,c.level)),b.exsubs.addBtn.setId(a),b.exsubs.addBtn.setCaller({self:this,caller:this._onClickAddBtn})}},this._updateNumber=function(){var a=this.imgr_.getAutoBuild();TQ.setRichText(this.items_.number,this.autoBuilds_.length+"/"+a.max),a.max==0?TQ.setRichText(this.items_.desc,HyperLinkMgr.formatLink(rstr.autobuilddlg.lbl.noEnoughVip)):TQ.setRichText(this.items_.desc,rstr.autobuilddlg.lbl.canBuildList)},this._updateAutoBuildsList=function(a){a&&(this.autoBuilds_=[],TQ.dictCopy(this.autoBuilds_,this.imgr_.getAutoBuild().list)),this.items_.autoBuildsList.setItemCount(this.autoBuilds_.length);for(var b=0;b<this.items_.autoBuildsList.getCount();++b){var c=this.items_.autoBuildsList.getItem(b);TQ.setRichText(c.exsubs.no,(b+1).toString());var d=this._splitCombineId(this.autoBuilds_[b]),e=this._getBuild(d.cid,d.id);e?TQ.setRichText(c.exsubs.name,TQ.format(rstr.autobuilddlg.lbl.buildname,e.itemres.name,e.level)):TQ.setRichText(c.exsubs.name,"--"),c.exsubs.removeBtn.setId(b),c.exsubs.removeBtn.setCaller({self:this,caller:this._onClickRemoveBtn})}},this._getBuild=function(a,b){var c=this.imgr_.getBuildsByCityId(a);return TQ.find(c,"id",b)},this._collectCanBuilds=function(){var a=this.items_.cityType.getCurSel(),b=[];a==0?b=[BUILDCITY_ID.MAIN,BUILDCITY_ID.SUB1,BUILDCITY_ID.SUB2,BUILDCITY_ID.SUB3,BUILDCITY_ID.SUB4]:a>0&&(b=[a]);var c=[];for(var d=0;d<b.length;++d){var e=b[d],f=this.imgr_.getBuildsByCityId(e);for(var g=0;g<f.length;g++){var h=f[g];TIPM.isCanBuildUpgrade(e,h)&&h.state==0&&!this._isInAutoQueue(h)&&c.push(h)}}return c},this._isInAutoQueue=function(a){for(var b=0;b<this.autoBuilds_.length;++b){var c=this.autoBuilds_[b];if(c==this._combineId(a.cid,a.id))return!0}return!1},this._splitCombineId=function(a){var b={cid:0,id:0};return b.cid=Math.floor(a/1e3),b.id=a%1e3,b},this._combineId=function(a,b){return a*1e3+b},this._onClickStartBtn=function(){var a=[];for(var b=0;b<this.autoBuilds_.length;++b)a.push(this.autoBuilds_[b]);AutoBuildSender.sendStartBuild(this.g_,a)},this._onSelCityType=function(){this._updateCanBuildsList()},this._onClickAddBtn=function(a){if(this._isArriveMaxCount()){this.g_.getGUI().sysMsgTips(SMT_WARNING,rstr.autobuilddlg.tip.fullAutoQueue);return}var b=this.collectBuilds_[a];this.autoBuilds_.push(this._combineId(b.cid,b.id)),this._updateWhenModify()},this._onClickRemoveBtn=function(a){this.autoBuilds_.splice(a,1),this._updateWhenModify()},this._updateWhenModify=function(){this.isModify_=!0,this._updateStartBtn(),this._updateAutoBuildsList(!1),this._updateCanBuildsList(),this._updateNumber()},this._onSvrPkg=function(a){var b=a.data;if(!b.autobuild)return;TQ.dictCopy(this.g_.getImgr().getAutoBuild(),b.autobuild),b.autobuild.list&&b.autobuild.list.length==0&&(this.g_.getImgr().getAutoBuild().list=[]),this.g_.sendEvent({eid:EVT.AUTOBUILD,sid:0}),this._update()},this._isArriveMaxCount=function(){return this.autoBuilds_.length>=this.imgr_.getAutoBuild().max}})