WorldBossForceTabHdr=ExpedForceTabHdr.extern(function(){this.isNeedSingleHero=function(){return!1}}),WorldBossSvrHdr=JClass.ex({init:function(a){this.g_=a,this.imgr_=this.g_.getImgr(),this.g_.regEvent(EVT.NET,NETCMD.WORLDBOSS,this,this._onSvrPkg)},_onSvrPkg:function(a){var b=a.data;b.events&&(this.imgr_.getWorldBoss().events=b.events),b.today&&TQ.dictCopy(this.imgr_.getWorldBoss().today,b.today),b.prank&&(this.imgr_.getWorldBoss().prank=b.prank),b.arank&&(this.imgr_.getWorldBoss().arank=b.arank),b.crankweek&&(this.imgr_.getWorldBoss().crankweek=b.crankweek),b.crank&&(this.imgr_.getWorldBoss().crank=b.crank),b.alligifts&&(this.imgr_.getWorldBoss().alligifts=b.alligifts),b.fightDemo&&(this.imgr_.getWorldBoss().fightDemo=b.fightDemo,this.imgr_.getWorldBoss().hurt=b.hurt,this.g_.sendEvent({eid:EVT.WORLDBOSS,sid:1})),this.g_.sendEvent({eid:EVT.WORLDBOSS,sid:0})}}),WorldBossDlg=JBaseDlg.ex({_innerInit:function(){this.forceTabHdr_=null,this.g_.regEvent(EVT.WORLDBOSS,0,this,this._onWorldBossUpdate),this.g_.regEvent(EVT.WORLDBOSS,1,this,this._onFightDemo),this.g_.regEvent(EVT.HERO_UPDATE,0,this,this._onHeroUpdate),HDRM.regHdrEx(this.g_,"worldbosssvr",WorldBossSvrHdr)},_isCanOpen:function(){return this.g_.getImgr().isInAlliance()?!0:(this.g_.getGUI().sysMsgTips(SMT_WARNING,rstr.worldboss.maindlg.tip.needJoinAlliance),!1)},_getDlgCfg:function(){return{modal:!1,title:rstr.worldboss.maindlg.title,pos:{x:"center",y:40},uicfg:uicfg.worldboss.maindlg}},_setCallers:function(){this.items_.changeForceBtn.setCaller({self:this,caller:this._onClickChangeForceBtn}),this.items_.assignSoldierBtn.setCaller({self:this,caller:this._onClickAssignSoldierBtn}),this.items_.treatmentBtn.setCaller({self:this,caller:this._onClickTreatmentBtn}),this.items_.fightBtn.setCaller({self:this,caller:this._onClickFightBtn}),this.items_.getTodayGift.setCaller({self:this,caller:this._onClickGetTodayGift}),this.items_.seeRankDlg.setCaller({self:this,caller:this._onClickSeeRankDlg}),this.items_.guwuOneTimeBtn.setCaller({self:this,caller:this._onClickGuwuOneTimeBtn}),this.items_.guwuTimesBtn.setCaller({self:this,caller:this._onClickGuwuTimesBtn})},_afterCreate:function(){this.forceTabHdr_=WorldBossForceTabHdr.snew(this.g_,this.items_)},_initInfo:function(){this._update();var a=this.g_.getImgr().getSaveForceByType(FORCELINE_TYPE.WORLDBOSS);this._updateForceTab(a.lineup,a.heros),WorldBossrSender.sendGetInfo(this.g_),this.items_.guwuType.select(0)},_update:function(){if(!this.isShow())return;this._updateEventsList(),this._updateBtnsEnable(),this._updateLeftTimes(),this._updateGuwuLevel()},_updateEventsList:function(){var a=this.imgr_.getWorldBoss().events;this.items_.eventList.setItemCount(a.length);for(var b=0;b<a.length;++b){var c=this.items_.eventList.getItem(b),d=a[b],e=RStrUtil.formatResNumStr(d.hurt),f=TQ.format(rstr.worldboss.maindlg.lbl.event,d.role,e,TQ.formatShortDateTime(d.time));TQ.setRichText(c.exsubs.desc,f)}},_updateBtnsEnable:function(){var a=this.imgr_.getWorldBoss().today;this.items_.fightBtn.enable(a.times<a.maxTimes),this.items_.getTodayGift.enable(a.gotGift==0),this.items_.guwuOneTimeBtn.enable(a.guwu<a.maxGuwu),this.items_.guwuTimesBtn.enable(a.guwu<a.maxGuwu)},_updateLeftTimes:function(){var a=this.imgr_.getWorldBoss().today;TQ.setRichText(this.items_.todayTimes,TQ.format(rstr.worldboss.maindlg.lbl.todaytimes,a.maxTimes-a.times))},_updateGuwuLevel:function(){var a=this.imgr_.getWorldBoss().today;TQ.setRichText(this.items_.guwuLevel,a.guwu+"/"+a.maxGuwu),TQ.setRichText(this.items_.addAttackPer,a.guwu*10+"%")},_updateForceTab:function(a,b){this.forceTabHdr_.setLineup(a,b),this._updateMyFightCap()},_onClickChangeForceBtn:function(){var a=UIM.getDlg("assignheros");a.setCaller({self:this,caller:this._updateForceTabAndSendSave}),a.openDlg()},_onClickAssignSoldierBtn:function(){UIM.openDlg("assignsoldiers")},_onClickTreatmentBtn:function(){TreatmentHeroHdr.treatmentHeros(this.g_,this.forceTabHdr_.getHeroIds())},_onClickFightBtn:function(){var a=this.forceTabHdr_.getCanExpedHeros();return ExpedHerosChecker.isValid(this.g_,a,EXPED_TYPE.ACT_WORLDBOSS)?(this._sendExpeditionCmdAndCloseDlg(),!0):!1},_onClickGetTodayGift:function(){WorldBossrSender.sendGetTodayGift(this.g_)},_onClickSeeRankDlg:function(){UIM.openDlg("worldbossrank")},_onClickGuwuOneTimeBtn:function(){WorldBossrSender.sendGuwu(this.g_,this.items_.guwuType.getCurSelId(),1)},_onClickGuwuTimesBtn:function(){var a=this.g_,b=this.imgr_.getWorldBoss().today,c=this.items_.guwuType.getCurSelId(),d=b.maxGuwu-b.guwu,e=rstr.comm.gold,f=100;c==1&&(e=rstr.comm.giftgold,f=50);var g=TQ.format(rstr.worldboss.maindlg.tip.guwuTimes,d,e,f);this.g_.getGUI().msgBox(rstr.comm.msgts,g,MB_F_YESNO,{self:this,caller:function(b){b==MB_IDYES&&WorldBossrSender.sendGuwu(a,c,d)}})},_sendExpeditionCmdAndCloseDlg:function(){var a=this._getTargetRes().copyField;a.objType=OBJ_TYPE.COPYFIELD,a.type=OBJ_TYPE.COPYFIELD;var b=EXPED_TYPE.ACT_WORLDBOSS,c=this.forceTabHdr_.getExpedHerosInLineup(),d=this.forceTabHdr_.getLineup();WorldBossrSender.sendExped(this.g_,a,b,d,c),this.hideDlg()},_getTargetRes:function(){var a=ItemResUtil.findItemres(FIXID.WORLDBOSSFIELD),b=ItemResUtil.findItemres(a.lineup);return{copyField:a,lineupRes:b}},_updateForceTabAndSendSave:function(a,b){this._updateForceTab(a,b),MilitarySender.sendSaveForceLineUp(this.g_,FORCELINE_TYPE.WORLDBOSS,a,b),TQ.dictCopy(this.g_.getImgr().getSaveForces(),[{_k:"type"},{type:FORCELINE_TYPE.WORLDBOSS,lineup:a,heros:b}])},_onWorldBossUpdate:function(){this._update()},_onFightDemo:function(){var a=this;this.hideDlg();var b=UIM.getDlg("fightmap");b.setHideCaller({self:this,caller:function(){a.openDlg(),b.setHideCaller(null)}});var c=this.imgr_.getWorldBoss().fightDemo,d=this.imgr_.getWorldBoss().hurt;b.openDlg(c.armyId,c.fightId,{type:"worldboss",hurt:d})},_onHeroUpdate:function(){if(!this.isShow())return;this._updateMyFightCap()},_updateMyFightCap:function(){this.forceTabHdr_.refresh();var a=this.forceTabHdr_.getHeroIds();TQ.setTextEx(this.items_.myFightCap,HerosUtil.getHerosFightCap(this.g_,a))}})