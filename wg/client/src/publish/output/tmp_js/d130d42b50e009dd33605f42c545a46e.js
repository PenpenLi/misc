ActTerraceExpedDlg=BaseDlg.extern(function(){var a=7,b=100,c=30,d=null;this.subGateList_=null,this.strBar_=null,this.agileBar_=null,this.phyBar_=null,this.myheros_=[],this.isAutoFight_=!1,this.autoToSubGateId_=0,this.enterTerrace_={stopTime:0},this.running_=!1,this.lastLifes_=0,this.checkAutoFightTimes_=0,this.reset=function(){this.running_=!1,this._stopAutoFight()},this.isRunning=function(){return this.running_},this.forceShow=function(){this.dlg_?(this.dlg_.show(),this._initUpdate()):this.enterTerrace_.curGate&&this.openDlg(this.enterTerrace_)},this._init=function(){d=this,this.g_.regEvent(EVT.LOGIN_OK,0,this,this._onLoginOk),this.g_.regEvent(EVT.NET,NETCMD.ACT_TERRACE,this,this._onSvrPkg),this.g_.regEvent(EVT.HERO_UPDATE,0,this,this._onHeroUpdate),this.g_.regEvent(EVT.SAVE_FORCES,0,this,this._onCheckAutoFight)},this._getDlgCfg=function(){return{modal:!1,title:rstr.activity.terrace.expeddlg.title,pos:{x:"center",y:40},uicfg:uicfg.activity.terrace.expeddlg}},this._setCallers=function(){this.dlg_.setCaller({self:this,caller:this._onDlgEvent}),this.items_.myHeroList.setCaller({self:this,caller:this._onSelectHero}),this.items_.treatmentBtn.setCaller({self:this,caller:this._onClickTreatmentBtn}),this.items_.exitBtn.setCaller({self:this,caller:this._onClickExitBtn}),this.items_.vsBtn.setCaller({self:this,caller:this._onClickVSBtn}),this.items_.autoFightBtn.setCaller({self:this,caller:this._onClickAutoFightBtn})},this._afterCreate=function(){this.subGateList_=HorizontalList.snew(this.g_,this.items_),this.subGateList_.setObserver({self:this,caller:this._onUpdateSubGateItem}),this.strBar_=VerticalAttrBar.snew(this.g_,b,this.items_.strBar,this.items_.strVal),this.agileBar_=VerticalAttrBar.snew(this.g_,b,this.items_.agileBar,this.items_.agileVal),this.phyBar_=VerticalAttrBar.snew(this.g_,b,this.items_.phyBar,this.items_.phyVal)},this._showDlg=function(){this.isAutoFight_||this.dlg_.show()},this._initInfo=function(){this.enterTerrace_=this.params_,this._initUpdate(),this.lastLifes_=this.enterTerrace_.leftLifes},this._initUpdate=function(){j(),k(),this._updateGateBaseInfo(),this._updateMyHeroList(),this._updateLeftLifes(),this._updateLeftTime(),this._updateBtnsState(),i();var a=this.enterTerrace_.curGate;this.subGateList_.setItemCount(h(a.gateId),4),this.subGateList_.setCurSel(this._formatSubGateId(a)-1),this.g_.regUpdater(this,this._onUpdate,1e3)},this._updateGateBaseInfo=function(){var a=this.enterTerrace_.curGate,b=g(a);TQ.setTextEx(this.items_.gift,rstr.activity.terrace.expeddlg.giftLabel+DropItemUtil.getDescNoGainLbl(b.dantiaodrop)),TQ.setTextEx(this.items_.gateNo,rstr.activity.terrace.expeddlg.gateNos[a.gateId]),TQ.setTextEx(this.items_.gateName,b.gateName),TQ.setTextEx(this.items_.gatePosition,rstr.activity.terrace.expeddlg.position+b.gatePosition)},this._updateMyHeroList=function(){this.items_.myHeroList.deleteAllItem();var a={};this.myheros_=this.g_.getImgr().getHeros().list;for(var b=0;b<this.myheros_.length;++b)this.items_.myHeroList.addItem({text:this.myheros_[b].name});var c=this.items_.myHeroList.getCurSel();c>=0&&c<this.items_.myHeroList.getCount()?this.items_.myHeroList.setCurSel(c):this.items_.myHeroList.getCount()>0?this.items_.myHeroList.setCurSel(0):(this.items_.myHeroList.setCurSel(-1),this.items_.myHeroList.setTitle(rstr.activity.terrace.expeddlg.myHeroDropTitle))},this._updateLeftLifes=function(){TQ.setDomWidth(this.items_.leftLifes,this.enterTerrace_.leftLifes*c)},this._updateLeftTime=function(){if(this._getLeftTime()==0){TQ.setTextEx(d.items_.leftTime,"");return}var a=TQ.formatTime(0,this._getLeftTime());TQ.setTextEx(d.items_.leftTime,TQ.format(rstr.activity.terrace.expeddlg.leftTime,a))},this._updateBtnsState=function(){this.items_.vsBtn.enable(!d.isAutoFight_&&this._getLeftTime()==0),this.isAutoFight_?this.items_.autoFightBtn.enable(!0):this.items_.autoFightBtn.enable(this._getLeftTime()==0)},this._formatStopTime=function(a){a.stopTime&&this.g_.getSvrTimeS()>=a.stopTime&&(a.stopTime=this.g_.getSvrTimeS()+1)},this._getLeftTime=function(){return Math.max(0,this.enterTerrace_.stopTime-this.g_.getSvrTimeS())},this._onUpdateSubGateItem=function(b,c){var d=this.enterTerrace_.curGate,e=g({gateId:d.gateId,subGateId:b+1});TQ.setTextEx(c.items.name,e.heroName);var f=ItemResUtil.findItemres(e.heros[0]);TQ.setTextEx(c.items.sfightcap,f.singlefightcap);var h=(d.gateId-1)*a+(b+1),i=TQ.find(this.g_.getImgr().getActTerrace().results,"id",h),j=i?i.result:0;TQ.setTextEx(c.items.result,rstr.activity.terrace.expeddlg.results[j])},this._onSelectHero=function(a,b){if(b<0){this._clearCurSelHeroInfo();return}var c=this.myheros_[b];IMG.setBKImage(this.items_.icon,IMG.makeBigImg(c.icon));var d=this.g_.getImgr();TQ.setTextEx(this.items_.healthVal,RStrUtil.getColorHealthVal(d.getHeroAttrVal(c,ATTR.HEALTH))),TQ.setTextEx(this.items_.creditVal,d.getHeroAttrVal(c,ATTR.CRE)),TQ.setTextEx(this.items_.sfightCapVal,d.getHeroAttrVal(c,ATTR.SFC));var e=d.getHeroAttrVal(c,ATTR.PH_B)+d.getHeroAttrVal(c,ATTR.PH_A),f=d.getHeroAttrVal(c,ATTR.ST_B)+d.getHeroAttrVal(c,ATTR.ST_A),g=d.getHeroAttrVal(c,ATTR.AG_B)+d.getHeroAttrVal(c,ATTR.AG_A),h=Math.max(e,g,f,1);this.strBar_.setValue(f,h),this.agileBar_.setValue(g,h),this.phyBar_.setValue(e,h)},this._onDlgEvent=function(a){a==C_SYS_DLG_HIDE&&!this.running_&&this.g_.unregUpdater(this,this._onUpdate)},this._onUpdate=function(){this._updateLeftTime(),this._updateBtnsState(),this._checkStopFight(),this._onAutoFight()},this._checkStopFight=function(){this.isShow()&&!this._hasLeftLifes()&&this._isArriveStopTime()?this._popCloseMsgBox(rstr.activity.terrace.expeddlg.noLifeMsgTip):this.isShow()&&this._isPassGate(this.enterTerrace_.curGate)&&this._isArriveStopTime()&&this._popCloseMsgBox(rstr.activity.terrace.expeddlg.passGateMsgTip)},this._popCloseMsgBox=function(a){this.g_.getGUI().msgBox(rstr.comm.msgts,a,MB_F_CLOSE,{self:this,caller:function(){d._stopAutoFight(),d.running_=!1,d.hideDlg()}})},this._onAutoFight=function(){if(!d.isAutoFight_)return;if(!this._hasLeftLifes())return;if(this._getLeftTime()>0)return;this._onClickTreatmentBtn(),this._onClickVSBtn()||this._stopAutoFight()},this._hasLeftLifes=function(){return this.enterTerrace_.leftLifes>0},this._isArriveStopTime=function(){return this.g_.getSvrTimeS()>=this.enterTerrace_.stopTime},this._onHeroUpdate=function(){if(!this.isShow())return;this._onSelectHero(null,this.items_.myHeroList.getCurSel())},this._onLoginOk=function(){ActTerraceSender.sendCheckAutoFight(this.g_)},this._onSvrPkg=function(a){if(a.data.autoFight){this.autoToSubGateId_=a.data.autoToGate,this._onCheckAutoFight();return}this._isNeedShowFightDemo(a.data.enterTerrace)?this._showFightDemo(a.data.enterTerrace):e(a.data.enterTerrace)},this._onCheckAutoFight=function(){this.checkAutoFightTimes_++;if(this.checkAutoFightTimes_<2)return;this.isAutoFight_=!0,ActTerraceSender.sendGetBaseInfo(this.g_)},this._onClickTreatmentBtn=function(){TreatmentHeroHdr.treatmentHeros(this.g_,[this._getCurSelHeroId()])},this._onClickExitBtn=function(){this.g_.getGUI().msgBox(rstr.comm.msgts,rstr.activity.terrace.expeddlg.confirmExit,MB_F_YESNO,{self:this,caller:function(a){a==MB_IDYES&&(ActTerraceSender.sendLeaveTerrace(d.g_),d.dlg_.hide())}})},this._onClickVSBtn=function(){return ExpedHerosChecker.isValid(this.g_,[this._getCurSelHeroId()],EXPED_TYPE.ACT_TERRACE)?(f(),!0):!1},this._onClickAutoFightBtn=function(){if(!this.isAutoFight_){var b=UIM.getDlg("inputnum");b.openDlg(rstr.activity.terrace.expeddlg.inputAutoFightMaxSubGateId,a),b.setCaller({self:this,caller:this._onSetAutoFightMaxSubGateId})}else this._stopAutoFight()},this._onSetAutoFightMaxSubGateId=function(a){if(a<this.enterTerrace_.curGate.subGateId){this.g_.getGUI().sysMsgTips(SMT_WARNING,rstr.activity.terrace.expeddlg.autoFightLessSubGateId);return}this.autoToSubGateId_=a,this._startAutoFight()},this._isNeedShowFightDemo=function(a){return!this.isAutoFight_&&a&&a.fightDemo},this._showFightDemo=function(a){this.hideDlg();var b=UIM.getDlg("fightmap");b.setHideCaller({self:this,caller:function(){e(a),b.setHideCaller(null)}}),b.openDlg(a.fightDemo.armyId,a.fightDemo.fightId)};var e=function(a){if(!a)return;d._formatStopTime(a),a.isExit?d.running_=!1:d.running_=!0,d.enterTerrace_=a;if(a.leftLifes==0){UIM.getPanel("sysmsg").append(CHAT_TAG.SYS,rstr.activity.terrace.expeddlg.noLifeSysTip),d._stopAutoFight();return}if(d._isPassGate(a.curGate)){UIM.getPanel("sysmsg").append(CHAT_TAG.SYS,rstr.activity.terrace.expeddlg.passGateSysTip),d._stopAutoFight();return}d.openDlg(a)};this._clearCurSelHeroInfo=function(){IMG.setBKImage(this.items_.icon,""),TQ.setTextEx(this.items_.healthVal,0),TQ.setTextEx(this.items_.creditVal,0),TQ.setTextEx(this.items_.sfightCapVal,0),this.strBar_.setValue(0,1),this.agileBar_.setValue(0,1),this.phyBar_.setValue(0,1)},this._formatSubGateId=function(a){return this._isPassGate(a)?h(a.gateId):a.subGateId},this._isPassGate=function(a){return a.subGateId>h(a.gateId)};var f=function(){var a=g(d.enterTerrace_.curGate);a.objType=OBJ_TYPE.COPYFIELD,a.type=OBJ_TYPE.COPYFIELD;var b=180001,c=[d._getCurSelHeroId()];ActTerraceSender.sendExped(d.g_,a,EXPED_TYPE.ACT_TERRACE,b,c),d.isAutoFight_||d.dlg_.hide()};this._getCurSelHeroId=function(){var a=this.items_.myHeroList.getCurSel();return a<0?0:this.myheros_[a].id};var g=function(a){var b=res_terrace[a.gateId],c=d._formatSubGateId(a);return b[c-1]},h=function(a){return res_terrace[a].length},i=function(){d.items_.autoFightBtn.setText(d.isAutoFight_?rstr.activity.tower.expeddlg.btn.cancelAutoFight:rstr.activity.tower.expeddlg.btn.autoFight)},j=function(){if(!d.isAutoFight_)return;d.enterTerrace_.curGate.subGateId>d.autoToSubGateId_&&d._stopAutoFight()},k=function(){if(!d.isAutoFight_)return;d.enterTerrace_.leftLifes<d.lastLifes_&&d._stopAutoFight()};this._startAutoFight=function(){this.isAutoFight_=!0,this._updateBtnsState(),i(),ActTerraceSender.sendStartAutoFight(this.g_,[this._getCurSelHeroId()],this.autoToSubGateId_)},this._stopAutoFight=function(){this.isAutoFight_=!1,this.isShow()&&(this._updateBtnsState(),i()),ActTerraceSender.sendStopAutoFight(this.g_)}}),HorizontalList=Class.extern(function(){var a=null;this.g_=null,this.items_=null,this.itemCount_=0,this.onePageCount_=0,this.curPage_=1,this.observer_=null,this.lastTmplIdx_=0,this.curSelIdx_=0,this.classs_={sel:"item_sel",normal:"item_normal"},this.init=function(b,c,d){a=this,this.g_=b,this.items_=c,d&&(this.classs_=d),f()},this.setObserver=function(a){this.observer_=a},this.setItemCount=function(a,c){this.itemCount_=a,this.onePageCount_=c,i(),b()},this.setCurSel=function(a){this.curPage_=Math.floor(a/this.onePageCount_)+1,this.curSelIdx_=a,b()};var b=function(){c(),d(),e()},c=function(){a.items_.preBtn.enable(a.curPage_>1),a.items_.nextBtn.enable(a.curPage_*a.onePageCount_<a.itemCount_)},d=function(){for(var b=0;b<a.onePageCount_;b++){var c=a.items_["heroItem"+b];TQ.setCSS(c,"display","none")}j(function(b,c){TQ.setCSS(c,"display","block"),a.observer_.caller.call(a.observer_.self,b,c)})},e=function(){j(function(b,c){TQ.setClass(c,b==a.curSelIdx_?a.classs_.sel:a.classs_.normal)})},f=function(){a.items_.preBtn.setCaller({self:a,caller:g}),a.items_.nextBtn.setCaller({self:a,caller:h})},g=function(){a.curPage_--,b()},h=function(){a.curPage_++,b()},i=function(){var b=uicfg.activity.terrace.expeddlg.t_[0];for(var c=a.lastTmplIdx_;c<a.onePageCount_;c++){var d=a.items_["heroItem"+c];d.items={},a.g_.getGUI().buildDomItems(d,b,null,d.items)}a.lastTmplIdx_=a.onePageCount_},j=function(b){var c=(a.curPage_-1)*a.onePageCount_,d=c+a.onePageCount_,e=0;for(var f=c;f<d&&f<a.itemCount_;f++){var g=a.items_["heroItem"+e++];b(f,g)}}}),VerticalAttrBar=Class.extern(function(){var a=null,b=0,c=null,d=null;this.init=function(e,f,g,h){a=e,b=f,c=g,d=h},this.setValue=function(a,e){var f=parseInt(TQ.getCSS(c,"top"),10)+TQ.getDomHeight(c),g=Math.floor(a*b/e);TQ.setCSS(c,"top",f-g+"px"),TQ.setDomHeight(c,g),TQ.setCSS(d,"top",f-g-TQ.getDomHeight(d)+"px"),TQ.setTextEx(d,a)}})