FillSoldierDropTypeList=Class.extern(function(){var a=null;this.init=function(b){a=b},this.fill=function(a,e){a.exsubs.userdata={soldiertypes:[],currentNumber:e.number},a.exsubs.soldiertype.deleteAllItem(),b(a,e),c(a),d(a)};var b=function(a,b){b.resid>0&&(a.exsubs.userdata.soldiertypes.push(b.resid),a.exsubs.soldiertype.addItem({text:RStrUtil.getSoldierNameByResId(b.resid)}))},c=function(b){var c=a.getImgr().getSoldiers();for(var d=0;d<c.length;++d){var e=c[d];if(TQ.find(b.exsubs.userdata.soldiertypes,null,e.id)!=null)continue;b.exsubs.userdata.soldiertypes.push(e.id),b.exsubs.soldiertype.addItem({text:RStrUtil.getSoldierNameByResId(e.id)})}},d=function(a){a.exsubs.soldiertype.addItem({text:rstr.assignsoldierdlg.lbl.nohas}),a.exsubs.userdata.soldiertypes.push(0)}}),UpdateFreeSoldierList=Class.extern(function(){this.setListItems=function(a,b){var c=a.getImgr().getSoldiers();b.setItemCount(c.length);for(var d=0;d<c.length;++d){var e=c[d],f=b.getItem(d);TQ.setText(f.exsubs.soldiertype,RStrUtil.getSoldierNameByResId(e.id)),TQ.setText(f.exsubs.soldiernumber,e.number)}}}).snew(),AssignSoldiersHdr=Class.extern(function(){var a=null,b=null,c=null,d=!1,e=null,f=null,g=null;this.init=function(d,e,h){b=this,a=d,c=e,g=h,f=FillSoldierDropTypeList.snew(a)},this.setHeros=function(a){e=a},this.setCallers=function(a){h(),i(),j(a),k()},this.fillSoldierDropType=function(a,b){f.fill(a,b)};var h=function(){for(var a=0;a<c.getCount();++a){var d=c.getItem(a);d.exsubs.soldiertype.setId(a),d.exsubs.soldiertype.setCaller({self:b,caller:p})}},i=function(){for(var a=0;a<c.getCount();++a){var d=c.getItem(a);d.exsubs.soldiernumber.setId(a),d.exsubs.soldiernumber.setCaller({self:b,caller:l}),d.exsubs.soldiernumber.setLimit(m)}},j=function(a){for(var b=0;b<c.getCount();++b){var d=c.getItem(b);d.exsubs.confirm.setId(b),d.exsubs.confirm.setCaller(a)}},k=function(){for(var a=0;a<c.getCount();++a){var b=e[a],d=c.getItem(a);TQ.find(d.exsubs.userdata.soldiertypes,null,b.soldier.resid),d.exsubs.soldiertype.setCurSel(TQ.getLastFindIdx())}},l=function(b,e){var f=c.getItem(e);f.exsubs.userdata.currentNumber=b,g&&g.onSoldierNumberChange(),!d&&n(e)==0&&a.getGUI().sysMsgTips(SMT_WARNING,rstr.assignsoldierdlg.err.noSoldierType)},m=function(b){var c=n(b),d=o(b,c),f=e[b],g=f.soldier.resid==c?f.soldier.number:0,h=a.getImgr().getHeroAttrVal(f,ATTR.CO);return{min:0,max:Math.min(d+g,h)}},n=function(a){var b=c.getItem(a),d=b.exsubs.soldiertype.getCurSel();return b.exsubs.userdata.soldiertypes[d]},o=function(b,d){var f=a.getImgr().getSoldiers(),g=TQ.find(f,"id",d);if(!g)return 0;var h=g.number;for(var i=0;i<e.length;++i){if(i==b)continue;var j=c.getItem(i),k=j.exsubs.soldiertype.getCurSel(),l=j.exsubs.userdata.soldiertypes[k];if(l!=d)continue;var m=j.exsubs.userdata.currentNumber,n=e[i];if(n.soldier.resid==d){var o=n.soldier.number;m-=o}m<0&&(m=0),h-=m}return h},p=function(a,b,f){var h=c.getItem(f),i=e[f],j=h.exsubs.userdata.soldiertypes[b];d=!0,j==i.soldier.resid?h.exsubs.soldiernumber.setVal(i.soldier.number):h.exsubs.soldiernumber.setVal(0),d=!1,g&&g.onSelectSoldierType()}}),AssignSoldiersDlg=Class.extern(function(){var a=null,b=null,c=null,d={},e=[],f=null,g=null;this.init=function(c){a=c,b=this,a.regEvent(EVT.HERO_UPDATE,0,b,u),a.regEvent(EVT.SOLDIERRES,0,b,v)},this.getCtrl=function(a){return d[a]},this.openDlg=function(){h(),j(),HelpGuider.getNewcomerSpirit().onDlgOpen("assignsoldiers",{parent:c.getParent(),items:d})},this.closeDlg=function(){c&&c.hide()},this.hideDlg=function(){this.closeDlg()},this.isShow=function(){return c?c.isShow():!1},this.click=function(){s()},this.onSoldierNumberChange=function(){HelpGuider.getNewcomerSpirit().onDlgOpen("assignsoldiers",{parent:c.getParent(),items:d})},this.onSelectSoldierType=function(){HelpGuider.getNewcomerSpirit().onDlgOpen("assignsoldiers",{parent:c.getParent(),items:d})};var h=function(){c||(c=Dialog.snew(a,{modal:!1,title:rstr.assignsoldierdlg.title,pos:{x:"center",y:30},btns:[{btn:{id:0,text:rstr.assignsoldierdlg.btn.confirmall},caller:{self:b,caller:s}},{btn:{id:0,text:rstr.comm.close},caller:{self:b,caller:t}}]}),a.getGUI().initDlg(c,uicfg.expedition.assignsoldiersdlg,d),f=AssignSoldiersHdr.snew(a,d.herolist,b),g=FillSoldiersHdr.snew(a,d.herolist,SoldierSender),i()),c.show()},i=function(){c.setCaller({self:b,caller:p}),d.clearall.setCaller({self:b,caller:q}),d.fullall.setCaller({self:b,caller:r})},j=function(){k(),o()},k=function(){if(!b.isShow())return;l(),m(),n(),f.setHeros(e),g.setHeros(e),f.setCallers({self:b,caller:w})},l=function(){e=a.getImgr().collectFreeHeros()},m=function(){d.herolist.setItemCount(e.length)},n=function(){var b=a.getImgr();for(var c=0;c<e.length;++c){var g=e[c],h=d.herolist.getItem(c);TQ.setText(h.exsubs.name,g.name);var i=b.getHeroAttrVal(g,ATTR.HEALTH);TQ.setTextEx(h.exsubs.health,RStrUtil.getHealthStr(i)),TQ.setTextEx(h.exsubs.prof,rstr.comm.heroprofs[g.prof]),TQ.setTextEx(h.exsubs.level,g.level),TQ.setTextEx(h.exsubs.maxnum,b.getHeroAttrVal(g,ATTR.CO)),TQ.setTextEx(h.exsubs.state,rstr.comm.herostate[g.state]),f.fillSoldierDropType(h,g.soldier)}},o=function(){if(!b.isShow())return;UpdateFreeSoldierList.setListItems(a,d.soldierlist)},p=function(a){a==C_SYS_DLG_HIDE&&HelpGuider.getNewcomerSpirit().onDlgClose("assignsoldiers")},q=function(){g.clearAllSoldiers()},r=function(){g.fillAll()},s=function(){g.confirmAll()},t=function(){c.hide()},u=function(){k()},v=function(){k(),o()},w=function(a){g.confirm(a)}})