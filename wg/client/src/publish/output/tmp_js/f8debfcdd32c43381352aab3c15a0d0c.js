CreateMapObjs=Class.extern(function(){var a=null,b=null,c=null,d=null;this.init=function(e,f,g){a=e,c=f,d=g,b=this,this.objs=[]},this.load=function(a){this.unload(),ItemResUtil.initItemsres(a,"id"),this.objs=a,this.filter(a),e()},this.unload=function(){for(var b=0;b<this.objs.length;++b){var c=this.objs[b];c.obj&&(a.getEntityfactory().freeMapObj(c.obj),c.obj=null)}this.objs=[]},this.clickObj=function(a){var b=TQ.find(this.objs,"id",a);b.obj.click()},this.filter=function(a){},this.getObjDom=function(a){for(var c=0;c<b.objs.length;++c){var d=b.objs[c].obj;if(d.getId()==a)return d.getEntity().getDomObj()}return null};var e=function(){for(var a=0;a<b.objs.length;++a)f(b.objs[a])},f=function(b){b.obj||(b.obj=a.getEntityfactory().allocMapObj(c)),b.obj.setNameTagImg(IMG.makeImg("npc/"+b.itemres.resId+"_tag.png")),b.obj.setId(b.id),b.obj.setResId(b.itemres.resId),b.obj.setSize(b.itemres.size),b.obj.setCaller(d),b.obj.setPos(b.pos)}}),StateCityPanel=CommMapPanel.extern(function(){var a=null,b=null,c={},d=0,e={},f=[],g=null;this.init=function(d,e){a=this,b=d,this.Super.init(d,e),c=this.Super.getItems(),b.regEvent(EVT.LOGIN_OK,0,a,h),b.regEvent(EVT.NET,NETCMD.MAP,a,i),ItemResUtil.initItemsres(res_map_worlds.list,"id"),g=CreateMapObjs.snew(b,c.mapscene,{self:a,caller:p})},this.getActTowerDom=function(){return g.getObjDom(FIXID.ACT_TOWER_NPC)};var h=function(){a.create()},i=function(a){var c=a.data;c.entercity&&n(c.entercity),c.npcs&&o(c.npcs),c.mapview&&b.getImgr().setMapView(c.mapview.x1,c.mapview.y1,c.mapview.x2,c.mapview.y2)},j=function(c){var d="["+TQ.find(res_map_worlds.list,"id",c).itemres.name+"]",e=TQ.find(f,"id",c).npcs;k(c,d,e),b.getImgr().setCurLoadCity(c),a.resetSMapCaller()},k=function(b,c,e){m(d),a.loadMap(b,c),g.load(e),a.setViewportPos(l(b)),d=b},l=function(a){if(!e[a]){var c=b.getWinSizer().getValidClientSize(),d={x:907,y:468},f=Math.max(0,d.x-c.cx/2),g=Math.max(0,d.y-c.cy/2);e[a]={x:f,y:g}}return e[a]},m=function(b){if(b==0)return;var c=a.getViewport();e[b]={x:c.x,y:c.y}},n=function(a){var b=TQ.find(f,"id",a.id);b||f.push({id:a.id,npcs:[]}),UIM.closeMapPanels(),UIM.getPanel("statecity").show(),j(a.id),SoundMgr.playBackSound(res_baksounds.stateCity),HelpGuider.getNewcomerSpirit().refreshCurNewcomerTask()},o=function(a){var b=TQ.find(f,"id",a.cityid);b.npcs=a.add,g.load(b.npcs),HelpGuider.getNewcomerSpirit().refreshCurNewcomerTask()},p=function(a){a==FIXID.ACT_TOWER_NPC?(UIM.openActTowerDlg(),HelpGuider.sendHelpTip(b,HelpGuider.HELP_TIP.ACTTOWER_FIGHT),HelpGuider.hideAllSpirits()):a==FIXID.ACT_TERRACE_NPC?UIM.openActTerraceDlg():a==FIXID.ACT_WORLD_BOSS&&UIM.openDlg("worldboss")}})