var C_FMAP_BLOCK_W=45,C_FMAP_BLOCK_H=45;ActorMoveEffect=function(){var a,b,c,d,e=0,f={dx:0,dy:0},g=0,h=!1,i=1e3,j;this.init=function(){a=this},this.setParam=function(a,e,i){b=a;var k=a.getPos();a.setAction("run"),a.faceToPos(e),c={x:k.x,y:k.y},d=e,j=i,g=Math.sqrt((d.x-c.x)*(d.x-c.x)+(d.y-c.y)*(d.y-c.y)),g<.1&&(g=1),f.dx=(d.x-c.x)/g,f.dy=(d.y-c.y)/g,h=!1},this.setSpeed=function(a){i=a},this.getActor=function(){return b},this.getUserData=function(){return j},this.update=function(a){e==0&&(e=a);var j=a-e,k=f.dx*j*i/1e3,l=f.dy*j*i/1e3;b.setPos({x:k+c.x,y:l+c.y});var m=Math.sqrt(k*k+l*l);m>=g&&(b.setAction("stand"),b.setPos({x:d.x,y:d.y}),h=!0)},this.clear=function(){h=!0},this.isEnd=function(){return h},this.init.apply(this,arguments)},FightHandler=function(){var a,b;this.init=function(d){a=d,b=this,a.regEvent(EVT.NET,NETCMD.FIGHT,b,c)};var c=function(b){var c=b.data;c.cdres&&c.cdres.mapid&&a.sendEvent({eid:EVT.FIGHT_CDLIST,sid:0,mapid:c.cdres.mapid,netres:[]});if(c.cdres&&c.cdres.list){var d=a.getImgr().getFightRes().list;TQ.dictCopy(d,c.cdres.list),a.sendEvent({eid:EVT.FIGHT_CDLIST,sid:0,mapid:0,netres:c.cdres.list})}if(c.fround){var e=a.getImgr().getFightRes().fround;TQ.dictCopy(e,c.fround),a.sendEvent({eid:EVT.FIGHT_ROUND,sid:0})}c.fmove&&a.sendEvent({eid:EVT.FIGHT_MOVE,sid:0,fmove:c.fmove}),c.fmenu&&a.sendEvent({eid:EVT.FIGHT_OPMENU,sid:0,fmenu:c.fmenu}),c.fattack&&a.sendEvent({eid:EVT.FIGHT_ATTACK,sid:0,fattack:c.fattack}),c.fresult&&a.sendEvent({eid:EVT.FIGHT_RESULT,sid:0,fresult:c.fresult})};this.init.apply(this,arguments)},MapBlocks=function(){var a,b,c,d=[],e,f=0,g=0,h={x:0,y:0},i=null,h={x:0,y:0},j=null,k=null,l=null,m=null,n=null;this.init=function(d,f){a=d,b=this,c=f.blocksize,e=f.mapscene,k=f.tipcaller,l=f.leavecaller,m=f.entercaller,n=f.clickcaller,r(),o()},this.setMapSize=function(a){p(a)},this.getBlockByPos=function(a){return s(a)},this.getBlockByIdx=function(a){return t(a)},this.setMaskBits=function(a){q(a)},this.getBuildCnt=function(){var a=0;for(var b=0;b<d.length;++b)d[b].actor&&d[b].actor.getFlag()<=FACTOR_FLAG.SELF_BUIDED&&++a;return a},this.getBlockABSPos=function(a){var b=TQ.domOffset(e);return{x:b.left+a.x,y:b.top+a.y}},this.isRoutePassed=function(a,b,c,d){return F(a,b,c,d)},this.clear=function(){for(var b=0;b<d.length;++b){var c=d[b];c.actor&&(a.getActorMgr().destroyActor(c.actor.getId()),c.actor=null)}};var o=function(){TQ.addEvent(e,"mouseover",x),TQ.addEvent(e,"mousemove",y),TQ.addEvent(e,"mouseout",z),TQ.addEvent(e,"mouseup",B)},p=function(a){u(),v(a),w()},q=function(a){var b=0;for(var c=0,e=parseInt(a.length/2,10);c<e;++c){var f=a[c*2],g=a[c*2+1];for(var h=0;h<f;++h)try{d[b++].flag=g}catch(i){alert("fight map the maskbits is invalid!")}}},r=function(){var a=TTIP.addTip(e,"no");j=TTIP.getTipById(a),j.setFlag(TIP_FLAG.CUSTOM),j.setCaller(k)},s=function(a){var b=parseInt(a.x/c.cx,10),e=parseInt(a.y/c.cy,10);return b>=0&&b<f&&e>=0&&e<g?d[e*f+b]:null},t=function(a){return d[a]},u=function(){d=[]},v=function(a){f=parseInt((a.cx+c.cx-1)/c.cx,10),g=parseInt((a.cy+c.cy-1)/c.cy,10)},w=function(a){for(var b=0;b<g;++b)for(var e=0;e<f;++e)d.push({idx:d.length,flag:0,col:e,row:b,x:e*c.cx,y:b*c.cy,actor:null})},x=function(a){A(a)},y=function(a){A(a)},z=function(a){j.hide(),C(-1)},A=function(a){h=TQ.mouseCoords(a);var b=TQ.mouseRelativeCoords(e,a);C(s(b)),j.show(h)},B=function(a){if(TQ.getBtnType(a)!=BTN_LEFT)return;var b=TQ.mouseRelativeCoords(e,a);n.caller.call(n.self,a,s(b))},C=function(a){a!=i&&(D(i),E(a),i=a)},D=function(a){a&&j.hide(),l.caller.call(l.self,a)},E=function(a){a&&(j.setData({block:a}),j.show(h)),m.caller.call(m.self,a)},F=function(a,b,c,d){if(a<0||a>=f||b<0||b>=g||c<0||c>=f||d<0||d>=g)return!1;var e,h,i,j,k,l,m,n,o,p,q,r=Math.abs(d-b)>Math.abs(c-a);r&&(e=a,a=b,b=e,e=c,c=d,d=e),j=c-a,k=Math.abs(d-b),n=j*2,o=k*2,p=a<c?1:-1,q=b<d?1:-1,l=-j*p,h=a,i=b;for(;;){r?m=h*f+i:m=i*f+h;if(!G(m))return!1;l+=o,l>=0&&(i+=q,l-=n*p);if(h==c)break;h+=p}return!0},G=function(a){var b=d[a];return b.actor&&b.actor.getFlag()>=FACTOR_FLAG.ENEMY_BUIDING?!1:!0};this.init.apply(this,arguments)},FightResultDlg_bak=function(){var a,b,c,d;this.init=function(c){a=c,b=this},this.openDlg=function(a,b){c=a,d=b,e()},this.isShow=function(){};var e=function(){TQ.setCSS(c.result,"display","block"),f(),g(),h(),i()},f=function(){TQ.setClass(c.r_result,d.ret==FRESULT_RET.WIN?"retwin":"retfail"),TQ.setClass(c.r_left,d.isattack?"attackflag":"defendflag"),TQ.setClass(c.r_right,d.isattack?"defendflag":"attackflag")},g=function(){for(var a=0,b=d.needcd.length;a<b;++a)TQ.setTextEx(c["r_cd"+(a+1)],d.needcd[a])},h=function(){j("self"),k("self")},i=function(){j("enemy"),k("enemy")},j=function(a){var b=["name","hero","level","carry","lost"],e=c["r_"+a+"list"],f=d[a].army;e.setItemCount(f.length);for(var g=0;g<f.length;++g){var h=e.getItem(g);for(var i in b)TQ.setTextEx(h.exsubs[b[i]],f[g][b[i]])}},k=function(a){var b=c[a=="self"?"r_selfget":"r_enemylost"],e=d[a][a=="self"?"get":"lost"],f=a=="self"?"+":"-",g="";for(var h=0;h<e.length;++h){var i=ItemResUtil.findItemres(e[h].id);g+=i.name+rstr.comm.colon+f+e[h].val+"<br/>"}TQ.setTextEx(b,g)};this.init.apply(this,arguments)}