CultureDlg=Class.extern(function(){var a=null,b=null,c=null,d={},e=null,f=-1;this.init=function(c){a=c,b=this,e=CultureSvrPkgHdr.snew(a),a.regEvent(EVT.CULTURE_UPDATE,0,b,r)},this.getCtrl=function(a){return d[a]},this.openDlg=function(){g(),n(),HelpGuider.getNewcomerSpirit().onDlgOpen("culture",{parent:c.getParent(),items:d})},this.closeDlg=function(){c&&c.hide()},this.isShow=function(){return c?c.isShow():!1},this.opSpeed=function(a){if(a.id==0)return;var b=ItemResUtil.findItemres(a.id);UIM.openDlg("uselistitem",[RES_EFF.ACC_CULTURELEARN],{id:a.id,stoptime:a.stoptime,name:b.name,type:RES_TRG.SELF_ROLE})},this.opCancel=function(b){CultureSender.sendCancelLearn(a)};var g=function(){c||(c=Dialog.snew(a,{modal:!1,title:rstr.culturedlg.title,pos:{x:"center",y:30}}),a.getGUI().initDlg(c,uicfg.culture.culturedlg,d),c.setCaller({self:b,caller:t}),h(),i()),c.show(),a.regUpdater(b,u,1e3)},h=function(){for(var a=0;a<rstr.culturedlg.tabs.length;++a)d.tablist.setTabText(a,rstr.culturedlg.tabs[a])},i=function(){j(),k(),l(),m()},j=function(){d.tablist.setCaller({self:b,caller:p})},k=function(){for(var a=0;a<d.tablist.getTabCount();++a){var c=d.tablist.getTabItems(a);c.list.setCaller({self:b,caller:q})}},l=function(){var a=[[120001,120002,120003,120004,120005],[120006,120007,120008,120009],[120011,120012,120013,120014],[120016,120017,120018,120019],[120021,120022,120023,120024],[120026,120027,120028,120029],[120031,120032]];for(var c=0,e=d.tablist.getTabCount();c<e;++c){var f=d.tablist.getTabItems(c),g=a[c];f.list.setItemCount(g.length);for(var h=0;h<f.list.getCount();++h){var i=f.list.getItem(h);i.userdata={cultureResid:g[h]},TTIP.setCallerData(i.exsubs.tooltips.$item,{self:b,caller:s},{id:i.userdata.cultureResid})}}},m=function(){d.learnbtn.setCaller({self:b,caller:v}),d.speedbtn.setCaller({self:b,caller:w}),d.cancelbtn.setCaller({self:b,caller:x})},n=function(){A(),o(),d.tablist.activeTab(0)},o=function(){for(var b=0,c=d.tablist.getTabCount();b<c;++b){var e=d.tablist.getTabItems(b);for(var f=0;f<e.list.getCount();++f){var g=e.list.getItem(f),h=ItemResUtil.findItemres(g.userdata.cultureResid);IMG.setBKImage(g.exsubs.icon,IMG.makeBigImg(h.bigpic));var i=a.getImgr().getCultureLevel(g.userdata.cultureResid);TQ.setText(g.exsubs.name,h.name),TQ.setText(g.exsubs.level,i),TQ.setText(g.exsubs.level_bak,i)}}},p=function(a){var b=d.tablist.getTabItems(a);b.list.setCurSel(0)},q=function(a,b){var e=d.tablist.getTabItems(d.tablist.getActiveTab()),g=e.list.getItem(b);f=g.userdata.cultureResid,y(),z(),HelpGuider.getNewcomerSpirit().onDlgOpen("culture",{parent:c.getParent(),items:d})},r=function(){if(!b.isShow())return;o(),y(),z(),A(),HelpGuider.getNewcomerSpirit().onDlgOpen("culture",{parent:c.getParent(),items:d})},s=function(b){var c=a.getImgr().getCultureById(b.id);return TIPM.getCultureDesc(c)},t=function(c){c==C_SYS_DLG_HIDE&&(a.unregUpdater(b,u),HelpGuider.getNewcomerSpirit().onDlgClose("culture"))},u=function(b){var c=a.getImgr().getLearningCulture();F(c)},v=function(){var b=a.getImgr().getLearningCulture();if(b.id>0){a.getGUI().sysMsgTips(SMT_WARNING,rstr.culturedlg.err.learning);return}CultureSender.sendLearn(a,f)},w=function(){var c=a.getImgr().getLearningCulture();b.opSpeed(c)},x=function(){var c=function(a){a==MB_IDYES&&b.opCancel()};a.getGUI().msgBox(rstr.comm.msgts,rstr.culturedlg.lbl.cancelLearn,MB_F_YESNO,{self:b,caller:c})},y=function(){var b=a.getImgr().getCultureById(f);TQ.setTextEx(d.desc,TIPM.getCultureLearnDesc(b))},z=function(){var b=a.getImgr().getCultureById(f);d.learnbtn.enable(TIPM.isCultureCanLearn(b))},A=function(){var b=a.getImgr().getLearningCulture();if(b.id==0){B();return}C(b),D(b),E(b),F(b),d.speedbtn.show(),d.cancelbtn.show()},B=function(){IMG.setBKImage(d.curicon,""),TQ.setText(d.curname,""),TQ.setText(d.upgradelevel,""),TQ.setText(d.lefttime,""),d.speedbtn.hide(),d.cancelbtn.hide()},C=function(a){var b=ItemResUtil.findItemres(a.id);IMG.setBKImage(d.curicon,IMG.makeBigImg(b.bigpic))},D=function(a){var b=ItemResUtil.findItemres(a.id);TQ.setText(d.curname,b.name)},E=function(b){var c=a.getImgr().getCultureById(b.id);TQ.setText(d.upgradelevel,TQ.format(rstr.comm.flevel,c.level)+" -> "+TQ.format(rstr.comm.flevel,c.level+1))},F=function(b){if(b.id==0){TQ.setText(d.lefttime,"");return}var c=b.stoptime-a.getSvrTimeS();c=c<0?0:c,TQ.setText(d.lefttime,rstr.culturedlg.lbl.lefttime+TQ.formatTime(0,c))}}),CultureSvrPkgHdr=Class.extern(function(){var a=null,b=null;this.init=function(a){c(this,a),d()};var c=function(c,d){b=c,a=d},d=function(){a.regEvent(EVT.LOGIN_OK,0,b,e),a.regEvent(EVT.NET,NETCMD.CULTURE,b,f)},e=function(){CultureSender.sendGetCultures(a)},f=function(a){var b=a.data;g(b),h(b)},g=function(b){if(!b.cultures)return;var c=a.getImgr().getCultures();TQ.dictCopy(c,b.cultures),a.sendEvent({eid:EVT.CULTURE_UPDATE,sid:0})},h=function(b){if(!b.learning)return;var c=a.getImgr().getLearningCulture();TQ.dictCopy(c,b.learning),ItemResUtil.initItemres(c,"id"),a.sendEvent({eid:EVT.CULTURE_UPDATE,sid:0}),HelpGuider.getNewcomerSpirit().refreshCurNewcomerTask()}})