TradingAreaDlg=Class.extern(function(){var a=null,b=null,c=null,d={},e={stopTime:0,rate:1,maxCitys:4,capacity:0,targets:[],totalDis:0,needTime:0,gain:0,todayTimes:{cur:0,max:0}};this.init=function(c){b=c,a=this,b.regEvent(EVT.NET,NETCMD.TRADING_AREA,a,s),b.regEvent(EVT.SELFALLI_DETAIL,0,a,t)},this.openDlg=function(){if(!f())return;g(),j(),k()},this.hideDlg=function(){c&&c.hide()},this.isCanOpenDlg=function(){var a=b.getImgr().getBuildLevelByResId(BUILDCITY_ID.ALL,FIXID.SHICHANGBUILD);return b.getImgr().isInAlliance()&&a>=res_trading_need_build_minlevel},this.isTrading=function(){return e.stopTime>0},this.isCanTrade=function(){return this.isCanOpenDlg()&&!this.isTrading()};var f=function(){return a.isCanOpenDlg()?!0:(b.getGUI().sysMsgTips(SMT_WARNING,rstr.alli.tradingareadlg.tip.canNotOpen),!1)},g=function(){if(c)return;h(),i()},h=function(){c=Dialog.snew(b,{modal:!1,title:rstr.alli.tradingareadlg.title,pos:{x:"center",y:40}}),b.getGUI().initDlg(c,uicfg.alli.tradingareadlg,d)},i=function(){c.setCaller({self:a,caller:l}),d.setTradingAreaBtn.setCaller({self:a,caller:n}),d.startTradingBtn.setCaller({self:a,caller:o}),d.startVipTradingBtn.setCaller({self:a,caller:p}),d.cancelTradingBtn.setCaller({self:a,caller:q}),d.speedTradingBtn.setCaller({self:a,caller:r})},j=function(){c.show()},k=function(){b.regUpdater(a,m,1e3),AllianceSender.sendGetMyAllianceDetail(b),TradingAreaSender.sendGetMyTradingInfo(b)},l=function(c){c==C_SYS_DLG_HIDE&&b.unregUpdater(a,m)},m=function(){y()},n=function(){var a=[];for(var b=0;b<e.targets.length;++b)a.push(e.targets[b].roleName);UIM.getDlg("settradingarea").openDlg(e.maxCitys,a)},o=function(){TradingAreaSender.sendStartTrading(b,!1)},p=function(){if(!b.getImgr().hasVipEffect(VIP_EFF.SPEED_TRADING)){var c=b.getImgr().hasVipEffectMinLevel(VIP_EFF.SPEED_TRADING);b.getGUI().msgBox(rstr.comm.msgts,TQ.format(rstr.alli.tradingareadlg.lbl.noEnoughVip,2),MB_F_CLOSE,null);return}b.getGUI().msgBox(rstr.comm.msgts,rstr.alli.tradingareadlg.lbl.confirmVipStart,MB_F_YESNO,{self:a,caller:function(a){a==MB_IDYES&&TradingAreaSender.sendStartTrading(b,!0)}})},q=function(){var c=rstr.alli.tradingareadlg.tip.confirmCancelTrading;b.getGUI().msgBox(rstr.comm.msgts,c,MB_F_YESNO,{self:a,caller:function(a){a==MB_IDYES&&TradingAreaSender.sendCancelTrading(b)}})},r=function(){var a=UIM.getDlg("uselistitem");a.openDlg([RES_EFF.ACC_TRADING],{id:0,stoptime:e.stopTime,name:rstr.alli.tradingareadlg.tip.trading,type:RES_TRG.SELF_ROLE})},s=function(a){if(!a.data.trading)return;TQ.dictCopy(e,a.data.trading),e.targets.sort(function(a,b){return a.distance-b.distance}),u()},t=function(){u()},u=function(){if(!c||!c.isShow())return;v(),w(),x(),y(),z()},v=function(){var a=b.getImgr().getBuildLevelByResId(BUILDCITY_ID.ALL,FIXID.SHICHANGBUILD),c=b.getImgr().getMyAlliance();TQ.setTextEx(d.allianceName,c.getName()),TQ.setTextEx(d.tradingRate,e.rate),TQ.setTextEx(d.buildLevel,a),TQ.setTextEx(d.teamLevel,a),TQ.setTextEx(d.maxCitys,e.maxCitys),TQ.setTextEx(d.capacity,e.capacity)},w=function(){d.list.setItemCount(e.targets.length);for(var a=0;a<d.list.getCount();++a){var b=d.list.getItem(a),c=e.targets[a];TQ.setTextEx(b.exsubs.no,a+1),TQ.setTextEx(b.exsubs.roleName,c.roleName);var f=FieldUtil.getPosByGridId(c.gridId);TQ.setTextEx(b.exsubs.cood,"("+f.x+","+f.y+")"),TQ.setTextEx(b.exsubs.buildLevel,c.buildLevel),TQ.setTextEx(b.exsubs.distance,c.distance)}},x=function(){TQ.setTextEx(d.cityNumber,e.targets.length+"/"+e.maxCitys),TQ.setTextEx(d.totalDistance,e.totalDis),TQ.setTextEx(d.needTime,TQ.formatTime(0,e.needTime)),TQ.setTextEx(d.gain,e.gain);var a=e.todayTimes.max;TQ.setTextEx(d.todayTimes,e.todayTimes.cur+"/"+a)},y=function(){if(e.stopTime==0)TQ.setTextEx(d.leftTime,"");else{var a=Math.max(0,e.stopTime-b.getSvrTimeS());TQ.setTextEx(d.leftTime,TQ.format(rstr.alli.tradingareadlg.lbl.leftTime,TQ.formatTime(0,a)))}},z=function(){a.isTrading()?(TQ.setCSS(d.cancelTradingBtn.getParent(),"visibility","visible"),TQ.setCSS(d.speedTradingBtn.getParent(),"visibility","visible"),TQ.setCSS(d.setTradingAreaBtn.getParent(),"visibility","hidden"),TQ.setCSS(d.startTradingBtn.getParent(),"visibility","hidden"),TQ.setCSS(d.startVipTradingBtn.getParent(),"visibility","hidden")):(TQ.setCSS(d.cancelTradingBtn.getParent(),"visibility","hidden"),TQ.setCSS(d.speedTradingBtn.getParent(),"visibility","hidden"),TQ.setCSS(d.setTradingAreaBtn.getParent(),"visibility","visible"),TQ.setCSS(d.startTradingBtn.getParent(),"visibility","visible"),TQ.setCSS(d.startVipTradingBtn.getParent(),"visibility","visible"))}})