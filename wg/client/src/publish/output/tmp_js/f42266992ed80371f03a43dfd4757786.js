JiTanDlg=Class.extern(function(){var a=null,b=null,c=null,d={};this.init=function(a){e(this,a),f()},this.openDlg=function(){g(),j(),k()};var e=function(c,d){a=c,b=d},f=function(){b.regEvent(EVT.LOGIN_OK,0,a,r),b.regEvent(EVT.ROLEBASE,0,a,s),b.regEvent(EVT.CITYRES,0,a,t),b.regEvent(EVT.NET,NETCMD.EXCHANGEEXP,a,v)},g=function(){if(c)return;h(),i()},h=function(){c=Dialog.snew(b,{modal:!0,title:rstr.jitandlg.title,pos:{x:"center",y:50}}),b.getGUI().initDlg(c,uicfg.jitandlg,d)},i=function(){d.assign.setCaller({self:a,caller:w}),d.exchange.setCaller({self:a,caller:x}),d.inum.setCaller({self:a,caller:u}),d.inum.setLimit(y)},j=function(){c.show()},k=function(){l(),m(),p()},l=function(){if(!q())return;d.herosexpbar.setRange(b.getImgr().getRoleAttrVal(ATTR.MXPS)),d.herosexpbar.setValue(0,b.getImgr().getRoleAttrVal(ATTR.XPS))},m=function(){if(!q())return;for(var a=0;a<4;++a)n(a),o(a)},n=function(a){var c=ItemResUtil.findItemres(b.getImgr().getCityResResIdByIdx(a));IMG.setBKImage(d["icon"+a],IMG.makeSmallImg(c.smallpic))},o=function(a){var c=d.inum.getVal(),e=RStrUtil.formatResNumStr(b.getImgr().getCityResValByIdx(a)),f=TQ.format(rstr.jitandlg.lbl.exchangeItem,c,e);TQ.setTextEx(d["res"+a],f)},p=function(){if(!q())return;var a=b.getImgr().getExchangeExp().todaytimes,c=TQ.format(rstr.jitandlg.lbl.todayTimes,a.cur,a.max);TQ.setTextEx(d.todayTimes,c)},q=function(){return c?c.isShow():!1},r=function(){ExchangeHeroExpSender.sendGetTimes(b)},s=function(){l()},t=function(){m()},u=function(){m()},v=function(a){var c=a.data;c.todaytimes&&(TQ.dictCopy(b.getImgr().getExchangeExp().todaytimes,c.todaytimes),p())},w=function(){UIM.openDlg("roleassignexp")},x=function(){if(!z()){b.getGUI().sysMsgTips(SMT_WARNING,rstr.jitandlg.tip.noEnoughTimes);return}if(!A()){b.getGUI().sysMsgTips(SMT_WARNING,rstr.jitandlg.tip.noEnoughRes);return}if(!B()){b.getGUI().sysMsgTips(SMT_WARNING,rstr.jitandlg.tip.noEnoughCap);return}ExchangeHeroExpSender.sendExchange(b,d.inum.getVal()),d.inum.setVal(1)},y=function(){return{min:1,max:C()}},z=function(){return D()>0},A=function(){return E()>0},B=function(){return F()>0},C=function(){var a=Math.min(D(),E(),F());return Math.max(1,a)},D=function(){var a=b.getImgr().getExchangeExp().todaytimes;return a.max-a.cur},E=function(){var a=4294967295;for(var c=0;c<4;++c){var d=Math.floor(b.getImgr().getCityResValByIdx(c)/1e3);d<a&&(a=d)}return a},F=function(){return Math.floor((b.getImgr().getRoleAttrVal(ATTR.MXPS)-b.getImgr().getRoleAttrVal(ATTR.XPS))/1e3)}})