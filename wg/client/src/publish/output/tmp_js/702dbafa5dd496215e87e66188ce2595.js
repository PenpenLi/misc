CommBuildPanel=CommMapPanel.extern(function(){var a=100,b=54,c=null,d=null,e=!1,f=null,g={},h=NullBuildBlocks,i=null,j=!0,k={x:184,y:206},l=!0,m=0;this.init=function(a,b,e){c=a,d=this,f=e,m=e.cityId,this.Super.init(c,b);var g=c.getWinSizer().getValidClientSize(),h={cx:2048,cy:1536},i=Math.max(0,(h.cx-g.cx)/2),j=Math.max(0,(h.cy-g.cy)/2);this.setFirstPos({x:i,y:j}),this.hide()},this.setFirstPos=function(a){k=a},this.open=function(){j?n():o()},this.hide=function(){c.unregUpdater(d,J),this.Super.hide()},this.opSpeed=function(a){i.opSpeed(a)},this.opCancel=function(a){i.opCancel(a)},this.setBlocksCanUseCnt=function(a){v(a)},this.handleSvrBuildsData=function(a){p(!0);var b=c.getImgr().getBuildsByCityId(m),d=q();TQ.dictCopy(b,a),ItemResUtil.initItemsres(b),r(b),x(),s(d)&&i.resetOpMenuItemsShow(),K()},this.getBuildBlocks=function(){return h};var n=function(){UIM.closeMapPanels(),d.setLastViewport(k),o(),h.setViewPos(k.x,k.y),j=!1},o=function(){d.show(),t(),d.loadMap(f.cityResId,f.mapTitle),c.regUpdater(d,J,1e3),x(),c.getImgr().setCurLoadCity(f.cityResId),UIM.getPanel("main").getSubCityBtnsBar().setCurSubCityId(m),d.resetSMapCaller()},p=function(a){l=a},q=function(){var a=h.getCurBlock();if(!a)return-1;var b=a.getItem();return b?b.state:-1},r=function(a){for(var b=0;b<a.length;++b)a[b].cityId=m},s=function(a){return e?d.isShow()?i.isShow()?q()!=a:!1:!1:!1},t=function(){if(e)return;d.create(),d.setViewportCaller({self:d,caller:A}),u(),v(f.canUseBlockCnt),w(),e=!0},u=function(){g=d.getItems(),h=BuildBlocks.snew(c,{map:g.mapscene,mousemap:g.mousemap,blockclass:InBuildBlock,poss:f.blockPoss,blockw:a,blockh:b,clickcaller:{self:d,caller:B},tipcaller:{self:d,caller:H}})},v=function(a){h.setCanUseBlockCnt(a)},w=function(){i=BuildsOpHdr.snew(c,h),i.createOpMenu()},x=function(){if(!e)return;if(!d.isShow())return;if(!l)return;y(),z(),l=!1},y=function(){for(var a=0;a<h.getCount();++a)h.getBlock(a).setItem(null)},z=function(){var a=c.getImgr().getBuildsByCityId(m);for(var b=0;b<a.length;++b){var d=a[b];h.getBlock(N(d.id)).setItem(d)}},A=function(a){h.setViewPos(a.x,a.y)},B=function(a,b){if(d.isDragged(a)||!C(b)){c.getGUI().hideAllMenu();return}D(b)?E(b):G(TQ.mouseCoords(a))},C=function(a){return a>=0&&a<h.getCanUseBlockCnt()},D=function(a){return h.getBlock(a).getItem()==null},E=function(a){var b=F();b.openDlg(m),b.setCaller({self:d,caller:I})},F=function(){var a={};a[CITY_TYPE.MAIN]="mainselbuild",a[CITY_TYPE.SUBRES]="resselbuild",a[CITY_TYPE.SUBARMY]="militaryselbuild";var b=c.getImgr().getCityTypeByCityId(m);return UIM.getDlg(a[b])},G=function(a){i.resetOpMenuItemsShow(),i.show(a),i.updateOpMenuItem()},H=function(a){if(!C(a.idx)){var b=CityLevelUtil.getCityLevelByCanUseBlockIdx(a.idx),c=RStrUtil.getCityNameByLevel(b);return TQ.formatLine(TQ.format(rstr.inbuild.panel.tips.disableblock,c))}if(D(a.idx))return TQ.formatLine(rstr.inbuild.panel.tips.eblock);var d=h.getBlock(a.idx).getItem();return TIPM.getBuildDesc(m,"build",d)},I=function(a){var b=M(h.getCurSel());CityBuildSender.sendAddBuild(c,m,b,a)},J=function(a){K()},K=function(){if(!e)return!1;if(!d.isShow())return!1;L(),i.updateOpMenuItem()},L=function(){var a=c.getSvrTimeS();for(var b=0;b<h.getCount();++b){var d=h.getBlock(b),e=d.getItem();if(!e||e.state==0)continue;var f=Math.max(0,e.stoptime-a);d.setTime(TQ.formatTime(0,f))}},M=function(a){return a+1},N=function(a){return a-1}})