CityDefDlg=Class.extern(function(){var a=3,b=null,c=null,d=null,e={},f={};this.init=function(a){g(this,a),h()},this.openDlg=function(a){i(),l(),m(a)};var g=function(a,d){c=a,b=d},h=function(){b.regEvent(EVT.HERO_UPDATE,0,c,o),b.regEvent(EVT.SOLDIERRES,0,c,p),b.regEvent(EVT.LOGIN_OK,0,c,q),b.regEvent(EVT.NET,NETCMD.CITYDEF,c,r),b.regEvent(EVT.NET,NETCMD.TOWER,c,r)},i=function(){if(d)return;j(),k()},j=function(){d=Dialog.snew(b,{modal:!1,title:rstr.cityDefDlg.title,pos:{x:"center",y:50}}),b.getGUI().initDlg(d,uicfg.cityDefDlg,e),d.setCaller({self:c,caller:n})},k=function(){f.create=CityDefCreatePanel.snew(b,e.tabList.getTabItems(0)),f.city=CityDefCityPanel.snew(b,e.tabList.getTabItems(1)),f.tower=CityDefTowerPanel.snew(b,e.tabList.getTabItems(2))},l=function(){d.show()},m=function(c){for(var d in f)s(d).open();var g=b.getImgr().getBuildLevelByResId(BUILDCITY_ID.ALL,FIXID.TOWERBUILD);g?e.tabList.setTabCount(a):e.tabList.setTabCount(a-1),e.tabList.activeTab(c)},n=function(a){if(a==C_SYS_DLG_HIDE)for(var b in f)s(b).hide()},o=function(){s("city").update()},p=function(){s("tower").update()},q=function(){CityDefSender.sendGetCityDefInfo(b)},r=function(a){var c=a.data;c.citydefs&&(TQ.dictCopy(b.getImgr().getCityDefs().defs,c.citydefs),s("create").update()),c.building&&(TQ.dictCopy(b.getImgr().getCityDefs().building,c.building),s("create").update()),c.defarmy&&(TQ.dictCopy(b.getImgr().getCityDefs().defarmy,c.defarmy),s("city").update()),c.tower&&(TQ.dictCopy(b.getImgr().getTower(),c.tower),s("tower").update())},s=function(a){return f[a]?f[a]:NullCityDefPanel.snew()}}),NullCityDefPanel=Class.extern(function(){this.init=function(a,b){},this.open=function(){},this.hide=function(){},this.update=function(){}}),CityDefCreatePanel=Class.extern(function(){var a=null,b=null,c=null,d=!1;this.init=function(a,b){e(this,a,b),f(),g(),h()},this.open=function(){d=!0,b.selList.setCurSel(0),b.inum.setVal(1),this.update(),a.regUpdater(c,x,1e3)},this.hide=function(){d=!1,a.unregUpdater(c,x)},this.update=function(){if(!d)return;j(),k(),l(),q()};var e=function(d,e,f){c=d,a=e,b=f},f=function(){for(var a=0;a<b.selList.getCount();++a){var c=b.selList.getItem(a),d=res_citydef[a];IMG.setBKImage(c.exsubs.icon,IMG.makeBigImg(d.bigpic)),TQ.setTextEx(c.exsubs.name,d.name)}},g=function(){b.inum.setLimit(i)},h=function(){b.speedBtn.setCaller({self:c,caller:y}),b.cancelBtn.setCaller({self:c,caller:z}),b.selList.setCaller({self:c,caller:A}),b.buildBtn.setCaller({self:c,caller:D}),b.inum.setCaller({self:c,caller:B});for(var a=0;a<b.buildedList.getCount();++a){var d=b.buildedList.getItem(a);d.exsubs.downBtn.setId(a),d.exsubs.downBtn.setCaller({self:c,caller:C})}},i=function(){var a=4294967295,b=function(b,c){var d=Math.floor(t(b)/c);d<a&&(a=d)};return F(b),a=Math.min(a,u()),a=Math.max(1,a),{min:1,max:a}},j=function(){var c=a.getImgr().getCityDefs().building;if(c.id==0){TQ.setCSS(b.buildingInfo,"display","none");return}var d=ItemResUtil.findItemres(c.id);TQ.setCSS(b.buildingInfo,"display","block"),TQ.setTextEx(b.buildingName,TQ.format(rstr.cityDefDlg.lbl.buildingNumber,d.name)),TQ.setTextEx(b.buildingNumber,c.number);var e=Math.max(0,c.stoptime-a.getSvrTimeS());TQ.setTextEx(b.buildingLefttime,TQ.formatTime(0,e))},k=function(){var c=a.getImgr().getCityDefs().defs;for(var d=0;d<res_citydef.length;++d){var e=res_citydef[d],f=c[d],g=b.buildedList.getItem(d);TQ.setTextEx(g.exsubs.name,e.name),TQ.setTextEx(g.exsubs.number,f),f>0?g.exsubs.downBtn.show():g.exsubs.downBtn.hide()}},l=function(){m(),n(),o(),p()},m=function(){var a=res_citydef[r()];TQ.setTextEx(b.selName,a.name)},n=function(){var a=res_citydef[r()];TQ.setTextEx(b.effDesc,a.desc)},o=function(){var a=b.inum.getVal(),c="",d=function(b,d){var e=a*d,f=e<=t(b)?C_TIP_VALIDCOLOR:C_TIP_INVALIDCOLOR,g=rstr.comm.resname[b]+C_TIP_SPACE+e+C_TIP_FOUR_SPACE;c+=TQ.formatColorStr(g,f)};F(d),TQ.setTextEx(b.expendDesc,c)},p=function(){var c=res_citydef[r()],d=a.getImgr().getRoleAttrVal(ATTR.IN_B)+a.getImgr().getRoleAttrVal(ATTR.IN_A),e=a.getImgr().getBuildLevelByResId(BUILDCITY_ID.ALL,FIXID.WALLBUILD),f=Math.ceil(c.ntime/(1+d/100+e/20));TQ.setTextEx(b.needTime,f*b.inum.getVal())},q=function(){TQ.setTextEx(b.capacityDesc,w()+"/"+v())},r=function(){return b.selList.getCurSel()},s=function(){return["money","food","wood","stone","iron"]},t=function(b){return b=="money"?a.getImgr().getMoney():a.getImgr().getCityRes().cres[b]},u=function(){return v()-w()},v=function(){var b=a.getImgr().getBuildLevelByResId(BUILDCITY_ID.ALL,FIXID.WALLBUILD),c=0,d=a.getImgr().getBuildsByResid(BUILDCITY_ID.ALL,FIXID.JIAOLOUBUILD);for(var e=0;e<d.length;++e)c+=d[e].level;return Math.floor(b*200*(1+c/20))},w=function(){var b=a.getImgr().getCityDefs().defs;return b[0]+b[1]+b[2]+b[3]+b[4]},x=function(){j()},y=function(){var b=a.getImgr().getCityDefs().building,c=ItemResUtil.findItemres(b.id);UIM.openDlg("uselistitem",[RES_EFF.ACC_CITYDEF],{id:b.id,stoptime:b.stoptime,name:c.name,type:RES_TRG.SELF_ROLE})},z=function(){var b=function(b){b==MB_IDYES&&CityDefSender.sendCancelBuilding(a)};a.getGUI().msgBox(rstr.comm.msgts,rstr.cityDefDlg.tip.confirmCancel,MB_F_YESNO,{self:c,caller:b})},A=function(){b.inum.setVal(1),l()},B=function(a){l()},C=function(b){var d=function(c){CityDefSender.sendDownCityDef(a,b,c)},e=res_citydef[b],f=a.getImgr().getCityDefs().defs[b],g=TQ.format(rstr.cityDefDlg.lbl.downInputNum,e.name,f),h=UIM.getDlg("inputnum");h.openDlg(g,f),h.setCaller({self:c,caller:d})},D=function(){var c=a.getImgr().getCityDefs().building;if(c.id>0){a.getGUI().sysMsgTips(SMT_WARNING,rstr.cityDefDlg.tip.hasBuilding);return}var d=b.inum.getVal();if(d>u()){a.getGUI().msgBox(rstr.comm.msgts,rstr.cityDefDlg.tip.noEnoughCapacity,MB_F_CLOSE,null);return}var e=E();if(e!=""){a.getGUI().msgBox(rstr.comm.msgts,rstr.cityDefDlg.tip.noEnoughRes+e,MB_F_CLOSE,null);return}CityDefSender.sendBuildCityDef(a,r(),d),b.inum.setVal(1)},E=function(){var a=b.inum.getVal(),c="",d=function(b,d){var e=a*d;if(e>t(b)){var f=rstr.comm.resname[b]+C_TIP_SPACE+e+C_TIP_NEWLINE;c+=TQ.formatColorStr(f,C_TIP_INVALIDCOLOR)}};return F(d),c},F=function(a){var b=res_citydef[r()],c=s();for(var d=0;d<c.length;++d){var e=c[d];if(!b[e])continue;a(e,b[e])}}}),CityDefForceTabHdr=ExpedForceTabHdr.extern(function(){this.isNeedSingleHero=function(){return!1}}),CityDefCityPanel=Class.extern(function(){var a=null,b=null,c=null,d=null,e=!1,f=300;this.init=function(a,b){g(this,a,b),h()},this.open=function(){e=!0,this.update()},this.hide=function(){e=!1},this.update=function(){if(!e)return;i()};var g=function(e,f,g){c=e,a=f,b=g,d=CityDefForceTabHdr.snew(f,g)},h=function(){b.saveForcetab.setType(BTN_TYPE.DELAY),b.saveForcetab.setDelay(f),b.changeForcetab.setCaller({self:c,caller:j}),b.assignSoldier.setCaller({self:c,caller:k}),b.saveForcetab.setCaller({self:c,caller:l})},i=function(){var b=a.getImgr().getCityDefs().defarmy;d.setLineup(b.lineupId,b.heros),d.refresh()},j=function(){var a=function(a,b){d.setLineup(a,b),d.refresh()},b=UIM.getDlg("assignheros");b.setCaller({self:c,caller:a}),b.openDlg({canEmpty:!0})},k=function(){UIM.openDlg("assignsoldiers")},l=function(){CityDefSender.sendSaveDefArmy(a,d.getLineup(),d.getHeroIds())}}),FillSoldiersHdr=Class.extern(function(){var a=null,b=null,c=null,d=null;this.init=function(c,e,f){a=c,b=e,d=f},this.setHeros=function(a){c=a},this.confirm=function(b){var c=e(b);if(!c)return;d.sendConfirmSoldiersAssign(a,[c])},this.confirmAll=function(){var b=[];for(var f=0;f<c.length;++f){var g=e(f);if(!g)continue;b.push(g)}d.sendConfirmSoldiersAssign(a,b)},this.fillAll=function(){var b=[],e=MyDict.snew(0);for(var i=0;i<c.length;++i){var j=c[i];if(!j.id)continue;var k=g(i),l=0;if(k.resid>0){var m=h(k.resid),n=m-e.get(k.resid);l=Math.min(n,a.getImgr().getHeroAttrVal(j,ATTR.CO)),e.set(k.resid,e.get(k.resid)+l)}var o={resid:k.resid,number:l};f(j.soldier,o)&&b.push({id:j.id,resid:o.resid,number:o.number})}d.sendConfirmSoldiersAssign(a,b)},this.clearAllSoldiers=function(){var b=[];for(var e=0;e<c.length;++e){var f=c[e];if(!f.id)continue;if(f.soldier.number==0)continue;b.push({id:f.id,resid:f.soldier.resid,number:0})}d.sendConfirmSoldiersAssign(a,b)};var e=function(a){var b=c[a];if(!b.id)return null;var d=g(a);return f(b.soldier,d)?{id:b.id,resid:d.resid,number:d.number}:null},f=function(a,b){return a.resid!=b.resid||a.number!=b.number},g=function(a){if(b==null){var d=c[a];return{resid:d.soldier.resid,number:d.soldier.number}}var e=b.getItem(a),f=e.exsubs.soldiertype.getCurSel(),g=e.exsubs.userdata.soldiertypes[f],h=e.exsubs.soldiernumber.getVal();return{resid:g,number:h}},h=function(b){var d=a.getImgr().getSoldierNumber(b);for(var e=0;e<c.length;++e){var f=c[e];if(!f.id)continue;if(f.soldier.resid!=b)continue;d+=f.soldier.number}return d}}),CityDefTowerPanel=Class.extern(function(){var a=300,b=null,c=null,d=null,e=!1,f=null,g=null,h=null;this.init=function(a,b){i(this,a,b),j(),k()},this.open=function(){e=!0,this.update()},this.hide=function(){e=!1},this.update=function(){if(!e)return;l(),t(),u()};var i=function(a,e,f){b=a,c=e,d=f,g=AssignSoldiersHdr.snew(c,d.forcetablist),h=FillSoldiersHdr.snew(c,d.forcetablist,TowerSender)},j=function(){d.clearAll.setType(BTN_TYPE.DELAY),d.clearAll.setDelay(a),d.fillAll.setType(BTN_TYPE.DELAY),d.fillAll.setDelay(a)},k=function(){d.clearAll.setCaller({self:b,caller:w}),d.fillAll.setCaller({self:b,caller:y}),d.confirmAll.setCaller({self:b,caller:x})},l=function(){m(),n(),o(),p(),q()},m=function(){for(var a=0;a<d.forcetablist.getCount();++a)r(a)},n=function(){var a=c.getImgr().getTower(),b=ItemResUtil.findItemres(a.lineupId);for(var d=0;d<b.grids.length;++d){var e=b.grids[d];s(e)}},o=function(){f=[];for(var a=0;a<d.forcetablist.getCount();++a)f.push({id:0,soldier:{resid:0,number:0}});var b=z(),e=c.getImgr().getTower(),i=ItemResUtil.findItemres(e.lineupId);for(var a=0;a<i.grids.length;++a){var j=i.grids[a],k=e.soldiers[a];f[j].id=a+1,f[j].soldier.resid=k.resid,f[j].soldier.number=k.number,f[j].attrs={},f[j].attrs[ATTR.CO]={val:b?b.maxnum:0}}h.setHeros(f),g.setHeros(f)},p=function(){for(var a=0;a<d.forcetablist.getCount();++a)g.fillSoldierDropType(d.forcetablist.getItem(a),f[a].soldier)},q=function(){g.setCallers({self:b,caller:v})},r=function(a){var b=d.forcetablist.getItem(a);TQ.setCSS(b.exsubs.container,"display","none"),IMG.setBKImage(b.exsubs.bak,IMG.makeImg("expedition/forcetab/disablebak.gif"))},s=function(a){var b=d.forcetablist.getItem(a);TQ.setCSS(b.exsubs.container,"display","block"),IMG.setBKImage(b.exsubs.bak,IMG.makeImg("expedition/forcetab/emptybak.gif"))},t=function(){var a=z();if(!a)return;TQ.setTextEx(d.strength,a.str),TQ.setTextEx(d.agile,a.agile),TQ.setTextEx(d.physical,a.phy),TQ.setTextEx(d.command,a.maxnum)},u=function(){UpdateFreeSoldierList.setListItems(c,d.freeSoldierList)},v=function(a){h.confirm(a)},w=function(){h.clearAllSoldiers()},x=function(){h.confirmAll()},y=function(){h.fillAll()},z=function(){var a=c.getImgr().getBuildLevelByResId(BUILDCITY_ID.ALL,FIXID.TOWERBUILD);if(!a)return null;var b=ItemResUtil.findBuildLevelres(FIXID.TOWERBUILD,a);return ItemResUtil.findItemres(b.fieldheroid)}})